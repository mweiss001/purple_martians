Purple Martians Revision History
December 23, 2001
Changes from Version 4.01
-------------------------
This is an attempt to document changes and keep a running log of plans.

Added a direct X version.
Recompiled with allegro 4.0

Integrated keyboard and joystick controller routines.

Changed cannons and podzilla to to shoot at the closest active player.
Changed archwagons to shoot if any active player is with range.
Changed lift prox trigger to recognize either player.

Things to do
------------
change rec_ap and play_ap
seperate the death routines for each player.
so that one player can die and the others does not affect!

Dev-C SNES KEYS
---------------
p1_up_key = 120
p1_down_key = 121
p1_right_key = 123
p1_left_key = 122
p1_jump_key = 126
p1_fire_key = 124
p1_map_key = 129
p1_menu_key = 128

p2_up_key = 132
p2_down_key = 133
p2_right_key = 135
p2_left_key = 134
p2_jump_key = 138
p2_fire_key = 136
p2_map_key = 141
p2_menu_key = 140

What if I changed the controller setup to automatically advance when setting keys?
It would be much faster to set them all...

December 2000

Made seperate controller setup for each player.

#defined NUM_PLAYERS 2 for now, but could be adjusted in the future

Must change all references to looping players to:

for (int p=0; p<NUM_PLAYERS; p++)
   if ((players[p].active) && (!players[p].paused))

note:
.active means that game screen is drawn
!.paused means that the player can move and interact with the level


add a new control method to handle the pausing

When a player dies:

-set the control method
-set paused on

When in this control method any key will exit and:

-set paused off
-restore the control method

-----------
too difficult

only use pause for after death

when in pause mode make a function that
- detects pause mode from the players data
- counts down with passcount
- displays
- waits for a keypress and turns pause off

---------------------------------------------

maybe I need to rethink the players variables

proposed new ones

- .display_window_active (used to indicate if the players screen values are valid)
  0 - no visible screen output
  1 - SX. SY, SW, SH are valid

//  when ever anything is drawn it is drawn on all of the valid screens above
//  when nothing is drawn what was there before is not erased (use for freeze)


- .running (does the player interact with enemies, items, etc and have input?)
  0 - no interaction
  1 - full interaction

- .paused_timer (used in conjunction with not running)

  -if (not_running) the paused_timer will decrement until zero
  - at which time the get any key will happen


modes:
1) running
2) one player timer paused with screen frozen
3) paused waiting for player input


death
show death message
freeze screen
timer_pause
get_key
move to start and continue


          |  active | paused
----------+---------+-------
running   |   yes   |   no
frozen    |   no    |   yes
key_pause |   yes   |   yes
running   |   yes   |   no

Update on all this stuff:
I went with the original values

!.paused and  .active means that game screen is drawn and the player interacts
 .paused and !.active means the pause_delay is counting
 .paused and  .active means waiting for keypress

!.paused and !.active is undefined

--------------------------

made a frame skip function
global variable frame_skip
and an allegro.cfg entry
the only way to change is to manually edit allegro.cfg
Under the [GAME] section set 'frame_skip = n'
n = 1 --> draw every frame (normal)
n = 2 --> draw every second frame
n = 3 --> draw every third frame
eventually I plan to make a menu entry for this
all it will need to do is cycle from 1, 2, 3 and 4 (any more is really bad quality)

---------------------------------
al_fixed the record apl functions to save the current number of active players and screen split
al_fixed the run apl functions to restore the current number of active players and screen split
-------------------------------------------------------------------------------------------

I want to make autoplay work on every level that is played with the following rules:

At the beginning of the apl file the following data must be recorded:
- level
- number of ap entries

- player[0].active
- player[0].num_bullets
- player[0].LIVES
- player[0].LIFE

- player[1].active
- player[1].num_bullets
- player[1].LIVES
- player[1].LIFE

Every time a new level is started, these values are reset

When ever the game is paused Save will save all of the neccessary data

These files can then be run with the run command or resumed with the load command

-----------------------------------------------------------------------------------
Removed the old load and save game
Added 1P and 2P start buttons
the old rec autoplay control has been changed to save autoplay

------------------------------------------

the next thing that needs to be done is change the game loop
so that I can call it with an autoplay level file and it will either
autoplay it or move to the frame then continue

make a global variable no_draw_till_passcount
normally set to zero, but when > 0 nothing is drawn until that passcount

this will be the load game thing


-----------------------
I really need to fix the menu structure before I can release and let others use it
I think I will go with a seperate menu to configure each player

How About:

At the sides under each player I would show the current mode for that player

Start Level(1)
Start Game
Resume Game
Player 1 - Setup Menu
Player 2 - Setup Menu
Save Game
Load Game
Options Menu
Help
Run Demo

Player 1 setup menu
--------------------------------
- Set to Off (disabled)
--------------------------------
- Set to Local Control
--------------------------------
- Get new controller values (all)
- Get new controller values (single)
- Set to arrow keys
- Set to joystick 1 default
- Set to joystick 2 default
- Switch fire and jump
--------------------------------
- Set to File Play
- Set file
--------------------------------
- Set to Network Server
--------------------------------
- Set to Network Client
--------------------------------

I want a remote connection able to join the game by sending a packet that contains all of the data
needed to resume a level just like the resume should.

How about for now losing the dual screen thing and making multiplayer a network thing.

I would really like to be able to do both

--------------------------------
split enemy_draw_and_collison to enemy_draw and enemy_collision

need to split proc_pbullets and proc_ebullets to seperate the draw part
done now we have items:

draw_items does all but lit bombs and carried items

I need to modify:

proc_lit_bomb
proc_lit_rocket
proc_player_carry

to take an integer argument (draw) and use this to draw or not
DONE

------------------------------
I think I have seperated all drawing to run only when draw_frame is set
-------------------------------------------
fire_held is set by proc p_bullets and cleared by player_key_check or set_controls_from_comp_move
-------------------------------------------------

In the Level Editor it dies horribly whenever I try to create a new lift.
I thought I would need to redo my allocation, but that still works fine using
malloc(sizeof()) free, although I would eventually like to change it to
new and delete, but why change it if it works?
The bugs turned out to be mostly cases of referencing an not-yet allocated variable
- just about completely fixed
- sometimes still crashes when deleting lifts from the lift viewer
- does not crash when deleting from the pop-up menu

--------------------------------------------------
What about reserving players[0] and [1] for local and all above that for net clients
---------------------------------
I want to change the event messages that scroll at the bottom of the screen
or at least I want to do somerthing new as they only work good in single player mode
I would like to make the exact same messages display exactly where the event took place
Sort of how enemy deaths have a flower item created, item activations, and other events
would cause a message creation that would animate and take care of displaying itself.
I think all I need to change about the existing messages it to add a position to it
an x and y in 0-1999 format.  Also the drawing bit would need to be updated to display
on active players screens

------------------------------------
The menu's have been redone with seperate player controller setup menus
Added Frame Skip to options menu
Added text to the main screen that shows which is player 1 and player 2 and if they are active

------------------------------------
Got libnet to compile with both versions and documented how to do it
The next thing I need to do with the network stuff is:
get a startup routine that measures the amount of delay between computers
set the keys to lag by twice the number of frames needed to beat the lag

I need a better startup routine

From the server end the server will:


- provide the master timing from which all net connections must sync to
- every 100 clock ticks send out a timing signal
- run the game with one or two local players
- accept connections from any number of other players
- sent api data to connecting clients so they can syncronize


- keep track of data for any number of connections

- measure the time to get a response
- check to see if it acceptable
- if ok send data to client about level and passcount
- client should then chase to this passcount and sync

I have just written a small poll and reply bit that seems to only take 2 or 3 passcounts to reply


How will the Server manage people trying to connect?

1 - mode=0, listens and accepts new connection, puts in array with who
2 - set mode=1, transfer data
3-  set mode=2, chase to passcount, might have to get another data transfer if chase is too slow


-------------------------------------------
Its going to be two seperate but linked problems:
how to synchronize and keep both updated

sync
----
The server is the master
before attempting make sure both can easily do set frame rate

whenever a client has data to send it will send it with the passcount of the change
the server will collect all client data for that passcount and send it back to all clients

When playing a network game, all input (local and remote)
is fed into the play array a few passcounts in the future.

The server sends one packet of all player data back to all clients (local and remote)

For example:

- local input recieved during passcount 10 is stored in array at passcount 20
- remote input is stored at sent location (already has 10 added at sender)
- at 15, 20 is sent to all clients

the client sends the change with passcount and does not get entered into local api until
returned by the server


-----------------------------------------------


maybe I don't need to clump them all together when I retransmit them
I think the server should reply with a broadcast message

the form of the move packet is going to change though

old - Move:xx 2bytes containing 13 states

new - Move:[passcount(2bytes)][player(1byte)][comp_move(1byte)]

--------------------------

I ripped out the old autoplay code completely
the global autoplay[5000][2] is gone as well as
api
api_read
api_write
they have been moved to the player structure
so that each player has its own
added a routine to clear them
seems to works good but the following are broken
load and save and run autoplay

--------------------------------------------------------------------
Server will have only passcount display
Client will have local and remote passount
--------------------------------------------------------------


-----------------------------------------
made a very good passcount sync check that that client originates
client sends SPOL with attached passcount
server reply and adds the server passcount
when the client receives the reply (usually the next passcount, but not always!)
the server passcount should be close to the sent and recieved ones
right now all it does is calculate the difference in passcounts and call in client_sync
---------------------------------------------

the whole CONTROL_LEAD_FRAMES thing broke the players shoot holdoff
and the fire_held used to carry and ride rockets

I should make CONTROL_LEAD_FRAMES zero except when in netplay mode

-------------------------------------------------
I should disable the load and save game or fix them
they are broken because of multiple api lists for each player
---------------------------------------------------------

-------------------------------------------------
I think this will be the best method for controlling the speed of the game
------------------------------------
removed all traces of 'dif' now there is only one difficulty level
removed all traces of mod
removed all traces of lines

----------------------
The new way that the timer routines work

A timer is set up at the desired frame rate.  This timer is the reference.  The
actual passcount is synced to this count.

variables:
- int timer_passcount is the reference counter
- int timer_passcount_fps is a global int used to control the speed of the timer

before every frame is drawn if timer_passcount is compared to the actual passcount
and the game waits until timer_passcount = passcount before drawing
if passcount > timer_passcount the draw frame is skipped

-----------------------
Now I'll add or subtract sync_adjust from timer_passcount_fps
and change the period of the timer
-----------------------

---------------------------------------------
I need to seperate .local_draw from .active
.active means what it always does
for anything that draws, .local_draw will be used with SX SY SH and SW
all local players will have .local_draw set
and all remote players will not have it set
they will still be drawn on the local screen(s) they just won't have a dedicated screen
---------------------------------------------------

players screen variables are set in a bunch of different places
I should have a function that sets a players variable

------------

what if all clients are numbered above 1?
the server can only use player indexes 0 and 1
and clients can only use from 2 and above
when server mode is chosen the game waits for a client to connect
and then starts them at the same time

-------------
I need a top menu function called start server game and start client game

--------------
I should change exits to require all players to touch the exit
---------------


I have agreed to let Roy be the 'Official Host' of Purple Martians for one year.
He has paid $100 for this.
This time period will be from July 1, 2003 to July 1, 2004
I am to give him a cleaned up version of the sources by June 19, 2003,
I have also got all the emails I have received about the game
and added them to the project sources.

In order to clean up the game I need to:


Disable the netplay stuff by commenting out #define NETPLAY...DONE

Update the help.txt file...........DONE

clean up the levels..........DONE


Make a windows direct X versions

with or without sound
with or





Released Version 5.0 !!!


New ideas


- add left and right arrow / controller left and right to menu
- add sound and music slider controls to menu

- make a new tile for the player when jumping (strech upwards), falling (stretch downwards)
- stretch to the right and left corners when moving right or left in combination with above

ladders, ropes ?

some items not activated until up or down arrow is pressed?



Version 6 will have network multiplayer capability

When the game is running in server mode, the only noticeable difference will be the control frame lag
and if another player joins, you will see them!


The client will request a new connection, the server will reply with a level number, a player number and color, etc
Then the server will begin to send sync packets of up to 1000 api entries

server will be able to send a sync packet to a player to allow the player to sync with the server
It will work similar to how ServerLink does
Each packet that is sent to the client will have timecodes associated with it
Say the server is running at frame 5000 and a client wants to join.
The client is sent the player data for frame 0-5000 and it chases to catch up
when it has reached frame 5000 it sends a reply, but by this time the server is at frame 5020
The server then sends frames 5001-5020 and hopefully the client will respond faster.

When the number of frames being sent drops below 5 we can say we are synced and allow the client to interact.

The client will display its current frame number and the frame range




The client will not check for collisions.
All collision checking will be done by the server and collision packets will be sent to the client.
void send_collision_packet(int player, int enemy, int item)


The server will be able to send a packet with the players exact floating point position.
Not every frame, but an adjustable ammount and I could keep track of any slippage.




Maybe the reason my game is not deterministic is my use of floating point on buggy intel uP's
Maybe I could redo it with a al_fixed point???





What am I going to do first?

I would like to set up the sync chase bit.

I will need to rewrite a lot of the code.

The server will just run on as normal but listen for connections

How can I make the server and client find its own local IP address?
How can I make the client find the server's IP address? (broadcast?)

The server needs to be able to have multiple independent connections in my code...

Some sort of handshaking should take place...

When a connection is estabilished, nothing happens until the client sends

either a query or a join packet

The server replies to a query with:
The level being played
The number of players
The time the level has been played(frame count)
The FPS the server is running at

The server replies to a join packet with:
The level being played
The player number to use
The FPS the server is running at

If it gets one it should start sending pd packets

A pd packet has the following data


int start_frame 0
int end_frame 100
int number_of_elements 2
int frame[0] = 0
int api[0] = 0
int frame[1] = 100
int api[1] = 8

and will have some sort of upper limit to its size like MAX (number_of_element) = 200 ?

the client will immediately advance to that frame and then send a reply packet

pr packet








October 29, 2003

Added right and left arrows to menu's
Plan to add volume and sound effect controls with these arrows



November 1, 2003

I removed all floats from the player structure and replaced them with al_fixed.
I also plan to do the same with items and enemies floats.
This is an attempt make the game more deterministic.
I am still in the process of working out all the bugs.

something wrong with player ride, it crashes - al_fixed

now when I try to carry an item it disapears and when I drop it it dies - al_fixed

I think the player stuff has all been worked out!!!

next I shold convert the floats asociated with items...


I want to store each player, enemy and items position as al_fixed and whenever I want an int just use al_fixtoi and discard the lower byte

November 22, 2003

I redid the players Y move thing, got rid of the trig and used way less variables

I have removed player[p].PXint and player[p].PYint from player and
replaced all occurances with al_fixtoi(player[p].PX) and al_fixtoi(player[p].PY)

seems to work OK

Now I need to convert enemies, bullets, and lifts

enemies will be hard if I need to change the editor too.. maybe I dont...!?

bullets would be the easiest...
players bullets already have no floats!!!

e_bullets only!!!


also rockets dont explode and bombs
- something wrong with proc_lit_bomb... al_fixed


also player ride lifts is a bit off - al_fixed




----------------------------------------------------------------------------------
what do I need to change to make volume and sound effect slider in the menu


in event I will create a variable to scale all the velocities
global int se_scaler (0-100)

This has been done, but the scales are both 0-9

December 7, 2003

----------------------------------------------------------------------------------
I need to make save api and load api work
It has been broken since api got added to the player structure.

I need to define the structure in such a way that I don't have to redefine it later.

play_level
number of player entries

player number
number of api entries
array of entries

December 7, 2003 - I can now save and play back both players!!!

------------------------------------------------------------------------------------------------


I need to fix the jump height using level 2 as a guide and then the left right thingy too.

The max jump height is defined as he can just barely not jump on a 4 block rise above himself

This has been done.

Also the max sproingy jump is 100 and it is enough to jump from the lowest to the highest

Also the max x speed is now 4 just like before.

December 8, 2003

----------------------------------------------------------------------------------------------

Now the player has troubles navigating single block openings...seems to be OK now

I think if I reintroduce initial x speeds that might cure it...
initial used to be 1.15... already done....

--------------------------------------------------------

Dec 13, 2003

added gfx_card to the values saved in the config file.
now if a windowed mode is chosen it will remember it when the game is restarted.

-----------------------------------------------------------

I want to add a menu entry 'Game Type'
the choices will be

LOCAL
-----
- one player
- two player coop
- two player deathmatch
- two player (one from autoplay file)


NETWORK
-------
- server game
- client game


----------------------------------

I want to make the bmsg stay where it occurred...

make a new structure called amsg

when an event occurs and the call to:

create_amsg(char *text1, *text2, int justify, int length_in_ticks, int start_scale, int end_scale, al_fixed xinc



-----------------------------------


August 2004

Made the level editor show the height of Sproingy jumps
I think the bugs are worked out for the players movement.

initial jump speed -8
slow gravity = .32
gravity = .60
terminal velocity = 7.8

I will leave it like this for now.

The level editor will only link with alleg40.a not liballeg?  go figure!



----escaped to real life for 5 years....but I couldn't stay away!!!




20091209

started working on it again

added clientaddress instead of using serveraddress for everything

compiles but i cant seem to get it to work...

logging would be nice...

a simple command like log("file", "text %d", a );




commands sent back and forth by netpaly

SPOL "server poll" sent to server by client - contains client passcount
server responds with SREP "server reply" - contains just rx'd client passcount and current server passcount


CMOV "client move" sent to server by client - contains passcount and comp_move
server adds to autoplay array
server broadcasts to all clients "SMOV"



make a log file thing done

add_log_entry( *char)


new versions:
-------------
dev-cpp-4.9.9.2.exe
added allegro-4.2.2-1len.DevPak with package manager
dumb-0.9.3
libnet-0.10.11

compiles clean!!!!!


now to get level editor to link; removed one line ya!!


server address was split in client and server address but didn't work until I set the same


why???


it appears client address doesn't matter...


-----------------------------------------
- the server starts without knowing or specifying its IP address

- the client needs the server's IP address to connect? yes
- client_init needs the server address to connect
- check client response does not...?
(i am using check client response as my connected thingy..?)

- client received data has no address
- client sends data with no address

- server recieved data has address (who)
- server can send data to specific client
- server can send to all clients

- when the server receives a message from a client; it gets "who" to send back to that client


------------------------------------------


maybe they don't seem to sync because they don't start out the same!!!!!!

i mean the server and the client both start independantly and then try to sync later

ideally

the server should start and run independantly

the client should not allow any user input until it has chase locked to the server

before client joins game; client must read join packet and set:
-level
-frame_speed
-player_number
-lead control frames

the server should broadcast a join packet periodically while waiting for clients

states

server - 1
client - 1


server
0 normal
1 waiting for client connection (broadcasting join)
2 connected; waiting on sync
3 sync'd


client
0 normal
1 looking for server
2 connected; waiting on sync
3 sync'd


------------------------------------------------
BUG - when server player dies...the game loop stops and client freezes without updates;

FIX: need non blocking death thingy
this would be cool even for the rest of the game
the player will freeze exactly where they died, but the level will continue to play in the background


-----------------------


save api automatically on exit so I can compare

added function blind_save_apl and call at exit
hard to go through manually
not really.. i have identical apl.txt's and different positions on the screen




how about a packet that compares the players position at a certain frame
and lets me know if they are different


whenever i print smove let me know how far ahead i'm putting it in array

frame lead is 0 or 1 with #define CONTROL_LEAD_FRAMES 2

frame lead is 2  with #define CONTROL_LEAD_FRAMES 3




log player position

where every 20 passcount??




what if its due to writing into api and it not getting executed!!!

make a large error happen if something is added after executed!!

20091211(fri)

compare api's between remote
api's are exact and position is different


record a complex api and see if if play back correct on another system


synctest1_38.apl ends up at: 2130-p[0]x:755 y:240 - p[1]x:770 y:240 on 1st work MCMP

synctest1_38.apl ends up at: 2130-p[0]x:755 y:240 - p[1]x:770 y:240 on 2nd work MCMP

synctest1_38.apl ends up at: 2130-p[0]x:755 y:240 - p[1]x:770 y:240 on dell wfdd

synctest1_38.apl ends up at: 2130-p[0]x:755 y:240 - p[1]x:770 y:240 on IBM thinkpad


BUG - make exiting play_apl clean up



now i have determined that the exact same .apl will play the same on different systems

now i need to record a netgame and see why it won't playback properly


what PC's at work to do this???

MCMP and 51 on xover



server start to show both players




what if I made a stand alone server....

it would run the level forever and be headless

a client could connect and watch or connect and interact

the clients would send cmov and receive smov

the main difference is that server would never be a client


the client would have to 'join' and then wait for sync before playing
if died then must rejoin???

right now I am having problems sorting out the master and server thing


the server sets up 2 players
p0-server
p1-client


the client sets up 2 players
p0-server
p1-client


---------

make server have no local player
p0-client
p1-client



runs the game loop and rx's cmov and pukes smov



--------
fantasy

server can run 2 local also

each client can run dual

can also have programmed players for levels

as each new player connects to server; other clients have to add them

make space in api for 8 players

when a new player joins after sync he can generate cmov
when clients gets first cmov from new player automatically sets to active

or should I have the overhead of sending a system message


server waits until new client is sync'd then broadcasts new_player

packet player_conf


---------------

breaking.......

- disabled local control in server control


need a method to call server control, not attached to player control method


global int ima_server


i am going to make server headless

where to call server routines - from proc_controllers - once per frame

what to display - follow p1 but no input



right now server control only tries to get the first connection...


player_


players[0].control_method = 3; // server (view only)












--------------



each player should have an input source that is call once per frame and fills api


on the server they will all be clients



on the clients they will be the smov packets


no drawing on server ???? al_fixed make player active and local_draw = 1;


finally this frame work works...

run server; run client; move with client; why does server differ???

test on easy level 38 with small net recorderd api


run netgame; move player somewhere; save api

server repeated exactly
client did waht server did; did not repeat itself

the client looks like it starts moving before it rx's smov???


show comp_move with ppp yes....

on client players[0].comp_move changes right away; not from api

on server players[0].comp_move never changes; reads from api only.....


find out where it changes!!!!

add more logging


in client control add make comp from api




normally proc_control does the thing where it looks for next passcount in api
and then does sets contols from comp_move in api


-get keys
-are they same as last frame get keys?
-y - nothing
-n - put new in old; make cmov

set players keys from api like before



----how is this different from now??

get keys


in the client, is there any direct way that compmove set them?


yes in player_key_check()


need to seperate the checking of key from the setting of player controls



key_check could return a comp_move


// these are for the currently read compmove

add variable newest_readkey_compmove
add variable old_readkey_compmove

// these are for the controls associated with the current passcount
(read from api)

whenever clients keys change, send a cmov
keep last

client proc control

read keys and generate compmove
if new_comp != old_comp
{
   old = new
   send cmov
}


need a new read key function that does not set control in player.

I can still set comp move; just not controls...

use comp_move abnd ol



void set_comp_move from keys



void set_comp_move_from_controls(int p)




then need a new companion function to set them with comp_move

set_controls_from_comp_move(players[p].autoplay[players[p].api_read][1],p ); //

int comp_player_key_check(int p);






use existing code to
check if passcount >= next entry in api
no; set keys from current
yes; inc and set keys from next

         // this is now common for all modes (set the current control config from autoplay)
         int next_api_passcount = players[p].autoplay[players[p].api_read][0];
         if ((next_api_passcount > 0) && (passcount >= next_api_passcount))
         {
            set_controls_from_comp_move(players[p].autoplay[players[p].api_read][1],p ); // new controls
            players[p].api_read++;
         }
         else
         {
            set_controls_from_comp_move(players[p].autoplay[players[p].api_read-1][1],p ); // use previous
         }



where is stored comp_move from previous frame?
api_read




i al_fixed the player_key routine to not set controls but it still doesn't work...

when I run a netgame the client moves before receiving smov

i need to figure out what sets comp_move;

actually comp_move is what i'm using for the keys

how am I going to trace all these variable and see what changes them?

multiple times per frame..

make a function to do it o/p to

global temp_string[1000];

add to it and dump once per frame



vars...
passcount
pxint, pyint,
apiread, apiwrite,
compmove, old_compmove
left right

short list

passcount, px, left, right, compmove, old_compmove


it look like it sets that by design



at the bottom of proc controls controls are set from api

and its grabbing the wrong one??

need to look at the passcounts and decision it make there...










first time through

api_write = 0
api_read = 0

compares to 0 in 0,0 - does nothing because passcount is zero
also tries to set previous -1 !!! bad


as soon as first passcount is written


what about initial setup like

api_write = 1; //this would always leave 0, 0 at the start of the table
api_read = 1; // this would prevent -1 index


OMFG that fucking al_fixed it!!!!!!!



now I have demonstrated that this can sync well
i will make a backup


next make more than one client able to connect

lots of subtasks there....

smaller chunks

---server should always run---die
in the server game i will go more doom style and run it all the time.
when a player dies; he freezes; but the level doesn't.
if server pauses the game loop the client must not choke or
I need to make them non-blocking.

--server should always accept new connection up to MAX 4?? for now
-- when server accepts new connections; it needs to tell the client what player number to use.

task---make death non-blocking;

timer death??? lose the timer death and timer for that matter

need to make a system config broadcast msg

p1-active 1-blue-IP
p2-active 0-
p3-active 1-red-IP
p4-active 0-

just use SMOV; add to beginning



-------------make server not view only!!!!!!!!!-------------


in server code

do the getkeys

if changed put in api; send smov


done that, but now need to sort out player numbers


current
server view p0 only
client p0 only

temp for now
server p0 local; p1 view

client p1 local; p0 view


            // and then rebroadcast to all clients
            Packet("smov");
            PacketAddByte(this_comp_move);
            PacketAddByte(p);
            unsigned char hi_byte = (unsigned char) (fpc/256); // passcount
            PacketAddByte(hi_byte);
            unsigned char lo_byte = (unsigned char) (fpc - (hi_byte*256));
            PacketAddByte(lo_byte);
            ServerBroadcast(packetbuffer, packetsize);

//            sprintf(msg,"%d--[tx smov]-[sent:%d]-[p:%d]-[client_cm:%d]\n", passcount, this_passcount, p, this_comp_move);
//            add_log_entry(msg);

         }

setting up a connection

current
-------
server starts in the middle of running game
client joins and catches up



server starts
constantly looks for connections

when connection is started

server needs to communicate directly
with client at the start

-client will send join request

hi! im client with ip address xxx; can I has join ur game?

-server will assign player number to that who and reply only to that who

yes, you may join, you are player 3





after that, the server









-send game_state packet to client
-level
-framerate
-passcount
-players[0] 1
-players[1] 1
-players[2] 0
-players[3] 1

-


I think players.control_method = 3 does not matter anymore


server control is called only only per frame no matter how many players
it is started by setting the global int ima_server = 1;




i need a way to tell where the data for a player comes from

0 = no network keys to api and controls
1 = no network files to api and playback
2 = view only (no local input)
3 = server_local keys to api and smov
4 = client keys thru server to api api to controls




it works great with server local and


      players[0].control_method = 3; // server_local_control
      players[0].active = 1;
      players[0].local_draw = 1;
      players[0].paused = 0;

      players[1].control_method = 2; //server client view only
      players[1].active = 1;
      players[1].local_draw = 1;
      players[1].paused = 0;


      players[0].control_method = 2; // server player to show on client ???
      players[0].active = 1;
      players[0].local_draw = 1;
      players[0].paused = 0;

      players[1].control_method = 4; // client (local control piped thru server)
      players[1].active = 1;
      players[1].local_draw = 1;
      players[1].paused = 0;






next how to make death; non blocking

do on single player first


on death, active is set to zero and paused is set to 1

why does thi block??

removed call to if (press_any_p_rt(p)) in player

now it doesn't block

map updates but level seems to freeze....look at draw code


made them all draw when player is paused as well ad

 (players[p].active && players[p].local_draw)






where does it count down??


finished fixing non-blocking death

need different msg for game over

need new shape or animation to use when player is ded


the enemies are not following the same!!!!!


on level 13 with only archwagon; follows good

on 18 with cannons does not follow good

test more...

make a emprt test level with just cannons and it went good



now trying with a cloner


seems good with cloner...








start initial network setup stuff

when client wants to join a game....

sends can I join??

server replies with join packet contains
level number
frame rate
assigned player number
other active players???




try with different lead frames !!!!



20091212 (sat)

holy shit another milestone!!

for the first time ever, my game pm ran over three computers!

i changed the ServerListen code to run every frame
i set it to display the number of connections and when client 2
connected the server showed 2 connections and the 2nd client sync'd!!!






next.......add a message from the server to alter the game state

call it............'alter_players_state'

use when players are added or dropped

clients request to be added or dropped
server tells all players which are active
0-1
1-0
2-1
3-1
4-0
5-0
6-0
7-0
8-0

each client only knows which player number they are; doesnt care about others

that should be all for now

this should be a simple packet to implement - one way




--------every client uses p2 internally for client????-------

1st one  will work

2nd client will require keys for P3 to be set up???

too complicated!!!!

right now client always works on P2; this is not ideal
client should always use p1 to make it simpler for the user

I should translate behind the scenes...how???


when in netplay; ignore local p2


-----this might help... make each player have a color variable

- i could make a couple line function to overwrite the players shape with new colors

do it!!!















----------------------------
new menu from main - netplay
server start
client start

--------------------


-------every net game will have p0 as server-----TRUE



make an array of bitmaps that contain the player shapes in different colors


memory_bitmap[1024]


player


to use a bitmap:

declare it

in main: ALLEGRO_BITMAP *player_bitmap[8][32];


initialize it


fill it with crap...done...but not tested


store player color = player structure...done

initialize it...done in main and set to 5

make draw player use it!!!!!....



200912131305


need to fix one small function get_player_shape() in zplayer...



then fix draw_player that calls it...only 4 calls...done
supplied players.color as index so get_player shape only has to get 2nd index


added shape to player



works.............

now i discover my auto coloring routine messes with the eyes!!!...fixed


bitmap 755 bullet redraw to have only three colors

add it to player_bitmap....done....




player color change done!!!!!!!!!!!!!


dream--------------

four player multiplayer with multiple objectives per screen

each color player wiil get 'green martian' and have to save therie own color

when you get close to you players color they will follow you

-----------------------



make cjoin and sjoin work


working on when client receives sjoin.......

sets all actives and color

then sets all active to control method 2



---------------------------------



does client even send cjoin?? probably not!!!

can't send from F8 client start...no connection yet

works when sent from when connection us estabilished in client





do I need to implement states yet?? not yet...

- press client start

- set up net connection

- send cjoin

- wait for sjoin

- game loop start

- sync

- allow controls






server color is always what is set for p0 server in F7

what about client; alway set from server!!


cool!!!!!!!

200912131813


server does not set up any secondary players until they connect...started

make player[2] work

when client connects as #2 nothing works!! well not much...


on client copy p0 keys to new client...done...still no good

try to get just single player to work on p2 or above...





client_control is never run unless one player has control_method == 4
so it can never set client control...!!!

client control needs to be run once per frame just like server control...done

client view is all screwy ??? extra players active??...



server view good...


// in draw player removed 2nd screen


client stil has ghosts



trying to fix player assignment....

p1 single works on server

when p2 joins all hell breaks loose...

get new background tries to draw twice!!!

changing get_new_background to only run once; not once per player

needs to know which player to center window on...

0 by default; single player p0 unless changed

if client never p0; find active with control method 4
force p1 for testing.............




parts of get_new_background need to run for every player for every frame
to set WX and WY for the rest of drawing....


still not right.............


need to set the view window for all non-local client to.....


what the fuck do I use local control for??  I should use it to determine waht to draw


al_fixed...............

try to use p2 or above...
server told client to join as 2 and it worked...sort of

p bullets go nowhere....al_fixed....

enemies never see me...cannons

funtions
find_closest_player does not seem to work
find_closest_player_quad(int EXint, int EYint, int quad, int prox) need to re done



some enemy function still use FP double!!!! WTF must die
al_fixed find_closest_player to not use sqrt and not need double!!




---> #define BORDER_WIDTH...DONE... now just use it everywhere needed...



broken......nothing happen for regular 1p non net game...al_fixed


when I setup a new player do I need to set SX etc...no...pm_main calls set screens

change set_screen to set SX SY SW SH for all active players

call from main like normal

call when adding new players





pbullet colors not right...need to add color or player to pbullet...al_fixed draw_pbullets






make client start from menu---don't start from running level


pass command line args 1 = server 2 = client






change game start mode
current





client can start from command line!!!  pmwin.exe -c
does not need to know anything but server IP





server will too later
pmwin.exe -s 18 192.168.0.101



you did it wrong!!!!! client needs to know server. that is all.


pmwin.exe -c 192.168.0.101.. this is truly done
pmwin.exe -s 18 skeleton code.. this is truly done......


have client show their player # client number!! no


need a way to break out nicely from client game <ESC> doesn't work

esc is in fnc key check put back in

need to make death messages stay by player...


frame and title should match the players color...done
FPS and top display one player only....done
move time and to top



players extra men should match color...done



network messages at bottom...

where is bottom pm5.0 message?....



I should try the three computer connect....


what happens when client hits ESC??

does process control happen for menu too?....yes al_fixed..



200912141715

multiplayer is working much better; client and server start cleaned up...


three player good!!!!!

still has enemy sync issues....

must kill doubles!!!!!!



....freeze client until snyc'd; not needed for server


death should only affect the player that died!!!!



extra clients dont work on client amchine beacuse no state message yet



log the player_change packet

maybe have to do more setup when new player

maybe packet should be add player: new player number
easier for clients to add...


move server init and client init to function in controls
so they can  be called by other stuff...DONE








I want the the client to search the subnet for a server;; worst case 255 tries



map does not work in netplayer..it is local control only...need a key....








packet is now called; add_player and only has one byte player number

rx part is done...now to send it...done

client rx's both.......



when server sends sjoin to one , should send add player broadcast too
make sure client doesn't do both!!!





3 player

server all three good

c1 shows on all three

c2 does not show on c1


fix................

when a client get add player...

is packet received??...yes

does it work?...yes, so far...







------------------------
what if I made the code that only draws items, lifts, enemies, bullets on visible screen
draw it on every screen?  I want to make it changeable, to see what the performance hit would be

what are the advantagesof the new way?
-simpler draw code
-trivial to add extra local views

what are the advantages of the way it is?
- only draws what is needed
- faster (need to test to see exactly how faster, could be negligible)
--------------------------------------------





------------------------------???not-------------
add to compmove an entry like passcount, player join exit sync

add another array like compmove, only called system_event

passcount int type inta data

have another loop process this

when passcounts match, perform the system event

example

00 00 00 // game start

234 01 2 // at passcount 234, add player 2

341 02 2 // at passcount 341, remove player 2

--------------------------------------------------



-------------cleanup----------------
move all players[p].xxx initialization code to one place...now its everywhere

make some helper funtions like copy_P0_keys to current player

------------------------------------------------------












here is what i'm thinking....my sync issues could be

when a client joins

his local is active but not moving from frame 0

on server and other clients he is not active until added....


common on others, what need to change is local client
need to make inactive until sync'd, how?...


can client chase and lock without have any active players?...
Doesn't need to.  The server is the active player.


where will I implement this?

what?? define this better.


when client is syncing, leave him inactive

when playing back a game, need to save when player are added


don't force adding a player...add an entry to the api to tell when player started at a certain passcount


how can I mod api to do this??


each player has a api  int autoplay[5000][2];

comp_move only uses 6 bits; could use next 2...might break current readkey stuff...


use bit 7 128 in compmove


add player.start_frame always 0 unless joining
-don't make player active until passcount >= start_frame


// make active if start_frame >= passcount
if ( (!player[p].active) && (player[p].start_frame >= passcount) ) player[p].active = 1;

where to call this???? in proc control





NETWORK descriptions
--------------------


init functions
--------------

void server_init(void)
{
   ima_server = 1;
   players[0].active = 1;
   players[0].control_method = 3; // server_local_control
   set_screens(0);
   initialize driver
}

void client_init(void) // needs char m_serveraddress to be set before calling
{
   ima_client = 1;
   players[0].active = 1;
   players[0].control_method = 2; // server view of cli
   set_screens(0);

   - init_driver
   - connect to server
   - send cjoin
   - wait for sjoin
   - set play_level, frame_rate, and client player number (cn)

   - set all 8 active and color from sjoin // ???

   - set all active to control method 2

   - set this player players[c].control_method = 4;


   - copy 8 keys from p[0] to p[cn]
   - set local_draw = 1;, SX, SY, SW, SH, num_bullets = 200 LIFE = al_itofix(100) LIVES = 5;
}

void client_local_control(int p)
{
   if keys changed, send "cmov" with passcount + control_lead_frames;
}


void server_local_control(int p)
{
   if keys changed, add to autoplay with passcount + control_lead_frames and send 'smov'
}



void server_control()
{
   ServerListen();
   {
      receive packet "cjoin"
      {
         - set new player number to cn
         players[cn].control_method = 2; //server client view only
         players[cn].active = 1;
         players[cn].color = cn;
         players[cn].local_draw = 1;
         players[cn].paused = 0;

         - send packet "sjoin"
            - server_passcount, play_level, frame rate, client player number
            -       // player state
                    for (int p=0; p<NUM_PLAYERS; p++)
                    {
                       PacketAddByte(players[p].active);
                       PacketAddByte(players[p].color);
                    }
         - send packet "add_player" (cn) to all clients
      }
      receive packet "spol"
      {
         reply with 'srep'
      }


      receive packet "cmov"
      {
         put compmove in api
         reply with 'smov'
      }
   }
}

void client_control(void)
{
   - send snyc poll every x passcounts
   ClientReceive();
   {
      receive packet "add_player"
      {
         if new player control_method == 4 (local) do nothing
         else set up as viewer  control_method == 2
      }
      receive packet "srep"
      {
         adjust client sync timer
      }
      receive packet "smov"
      {
         put received compmove in api
      }
   }
}



init's are called only once when initing

client_control is called once per frame from proc_controllers

server_control is called once per frame from proc_controllers

server_local_control is called once per frame from proc_controllers when p == 3

client_local_control is called once per player per frame from proc_controllers when p == 4










adding clients to client
-------------------------
where does it happen? in client_control()


-client rx 'sjoin' for local
-client rx 'add_player' for other clients and local too (but its ignored)


when adding clients, make not active till sync'd


// make active if start_frame >= passcount
if ( (!player[p].active) && (player[p].start_frame >= passcount) ) player[p].active = 1;

added to proc control...done


big assumption  --> when client is syncing, control_method == 2, active == 0
we'll see how that works out


this whole thing won't work...good thing i figured that out before i wasted any more time

why wont it work??????

in order for everything to sync all clients must be able to
play back exactly when other clients joined

but...i could still use this to sync before allowing player active

yes..but that would only work for the first connecting client,
when the second client connects, they don't know when the first client joined
unless they read frame_start from that player <big grin>

frame start is sent by server with sjoin...is it?...server should know it for every client

the problem is, clients only know their own frame start...needs to be sent

at the same time; do frame_end for player leaving the game



describe it very simply
----------------------

c1 sends cjoin and gets sjoin with client_num and frame_start

c1 sets  control_method = 4 and frame_start player is still inactive

c1 chases and syncs asnycronously

C1 sets new player active when passcount = frame start



C2 joins later

how does C2 know when c1 started?...

server could send a package on join about system info
and broadcast it later also if anything changed

packet would contain
array of data for all 8 players including
-active
-start_frame // when to make the player active
-end_frame // when to make the player inactive



instead of the packet add_player

broadcast 'game_state' that includes array of data for all 8 players
-start_frame // when to make the player active
-end_frame // when to make the player inactive

all client has to do is update starts and ends on its side

when sjoin is received all it has to do is set the local player number

when game_state is received it sets the start and end frame

and that's what takes care of setting active at the right time


----> blanket statement <----
code should enforce (players[p].active == 0) unless end_frame <= passcount >= start_frame
what about when start or end == 0?

if (control_method == 0) // local game; ignore start and end



if (control_method == 2)
{
   if (start_frame == 0) // client view; syncing...
   {
       INACTIVE (no start)
   }
   else // start_frame != 0)
   {
      if (passcount >= start_frame)
      {
         if (end_frame == 0)
         {
            ACTIVE (no end)
         }
         else
         {
            if (passcount <= end_frame)
            {
                ACTIVE (before end)
            }
            else
            {
               INACTIVE (past end_frame)
            }
         }
      }
      else // (start_frame >= passcount)

      {
         INACTIVE (before start_frame)
      }
   }
}


i think this will work, how do I implement it??

set up sending the packet 'player_change' on server right after sjoin....DONE

change sjoin to not send actives......DONE sends server_passcount, play_level, frame_rate, client_num

change sjoin to get rx's properly........DONE

set up rx player_change..........DONE

set up code in proc controls to enforce strart and end...DONE

inactive and 4 will only set active for start

I should have the code run on all players, not just active

code will set any player with start_frame = 0 to inactive

by default I need to set start_frame = 1 for all players




that is a lot of changes........compile and work 1st try???


compiles and runs; loacal player broken....

server player works...need some setup for local....

first time through the menu game_exit is nor set so proc_controlls reset p0 active!!!...al_fixed

client is disabled on start....

server_sync always 0;


if I am passing passounts (frame_start and end) I need ti use 2 bytes

can I make a simple function to do this for me??



void PacketAdd2Bytes(int)
give it an int and it calls PacketAddByte twice for you


int Packet2ByteRead(void)
reads GetPacketByte twice and returnd an int

usage:

PacketAdd2Bytes(275);

int res = Packet2ByteRead();

nice!!! see if you can do this with SPOL, then the rest

looks good!!!!...compiles clean

back to debugging...


client is disabled on start....

server_sync always 0;

looks like it syncs then freezes..look in after sync code


the code in proc_controller 'enforce starts and ends even if inactive' may be wrong,
why do I want to enforce on inactive?  only for local client sync.
enforce only on active and the special case active == 0 and control_method == 4

DONE

client game runs now, but only views server in wrong color...

look in...where server is set up on client...

make a log function to show player array state

never changes on client

i did my logging wrong



i need to see what's going on in !active control_merthod=4

weird shit....

ef starts out at 8; is set to 0 at frame 12or3...wtf

then at frame 22or26 ... sf is set to 11 and ef is set to 1

where else to log...server


make a function to initialize a single player


call it from main b4 local start and client_init and server_init and add.....


void player_init(int p);


lose set_screens add to player_init...done

same thing with copying keys....done

also go some more stuff from initial setup and replace it with call

also added erase_autoplay...done

now all player initialization is handled by player_init



back to testing.........


need to know what the server is doing at passcounts

where exactly in server?.....


why is ef set to 8?????? WTF as far as I know, nothing sets it...rebuild all


packet int passing problem?..........


SPOL works good, wrong reading order for PC????


------------------------------


client on client never gets a start_frame...why?? don't we send one??...



follow clients start level all the way throough.. no start in middle at packet exchange


why do i get only one player change on server, but one every 20 frames on client?....

does client keep retriggering itself???...wtf



log player state after sjoin rx'd....still no frame start set...wtf...


log on server at send sjoin....frame_start set there...


back to sjoin rx'd...in client init...



what does sjoin read?....sp_passcount (2) play_level(1) fps(1) cn(1) sf(2) ef(2)
what does sjoin send?....IT NEVER SENDS SF and EF!!!!!.....fixed

now client start and sync's then exits??.............wtf
client log show no start or end yet

on server it was still one...set it to passcount...

client has some big numbers in sf and ef and sent passcount like > 10,000

numbers are not fucky on server side, why do they not go through sometimes????


in proc controls

its 4:00AM must figure out later

backup...


must find out why packet sending ints is mangled...al_fixed...


now client sync's good then screen smears....

first player change also has and end... shouldn't...al_fixed

still smears after snyc...

log before and after join in proc....


watched active get set on client at correct passcount...

client game freezes after control method is set to 4

proc_control keeps getting called...and passcount incs


log more player variable...local_draw


what if I don't make p1 active after frame_start and see if it still freezes?.....it doesn't

problem is when p1 is made active!!! look in draw code

player needs SXWWH etc set...where???...client init...

in player_init duhhh!!!!


-------------------------

now client inits, but has no keys...

are keys loaded from config file before player_init is called?


in 'initial_setup'

gets p0 and p1 active from config file

if active runs init for each

later does load keys

----

how should it be

move load_keys to before player_init..done


keys are good...what else...?

log client local control...its sending cmov properly

log srep...smov dumas...look like client get smov good


next......see if got to apl..no..p1 in apl has only one entry on both client and server.....fix...

its not a matter of reading it out of api..its not being put there!!!!...or getting cleared...

check server first....server rx cmov....


client smov works when server player sends it, but not when in reply to cmov.......

log api_write...


smov received in response to cmov comes out garbled




check out 1st smov sender...in server_local_control

      Packet("smov");
      PacketAddByte(players[p].comp_move);
      PacketAddByte(p);
      PacketAdd2Bytes(fpc);
      ServerBroadcast(packetbuffer, packetsize);


check out 2nd smov sender...in server_control

            Packet("smov");
            PacketAddByte(this_comp_move);
            PacketAddByte(p);
            PacketAdd2Bytes(this_passcount);
            ServerBroadcast(packetbuffer, packetsize);







check only reciever in 'client_control'


     if(PacketRead("smov")) // this packet sent from the server is inserted into the local player's autoplay array

         int this_comp_move = PacketGetByte();
         int p = PacketGetByte();
         int sp_passcount = Packet2ByteRead();

         players[p].autoplay[players[p].api_write][0] = sp_passcount;
         players[p].autoplay[players[p].api_write][1] = this_comp_move;
         players[p].api_write++;


1 - compmove (1)
2 - player_num (1)
3 - passcount (2)




----------------------
changed some shit; testing again....

smov rx'd by client from itself has large ints
smov rx'd by client from server is good...wtf


log the 2 place where they are sent...bad on send from rx cmov



bad rx smov on client;
sent by server_control smov wrongly too



client finally moves...!!!! or does it


//this is good
int cm = players[p].comp_move;
PacketAddByte(cm);


//this is not good
PacketAddByte(players[p].comp_move);

maybe the above is wrong...


I finally found the bug cmov sent passcount as byte!!!!!!!!!


add packet logging

at top of controls

#DEFINE PACKET_LOGGING

added logging to every packett...now to test......seems goodly!!!!!




server is green locally but purple on others...al_fixed force color 11


------------------------
I want to change the order of my color table to make popular colors at the start...DONE

p0 = red (only server local)
p1 = lt blue (p0 in local game) (c0 in netgame)
p2 = lt green (c1)
p3 = green (c2)


local game uses different player shapes...fix later....
------------------------------


Backup 20091217_0827  2 players work great



----------------------------
when player 3 joins....


c1 joins good

when c2 joins
-c2 not on c1
-C2 not on server
-c1 not on c2


what packet's are left to implement?...

when player joins



--------------------------------
show whats happening when client starts...

if no server, where does it die?...

if server runs too long before clients connects, where does client die?...

did a lot
- if serveraddress not found; searches entire sbunet....

totally re-did client_init...much better....

make client_init try longer for passed IP...disabled search for now...DONE

need to find local IP address...why??

-----------------------------------


why does client not start good if server running too long??....

client start

237 is bad;


251 good
234 is good
230 good
226 is good
76 is good

268 bad - i think it sets the frame timer out of bounds...log it...

from the existing log it looks like client sends spol lots while syncing...
how about don't send another spol until srep is rx'd



int spol_active = 1; when sending; scope just control.cpp
clear when srep rx'd
dont send another while spol_active
DONE...now it never sends spol...










------------------------------------------
it should be trivial to prevent local client control until > frame start.....
------------------------------------------



if game sync's before start_frame all is good...



I think my sync concept migh be flawed and have to be re-written....no but it is broken


if the client had a high fps chasing... it will overshoot and the client will have to decrease the timer
if decreased lower than frame_rate is will come out negative and that is where it dies?....YYYEEESSS!!!!

make fps_chase never go below 1 or 2....way to slow...try 10...OK... still overshoots


//         int fps_chase = passcount_timer_fps + server_sync;
         int fps_chase = passcount_timer_fps + server_sync/2;


did this........takes longer to sync, but never crashes...yet...




---------------------
another way to sync

server sends all player data up to passcount in one big packet
if more data then max size; only send up to max_size, then send more

why??? cause right now i send a packet for every 2 bytes in autoplay
if I know I have 500 to send; I should put them in a big packet

I will do this eventually........

-----------------------

----------------------------------------------------------------------
WTF is up with my code.. am i missing something????...

server starts and sever_local player runs around...

client joins later...how does client get server's previuos keys?....WTF....

I haven't implemented that yet...
the client starts with server active and client not then chases to start frame,
but what about the server's moves up till then????


need to implement:

PACKET 'player_data'
int player_num (1)
int start_frame (2)
int num_frames_sent (2)
int last_frame_on_server(2)

each data point

passcount(2) comp_move(1)
...num_enries


sent from server only to client that requests it with:

PACKET 'req_player_data'
int player_num (1)
int start_frame (2)



when client is syncing; after it gets player_change,

it needs to fill autoplay for all active players

if active
   find out local api_write
   req_pd from there to start_frame

get data
put in api





in server control look for packet 'req_pd'.....DONE

PACKET 'req_player_data'
int player_num (1)
int start_entry (2) // index to autoplay




and reply with:

PACKET 'player_data'
int player_num (1)
int num_frames_sent (1)

int start_entry (2) // index to autoplay
int last_frame_on_server(2)

<passcount><comp_move> x num_frames sent


do I want to use frames or the index to autoplay????.....index

DONE

now in client add calling pd_req and check return

where to call...after sjoin received in init???...while syncing in proc control???




can't be while chasing...need player data before chase...

look like it needs to be done in init....yup....



patched in all the player_data code; now to test......

client log...1 tx req_pd...2 rxpd one for each player????

server log...1 rx req_pd...1 txpd...???


when rxing set api_write when done...done


-------------------


crx player data in ci runs twice first time gets junk.

stx player data in sc (sends a 2 bytess) logs good gets 1

ctx req_pd logs good



somehow start_frame from crx sjoin is being put in last_serv

where?????

shows up in client log

crx sjoin rx's start_frame (111)

clinet sends req_pd with 0, 0

crx pd last_serv = 111 then crx pd last_serv = 1

trace from the error, back....

crx pd last_serv = 111...from client log...what sends?....


stx pd logs good...have a closer look...yup looks good



crx pd could receive twice if !match at end

1st time serv = 111 here = 1
2st time serv = 1 here = 1


pack it up and go home.....

20091171813



-----------------------------

where was I?...why does client rx player_data with last_server_entry = 111???

same as frame_start from sjoin....

where have I looked???




trace forwards from server....


last_server_entry is read from players[p].api_write...check there...

on server in function sc send pd....
everything good, logged a couple of places...





rx'd by client in client_init



sjoin is sent 4 time client joins 4 times??? WTF.....

client init is fucked...wat too many loop and shit...flattenb it out....

broke out client_init_driver...
broke out client_init_join...

it works!...but still last_serv = crap


I log it immediately after being received on client...its bad


first try swapping last 2 args !!!....

now bad value goes to other arg..... there we go...its not my code...

unless something else is stepping on my variables...


try changing 1 byte to 2 byte...


I discovered something..............in packet.cpp it looks like packet naem can only be 4 char!!!!!!!!


list all my packet names here

SPOL
SREP

cmov (CMOV)...done
smov (SMOV)...done

cjoin (CJON)...done
sjoin (SJON)...done


req_player_data (CRPD) Client Request Player Data...done
player_data (SSPD) Server Send Player Data...



go through code and replace all and rename all to upper....DONE

that was a nasty bug, now back to real testing.....!!!

server game has 2nd player enabled before cjoin...DONE


server move before join is not put in client api
between client getting SSPD and game start erase(p) is called!
how to block it in pm_main only erase control_method(0)...DONE


chokes when > 100 keypresses and 2 packets required...


how are the next batch supposed to be sent??

does the server know to sned another packet???

i think the client should request more if needed

server code is good, only blindly replies to request

make client request more...done...test boundary cases by make max sixe 10...later....DONE works perfect


client is very slow....why???...only once on a long sync...

it runs slow because it over shoot then run at 10 fps to slow down



200912180645 this snapshot works!!!!



overshooting sync....


next to fix - 2nd clients join get PD from other active clients too

take another laptop to work for testing r4000






------------

make a player array print thingy for the screen


what do I want to log? make is customizeable

call it void show_player_data(void)


p a cm snyc sf ef
0 1 4
1 0 3
2 0 0
3
4
5

------------





------
fix chasing....

int no_draw_till_passcount ????......

no delay and no draw...till passcount




setting the timer may not be the best way to chase....overshootz

waht happens?

while chasing, waiting for start frame, sync get lower nicley
after start_frame the very fast internal time gets way ahead

what would happen if I sent SPOL every 10 not 20?....not much

sent multiple SPOL before SREP....added spol_pending...DONE

rx multiple packets per frame....client_rx_loop done...testing...GOOD


next,,,???



after pd rx'd start and free run to end of PD then try to snyc

how? use no draw till passcount and disable internal timer to free run


in loop ~300 changed draw to use no_draw_till_passcount..ok waht sets it?...

proc_control start_frame...no..disabled spped control there

in client_init just before exit...done

does client change fps; should set it back in.DONE




still has trouble overshooting...but not always...


as soon as start_frame happens...
SPOL tx 1040
SREP rx 1464
-------------
         424
on the client, 424 frames passed between sending SPOL and RX'ing SREP

SPOL tx 1480
SREP rx 1565



before that its like...
SPOL tx 1000
SREP rx 1001

SPOL tx 1020
SREP rx 1027


only adjusts timer when receiving a SREP???



need to ensure the client does not go past the server...a brick wall if you like

only past chase, when syncing....

compare the passcount

don't I do this already?...


BRAINWAVE when it takes a long time to chase; passcounts will be off more!!!

after chasing to first, chase to next?

what am I changing when I change passcount...log both passcount and timer_passcount...







set free_run_till_passcount in client_init SSPD rx...use start_frame...

client gets it from server packet "player_change" which I must rename 'PLCH'...rename....DONE


i dont see player_change getting logged on client...


server sets it between rx cjon and tx sjon passcount + 100;
puts it in players[p].start_frame

sends it with SJON and logs good...
sent again with PLCH

PLCH is only looked for in client_control; not client init


PLCH is only sent by server to client...
I still might need it later for other clients.


SSPD only gets data for a certain p, but could sent player_change in the same packet
or it could be part of SJON...that's better...
when joining, get player data like active, cm, sf, ef for all eight players

then use this data to get player data...


task add player_chanhe to SJON


in server where SJON is sent...done

in client where rx'd....done


back to troubleshooting...client receives SJON with players[1].start_frame = 506

after client rx SJON

works!!!; was reading from [o] server instead of [1] need to fix later
hard coded for now.  Should I have a game variable, local_player???...sure


need a way to make it sync more and better

like combining chase and snyc

-get player_data
-chase
-how for behind are we?
-get more player data
-once these are close; try snyc


for now at the end of chase...see how far behind we are..use server_sync






make a function that will take care of getting the latest player_data

void request_player_data(int p, int start_frame)
{

   // send packet CRPD

   // wait for SSPD

   if not last data goto send CRPD


}


pass it player and start frame

it will reply with SSPD p, num_ent, start_ent, last_serv
and an array of data...


when it is done it returns the last_serv...why?


this function will be called by both






hi level sync flow

setup player

get all player data from server
chase to sf

see how far behind

get more data from server
chase to sf

when server_sync < 50 start regular game...




hack up client_init and remove req_pd


added global active_loacl_player; set in client when sjon rx'd




------------------------------------------------------
-display something on client when syncing ...DONE

- text while in client_init ??? do I have a screen yet, yes
now shows on screen driver, join, chase, all in client init...DONE

-------------------------------------------------------------





....debug

client chokes hard somewhere after rxing SSPD....al_fixed...

cant active_local player was garbled when init and defined at the top of controls.cpp

al_fixed by init and define in main, and extern in controls...???

..............................


frtp is not getting set again....using wrong player...
frtp comes from active_local_player start frame...







now how do I make it ask for more packets...

call req_player_data from sync code in proc_control

seems to works, but doesn't help sync...



what will help snyc...










what if I made a huge list of event like api only better

system events - netgame start - player add
key events - keys pressed


if I only have one array to sync between clients it will be easier!!!



---------------
fix something easy

server frames color is wrong...

need to make player_color actually that

need to add player_bitmap_index...or just use p...


add bitmap_index to player structure....




color can be changed in these places...

frame_and_title uses alp    0 for local    0 for server

draw_player (map_section) uses [p].color good

get_new_background




.............all colors are f'd up

server_local
player red
free men red
game_frame purple orig
title_screen purple 1st rever 2nd

local
player lt blue
free men red
game_frame purple orig
title_screen red 1st rever 2nd


need to use F11 and F12 and set bitmap to fix!!!!


0 bitmap is the default but it corresponds to color 0

fix the color variables...in player_init...

why are 0 and 1 the same??? in player bitmap...dont need to be...done

player bullets wrong color...al_fixed

set all player color and player bitmap_index in player init

player color thing is completely DONE and works.......

---------------------------



==========

eventually I will need to remove local player 2; wont work with major refit


what computer am I going to take...set it up...

backup snaphsot 20091219_0902



weekend made a couple of samll changes...

level editor when pasting, al_fixed multiple paste by waiting for mouse b1 relesse

removed p2 display from main menu

al_fixed draw bottom message to scale properly





now, i'm going to gut it and make it totallty different.....

not really


i will make a very similar function called ... lmsg??

x and y pos in 2000, 2000 scale

text of message (maybe multiline wait passed parameters)

how long to display as a counter that decs with each passcount

what other effects to run while counter decs

scale inc dec
rot inc dec
xinc yinc
color shift


make a simple function to add a new one like

void add_screen_msg(int x, int y, char* msg, int delay)


all it does it create a new entry, that runs by itself...


struct screen_msg
{
   int active;
   int delay;
   int x;
   int y;
   char text[80];
   int color;

};
extern struct screen_msg screen_msgs[100];



make a function to process and show...where


draw where...screen_buffer
x, y, and screen width from draw items



 )

Finished the screen_message thing...looks good..

new to implement some special effects...

change the add mesg fucntion so you can pass

special seq num (0= normal inc)

color
color_inc
color_frame_delay

xinc
yinc

size
size_inc

// rot
// rot_inc
leave rot for later...


change mtextout to have rot also

uses


working on rot and stretch retextout and effects fro screen messages...

-------
trying to get rtextout to remain centred despite rot or scale

testing with Door and text '--O--'

testing rot...works perfect with scale 1.0

testing scale...moves a little to the right then left at scale 1.0 to 0


draw where it thinks the middle is with dw and dh and see if its off...

done...draws and rotates goodly...

this function is work of art...

void rtextout_centre(ALLEGRO_BITMAP *dbmp, char *txt1, int x, int y, int col, float scale, int rot)
{
   ALLEGRO_BITMAP *temp;
   int sw = strlen(txt1) * 8;
   int sh = 8;
   temp = al_create_bitmap(sw, sh);
   clear(temp);
   textout_centre_ex(temp, font, txt1, sw/2, 0, col, 0);
   pivot_scaled_sprite(dbmp, temp, x, y, sw/2, sh/2 , al_itofix(rot), al_ftofix(scale));
   al_destroy_bitmap(temp);
}


add something to prevent scale being negative, dont, draw!!!


now to plug in some cool shit!!!


what custom thing should I do first?

how about bonus

the simplest will be a straight in and out
stage 1 zoom out


this is done enough that I can leave it for now
---------------------------------------------------

20091222 (tue)

testing net game stuff again...

client cant find server...times out???...sometyimes...weird...



seems to sync when client started close after server


gets past start_frame then sync keep getting lower...


-join
-get pd
-set no draw till passcount

run loop
-no draw till passcount
-not active til start_frame


----------------------
server display for debugging

player

num active cm color sf ef api_write sync

-----------------------------


each client needs to know the last server updated passcount for each player...???


basically an int that says:

'I have data for player x from server up to frame y'

right now, it assumes if it doesn't rx any, there are none!!!




--------------------doom/quake style netgame---------


i would need to rewrite my game a little

make a master list of events, instead of per player comp_move
also must have some system control stuff too.


then I only have one chunk of data to sync

server has seperate logic for each client

each client gets a diff packet from the server, applies it and responds
server won't send next until good rx on previous


------------------------------------------------------------



it seems like I am spending a lot of time trying to debug the
netgame stuff with getting anywhere or having any record of it here.

I am going to try to leave much more details here about it.


make client not active until synced....


right now comes active when sf done...move to...


what is the whole concept of start frame???
its when player becomes active

what if i keep pushing it off until synced by adding to sf?...





its seems to work good when sync'd, but it take a long time to sync

move fps display to show every time...get about 200 fps when chasing

what slows me down???



-------bug---cloner does not trigger for some players...al_fixed...need to test




when chasing show 1 in 100 frames...or so

what if I remove the free run stuff...








------------------screen_msg stuff------------


why does bonus keep retrigerring???..


beacuse the code the checks for duplicates, compares x and y and we change them..duh

how can i fix this?....


added

   int original_x;
   int original_y;

to screen_msg structure

now to set in add screen_message...done and works...

add some more screenm messages


door make entry and exit seperate....



event can only pass so many data points.

need to extend...

current...

void event(ev, x, y)

need a few more ints..


in code call event with code number and x, y

event func adds text and more based on type.


new.....

event(type, x, y, extra int 1, 2, 3)

added 4 int to event...use them wisely for each event...

bang use player color and direction...


now in event handle I need to send more ints to add_screen_msg...
do it...


why all this duplication???....deal with it...done, took ~200s!!


back to bang...done...


now do door........

looks good with just in and out labels...add color_shift...



make a two stage fade in and out...for door...done...


change key to use color...done...

add sproingy....done...

add mine...done...done

make door last longer...

add switch...done


redo fruit bonus to have health and bullet nums...done...


------------------screen_msg stuff------------DONE...



---------profiling my code-------------
create a new timer as fast; as it will go

incrementing a variable in a locked functions


int prof_array[10]

at each point

pa[0] = mscount;
pa[1] = mscount;
pa[2] = mscount;


at the end print them all


for (a=0; a<10; a++)
printf("%d",pa[a])




declare at the top of main:

volatile int prof_timer = 0;

void inc_prof_timer()
{
   prof_timer++;
}
END_OF_FUNCTION(inc_prof_timer);


in initial setup:

   LOCK_VARIABLE(prof_timer);
   LOCK_FUNCTION(inc_prof_timer);
   install_int_ex(prof_timer, 1);


in loop:
extern int prof_timer;
int prof[10];




the only thing that take any measureable time is:

blit(screen, scrn_buffer);
and the passcount delay just below


-----------------------------------------

------when client starts locally he's on lift..but on server, not...


FIX starting stuff..................






-------------------------------------------


time to join test........

start server level 12 50fps

wait till time = 20

time how long client takes to connect...7

wait 20..7
wait 40..15
wait 100..30


maybe I don't need the free_run_until_stuff


--------------------

sometimes clients freezes at waiting for start frame...but ESC gets it going...where does it die???






---------------
-server needs to know server_sync for each client

store in player array?...

why? so server can make them be active when sync is good


remove the start frame active thing in proc and see what it breaks...done




how does server know clients sync?....
go to where server send SREP...yes but at that point i dont know what player...

now I know what player...

added int server_sync to player....done

set it in SREP.......done but hardcode to player 1...test...show in server display

server now sets server sync properly for each client...DONE
by default players[p].server_sync and who are set to 99
who is typically 0, 1, ...etc


where is client set active on server? when srvr rx's cjon and sets up new player..made inactive..

now server never gets active

---> when server notices that server sync is less than 3 send plch

why does server freez sometimes at start after start frame???


save 'who' when joining so i do know
make it a part of player...done...added int who to player struct
set it when doing join...
when rxing cjon get who from rx'd packet and set  players[cn].who = who;...done
so now the server knows who!...done!!!


never make client active for now, client game will just chase and sync with server
see if any fuckups...seems to work good..


make a message from server to make player active....

look for plch...it is disabled and just sends player_start

need new message...

like sjon??

sjon sends start_frame, but used only for chase??


packet needs to send

player_number
frame to make active
how does server know what frame to make active???

new variables in player struct...DONE
frame_to_make_active
sync_good_frames


sync_good_frames will inc every SREP when server_sync < 3
set where? server and client different??

server in srep...
            players[p].server_sync = passcount - this_passcount;

            if (players[p].server_sync < 3) players[p].sync_good_frames++;
            else  players[p].sync_good_frames = 0;

DONE


frame_to_make_active = (0 ignored) else active when equal



where will packet be sent from??? SREP proc on server...
            if ((players[p].sync_good_frames > 4)  && (players[p].active == 0) && (players[p].frame_to_make_active == 0) )
            {
                 players[p].frame_to_make_active = passcount + 10;
                 Packet("PLAD"); // player add
                 PacketAddByte(p);
                 PacketAdd2Bytes(passcount+10);
                 ServerBroadcast(packetbuffer, packetsize); // broadcast to all
            }



client rx PLAD........
      if(PacketRead("PLAD"))
      {
         int p = PacketGetByte();
         players[p].frame_to_make_active  = Packet2ByteRead();



common code to use frame_to_make_active...inactive part of proc_controls..



all this crap is done and has been tested...

clients join good....now what....

second client gets no info about first...why???

has no idea when first client joined...arrrghhh!!!!!!!...al_fixed


look in join stuff........it should but doesnt...why?...cause not active??..
client get player data from server during join...

now client moves server too...al_fixed...


fix player starting position...the instant player is active...in proc_control

done...!!!
--------------




trying multiple players....2nd client....
2nd client gets to start frame and freezes...

can server handle multiple polls per frame?...

r4000 doesn't play nice with the others???...why


it seems to show up on server display with negative sync then dies

could be beacuse negative sync looks like good sync...al_fixed



----got 2nd client to sync and play!!...now try on simpler level..13

good...2nd client take a long time to sync...where?

bad...1st client moves 2nd client on 1st client localmachine..why??

cm is 0 on c1 machine for player c2; needs to be 2;


when rxing player_add packet; if alp set 4 else 2



active_local_player for client is set when rx'ing sjon use that...done

--------------------------------
3 player works good on level 13

2nd client takes a long time to sync and freezes after start frame...

add more logging to find where it blocks...

remove that goddam waiting to start frame logging...done




when the start frame processing in proc_controls is done
, sf is set to 0, active is NOT set

then the main inactive code looks for ftma to be set in player struct

ftma is set by server and passed to client via SREP when snyc_good

diplay there?...where...client rx srep...what sync_good

there is a display in client rx SREP; but it only shows once then freezes

check the passcounts and timer_passcounts


client has trouble joining if server has made no moves....FIX


freezing is due to a passcount and timer thing

where is it set?....

passcount_timer_fps; need to store original value

when client gets it from sjoin sace it somewhere so you can re-set it...

how is it adjusted???

use passcount_timer_fps as the reference

use temp to adjust

restore from passcount_timer_fps;

set passcount_toimer_fps in sjoin...

look in log near free run done



----------------answer

after sf





seems to work goos with three player

still working on start frame crap...do I need it?...

it is used to get more player data when syncing



ctx cjon
stx sjon

crx sjon set sf and get data up to sf

free run till sf

during free run timer is ignored

when free run ends set timer to actual passcount

after free run sync is started

------


should be after free run

when client rx's player data, needs to set somewhere in player. the last passcount


the client needs to know where it is on the server...??


you know what I mean...???


added:  PacketAdd2Bytes(passcount); // server_passcount ;
the client will know it has all data up to this passcount

to end of SSPD

read server_passcount in client rx SSPD...done
now what to do with it?...

add player.last_SSPD_passcount and set it

now what to do with THAT!!??........use it to get more data before joining...

don't let client passcount > last_SSPD_passcount

set last_SSPD also when rxing SMOV...


server also needs to know what it has sent client...




server_control needs to monitor server_sync for clients not active
and set active if good

set active means send






-----------
20091223_1800

took it home a worked once; now no net will happen???

same old bug, if no server move, join dies!!!!fix it..........

look in logs for SSPD req and such....


good

Server Mode started
Server Initialized
58--[sbx SMOV]slc - sent_passcount:61 p:0 client_cm:2
64--[sbx SMOV]slc - sent_passcount:67 p:0 client_cm:0
176--[srx CJON]sc - no args
176--[stx SJON]sc - passcount_sent:176 play_level:13, frame_rate:50, start_frame:176 end_frame:0
176 player state
[p][a][m][w][r][sf]
[0][1][3][3][3][1]
[1][0][2][1][1][176]
[2][0][0][1][1][1]
[3][0][0][1][1][1]
177--[srx CRPD]sc player:0 start_entry:0
177--[stx SSPD]sc player:0 start_entry:0 last_s


384--[srx CRPD]sc player:0 start_entry:0
384--[stx SSPD]sc player:0 start_entry:0 last_server_entry:3 num_entries_sent:3
432--[srx SPOL]sc - sent passcount:0
432--[stx SREP]sc - reply passcount:432
433--[srx CRPD]sc player:1 start_entry:0
433--[stx SSPD]sc player:1 start_entry:0 last_server_entry:1 num_entries_sent:1

bad
never rx sjon

the client does nothing different
in client log, the last entry is  client sending CJON
it must die waiting for SJON which never comes...true

in server log no packet is received...
with more logging i've found that something is received
but doesn't match any packets ~100 frames in

it turns out my server receive loop will get a packet
but doesn't match any header in rx loop
i strncpy the first 4 char and they are CJON just like the should be

the server will not do the rx loop nice util i tx's something

server_init..broadcast junk packet seems to fix problem...done


also at home it is much harder to get server_sync < 3 for 5 frame...try 5??



--------------

when server player dies; does he become inactive for a while?...yes
does this fuck things up? probably not...
only server_local wont be called
server_proc is called every frame that proc_controls is...

------------



back to network troubleshooting...



added:  PacketAdd2Bytes(passcount); // server_passcount ;
the client will know it has all data up to this passcount

to end of SSPD

read server_passcount in client rx SSPD...done
now what to do with it?...

add player.last_SSPD_passcount and set it

now what to do with THAT!!??........use it to get more data before joining...

don't let client passcount > last_SSPD_passcount

set last_SSPD also when rxing SMOV...


show SSPD on client...







---describe this function-------

function client_req_player_data(int p)

this function blocks; used for setup code only

while (passcount != passcount)
{
   tx CRPD start_entry (players[p].api_write - 1;
   rx SSPD num_sent  last_entry_on_server

   adds (num_sent) data to local players[p].api[][]







THE PROBLEM with the current method is...

when a client joins far behind...
race to start frame after getting data to there...
then while syncing could miss keys...

this last attempt tries to get more packets

in proc control inactive cm4 where only syncing client ever gets





THERE are three methods used at the same time to chase

- free run till passcount

joining sets start frame and gets player data up to start frame
game_loop is run at max speed with int free_run_till_passcount
this is also known as 'chasing to start frame'


after this runs out the regular game sync takes over

regular game sync does not use CRPD and SSPD..it relies on SMOV and CMOV




this sound like a lot of duplication

simpler packets...

sync every 20 frames
if SMOV







- client starts and joins but gets no data;


starts main game loop;

- game loop wont let client pass frames unless has server data past that

- client gets as much api data as server has

- client chases to there

- rinse repeat...




- game loop wont let client be active until sync good






-----------------------------------------
-----------make map work on netgame...........

just need a key???.only for local player...DONE

------------
----------make warp work.........DONE.....

----make map move work...find old code or re-do....
key move done..good for now...

---------------------------

20091224_1636  backup snap shot in good working condition...!!!

level 36 is warp level!!!!





-----------------------------

back to network stuff...

I want move all server stuff from controls to server, same with client and packett..done GOOD

now controls only has one fucntion I care about: 'proc_controls()'

testing..........good!!



--------------------------
i could freeze the game when it is syncing by not processing any loop stuff except controls
---------------------------------------------


---------------------------------------

i am going to bite the bullet and create a game api..like what i have but for all players..

all game stuff must be there...


int game_moves[10000][4];

game_moves[gm][0] = passcount;
game_moves[gm][1] = type;
game_moves[gm][2] = data1;
game_moves[gm][3] = data2;


'[00] start game' will always be frame 0, like this:
0000 00 start_level

players will not come active until getting '[01] player_state' like this:
0000 01 p active

most will be '[05] player moves' like this:
0123 05 p comp_move




the array will be identical on all machines

does the array care who is loacl active player? shouldn't.



as i implement this i will not break what I have already....

declare int game_moves[10000][4]; in main extern in pm.h.....done...

clear it in initila_setup........done...

where to hook it in....proc_controls..sets current controls from api...
this is per player for keys

also needs to run once per frame for system messages


this is where I hook it in to get data out

where do T hook in to get data in?...

proc_control for local keys in


added function to proc_control proc_game_loop to run once per frame
its intention is to get and process system messages from game_moves
right now all it processes is player active...done for now


added a function to add data to game_moves..

add_game_move(int passcount, int type, int data1, int data2)


server is the only one putting things in the queue
but i dont know if i can assume they will always be in order...

however, if im looking for a specific one it probably wont be > +/-20

variables to keep track of this...game_move_entry_pos
also can be used for knowning how much to send to client

init to 0 in main extern in control



same place as init api do same for game_move

it get serase in player_init...

when?.. when a new level starts...set 1st at same time too!!!...done


also set player active at same frame 0...only for server and local...
if client don't?? how do I know imaclient!...DONE


now to set when keys are changed...4 places??

in local game bottom on proc_controls...done

in server local control...done

client local.........done

where else??? the common code the all player read from every framr in proc_controls


so far all code from the old way and the new way co-exists

when I change the common code they all use in proc controls that is it.


look for matching player and most recent entry
if > passcount do nothing
if <= passcount apply it


done and work for local player!!!! code actually look simpler!! BONUS


of course net game will be broken until i pass this new game array with messages....

its just about time for the kids to wake up on xmas...

im going to make a snapshot bakup....20091225_0815


what are my thought on how to pass this....

set up a new packet exchange with the sole purpose of syncing the game_move array...


server will do this seperately for each client

in the packet exchange the client will let the server know it has rx'd up to a certain point

the next message to that client will start from the last acked point

who inits? server both?

when local_client has new move...still sends cmov

client init only with new data; sends new data and requests




server sends every x passcounts



do i nedd to combine with sync? sure! only send sync every x passcount if new new keys in that time
otherwise use keys..

packet new cmov 'cdat'

passcount, p, cm



whenever server rx's cdat it puts it in game array and replies with new sync_data paket


packet 'sdat'
passcount, p, game_move_index_start, num_entries

<entries>


client must reply to sdat with 'sdak' to let the server know it was rx'd

packet 'sdak'
passcount, p, updated client_game_move_index



also server will generate sdat packets if none have been sent in the last x frames


'sdat' will be the new sync and data tranfer packets...


where to start...server rx cdat...done



after server rx's cdat and sticks it in game_move, game_move_entry_pos is incremented on server


for each client that has a lower entery_pos than server:
server send SDAT to each client


check for this once per loop


client keeps track of entry_pos; global; only one..
server needs to keep track for every client..where?...in player struct on server only?..sure..

added players[p].game_move_entry_pos

will set when server receives sdak

do server rx sdak..........done


(1) client send cdat...in client_local_control done....and logging too...done

(2) server rx cdat...done with logging....


(3) server send sdat...made a function called once per frame that manages all clients

void server_send_sdat(void) look for clients with entry_pos less than server and sends them packets...DONE HERE..wait need logging



(4) client rx sdat....doen and logged



(5) client tx sdak...immed after proc sdat...done with logging....


(6) server rx sdak...done with logging


what is the structure of sdat...

passcount, p, start_game_move_index, num_entries,


<entry int, int, int, int>



do i need to include last_entry_on server in sdat? no i dont think so



in most cases sdat will send everything it has, but when very far behind
needs a way to know. who? client why?

the server needs to knoe the last good rx for each client..
..from srx sdak set players[p].game_move_entry_pos...done

then in server loop


testing.......nothing

how does it all start?

server starts and runs...

when client sends cjon





is my code ready.. when server makes new player join..will my code see its far behing and chase??


where does it die??? client rx's sjon...log msg to long for char msg[80]..
how nuch fucking time wasted on that tiny bug?



remove some extra cvlient logging crap so i can see whats going on..


disable server send SMOV...done



client sends cdat, server never logs rxing it...mov logging up..FIXED server now rx sdat



for logging SREP and SPOL will have 20 - at start on client

much easeir to read now


server gets cdat; server never sends sdat log in that function...






it looks like void server_send_sdat(void) is working but...

does data get there in time???

also sends once per frame and the rx's three replies


server log


1547----checking -- p[1].gmep:148  gmep:148
1548----checking -- p[1].gmep:148  gmep:148
1548--[srx cdat]sc - pc:1548 p:1 cm:1
1549----checking -- p[1].gmep:148  gmep:149
1549------------sending record:1548 [5][1][1][-1]
1549--[stx sdat]sss - p:1 start:148  num:1
1550----checking -- p[1].gmep:148  gmep:149
1550------------sending record:1548 [5][1][1][-1]
1550--[stx sdat]sss - p:1 start:148  num:1
1551----checking -- p[1].gmep:148  gmep:149
1551------------sending record:1548 [5][1][1][-1]
1551--[stx sdat]sss - p:1 start:148  num:1
1552----checking -- p[1].gmep:148  gmep:149
1552------------sending record:1548 [5][1][1][-1]
1552--[stx sdat]sss - p:1 start:148  num:1
1552--[srx sdak]sc - pc:1549 p:1 new_entry_pos:149
1552--[srx sdak]sc - pc:1549 p:1 new_entry_pos:149
1552--[srx sdak]sc - pc:1549 p:1 new_entry_pos:149



problem 1 - server receives data on exact frame its needed???

trace the passcounts...srx uses displays sent pc...ctx uses current pc + lead frames


it looks like i really have that much lag...increase CONTROL_LEAD_FRAME?? sure try 8

both players work on the server
neither work on client...on client see when sdak how late it is...


on client when rx sdat logged the passcount - the sent passcount
CONTROL_LEAD_FRAMES has no effect on this (index to game_move; not



i need to look at the passcounts of the entries...


make a function to dump the game_loop_enrty at exit...


on client it is completely blank???????? that could be the problem!!!

look in rxing of sdat on client only....



does client ever inc game_entry_pos?....it does it player array but not globally..al_fixed


multiplayer now works with 2 clients!!!!!!!!

remove some packet debugging.......done

control lead frame back to 4 done

still works! three player good too!.....


remove all start frame crap, player add packets. etc...

al commented out and still works

do a snaphot then remove


20091226_0817

remove commented code...done..still works

change PLAD packet to be put in game_array...

who sends and sets up? ...server tx srep...

there is a bunch of init code when player become active...in proc_control
move it to game_event...done....testing...


bug-c2 controls c1 also!!!

other variable I'm going to remove...


player struct
.frame_to_make_active gone...
.last_SSPD_passcount
.start_frame;
.end_frame;

must get rid of passing start and end frame with SJON...done..tested

next...

array api...done...

server only dies instantly...server init completes...

both are called almost identically from main...

where is game_move_entry_pos set??...cleared at same time as array,
right after loading level...


loggggggg dam it.....
does it make it to proc_controls?....al_fixed it was init code...



back to getting rid of things...........


.local_draw..gone!!!

free_run_till_passcount...






one of the problems with dying is the player is inactive for a while

I need to redo this with more granularity.

inactive means all proc is dead, other player can use p[]

active just means check the reat of the flags

.joined

.enemy_detect

.keys_disabled

etc


player should never go inactive like he does when he dies...

just make him invisible to enemies and bullets and disable keys...




server display better...add sync per client-- done..

my server sync stuff works so good, what else could i monitor?





--------------
add SPOL and SREP to cdat and sdat.


first on client...

cdat needs to have what added to make it sPOL

all SPOL really sends is client passcount

cdat does this alreay...but sends pasccount + control frames

no changes neccesary...


when rxing cdat on server, do what srep used to...


-----------------------------leave it for now..works good...



when c2 connect c1 thinks it local...al_fixed.....


where is the code that only looks back 100 entries?...


it is falling out of sync sometime and there are warning in log
increase control_lead_frames and retest..try 6..done


what do I need to monitor to see how the data transfer is going

when client adds to game_move see if passcount is in future

how to deal with multiple packets...don't overwrite data..use  game_move_entry_pos

where to do this?..on server...where SREP tx'd
where to do this?..on client...where SREP rx'd


no...where client rx's sdat....changed to only enter new game_move entries
..also changed to only check when entering new..logs error if < passcount...done

change logging in client rx sdat..
now..server sends passcount
..client compares to c passcount = result is sync which I already have from SREP
..removed


I now have a much better indicator of how the game_move thing syncs..
I need to store this in player array and show on client screen...
only needs to be stored once for a client game...global int client_lead_frames
DONE..

only has a value if sdat rx'd........

try lowering control lead frames and see what happens...?? 6 to 4 nothing??

try 20..got 20

try 10..got .-10

try 6..got 5


try 4..got 3-4 but something fucked up...

try again..fucked up again

back to 6..still fucks up???


something is broken........games do not sync

it my code that does not update unless new...
was causing occasionaly game_move entries to be 0 0 0 0




back to testing control lead frames 2..

hard to tell with multiple entries...

why dont I use a funtion to add to game_move and reject if already exists


added int add_game_move_check(int pc, int type, int data1, int data2)

returns 1 if something added

now use it in client rx...wait....maybe not

let me think some more


one of my biggest problems is a lot of extra sdat packets..how do i thin down?


server send every frame that entry_pos are not equal
waits for sdak

at home typically 2 or 3 sdats are sent before a reply is rx'd

if i had a 1 frame hold off that would get rid of alot
..its never rx'd in that time anyway

try it...

add to player struct .server_last_sdat_sent_frame

only server uses it, to keep track of when last sdat was sent to client

done.. one frame holdoff now results mostly in singles a doubles
need monitor cntrol lead frame while manip this....

clf = 2; holdoff1  missies by up to 4...
clf = 2; holdoff0  missies by up to 3...
clf = 3; holdoff0 misses by up to 3 but mostly 2
clf = 4; holdoff0 good 1 to 4
clf = 4; holdoff1 misses by 1 regularily

use no holdoff and clf=4
---------------

display min and mix client lead frame in client control
diplat number of misses....

why do I can about min max?  just show current and misses




--------------------

make it so player does not go inactive when dying...

can even do this on single player then patch it in.

-------------------
time for a backup snapshot

20091227_1241



int clf_err = 0; in main
extern int clf_err; in pm.h


clf_err = 0; in client_init

clf_err++; in client rx sdat




all is good when only server is moving..
when client moves clf_errors....look in log......

not really errors, just second rxing

fix it so second rx-ing dont affect clf done....


why are there extra crap in player array
like a player 5 6 or 7 with active 32747826478236478

NUM_PLAYERS was 4 changed to 8;



very ocassionally clf = -1 so i'm setting CONTROL_LEAD_FRAME 6

testing.. client log in 4 or 4 ahead now...good leave ther for now...


test more....


c2 has problems with c1 doesn't start previous clients correctly

remove sdat logging and log player add stuff...


c1 player active 1312

i think something else might be making player active...


SJON set players active..remove this..

now sets all control_method == 2 to incative



c1 log 1031 p1 active
c1 log 2892 p2 active


c2 log no p1 active
c2 log 2892 p2 active



c1 gm 1031 1 1 1
c1 gm 2892 1 2 1


c2 gm no p1
c2 gm 2892 1 2 1

------------------


later clients do not add previous players nicely..why?....

are gms the same???


server log
1132 p1 active
5192 p2 active
9011 p3 active
gm good


c1 log
1132 p1 active
5192 p2 active
9011 p3 active
gm good


c2 log
9011 p3 active
gm missing huge chunk

--------------------------------
c2 sync is screwy, why c1 is real nice???....
gms differ...




-------------------------
sometimes its ok...what breaks it...

all players sync before move, good

s move before c1 and c2 join good

s move > 100 before c1 and c2 join



smove > 100 before c1 join causes...bad game sync..why?

put max on packet size of sdat 100 entries



still c3 act weirds, could be due to c2 leaving...



-------------------------


fix the player died inactive stuff...

instead on inactive

add joined
joined == 0 will cause:
keys still active but controls disabled
enemy detect (seek) disabled
enemy collision disabled
bullet collision with player disbaled

draw still good; but maybe different shape???


joined gets set where active does during join

set to 0 when dead waiting....

setup and test on local game





added joined to player struct.


when player dies set joined = 0; not active
paused stays same...


puase countdown...done



find and fix all paused stuff...


proc_pbullets  start new bullet if ((players[p].active) && (!players[p].paused))



proc_ebullets



why do I need to use joined? when paused will do the same?  just dont make inactive...


remove joined from player struct..done

remove at death...done...remove paused_passcount use only paused

paused_passcount totally gone.........
joined totally gone.........

seems to work.......

there are a million tests in my code for

if ((players[p].active) && (!players[p].paused) )






if ( (players[p].active) || (players[p].paused)
these ones i can kill because now there were only need while inactive and paused..

draw_ebullets()

draws for each player...change it to active local player only.no

enemy_draw draws for each player..change to active local

draw_items same...al_fixed

draw_lifts same...al_fixed
draw_lifts timer wait

draw_player...needs to draw all players..alreadt screen p[0]


tested...........3 player multiplayer works awesome......




i should splpit enemy move into function for each enemy type

then enemy move would be one big switch statement:

99 enemy death count down..done (34 lines)

3 archwagon (252 lines)

4 bouncer (110 lines)

6 cannon..(110 lines)

7 podzilla (105 lines)

8 trakbot (390 lines)

9 cloner (200 lines)

11 block walker (167 lines)

12 flapper (98 lines)



old enemy move has been completely redone to just a switch
all enemy move functions are named enemy_xxx(name)

now... what can i find common in these fucntion that I can make a function itself???
this crap is common for all but 99



   if (Ei[EN][31]) // hit
   {
      int na = 34; // new ans
      int dl = 20; // delay
      int ht = Ei[EN][31]; // hit type

      Ei[EN][27] = 2; // bonus type
      Ei[EN][26] = 929+(ht-1)*32; // shape

      Ei[EN][24]*=ht; // bullet bonus
      Ei[EN][25]*=ht; // health bonus

      Ei[EN][3] = na; // new ans
      Ei[EN][30] = dl; // death_loop_wait;  set delay
      Ef[EN][11] = 1.08; // scale multiplier
      Ef[EN][13] = 0;// 255/dl/2; rot inc

      zz[0][na] = zz[5][na]; // set shape
      zz[1][na] = 0;         // point to zero
      zz[2][na] = passcount; // set counter
      zz[3][na] = dl / (zz[4][na]+1); // set ans timer

      Ei[EN][0] = 99; // set type to death loop
      e_killed_type = 3;

      event(13, EXint, EYint, 0, 0, 0, 0);
      return; // break;  to stop rest of execution
   }



put all this in a function; now look for ways to optimize that...



find and destroy e_killed_type add to event()
aslo uses when enemy hits player...

pass EN as data1

for all event 12 and 13

DONE..............

next....enemy_player_hit_proc()




  if (--Ei[EN][23]<0) // hit player retrigger
   {
      if (Ei[EN][22]) // player hit!
      {
         players[Ei[EN][22]-1].LIFE -= al_ftofix(Ef[EN][4]);
         event(12, EXint, EYint, EN, 0, 0, 0);
         Ei[EN][22] = 0;  // clear hit
         Ei[EN][23] = 60; // set retrigger amount
      }
   }
  else Ei[EN][22] = 0;


DONE...newline counts

99 enemy death count down..done (34 31 lines)
3 archwagon (252 to 182 lines)
4 bouncer (110 to 90 lines)
6 cannon..(110 to 83 lines)
7 podzilla (105 to 64 lines)
8 trakbot (390 to 360 lines)
9 cloner (200 to 150 lines)
11 block walker (167 to 145 lines)
12 flapper (98 to 61 lines)


not much but it looks a lot better...!!!!


--------------
20091228_1111 backup...



do I really need trig at all???

i know the x difference and the y difference,

distance can be found with sqrt(x^2+y^2)

speed is how many frames to get there


player position 100, 150

enemy position




doesnt show current level on start, only after re-entry to main menu

al_fixed...remove p2 from menu...



in level editor why can't i edit filename im trying to save..fixed


where are the block map colors in pmwin??

in main...

int map_solid_color = 240, map_semi_color = 3;
int map_break_color = 12, map_empty_color = 241;
int map_bullet_color= 14; //enemy bullets only;
int map_item_color=7, map_enemy_color=5;


in main...

in maps_and_background_fill()...uses bcmt look up table...reads from sprit file


fine...is there an editor in bitmap_editor??....yes..hold M and b1 in bitmap editor

when switch is processed, redraw map using bcmt...works perfectly

now make empty switch block color darker...done...



track_bot error??? al_fixed.......

Ei[EN][4] mode

Ei[EN][2] draw type
Ei[EN][20] rot

Ef[EN][12] scale


make it so when player is hit with enemy bullet, add recoil!!


make a function called:

void move_thing(int start_x, int start_y, int dest_x, int dest_y

int size_x, int size_y

somehow returns the allowed x and allowed y

this function could be called by players, enemies, and items that move

instead of the god awful mess i've got now

            if (!is_left_solid(EXint, EYint))
            {

// check if currently stuck


x_move = start_x - dest_x;

if (x_move > 0)
{
   if (start_x + size_x is solid) // already solid
   {
      try start_x + 1 until dest_x and check if solid
      set allowed_x to one less that still is not solid


   }

if (x_move < 0)
{
   if (start_x is solid) // already solid
   {
      try start_x - 1 until dest_x and check if solid
      set allowed_x to one less that still is not solid


   }



}



needs a helper function

int is_solid (int x, int y);




weekend off... back 20100103_0700


archwagon jump all the time???


make archwagon ride lift up only

in down check...


how does player adjust with lift??..


redo menu...

level editor on main screen...done







bug - doesnt show current level on start, only after re-entry to main menu

load_level
draw_level
slow_load_and_draw_level


player shows on levels when changing levels..al_fixed...

20100104_0900 backup



what the hell am i doing?????

how is the netgamne thing coming??

2 player l71 seems good, only if started close and server minimal moves



before client gets off passcount zero, it has rx'd 17 sdat packets
all that have been already entered...

server is responsible for sending them all...

how can i make the server hold_off work??
do it only if not joined??...




---------------------------------------
what if I combined SREP and sdat???

client will get sync info from sdat instead of SREP

client will not need to request sdat





server will need to send sdat every time the last sdat sent > 20 or when new data

client will reply with sdak



how does sync work now?

client sends SPOL with its current passcount

server returns SREP with sent passcount(client) and its own(server)
server calculates server_sync for each client by server_passcount - client_passcount
server calculates good frames and inserts game move to make player active

client rx's SREP

client calculates server_sync by server_passcount - client_passcount
client sets fps_chase


how do I plan to change it??

server sends sdat every time the last_sdat_sent > passcount - 10 or when new data
done...test...good

next make client do the sync thing with sdat...ok

make client not send spol...ok

test...

client can sync good, but server needs to make active at right time

add server processing after rxing sdak; like old srep processing...





when server rx's a move from client and it is already too late,
it will not put it in game_moves and log an error!!


sync is resetting the timer too much...
need to get average server_sync over 20 frames then apply

or 4 sdats then apply

or divide sync by 2

what data does server have for each client?

-server_sync      server_passcount - last_sdak_sent_passcount

add..
-late cdat



what does client have?
-server_sync
-client lead frames (from last sdat rx'd)
-clf error (count if ever goes negative)



-----------------------------------------

I think I have the CPOL and SPOL and SREP not used any more..
comment them all out make sure it still works backup then remove!!!


20100104_1847



---------------


done... now back to regular network troubleshooting...



i want to add some more server monitoring...

per client...

should add to player structure for per player stuff

late cdat rx

last sdak rx in passcount form...done but not that usefull, could be a good heartbeat counter

what i really need is how far in future are cdat data rx'd..












i think my sync errors are due to client passing server when chasing...

need to monitor this...where..client..

took out average fps adjust thingy...why?.. need to monitor first...

now i cant seem to get a client to pass server...

average method causes delays in setting fps and causes overruns...disable..done



still not the same...find simplest way to test...


client gm has all entries but they are blank??? al_fixed


working better now



---------------
when ever player gets shot add -1 to yinc...works...
now change to bullet momentum..done...
-----------------------------------

deathmatch!!!...done...
------------------------
lift prox wait doesnt detect players above 1...al_fixed
-------------------------



back to network troubleshooting

what is wrong now???

testing...
level4 played 2 player for 250 frame all good both start close

level 4 played for 50 b4 c1 joined, error died, c2 joined all good


i want to test 3 player...

tested level 4 on 3 player all started b4 any move..worked good


c2 joins bad if lots of data?...



make a better packet logging thing that only writes to disk on exit



bkup 20100105_1735


testing at home...


started three player game no moves till all synced..moved c2 and key stuck moving
looked in c1 and c2 gm identical..also both c1 and c2 have 2 gm entries, 5 frames apart, where both come active twice??
maybe cause c2 has a false start due to screen size...

should edit gfx init routine to just pick a better screen size and move on rather than exiting...done...test???.....


need some automated testing....

script to copy pmwin to clients


make pmfle run in windowed mode...done..looks nice
make pmfle run in 1280x1024 mode...done

when player hit show a mini health bar for a few seconds...




--------------
back to network trouble shooting...
multiple player active entries??? shouldn't be a problem
al_fixed by inserting active only when good_sync is exactly 4 not > 4

---------------------

3 player game all join b4 move c2 loses keypresses...test with clf 5 not 3

great with clf = 5..set back to 3 and look for error logging on server

yes.. getting logged goodly...

this does not cause the game to go out of sync...gm's are identical

causes client to lose keys...

set clf to 4 and see if any errors...after a long perfect sync'd game c2 had 2 errs

set clf to 5 and run more tests...no errors...

is there any errors left with the net code?....

try s and c1 play for a while then c2 join...s and c1 stay good but c2 different


need an automated way to tell if out of sync...


every 100 frames client sends PX and PY

frame 2600 px = 1234  py = 254
the server compares to local data for that frame



make client send packet 'dtck' data check every 100 frames

server rx's packet, but where to store and how to compare??...

server needs to store for each client and self...

make part of player struct for server use only

int last_dtck_pc
int last_dtck_val (PX + PY)

init ...done

server sets when rx dtck...done

server set for itself...

this is all done but doesn't show errors on PX position
how about num_enemies!!!

i get error with this!  errors show on server, what about client??

make counter for error and show on server...done...

I get enemy errors from c2 if joining far behind...

test on levels with only archwagon and no lifts...no errors
when c2 quits and rejoins as c3 sync overshootz a lot gets way behind...


i would have more confidence in the game sync if i monitored more things

PX, PY, num_enemies, num_items,

right now num_enemies is all i'm monitoring




----

make save and play game work with gm
record a complicated game
play back on different machine

make playback stop at certain frame an report results
PX PY num items, num enemies..etc

in this way you can automate testing...



blind save gm already happens at end of main

make a function to load it and play it back

added save game and tested good.

now get it back

save and play game seem to work good

sometimes player starts active...how is this set?
when clients rx's SJON gets list of who's active...this is wrong...
should be game_move sets players active...
could be causing sync issues...

removed reading active and cm for each player from SJON rx in client






-----------------
-----------------
where is player initialized?
-------------------------------
all get done in initial setup 0 active 1-7 inactive
all get done in load gm  0 active 1-7 inactive

server_init p[0]
server rx cjon p[cn]

client_init p[0]
client rx sjon p[cn]

that's it...

-----------------
-----------------

active_local_player where is set? need to set for local game to0

should be zero by default and only changed for clients

in main is set to 0 and only one place in client where its set...good

run game needs a control method for clients, try 0 for now.no needs to be 1

why do my save games not make other players active?....al_fixed

recorded very good a2.gm

make file selectors filter for .gm  done


3 player l71
1st time c2 did not have any c1 moves
2nd time worked good and saved as a3.gm

did 7 player and some worked good
some skip previous clients going active



bad search at front on game_move_entry
use one from proc...done

recorded good a4




-----------

did a 4 player test and all worked good
no move till all join archwagons only

try same thing with cannons...
level 72 same as 71 only with cannons
played 4 player to level time 150 all good


tried level 4 test..
s does full loop
c1 joins and does full loop...
c2 joins and is not right...

joining too late???

what happens..why??

should i make a better packet logging thing?

yes...trivial to implement


back to testing level 4 c2






---------

20100107_0820

getting ready for another backup

what have i done?...

save game and load game work...done

deleted all apl and demo directory

netgame works good with 3 player but
c2 does not always sync good has clf b4 active?..



why????...


recorded a7 at 30fps level 4 4 player good

make game_moves_log better annotated...started

need a function to take a comp_move int and return a string

how to return a string ... done

blind save game move log now has nice annotation..


ran a nice 4 player game on level 12 synced goodly

saved as a8 c3 joins about 110

hard to find errors now!!
make an easier way to set screen SPEEDs



clean up the speed and passcount_timer_fps crap...later...



tested on level 32 3rd player was not the same...


added command line argument to start game from file...
pmwin.exe -f a8.gm


recorded lev16 3p game 180long 62c1join 172c2join

when c2 joined level was not same,,,

look at c2 gm_log..looks identical to server gm..
they are the same..



I just played j56c1 and j56s level16
1057 entries
933 till c1 join... c1 messed up...saved c1 locally..played back like s


gm's are identical, what else could be wrong??


when client saves games and plays back it matches server,
but not first time when chases a really fast speed

try setting a max chase speed..200



or just turn on packet logging and look for errors

from the log it appears that client only gets 100 items max
per packet exchange which could be a few frames.

in that time the game races and replies to the first 100 at frame 308; 200 at 2280

i could set a max chase speed, or I could block until caught up..

how can I reproduce?....have sex;)


level 34 30 fps 60 ticks 3179

i should know about this, packet logging_sdat????...


try max speed = 100...works but takes a long time to sync


if (num_entries < 100) adjust fps; else ignore..works, no clf errors

would be nice to have a funtion that gets all this data before the game loop starts

for now set fps to 100??




disabled client send dtck for now...done

client only rx's one packet; sdat and replies with sdak
client sends only 2 packets; sdak and cdat when it has new data


made fps = 100 when getting num == 100 else use fps adjust


try different packet sizes until i get an error!!






when running game have options:

run to a specific frame

run to end then local control
run to end then server
run to end then pause and return


frame speed

map on





make the client init function save ip address of server..later big waste of time...


how is it going to look? the final netgame entry points?

server will have a start server from menu
client too..





make map work when running game...done...




when starting client get server IP from config file
if successful connect save to config file




[NETWORK]
server_IP = 192.168.0.100


BUG after run game local control don't work...fixed

make main command line args better...done

BUG after screen change not all variable get set right until game is retsarted....


now add server and client start to main menu

lower map a few...done

redid the main menu screens...nice!!

there are lots of cleanup tasks I can do while I'm gone for a week


-fix the speed and fps crap...use only fps...


fix the char msg[80] everywhere.. define it in main and extern it in pm.h AND NOWHERE ELSE!!!

I would love to do that now...
starting from fresh backup 20100108_1812.....

search and replace all char msg[80] with ""...

client..done
network..none
packet..none
pm.h.. none
server 5 done
yfilecom..done
zbullets..none
zcontrol 2 done
emove none
file 2 done
fnx 1 done
item none
lifts 1 done
loop 1 done
main none
menu 2 done
player 2 done
screen 6 done
sound 1 done

added to main and pm.h

compiles clean...yay!!!

comment out the dtck packet stuff...done




wouldn't it be cool to have door make player invincible and move to destination
all while level plays around you!!!

wouldn't it be cool to have some weapons upgrades? yes


take my best levels and start them at 100


when pmfle exits, starts pmwin as client??
pmfle does not start pmwin, it returns level num on exit



in pmfle fix the save selection crap to use sel dir and larger char
also had to remove a bunch or char msg[80] from pmfle to make it compile


need to have a better screen setup for level editor

now I have three menu option

i added 1280x1024 and I want to force one of these 4 resolutions
i want to be able to set fullscreen or not and store in config

make one menu entry set screen resolution and have it call rhe dialog

found entry point...~1800 e_editor...

copied from pmwin setup code...

sx = lsx???

how does fle setup

in e_main

added...

int lsx = 640;
int lsy = 480;
int lgfx_card = AUTODETECT;

now load at start from cfg

level editor screen thing done...
only one menu entry that calls gui to select screen size, saved in cfg and processed at start...


--------------------------------------------------------------


make warp able to have different ans or shape (or none!)
make warp go to an exact x and y on destination level...really needed
if not done already make warp not affect health, ammo, etc

how will this affect other players in netgame??
they will have to enter new level at the same instant and place as player that got warp

later





-------------------------------------------------







when pmfle exits, starts pmwin as client??
pmfle does not start pmwin, it returns level num on exit


while running file game show a countdown on screen...done

make F7 and F8 inc and dec fps.......done..
played back awow at 1000fps and it took 55sec..cool

now I should patch something in at the end of file play...

make it optional...
- return immediately with game exit
- freeze for time then exit or wait for keypress

-when going back to menu; dont have to erase gm; can leave it for player to continue
-however if leaving with esc before file finishes...have to clean up..cant leave gm wonky

for now I am going to find the place to patch it in...done

the way it works now is:

- in proc_control control method == 1
- it finds the last pc not 0 in gm
- when passcount > 100 past end inits all players above 0 and sets 0 to local control

to finish the run game thing i need to handle the esc exit...where??..proc_control





now I need to handle the client exit nicely...

use cdat...


to handle all exits nicely i should remove the esc check from controls
and do it per control method

removed from key check..done
added to front of server local and client_local...add more exit code there later..

test...good; framework is done... now put real exit code for server and client there...


client...when client exits send notification to server
and wait for server to send gm with player inactive packet...

use comp_move 255??..yes..done..

decode on server...done

handle in proc game move...done

bug - the last entry in clients gm is 255 but shoul not be???
look on server...

client rx's 255 from server, client is good, make server change 255 to ??

255 does nopt work good but 127 does...
works good on server..but client has extra entries in gm...al_fixed


client seems to exit good .... but exits server too ...

what about ima client and ima server??..handled at game move when player set inactive


seems to work good!!!

time for a backup 20100110_1620...
its sunday and im going to nisku tomorrow for the week...


20100112(tue)

didn't feel like doing anything last night or tonight...


I should add player death thingy...where..in draw_player..done

make a funtion that draws the health bar and call it from top display...done

need to make the paused code restore health after pause...done...
make it show 0 as all red...done


20090113 (wed)

what does screen change no do that cold start does...after changing resolution...game is wrong...
it was setting sx sy sw sh in player struct...done

cleaned up sc_setup...much shorter now

20100114(thu)

make the player color change thingy good actually usable by regular user

add a text description of each color...done
declare color_name[16][20]; in main and extern it in pm.h..done


add a menu item player color and use arrows to change
do it on main menu so changes are visible instantly...works great...now just save in cfg file

find where init in main...done

run game ovewrite cause it calls player_init

move color code to player_init...done...

make move move and map size have 2 keys...done..just S now for size..


20100117_0548

back at home for a couple day but havent made any changes...


need to find out how to add certain resolution to the gfx_set GUI thingy
I can manually set modes 1400x1050 on d610d and 2560x1024 on ma

need to look in sources...

right now, I can just put the values in allegro.cfg and remove the hard coded bit...done

I need to sort out the player color thing..

player 0 can set his color and that is saved in cfg file

it is not saved anywhere in gm, should it be?...

yes, it would be trivial...

when game starts the color of player is put in gm just before player goes active...


added game move type 2 color at level start

now need to decode it on controls...done...

now color is saved in gm and played back with correct color for local game

in net game client starts with proper server color

make color part of client join...added to CJON...done


client gets color he wants; but server gets overwritten somehow??



in log server only logs p0 color; no p0 log in client??..



client passess frame 0 and has no data yet in log...al_fixed


snapshot

20100117_1007

works and multiplayer color net works...


set up another computer for testing...


test s = purple
c1 = red
c2 = aqua


works and plays back correctly...



i need to set up an automated test system that works better...


have some code that copies exe to destinations...

pmwin -t

copies its own executable to multiple locations...

pmwin -a

copies all files to multiple locations...


sweet.. now i have a semi-automated 5 player test setup

ma        - server and dev machine - purple
sunny     - pm_client1 - red
pav1520   - pm_client2 - green
d610_lost - pm_client3 -
d610b     - pm_client4


in the background, while on the main menu, it should look for server games
and if found should flash the join game item...




20100118_1900 things to do..

when adding new player with SJON.. use first empty instead of client_num

also prevent same color with sjon

if client gets no response from server, exits...

when client exits, clean up nice...force local gm entry..last one..




make a new function for me called step record level
or step play along...

runs a saved game and lets you play along with it...cool

afterwards can be saved again and will have new data...


i have tried an 8 player game and it worked good

i still get errors if trying to sync too far...


make clients display same color as client...done



i have setup pm to  copy executable to other locations with -t
now in dev-c when I hit F9 to compile and run, i've made parameters -t
so it compiles and runs with -t; then copies itself to client then exits!
and it does it all pretty quickly (< 1s)

rename executable to pm and on windows pm.exe...fuck typing win all these/those times...
done..i think


show the version on the screen bottom
never reset build #

done... now at build 3245...


what still needs to be done to netgame?...

dies on long chase sometimes

multiple color check on server

client number to player number translation

better reporting and display of sync data

live changing of control frames

menu background search for netgame...



what has to be done before release?.....

d/l, install, and integrate pm with ubuntu....

i want to make 2 player local work again before release, unless it gets too difficult.

controller improvements

help menu re-written

run game to show data about each run game in custom file select...

better level select, show data about each level b4 opening...

levels to be all al_fixed and put in order

lots of work b4 release...im guessing a couple of months...

20100119_0719 bkup


20100122_0645

nothing done for a couple of days.


al_fixed a bug in the controller code..joystick not working with netgame

made game display version info from Dev-C on game screen

displays allegro init stuff on command line


At start, before setting a screen mode, I want to detect the desktop resolution..done

now I would like to set this as the default screen, but how to disable???

only sets desktop sx and sy when 'pm -x'


20100127_0400

I am in the hotel in Nisku.  Doing good at work  but no programming in a while.


Work stuff
----------

when I get back home I need to make a maint plan for 2010

A big excel spreadsheet, with per tool sections.

For example

PBMS
----

9 PBMS-A
1 PBMS-B

need to be Q checked every year

parts required for Q...

parts to have in stock (minimums)



tools that I can Q

PBMS (PSTC PBMS)
RST (RSC-RSS-RSX)
SCMT (SCMX and SCMC only, SCMS needs sonde Q)
PFCS

SSLT (SSFC and SSLC only, SSAS need sonde Q)

HGNS
HRMS (needs sonde Q)
HRGD
HRCC
HTBC
AIT (ele only, also needs sonde Q)

DTC
TCC
SGT-L, N
CAL-B
CAL-Y
CCL-L
UPCT-A
PGGT-D

tools that I can't yet
DSLC
HRLA


This morning, wednesday I am going to initiate that RAN for the broken caliper arm



20100124 (sun)

i am going to NISKU tomorrow...

need to get HRMS's ready
grab PPE and work computer
grab old SGD detectors
oring part number

fill lindas van with gas

pack my computer bag
D610D + key board and mouse

could I do it on my work laptop???



back to the game...

need to do some cleanup...

I think I'll use the desktop size most of the time

for fullscreen and windowed modes, make sure never bigger than desktop...

I could do away with fullscreen modes that are'nt exactly the dsktop size??

I could have some values in a menu like...

checkbox [] auto set fullscreen to desktop size

or just an menu item to set the screen size to max..an option currently unavailable in gfx_mode_sel


the problem is that I have to detect the screen size after allegro init, but before set_gfx_mode
and they both happen in initial_setup...


right now, thats where it is and it always sets to max screen size...test for a while and see if you like it...

what else should I work on??

controller setup

-----------------

trying to compile pmfle

uses eitype_desc[50][32][40] to describe enemy ints..needs to be three dimensions

why is it also used in pm for something else???

fix pmfle first.. done.. restored old 3d eitype

in pm replaced all eitype with 2d enemy_name..done

find a way to iterate all file in a dir in allegro

use for each filename.. and callback function

what am I going to do with the list of filenames? stick it in an array somewhere

ideally a list box

save games
filename  level  players moves times recorded date


levels
filename picture enemeies items, all dead, multi exits, cloners

for now i could print out data on the command line


made a function that gets called with -a; lists all files in levels dir

my load and save game use level number at the lowest level

I want the lowest level to specify a filename

maybe I could get rid of the whole level number thing and use filenames

If I had something like a screen to select levels


right now the game can only run levels that end in a three digit number...

make exits return you to the main level selection map, or.. warp instantly to a new level




in pmfle the buttons are defined in many places

int new_button(int * 16!)
takes care of drawing all buttons and procesing clicks

int edit_int_slider(int * 16)


function edit item calls list of these functions


removed e_file.cpp from pmfle, was blank, compiles clean without it..

i think I need to make a list box thingy



how about a rectangular grid of levels?

customizable row and columns, or just size and auto rows and columns

needs a function to load level by filename...

make the main load routine use filnames

then make a helper routine that converts level num to filename

should be trivial

what are they called now???


i have one routine called make filename that take int level_num and writes to global level_filename


used by load_level, quick_load_level, and save_level



20100204(thu)

not much prog lately, real busy with work


20100207 (sun)

al_fixed another bug in joystick code

need to be able to make bomb with bigger fuses and damage range

done..made fuse max 200 and bomb max 800

game keeps crashing an few seconds after starting level 17..



where is item riding lift in my code?


al_fixed it so that items riding lift do not pass thru wall...done


fix so player do not go down thru floors on lifts...done

make it so that rockets do not push player thru walls


make it so when player is riding rocket, he is drawn smaller; on top of rocket!!!
if you lose the left and right side for rocket it will be better!!!


done



there is a bug in proc_lit_rocket...it draws!!!



removed drawing from proc_lit_rocket and proc_carry_item

cant remove from proc_lit_bomb yet...

uses bomb[20][5] but does it really need to??

couldn't it use the item variables??

what does it add??

bomb[b][0] = 32 + link to item id
bomb[b][1] =
bomb[b][2] =
bomb[b][3] =
bomb[b][4] =

bomb[d][0] = 32 + x;                 // link to item
bomb[d][1] = item[x][9] * zz[4][25]; // total fuse wait
bomb[d][2] = item[x][9];             // seq fuse wait
bomb[d][3] = item[x][7];             // damage
bomb[d][4] = 1;                      // for blow up


get rid of bomb

use just item 98

0 2 and 3 were duplicates
1 is calculated from 2 and 4 should be used as mode.

mode 0 un lit
mode 1 lit
mode 2 fuse done


make proc_lit_bomb look for item [i][0] == 98


----
renamed proc_lit_bomb to old_proc_lit_bomb

new proc_lit_bomb look for item[x][0] == 99


already 7 is damage
already 9 is fuse wait

will use 6 for sequence; set to one when lit
will use 8 for total fuse wait


almost done;;

split into two animation sequences

one for fuse countdown and one for blow up
store both ans in item ints

96 is bomb fuse
97 is bomb explosion

use 96 for seq(6)1 and 97 for seq(6)2

works good, no item draw except in draw_item!!!

left to do...

read fuse and explosion ans seq from item variable
make new fuse and explosion ans
allow changing in level editor

test box damage box display

make item[c][2] draw type actually work

1 = normal .. good
2 = rotate al_itofix(item[c][10]/10)
3 = stretch al_itofix(item[c][10]/100)

in glt  make all rockets (11) have draw == 2 done
also made all bombs have corrected fuse length


rockets don't have good explosions like bombs do.. all i needed was to set draw_type..done

items have  been clened up a lot

the whole file is much tighter

pmfle rockets creator needs to have  draw_type set ??

maybe not


now i want to use glt to find out item details...




lift editor bug
--------------
level 74 one lift
try to move any step and hard crash...

insert and delete work good...

move works for step 0 but other steps crash...done

was passing step to getxy and last int but should be current_lift

now make it so when hovering over dots in lift_editor can click and drag to new spot!!! sweet

where... in lift editor of course...done..works great!!!

rewrote credits page


what are my block ranges??

solids use > 31 and < NUM_SPRITES

0-31   empty
32-63  semi_solid
64-95  bombable
96-127 breakable

169 = map_translucent


generalities used by is_x_solid functions
-----------------------------------------
< 32 = empty
> 31 = solid and semi
> 63 = solid


what are the attributes??

locked and unlocked

s B E

if marked as B it will show up  in block editor selection window



block editor was an attempt at a user bitmap editor but its broken

it thinks that there are 8 only for empty bomamble, semi



going to add ladders and ropes

will need to add to player struct on_rope on_ladder

will never get on_x unless up is pressed

once on...

ladders
up and down move up and down and center player in
side to  side mov a little then fall off

ropes left and right to move; down to fall

need new player shapes for this

need new blocks



-----------------
20100214 (sun)

i need to finish some things that are left half done like...

screen setup
make a way to choose either fullscreen autodetect to desktop resolution or custom screen size
easiest way would be to  remove all screen setup from menus and use auto


make a config int SCREEN_AUTO_DESKTOP_FULLSCREEN

if set do it; else do regular. done

then change then menu item screen setup

could have sub menu...


auto desktop fullscreen
choose custom

fullscreens
-----------
1280
1024
800
640

windowed modes
--------------
1024
800
640

or could have 3b box; gui, auto, exit










controller setup
need to make menu display actual keys

where to det this..when controller menu starts...

zmain line 790

i think the controller setup is done goodly

need to something better for alt and other special keys

need to move joy stuff much higher and leave more space in between buttons
currently
joy 1 is 120 u d l r b0-b7
joy 1 is 132 u d l r b0-b7

some keys came in between 120-and 127 so i named them and moved joysticks to

joy 1 is 128 u d l r b0-b15

joy 2 is 148 u d l r b0-b15


now need to fix all this in code somewhere..should be all done..but not tested



made lifts have 40 and lifts steps 40

need to make creator not stop at 20 done...cool




random musings

when i redo the core, with objects...

al_fixed or float fine_point will be the fine resolution point
(point) will be an x,y point in the level_space
(shape) will be a rect 2 d area in level space

all enemies, items, lifts, walls, floors, bullets will be inherit shape, point and fine_point


every shape will have:
al_fixed fx, fy, fxinc, fyinc;
int x, y, height, width

when moving, code should not set fx, fx directly; should modify fxinc, fyinc

then common to all shapes:
-apply fxinc, fyinc
-collision check
-undo fxinc, fyinc





im going to back up the config_file, then see what gets created...

complains about can't load joystick data..al_fixed









screen setup code

startup code

before setting any screen mode; read desktop resolution and store in dsx and dsy

if auto
-try to set fullscreen screen dsx, dsy
- success - don't write to config, update menu
- fail, try to set to config file values







if auto, call auto function
if manual get from config

then, common to both,

try to set screen mode and error if cant


i really want to make a graphical file selector

a list of files up and down moves highlight

could i extend menu, scroll past top and bottom




use for run game; and level select in game and menu

do foreach and fill struct

level_data

- filename
- level num
- size 100 scale

- num and types of enemies
7 archwagon
8 trakbot
22 cannons

- num and types of items
5 doors
6 keys

basically when I select 'run game'
I am presented with a list that I use up and down arrows to move highlight and enter to choose
as the highlight moves, information about the highlight level is shown, and also a map

i really need to do this




display all kinds of stats with the existing main ment level file selector
then extend it to work with run game too...

where do I do this???



slow load and draw level


stick results of for each in array up to 100 files

char run_filenames[100][255];
make a global int pointer to current index into above
call it run_filenames_index

display it in menu when left and righ t arrows on run
and also display info about it!!!

all done except for display info about selected run game


i know how to make it works

do the run game info crap at the same time as the other level info

where is the other level info











-------------------

what if i made l more dimesional like

l[100][100][8]

0 = shape to draw
1 = solid; semi; empty; bombamble; breakable;

2 = type (int) 0 = normal block
3 = mode
4 = holdoff
5 = counter

the first; breaking out the type from the shape is great

each will be a bit

0 = solid or not
1 = semi solid or not (both 0 and 1 must be 0 to be empty)
2 = bombable
3 = instant death


use last three with type to create blocks in intersting block types

- disappearing and reappearing based on a timer

- dissappering when shot or bombed and reappearing after timer

- taking multiple shots to remove; then slowly builds back

- mostly invisible barrier but briefly mad pain death




snapsnot taken
20100221_2116





snapshot taken 20100308 just before nisku trip

I am combining the two projects, pm and pmfle

i has a brain wave...

if i need a global variable i should just decalre it in pm.h
wont work, myltupli file call in a 2nd and layer defiones will fails




201003090601

success!!

level_editor has been integrated with game and it works good

battery is almost dead!!!

why did I not bring charger!!!!


save and shut down and go do somethig else!!!




pm_main is called 10 times in main!!!


menu
-----
start new game
resume game
run game
host netgame
join netgame
post level editor

command line
------------
pm 37 - starts playing level 37
pm -s 23 - hosts a network game starting on level 37
pm -c <ip> - start client network game and looks for server on <ip>
pm -r long_bomb.gm - starts running saved game from file



the switching to and from level editor is awesome!!!!

there are some global variable that I need to clean up...

new rules....

all gloal variables are declared in main and externed in pm.h

done
-----
int l[100][100]

int Ei[100][32] done
float Ef[100][16] done

int item[500][16]done
al_fixed itemf[500][4]done


duplicated in level_editor and game is
ALLEGRO_BITMAP l2000  - level editor
ALLEGRO_BITMAP level_2000 - game
both show up in lots of places
I will go with l2000; declare in main
remove all extern BITMAPS at same time done
all declared in main and externed in pm.h
now to replace all level_2000 with l2000 done
now menu calls edit_menu directly and startup code is in initial setup with all the rest
done

level editor creates 4 different bitmaps for all possible zoom fullscreen
need to only create when needed... later  going with 4 for now


BUG in game menu map draw has funny lifts when not resume
only in y direction??
looks like y2 goes up (-) instead of down (+)
where? in draw code?
slow_load_and_draw_level
uses draw_level
uses add_eilp_to_l2000
now at 2048x1156 only when resume looks fucky
al_fixed- done draws good now

BUG level editor do not work good with db = 11
forced only one place db is set...in set_map_var
called in init_setup and sc_screen_change thingy
i force it to be 10 if > 10 and
force 7 for 8 and 8
seems to work...



BUG player falls through lifts when jumping

where does this get changed set????


in player control??

or in is down solid??

when player is falling will fall through lifts...al_fixed
in is down solid changed from 17 to 25


need to make
int md...done
int map_double...good
int db ... done

all declared only in main and externed in pm.h
also only set in set map_var


db goes with txc...

int txc

int map100_x; map100_y... done

int txc....


done.....





net errors

l33 server ran 400 game moves and client joined OK


level 33 ran 109s and 1000 game moves and choked on join


level 33 ran 140s and 110 moves and choked

l33 ran 83s and 3 moves good join

l33 ran 100s and 60 moves good join

143 ran 104s and 401 moves good join

l33 ran 150s and 404 moves choked!!

looks like its time, not moves??

120s 38 moves dies

try in box???

110s 5 moves good join

125 3 moves dies!!!

118 3 moves good join

need to turn on packet logging and capture failure vs good !!!!

last one 118s 3 moves good sync
client pc 858 - sync 5074
client pc 1861 - sync 4081
client pc 3745 - sync 2217
client pc 4623 - sync 1349
client pc 5466 - sync 516
client pc 5611 - sync 381
client pc 5717 - sync 285
client pc 5801 - sync 211

150s 3 moves overshot sync

0801 - 6747
1811 - 5747
2751 - 4817
3663 - 3915
4548 - 3040
5391 - 2207
6197 - 1411
6690 - 658
7703 - -75
8405 - -767
8946 - -1298
8947 - -1289


140s - 3 moves overshot a little...
[ 846]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7195 fps:6389 sync:6349
[1869]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7205 fps:5376 sync:5336
[2932]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7215 fps:4323 sync:4283
[3997]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7225 fps:3268 sync:3228
[5058]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7235 fps:2217 sync:2177
[6125]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7245 fps:1160 sync:1120
[7180]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7255 fps:115 sync:75
[7401]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7265 fps:4 sync:-136
[7402]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7275 fps:4 sync:-127
[7403]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7285 fps:4 sync:-118
[7404]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7295 fps:4 sync:-109
[7405]--[crx sdat]--p:1 start:77 num:0 [77] fpc:7305 fps:4 sync:-100

135s 3 moves good...
[ 875]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6782 fps:5947 sync:5907
[1943]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6792 fps:4889 sync:4849
[3010]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6802 fps:3832 sync:3792
[4074]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6812 fps:2778 sync:2738
[5133]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6822 fps:1729 sync:1689
[6207]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6832 fps:665 sync:625
[6624]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6842 fps:258 sync:218
[6690]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6852 fps:202 sync:162
[6742]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6862 fps:160 sync:120
[6782]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6872 fps:130 sync:90
[6815]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6882 fps:107 sync:67
[6842]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6892 fps:90 sync:50
[6865]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6902 fps:77 sync:37
[6884]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6912 fps:68 sync:28
[6901]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6922 fps:61 sync:21
[6916]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6932 fps:56 sync:16
[6930]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6942 fps:52 sync:12
[6943]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6952 fps:49 sync:9
[6956]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6962 fps:46 sync:6
[6967]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6972 fps:45 sync:5
[6979]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6982 fps:43 sync:3
[6989]--[crx sdat]--p:1 start:3 num:0 [3] fpc:6992 fps:43 sync:3
[7000]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7002 fps:42 sync:2
[7011]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7012 fps:41 sync:1
[7021]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7022 fps:41 sync:1
[7031]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7032 fps:41 sync:1
[7036]--[crx sdat]--p:1 start:3 num:2 [3] fpc:7037 fps:41 sync:1

145s 3 moves overshot...
[ 816]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7291 fps:6515 sync:6475
[1883]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7301 fps:5458 sync:5418
[2954]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7311 fps:4397 sync:4357
[4022]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7321 fps:3339 sync:3299
[5069]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7331 fps:2302 sync:2262
[6115]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7341 fps:1266 sync:1226
[7169]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7351 fps:222 sync:182
[7521]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7361 fps:4 sync:-160
[7525]--[crx sdat]--p:1 start:3 num:0 [3] fpc:7371 fps:4 sync:-154


client is running at very fast fps...
needs to recalc fps every frame; not only when rxing sdat...



replaced all lmsg[10000] with log_msg[100000];
lmsg[5][80] is used by level_editor...




added code to client_control:
- adjust fps if not adjusted in last 20 frames

160s join good



200s join fail


[8650]--[fps adj]--la:8629--fps:1854
[8671]--[fps adj]--la:8650--fps:1833
[8674]--[crx sdat]--p:1 start:942 num:0 [942] fpc:10474 fps:1840 sync:1800
[8695]--[fps adj]--la:8674--fps:1819
[8716]--[fps adj]--la:8695--fps:1798
[8737]--[fps adj]--la:8716--fps:1777
[8758]--[fps adj]--la:8737--fps:1756
[8779]--[fps adj]--la:8758--fps:1735
[8800]--[fps adj]--la:8779--fps:1714
[8821]--[fps adj]--la:8800--fps:1693
[8842]--[fps adj]--la:8821--fps:1672
[8863]--[fps adj]--la:8842--fps:1651
[8884]--[fps adj]--la:8863--fps:1630
[8905]--[fps adj]--la:8884--fps:1609
[8926]--[fps adj]--la:8905--fps:1588
[8947]--[fps adj]--la:8926--fps:1567
[8968]--[fps adj]--la:8947--fps:1546
[8989]--[fps adj]--la:8968--fps:1525
[9010]--[fps adj]--la:8989--fps:1504
[9031]--[fps adj]--la:9010--fps:1483
[9052]--[fps adj]--la:9031--fps:1462
[9073]--[fps adj]--la:9052--fps:1441
[9094]--[fps adj]--la:9073--fps:1420
[9115]--[fps adj]--la:9094--fps:1399
[9136]--[fps adj]--la:9115--fps:1378
[9157]--[fps adj]--la:9136--fps:1357
[9178]--[fps adj]--la:9157--fps:1336
[9199]--[fps adj]--la:9178--fps:1315
[9220]--[fps adj]--la:9199--fps:1294
[9241]--[fps adj]--la:9220--fps:1273
[9262]--[fps adj]--la:9241--fps:1252
[9283]--[fps adj]--la:9262--fps:1231
[9304]--[fps adj]--la:9283--fps:1210
[9325]--[fps adj]--la:9304--fps:1189
[9346]--[fps adj]--la:9325--fps:1168
[9367]--[fps adj]--la:9346--fps:1147
[9388]--[fps adj]--la:9367--fps:1126
[9409]--[fps adj]--la:9388--fps:1105
[9430]--[fps adj]--la:9409--fps:1084
[9451]--[fps adj]--la:9430--fps:1063
[9472]--[fps adj]--la:9451--fps:1042
[9493]--[fps adj]--la:9472--fps:1021
[9514]--[fps adj]--la:9493--fps:1000
[9535]--[fps adj]--la:9514--fps:979
[9556]--[fps adj]--la:9535--fps:958
[9577]--[fps adj]--la:9556--fps:937
[9598]--[fps adj]--la:9577--fps:916
[9619]--[fps adj]--la:9598--fps:895
[9640]--[fps adj]--la:9619--fps:874
[9661]--[fps adj]--la:9640--fps:853
[9682]--[fps adj]--la:9661--fps:832
[9703]--[fps adj]--la:9682--fps:811
[9724]--[fps adj]--la:9703--fps:790`
[9774]--[crx sdat]--p:1 start:942 num:0 [942] fpc:10484 fps:750 sync:710
[9795]--[fps adj]--la:9774--fps:729
[9816]--[fps adj]--la:9795--fps:708
[9837]--[fps adj]--la:9816--fps:687
[9858]--[fps adj]--la:9837--fps:666
[9879]--[fps adj]--la:9858--fps:645
[9900]--[fps adj]--la:9879--fps:624
[9921]--[fps adj]--la:9900--fps:603
[9942]--[fps adj]--la:9921--fps:582
[9963]--[fps adj]--la:9942--fps:561
[9984]--[fps adj]--la:9963--fps:540
[10005]--[fps adj]--la:9984--fps:519
[10026]--[fps adj]--la:10005--fps:498
[10047]--[fps adj]--la:10026--fps:477
[10068]--[fps adj]--la:10047--fps:456
[10089]--[fps adj]--la:10068--fps:435
[10110]--[fps adj]--la:10089--fps:414
[10131]--[fps adj]--la:10110--fps:393
[10152]--[fps adj]--la:10131--fps:372
[10173]--[fps adj]--la:10152--fps:351
[10194]--[fps adj]--la:10173--fps:330
[10215]--[fps adj]--la:10194--fps:309
[10236]--[fps adj]--la:10215--fps:288
[10257]--[fps adj]--la:10236--fps:267
[10278]--[fps adj]--la:10257--fps:246
[10299]--[fps adj]--la:10278--fps:225
[10320]--[fps adj]--la:10299--fps:204
[10341]--[fps adj]--la:10320--fps:183
[10362]--[fps adj]--la:10341--fps:162
[10383]--[fps adj]--la:10362--fps:141
[10404]--[fps adj]--la:10383--fps:120
[10425]--[fps adj]--la:10404--fps:99
[10446]--[fps adj]--la:10425--fps:78
[10467]--[fps adj]--la:10446--fps:57
[10488]--[fps adj]--la:10467--fps:36
[10509]--[fps adj]--la:10488--fps:15
[10530]--[fps adj]--la:10509--fps:4
[10551]--[fps adj]--la:10530--fps:4
[10572]--[fps adj]--la:10551--fps:4
[10593]--[fps adj]--la:10572--fps:4
[10614]--[fps adj]--la:10593--fps:4
[10635]--[fps adj]--la:10614--fps:4
[10656]--[fps adj]--la:10635--fps:4
[10677]--[fps adj]--la:10656--fps:4
[10698]--[fps adj]--la:10677--fps:4
[10719]--[fps adj]--la:10698--fps:4
[10740]--[fps adj]--la:10719--fps:4
[10761]--[fps adj]--la:10740--fps:4
[10782]--[fps adj]--la:10761--fps:4
[10803]--[fps adj]--la:10782--fps:4
[10824]--[fps adj]--la:10803--fps:4
[10845]--[fps adj]--la:10824--fps:4
[10866]--[fps adj]--la:10845--fps:4
[10887]--[fps adj]--la:10866--fps:4
[10908]--[fps adj]--la:10887--fps:4
[10929]--[fps adj]--la:10908--fps:4
[10931]--[crx sdat]--p:1 start:942 num:0 [942] fpc:10494 fps:4 sync:-437
[10952]--[fps adj]--la:10931--fps:4
[10973]--[fps adj]--la:10952--fps:4





the adjust thingy works goog until it get closer..
my adjusting of fps_chase works good until last section

but after that even at 4 fps the next sdat is -437 then -1557 then -2490 before sdat rx's stop fps adjust??!!

maybe there is a max that I should not exceed with my fps_adjust??

maybe is should start shlowing down faster when server_sync < 1000??? tried didn't work

try setting max fps to 1000 fps...that seemed to fix it!!!!

no I had server run 230s and good client joins, then dissconnect and good rejoin!!

now trying higher values...5000

made sunny the server so i can do stuff here while waiting...



joined to p5 334s 325 moves and crashed on server and client...

do it again....



p3 285s and 693 moves

again...

tried to join @ 147 and overshot....???
joined 170 good...

191

208 3 clf b4 join??

220 join 3 clf agin b4 join

crash @ 233 and 14 mmoves


i watched server sync go to -65535 after a really long game ~1250s


1250 * 40 =

65535/40 = 1638

65535/50 = 1310

1310 / 60 = 21.8 minutes

21.8 * 256 = 5785 minutes / 60 = 96 hours



doesnt matter how big int is, i'm passing it as 2 bytes in packets...



when player5 goes active game dies ???

yes, happens all the time!!!!

player can join and chase fine, but as soon as it goes active, server and client both die without, showing that they went active



in server when client joins print out client num just to check


server printed

1 4 5 6 then died...
1 2 3 4 5 then died...
1 2 3 4 5 then died...


for trouble shooting assign higher player number and see if dies!!

dies on 5
123 then died...what is up with p5????


try going back a few versions to before I merged le and game and see if error is there

tried 20100208 and also died on p5

back to 0314...


tried to force p6 p7 and both work... only 5 dies...

curiouser and curiouser said Alice...


problem is in enemy move; trakbot, find closest player quad

uses array d[2] should be d[NUM_PLAYERS]

BUG HAS BEEN FIXED!!!!!




next; what packets have passcount?


[cdat]
passcount(2)----------------
player(1)
cm(1)

[sdat]
passcount(2)-----------------
player(2)
start_entry(2)
num_entries(2)

each entry:
passcount(2)-----------------
type(2)
data 1(2)
data 2(2)

[sdak]
passcount(2)------------------
player(2?)
new_entry_pos(2)

[cjon]
req_color(1)

[sjon]
passcount(2)-----------------
play_level(1)
fps(1)
cn(1)
color(1)

need to change all passcount passing to 3 bytes

make new fucntion read3bytes and write3bytes and plug them in...



start with:

cdat ctx done
cdat srx done

sdak ctx done 3pc 1p
sdak srx done 3pc 1p

cjon good

sjon stx done
sjon crx remove passcount...

sdat stx
sdat rx



new
-----------
(bytes)

[cjon]
(1)req_color

[sjon]
(1)play_level
(1)fps
(1)cn
(1)color

[cdat]
(3)passcount
(1)player
(1)cm

[sdat]
(3)passcount
(2)start_entry
(2)num_entries

each entry:
(3)passcount
(2)type
(2)data 1
(2)data 2

[sdak]
(3)passcount
(1)player
(2)new_entry_pos


made player number recycle but it breaks stuff when resyncing....
tries to run player both from gm previous and also from current...causes conflicts...
removed, will re-think...

----------------

BUG when client exits; starts another game right away...only when starting client command line...

how does client leave pm_main???


----------------
BUG level_editor setup write all over controller setup
text_setup is for le
menu_setup is for pm
call ts b4 em and ms after...DONE
--------------------


overnight left a 2 client game runing...server crashed at ~8900 c1 and c2 still running @ 4fps ~10000 frames
ran 4c game to ~2200 and quit and rejoined; overshot by ~70000
repeat and overshot by 58000
quit ma and rejoined good
ran out of clients on server

how am I going to fix this??

make max players 16 or 32??


-------------------
how will I implement multiplayer record?
merge 2 or more already recorded gm files
but what if I want to play along with a gm file and save result
that is the one task i want the most 'run game from file while playing along'
and after have the option to savce that result. And in with that simple functionality
I can layer record!

again, how will I implement this??

method 1

-make a seperate array, mirroring gm where the run game file is loaded
-while running add entries from 2nd gm to main gm exactly on the frame required

method 2
- use only one gm but make a function to insert moves when needed by local player


2 looks easier to implement.........


in both cases, at the very start, it must be determined what player number will be the new added one
 i need a function that will take a gm file as input and return the first empty player number

or it could just operate on the gm in memory...yeah do that...

make an array x[NUM_PLAYERS] and init to zero

iterate gm
if any entries refernce a player number p; x[p]++

make the array global; call it









full blown version

choose 'run game and play along'

choose existing gm file

see how many player are in chosen gm

allow choice of any player (if exists, erase)

allow choice

run game

after exit allow save; (nothing to do; that's how it is already)



that gets me to thinking...when does the game end?  when player 0 quits?

how should it be?  as long as one player is active it should continue??

right now, i think player 0 is the master player

for all local games p0 is the only player

in network game mode; p0 defines how long the game runs

in file playback mode there will always be a p0; beacuse its saved from one of the above






how will I signal that a player is added???



method 3 (this proves the point of planning b4 programming)

how about while a game is running a special key code will let you join!!!!!!
at that point a new type of control method is needed
all it needs to do is insert in the middle of gm instead of at the end





-----------------------------
started sorting out sources

currently they live @ \\X\mw\docs\aa_mdw_programs\pm

they earliest version I've found so far is from 98

I started in nov/dec of 1997 in the basement appt on Fair St.

i need a way to serch all these folder and zips so I can:

- remove duplicates or
- find all unique and/or overwritten levels!!!!!

lots of cool stuff out there, how to find and organize??

make a file iterator and run it on top level

for every file, enter into db

filname and path
mod date stamp
level num
picture of level
num_enemies
num of enemy_ints


level_data description
-----------
level_header[6]
l[100][100]
Ei[32]
Ef[16]

need a convertor to handle any type of level you can throw at it

converts old style enemy, item, lifts definitions to new









--------------------------
re do log file and blind save gm
right now they always use the same filename and overwrite all the time

I want unique filename with 14 char time stamps and level info like

pm_log_YYYYMMDD_HHMMSS_L21_P2_M239.pml

gm_YYYYMMDD_HHMMSS_L21_P2_M239.pml

that way I never have to overwrite old logs or games i've played

I need a function

char* get_date_time_stamp(void);
{

}
that returns a string in the format 'YYYYMMDD_HHMMSS'








--------------------------------------------------------------------------
20140206

have been away for a long time.....

There are a lot of changes since the last released game

I have not been successfull with the multiplayer part...

I wonder how hard it would be to remove it all so I can do a normal release....


now with win 7 some of my pallette is messed up, the first 8 colors are wrong

only when in fullscreen mode, does not happen in windowed mode


how can I make this work????

redo the entire game????

I need a single block of data that can completely describe the game state for each frame

then i need a method of syncing it over clients




-----------------------

20140308

bug fix item creator crashes level editor
getxy displays then dies
putting a printf line in the loop causes it to not die
rest does nothing only a printf, even if it doesn't actually print anything
al_fixed.


bug message creator crashes program
can view existing messages...
traced to item sort section that deals with pop-up messages
could it be due to the fact that the temp created item has an
unititalized pmsg[]???...yes that was it!!!
al_fixed.

bug player can leave edges of the screen...al_fixed


-----
try to read desktop color depth with resolution
done but when setting game color depth to 32 same as desktop...doesnt work so commented out


bug when creating or getting new block range for key...crashes
in function  getxy added 2 printf's
al_fixed.

--------------------------------

need to simplify:
int select_window_num_block_lines = 9;
int swnbl = 7;
search for both and sort it out
not done

----------------------------------

bug in lift creator and editor

made move lift from right click on step work...done

made insert step from right click work...done

i could simplify the lift creator to just create a lift,
then open it in lift viewer...seems to work so far...


something is going wrong with lifts that move slowly
they don't move at all...
looks like speeds < 10 freeze lifts...
changed code to cast to float befor dividing by 10
fixed...


then I need to add code to be able to edit move to step zero speed
already good

when adding first step getxy looks messed
whenever the step to be added is the last, getxy looks messed
when moving the last step also...
its the entire draw_bs function that's bad...
I think I al_fixed it by adding a case for db=10
al_fixed.

deleting lifts sometimes crashes

when deleting from lift editor menu
nlv 920

when deleting from pop menu ok
editor 1563

both call erase_lift(int lift);






20170301

removed netplay with ifdefs...

why does fullscreen color messed in win7???

should I go to allegro 5???





what about 4.4.2?


what version am I using now???

what version of mingw?




20171022



I think that I can do deterministic lockstep.....

I just need to debug to find out what causes non determininsm...



Do I have any floats???

yes I do.

Ones that I can ignore are:

level editor
display only code

what about

PDEf

EF




There are a lots of floats used....why, I thought I al_fixed this?



See if you can fix Ef, the PDEf, the bullet x, thien lift x.....


First PDEf


looks like I can save al_fixed to a file by converting float to fix and the printing like int with %d

now the file is called pde2.pm and saves floats and al_fixed
as soon as they are loaded they are converted to floats


now make a shadow array PDEfx and put the al_fixed there also...

added
   extern al_fixed PDEfx[100][16];
whenever
 extern float PDEf[100][16];
was found


cleaned up the whole pde file...

there is no more mention of PDEf, just PDEfx



pbullets are already integers....

e bullets are floats and need to be changed

only in game, not editor...

extern int e_bullet_active[50], e_bullet_shape[50];
extern int enemy_bullet_colision_window;
extern float e_bullet_x[50], e_bullet_y[50], e_bullet_xinc[50], e_bullet_yinc[50];



struct lift
   {
      float fx;
      float fy;
      float fxinc;
      float fyinc;
      int x1;
      int y1;
      int x2;
      int y2;
      int width;
      int height;
      int color;
      int current_step;
      int num_steps;
      int limit_counter;
      int limit_type;
      char* lift_name;
   };
extern struct lift *lifts[40];
struct lift_step
   {
      int type;
      int val;
      int x;
      int y;
   };
extern struct lift_step *lift_steps[40][40];







There are a lot of things that have x and y positions and should have common data structures


every object that has a screen position should have
x and y (top left pos)
h and w
x inc and y inc

these include:
players
enemies
items
bullets
lifts
wall and floors

these should all be al_fixed integers stored as 32 bit number that can be divied by 65536 to get actual screen position

20171106

looks like itemf is already al_fixed....


20171107
I re-enabled #netplay

Where I am going with this?

If I make a simple level with no enemies or lifts, I could avoid floats....
right now float are only in:
- enemies
- enemy bullets
- lifts

level 46


I noticed in the sproingy code that I am using a float cast... do I really need this? how can I avoid it?

players[p].yinc = al_ftofix(0-(float)item[x][7] / 2.82 );

al_itofix(item[x][7]) / al_ftofix(2.82)


I am about ready to give up on the float removal thing

even if I use al_fixed, I still need to get small values into al_fixed without using float.


the whole world is 2000x2000

2000*65536

the upper byte 0-65535 will be exactly this
the lower byte will be the fraction

1/65536 = 0.00001525

suppose I want 2.82 to be a al_fixed

I could mutliply by 100 to get 282, then convert to al_fixed, then divide by 100 in al_fixed mode

its like I need a function to convert a decimal constant to al_fixed, without using float.

suppose I want 2.82
al_itofix(282) / 100

now modify this code:


players[p].yinc = al_ftofix(0-(float)item[x][7] / 2.82 );

al_fixed:
players[p].yinc

int:
item[x][7]

A fixed point value can be multiplied or divided by an integer with the normal `*' and `/' operators


players[p].yinc = al_ftofix(0-(float)item[x][7] / 2.82 );
printf("players[p].yinc fl %d\n", players[p].yinc );

players[p].yinc = al_itofix(0) - al_itofix(((item[x][7] * 100) / 282));
printf("players[p].yinc fi %d\n", players[p].yinc );

The difference between the 2 calculations is too big:

players[p].yinc fl -1742979
players[p].yinc fi -1703936


I did it wrong:

this did the conversion in as ints:
players[p].yinc = al_itofix(0) - al_itofix(((item[x][7] * 100) / 282));
printf("players[p].yinc fi %d\n", players[p].yinc );

this does the conversion as fixeds:
players[p].yinc = al_itofix(0) - (( al_itofix(item[x][7]) * 100) / 282);
printf("players[p].yinc f2 %d\n", players[p].yinc );

players[p].yinc fl -1742979
players[p].yinc f1 -1703936
players[p].yinc f2 -1742978





here is another float fix in zitem.cpp

float atmp = al_ftofix( (float) item[x][8] / 10);
printf(" h dec float = %f\n", atmp);


// players[p].LIFE -= al_ftofix(atmp);





al_ftofix((float) item[x][8]/10)



players[p].LIFE -= al_itofix(item[x][8]) / 10);



players[p].LIFE is a al_fixed


                     int a = item[x][8];
                     printf("float method\n");
                     printf("item[x][8] = %d\n", a);
                     float a1 = (float) a;
                     printf("item[x][8] = %f\n", a1);
                     a1 /= 10;
                     printf("item[x][8] = %f\n", a1);
                     al_fixed a2 = al_ftofix(a1);
                     printf("final = %d\n", a2);




//                     printf(" h dec float = %f\n", a);

                     int b = item[x][8];
                     printf("al_fixed method\n");
                     printf("item[x][8] %d\n", b);

                     al_fixed b1 = al_itofix(item[x][8]);
                     printf(" h dec al_fixed = %d\n", b1);

                     b1 = al_itofix(item[x][8]) / 10;
                     printf(" h dec al_fixed = %d\n", b1);

                     printf("final = %d\n", b1);



//                     al_fixed b = al_itofix(item[x][8]) / 10;
//                     printf("al_itofix(item[x][8]) = %d\n", b);


                     event(10, itx, ity, 0, 0, 0, 0);
                     players[p].LIFE -= al_ftofix((float) item[x][8]/10);
                     players[p].health_display = 80;


float method
item[x][8] = 5
item[x][8] = 5.000000
item[x][8] = 0.500000
final = 32768
al_fixed method
item[x][8] 5
 h dec al_fixed = 327680
 h dec al_fixed = 32768
final = 32768
float method
item[x][8] = 3
item[x][8] = 3.000000
item[x][8] = 0.300000
final = 19661
al_fixed method
item[x][8] 3
 h dec al_fixed = 196608
 h dec al_fixed = 19660
final = 19660

-------------------------------------------------------


there are floats in key animation but they are just for display

there are floats in the bomh handling routines, but they are ok
because all they do is display
ratio of steps done to total steps for animation sequence
scaling factor for drawing exploding bomb

there are floats in the rocket handling code that need to be addressed....


 // set angle and speed
         angle = ( (float) (item[c][10]-640) / 64/10)*1.57; // convert to radians
         itemf[c][2] = al_ftofix(cos(angle) * item[c][11]/1000);       // hypotenuse is the speed!
         itemf[c][3] = al_ftofix(sin(angle) * item[c][11]/1000);


how do I store angle in item[c][10]?

where is the code for controlling riding a rocket???
its in proc_lit rocket!!!!


up = 0
right = 640
down = 1280
left 1920

al_fixed point trig needs angles in al_fixed point...

look like I could just divide by 10...


         // set angle and speed
         float angle = ( (float) (item[c][10]-640) / 64/10)*1.57; // convert to radians
         printf("float angle %f\n", angle);


         itemf[c][2] = al_ftofix(cos(angle) * item[c][11]/1000);       // hypotenuse is the speed!
         printf("xinc float %f\n", cos(angle) * item[c][11]/1000);
         printf("xinc al_fixed %d\n", itemf[c][2]);
         printf("xinc final %f\n", al_fixtof(itemf[c][2]));
         itemf[c][3] = al_ftofix(sin(angle) * item[c][11]/1000);


         al_fixed fangle = al_itofix((item[c][10]-640) / 10);
         printf("--new-----\n");
         printf("al_fixed angle %d\n", fangle);
         itemf[c][2] = (fixcos(fangle) * item[c][11]) / 1000;       // hypotenuse is the speed!
         printf("xinc al_fixed %d\n", itemf[c][2]);
         itemf[c][3] = (fixsin(fangle) * item[c][11]) / 1000;       // hypotenuse is the speed!







enemy bullets--------------------------------

extern float e_bullet_x[50], e_bullet_y[50], e_bullet_xinc[50], e_bullet_yinc[50];
extern al_fixed e_bullet_fx[50], e_bullet_fy[50], e_bullet_fxinc[50], e_bullet_fyinc[50];

e bullets are done!!!!!!


enemies is huge, but needs to be done...

how about we leave the editor alone for now and just concentrate on the game
as we read the enemy floats from the level file, we will convert them to al_fixed...
later we will save them as al_fixed...

extern float Ef[100][16];

extern al_fixed Efi[100][16];

enemy draw is done
enemy collision is done


death animation sequence


         Ef[EN][12] = 2.8; // initial scale
         Ef[EN][11] = .94; // scale multiplier
         Ef[EN][13] = 0;  // 255/dl/2;  rot inc


done


on to the actual enemies


archwagon.....
working
except for the bit of code that aligns the enemy with the floor after falling....




now bouncer
fix function: int get_rot_from_xyinc(int EN)
al_fixed, now only has 4 lines!!!
also al_fixed
void seek_set_xyinc(int EN, int EXint, int EYint)

bouncer is completely done


cannon

need to do the extra shot stuff...done

need to redo get_rot_from_PXY(EN, EXint, EYint, p)
al_fixed, now only has 4 lines!!!


podzilla

very easily done



trakbot

complicated, but its done!!!!!

except for align with floor.....

block walker done...



I've got the align with floor thingy figured out and patched into
archwagon, block walker and trakbot

what I dont have figure (commented out) is the floor below stuff for lifts
for block walker and trakbot...



flapper is done
could add starting direction in level editor and also height above player to float.




last is cloner.....


cloner is partly done

still need to do cloner lines...done

cloned archwagons sometimes have frozen arrows ????
all enemies.....
al_fixed bullet routine and now only trakbot is bad...

not just cloned trakbot, all trakbots....al_fixed

now there is no mention of Ef anywhere in:

zbullets
zcontrol
zemove
zfile
zfnx
zitem
zlifts
zloop
zmain still have main declaration for level editor stuff...
zmenu
zplayer
zscrn
zsound

yfilecom still saves as float and loads both float and al_fixed, but game uses no floats

----------------------------------------------------------------------------

are lifts the only float thing left in game???

struct lift
   {
      float fx;
      float fy;
      float fxinc;
      float fyinc;
      int x1;
      int y1;
      int x2;
      int y2;
      int width;
      int height;
      int color;
      int current_step;
      int num_steps;
      int limit_counter;
      int limit_type;
      char* lift_name;
   };
extern struct lift *lifts[40];
struct lift_step
   {
      int type;
      int val;
      int x;
      int y;
   };
extern struct lift_step *lift_steps[40][40];






the only time floats are used is when moving

changed to

      al_fixed fx;
      al_fixed fy;
      al_fixed fxinc;
      al_fixed fyinc;


lifts are converted in game but sometimes get random crashes...


there is code if lift move and in player move to deal with players riding lift....




debug lift crashes:



level 32 has 37 lifts
does passcount 0 and 1 processing all lifts then dies before the passcount 2

level 20 has 11 lifts
does passcount 0 processing all lifts then dies before the passcount 1

lets check out the draw code.....

never gets to the draw code???

looks like it dies in proc item move......
al_fixed that....

ran level 32 for 7259 passcount till it died in move lift 35 (2nd to last)

2nd time also ran level 32 for 7259 passcount till it died in move lift 35 (2nd to last)

dies when going to next step on a lift that has no loop to start
lift 36 of 37 (second to last)

         printf("current step:%d\n",lifts[d]->current_step);
         printf("num of steps:%d\n",lifts[d]->num_steps);

         printf("-------------------dif:%d\n",lifts[d]->num_steps - lifts[d]->current_step);

         if (++lifts[d]->current_step > lifts[d]->num_steps)    // increment step
             {
                 printf("current step:%d\n",lifts[d]->current_step);
                 printf("num of steps:%d\n",lifts[d]->num_steps);

                 lifts[d]->current_step = lifts[d]->num_steps;     // bounds check

                 printf("current step:%d\n",lifts[d]->current_step);
                 printf("num of steps:%d\n",lifts[d]->num_steps);
              }


the biggest difference I ever see is 2
when it dies I see 1

put in a bound check and all seems good...


how about run lifts from level editor...done


now why do lifts not move good when the speed is very slow?
they dont loop back to zero when speed <5...


the problem is that when the distance between steps is 0 in both x and y
the limit counter gets set to a really large value.

this happens when doing the loop to zero thing

i will modify
void set_lift_xyinc(int d, int step)
to set xinc, yinc to 0 and limit counter to 1

also I should check to see if I can do without the extra last step...yes i can



lift creator has a huge pause
uses getxy
when used to set new lift step position its awesome
but not for initial position
if (getxy("Set initial position", 4, 0, current_lift) == 1)
nlv 331 if (getxy("Set lift position", 4, 0, step) == 1)
enough of this for now, its really hard...

archwagon to ride on lifts...done


trakbot gets stuck on single blocks

lets fix trakbot getting stuck...
inside turn are good, outside ones are not...
need to fix Efi and +/- te and al_itofix..............
trackbot is done...sometimes fall off 1x1 at faster speeds....


-------------------------------

have I got rid of all floats in the game part????
all that matter....

zbullets
zcontrol
zemove
zfile
zfnx
zitem
zlifts
zloop
zmain still have main declaration for level editor stuff...
zmenu
zplayer
zscrn
zsound

-------------------------------
save selection to disk crashes
-------------------------------

items and blocks seem to work

enemies dont
enemies get save and brough back from disk just fine

do fcopy put them back good, but then all al_fixed seem to get zero'd

i know what it is: in the editor, floats are still used not al_fixed....

now save to disk does all but lift which crash hard...
not all the time....

crashes:
level 33 copy abcd only when lifts are selected

am I exceeding the last step ????
lift 13 has 4 steps 0-3

i get error when reading step 4

lift 2 has 11 steps 0-10
it doesn't give an error because it lim aborts before it gets there

the numlifts was indexed by c (new) instead of b (old)

al_fixed now!!!!


-----------------------------------------------------------------------
I want to be able to scale the window, like, double it or something...
-----------------------------------------------------------------------
I an do this easily in the game, beacuse everything get drawn to the screen buffer
then blitted to the screen.  I made a screen buffer that is twice the height and width
and blitted that to the screen...it works but there are lots of place in the code
that refer to SCREEN_H and SCREEN_W so I gave up for now...

--------------------------------------------------------------------------
I want to make the edge of the screen scroll areas larger in level editor
--------------------------------------------------------------------------
it was as easy as changing one variable "scrolledge" in:
int process_scrolledge(void)



--------------------------------------------------------------------------
I want to a small no scroll spot in the middle of the screen in game
--------------------------------------------------------------------------
if function void get_new_background(void)

made some code to implement this
it could be dependant to screen size
a large play window could have a large no scroll window
but that would not look good on a small screen
made the no scroll window proportional to the screen size
looks good now.....

--------------------------------------------------------------------------
why do bomb and rockets not make explosion sounds anymore???
al_fixed...
--------------------------------------------------------------------------


--------------------------------------------------------------------------
in lifts when you get to a step, you should align it exactly to remove any rounding errors
--------------------------------------------------------------------------



--------------------------------------------------------------------------
if you start the game and it borks due to screen requested is bigger than desktop
set it smaller, so the second time it won't....al_fixed.....
--------------------------------------------------------------------------



--------------------------------------------------------------------
--------------------------------------------------------------------
--------------------------------------------------------------------
--------------------------------------------------------------------
I think I am ready to get back to the netplay stuff.....


I havent been able to see it go out of sync yet.....


now I have a third client and it hasn't broke yet...



--------------------------------------------------------------------------
What happens in net game when a level is finished?
--------------------------------------------------------------------------
Server goes to next level and client borks....

what do I want to happen?

I want the games_moves to be saved whenever a level is done in an auto incrementing filename

the auto inc part might be tricky, i'd have to search a lot of files to find the next empty number...
I could used a date stamp (YYYMMDDHHMMSS) if that is any easier....
for now i will just use one file and keep overwriting it
ok that works for now



what does the server do when level done?


what I want to happen:
- put level done message in game_moves
- let that trigger everything else


how is level_dobe triggered now?

collison with exit sets level_done = 1
at the end of the main loop  level_done is checked

- make the colliosion set level done in game move; but only on server
- still use level done = 1; but have only the server check for it

then the server can set it in game move
only the server? if in netgame then only the server
if not a netgame then what???

if running a game will be read from game move



add_game_move type = 6 level done

- check for that in proc_game_move ?

i think that the server starts the next level before the client gets the message

once the server moves on and clears its game_moves it will never sync to the client

-options
dont reset game move with new level
- bad, it will grow to be huge and needs to be sync'd for new player
- bad,  level done is a oppotunity to re-sync should the become out of sync

how to fix...
-delay the ending on server for a set number of frames, till we are sure the sync is done
or
-get a reply from client that the sync is done
or
make a new packet and send it to all clients


is there one function on the server I could keep running that would sync stuff???

maybe I could run void server_send_sdat(void)

until clients dont need anymore data



------------------

client dies and can't exit after starting 2nd level
why??? and pls fix it...re_compiled everything and now ok?

is there a difference between starting from command line of menu?
not really it works now....


--------------------

I have a temp work around that runs: server_send_sdat(void)
for a while on the server after level done to make sure client gets it
that seems to work fine and both server and client have the exact same game_moves

but on the new level the client and server do not match...
do I need to make the client inactive and then active again???

---------------------------------------------

what do I need to do to test the other method, just continuing with game_moves??

in loop.cpp function proc_level_done(void)

comment out the continuing to run: server_send_sdat(void)
not doing this

passcount needs to get reset
----------------------------
patch proc_level_done() into regular mode

in server loacl control
   if (level_done)
   {
      // insert level done into game move
      add_game_move(passcount, 6, p, 0);
   }
is there a better place for that?
yes moved to proc_controllers

--------------------------------------------

do I need to make the client inactive and then join again for every level start?

might not be as hard as I think....


make the client inactive
- not with game move but with ....


      // unjoin
      player_init(0);
      players[0].control_method = 2; // server player to show on client
      client_init_join();

how does it normally go inactive.....
when esc press in client mode

adds a game_move to make player inactive

then in void proc_game_move(void)
the game_move makes changes to the players settings

where does it become active?

void client_init_join(void)
sets control method = 4 and not active....

thats not it, I'm looking for where the client is chasing and then catches up and joins

there is some in client_control(void)


------------------

when the client joins, player is not visible...




-----------------------------

when I join a level, then quit and join again, that works
but I am another player when I join again...

how is that controlled...badly for now

I don't wnat to go through all that joining again
I just want to chase sync again...

it is set on the server
sync for each player is stored in the player struct
it comes from sdak packets rx'd by the server

so I just need to set the control_mode = 4 and not active and wait for it to catch up...??

is a client always player 0?? on its own machine??? i think not...use active_local player
server and local game always use player(0); clients can use any other number





-----------------------------------------------------------------------------------------
now the client is getting duplicate level done game_move entries...?

I'm sure that an extra one is not getting added on the server..
it could be a problem with the sync...

the problem was I was entering a game_move when I am a client
I should never do that! Only the server gets to enter things in game_move

I need to move the code that creates this game move step to somewhere only server can do it...
maybe only server or local player?  basically they only one that can't do it is a client
now this is solved
----------------------------------------------------------------------------------------------

I don't know what variable are set that I'm not doing right when I change levels



These are all part of the player structure:
-------------------------------------------

   int game_move_entry_pos; // server only for client game_move data sync
   int server_last_sdat_sent_frame; // only server uses it, to keep track of when last sdat was sent to client
   int who; // for network id of clients
   int server_sync;

   int sync_good_frames;

   int c_sync;
   int c_sync_err;

what is c_sync?

when a cdat packet is received from a client,
the enclosed passcount is compared with the server passcount to get c_sync:
c_sync = pc - passcount;

basically the move data from the client needs to be tagged with a passcount in the future
so it can be put into the game_moves array and processed.
if it is data from the past, it cannpt be used and and error is raised

this should not cause the game to go out of sync, those last cdat packet will be ignored
and it will b as if the client never pressed that control...




 if(PacketRead("cdat"))
         {
            int pc = Packet3ByteRead();
            int p = PacketGetByte();
            int cm = PacketGetByte();
            players[p].who = who; // set who in player array; later may be redundant; do it join

            int c_sync = players[p].c_sync = pc - passcount; // check to see if late...
            if (c_sync > 1) add_game_move(pc, 5, p, cm);
            else players[p].c_sync_err++;

#ifdef PACKET_LOGGING_cdat
               if (c_sync > 1) sprintf(msg,"[%4d][srx cdat]sc - sent_pc:%d p:%d cm:%d c_sync:%d\n", passcount, pc, p, cm, c_sync);
               else            sprintf(msg,"[%4d][srx cdat]sc - sent_pc:%d p:%d cm:%d c_sync:%d [ERROR]\n", passcount, pc, p, cm, c_sync);
               add_log_entry(msg);
#endif



players[p].who = 99; (this is the connection number from libnet for identifying connections)


when server gets an "sdak" packet from a client, it contains:
- the client passcount (client_pc)
- the player number (p)
- (new_entry_position) for game_move[] (basically acknowleding everything has been received up to that point)

then server_sync is calculated and set in the player structure like this:
            players[p].server_sync = passcount - client_pc;


  if(PacketRead("sdak"))
         {
            int client_pc = Packet3ByteRead();
            int p = PacketGetByte();
            int new_entry_pos = Packet2ByteRead();

            // mark as rx'ed by setting new entry pos
            players[p].game_move_entry_pos = new_entry_pos;

            // set server_sync in player struct
            players[p].server_sync = passcount - client_pc;


            // if (-2 < sync < 4) add to sync_good_frames or reset
            if ((players[p].server_sync < 4) && (players[p].server_sync > -2))
               players[p].sync_good_frames++;
            else  players[p].sync_good_frames = 0;

            // if good sync 4 times in row set player active in future
            if ((players[p].sync_good_frames == 4)  && (players[p].active == 0))
            {
                 add_game_move(passcount + 10, 2, p, players[p].color);
                 add_game_move(passcount + 10, 1, p, 1);
            }




-------------------------------------------------------------------------------------

I think what I need to do is clear the player data on the server, not the client

   int game_move_entry_pos; // server only for client game_move data sync
   int server_last_sdat_sent_frame; // only server uses it, to keep track of when last sdat was sent to client
   int who; // for network id of clients
   int server_sync;

   int sync_good_frames;


   int c_sync;
   int c_sync_err;


how do I make sure I'm doing on the server??
can't i do it on both??






i cant rely on void init_player_before_level_entry(int p)

when I set start mode, because i need to set the player to inactive...

what if I call this when the player becomes active??// its already there...

---------------------------------------


what now?????



the simplest way to think of it is:
I need to reset the seever and client completely between each level
just like is done the first time

I have been trying to do that, but there must be something I am missing



lets make it so that when a client goes INACTIVE, it really means that they have left the game
thats kind of what it means now.

when they rejoin they are treated as a new player, the old player is not reused
so that when 7 people join, I run out of room

I could fix this by making the array of player structures bigger...but is that the best way?
If I am thinking about making them rejoin after each level done maybe not...

lets see if I can reuse one when rejoining....
right now when one joins, the server assigns a player number that is the same as the connection number
set it to use the first empty, but when player rejoins all is not good!!!

--------------------------------------------------------------------------------------
I am not sure of the method I want to use, and that makes doing it hard....
-----------------------------------------------------------------------------------

what are my options:

After level done:

1 - make clients rejoin with new player number on server
2 - make clients rejoin with same player number on server
3 - just make them rechase and sync with same player number



Also when client quits and rejoins in the middle of the level:
1 - reuse the player number
2 - start with a new player number (works)

rejoining level:

using first inative player:
if I quit and rejoin the level is new??

using cn as player number I get the proper used level...

I think the client is not playing back the stuff that player number did the first time
because now they are the same player number the next time...

result...use new player numbers evertime a client rejoins a level....


what if I added some field to the player struct?

int used; // has this player been used in a netgame so far
int waiting_to_lock

could I just use method and set it to a new value to reflect that it has been used by server on this level
so that I don't re-assign it

yes, do that...

when a client quits, pressed ESC, goes inactive
- on the server set the control method to 9

done

now on server when letting a new player join, it won't let a previously used player or one that is sycing join
active (no)
inactive and cm=2 (no) joining
inactive and cm=9 (no) used and left

also changed the color selection to not use any of the above's colors

------------------------------------------------------------------------------------

does the client even know how far behind in game moves that it is?
it doesn't look like it....

------------------------------------------------------------------------------------
made a nice "waiting for server sync" loading screen for client
------------------------------------------------------------------------------------

------------------------------------------------------------------------------------
make run game able to switch player that camera follows...done
------------------------------------------------------------------------------------









FIX level done in netplay....
--------------------------------------------------------------------------------------
I am not sure of the method I want to use, and that makes doing it hard....
-----------------------------------------------------------------------------------

what are my options:

After level done:

1 - make clients rejoin with new player number on server
2 - make clients rejoin with same player number on server
3 - just make them rechase and sync with same player number




i like #3 best.....

what do we have now??


I want to put something in the logs about when level done is done...

right now on server, after level done,
- we run the server loop a few time to make sure the level done packet is sent.
- play_level++
- start mode = 1

and jump back into it...

init player before level_entry gets called, but does it do enough???


added this in level done....

     for (int p=0; p<NUM_PLAYERS; p++)
         if (players[p].active)
          {
//             init_player_before_level_entry(p);
//             if (p) players[p].active = 0; // set all inactive except 0
             players[p].c_sync = 0;
             players[p].c_sync_err = 0;
             players[p].server_sync = 99;
             players[p].sync_good_frames = 0;
             players[p].game_move_entry_pos = 0; // server only for client game_move data sync
             players[p].server_last_sdat_sent_frame = 0; // only server uses it, to keep track of when last sdat was sent to client

         }


server player does not show up on client for a long time then is oos

eventually they both showed up and were contollable, but one enemy dead was different
game_moves for the level were the same

what if I make the clients inactive to get them to sync again...

I can see on the server that it sycned and became active...


the function proc_level_done called by:


print the player array on client, just like on server...done


the client never goes active...why??

the game_move logs on the client show that he went active
but the packet logs on the client don't

both on the server show that he did???


it looks like the client is not processing the game_moves, but why?

print on client screen the gmnep, works for 1st lvl but not 2nd...why?

player mode for player 1:
first and second level are the same:
server = 2
client = 4

what calls proc_game_move?
process_controllers which is definitely called every frame from the main loop.


server shows player active in logs
server gm show player active at 201
client gm shows player active at 201
player becomes active on server
BUT NOT CLIENT!!!!

server moves don't affect client for about 20s or so

identical game moves....

what about the passcount  same...


what about the game move pointer for each player on the server?

on the client the game move entry position does nothing till about 200 on the timer (200*40) = 8000 passcount

between 5-30 seconds the game move entry position on client starts and then it works but sync is usually off

WHY!!!!!!!


is client looking back in game move and cant find passcount???



it doesnt make any sense....

I'm going to increase the client delay after level done from 2s to 5s and see what that does....

did not help!!!

what if the client has to run frames for the data to catch up
but cant do that until....nevermind

find that actual player init stuff
-nothing there that i dont do...

 players[0].active = 1;         // server is alway player 0 on the client
 players[0].control_method = 2; // reset from server local to remote view




i think i goit something

why does the clients new entry position not reset when level done....



from the log:

this is from the first level that works....
[ 46][ctx sdak]cc - p:1 new_entry_pos:3
[  46]-gmd---Game Move Debug -------------------------------------------
[  46]-gmd---game_move_entry_pos:3 -------


[ 514][sdat entry]--pc:[ 517] type:5 d1:1 d2:2--entered:3 frame lead
[ 514][sdat entry]--pc:[ 514] type:6 d1:0 d2:0--entered:0 frame lead[WARNING!]
[ 514]--[warning!!!] entering pc:514 same as passcount:514
[ 514][ctx sdak]cc - p:1 new_entry_pos:16
[ 514]-gmd---Game Move Debug -------------------------------------------
[ 514]-gmd---game_move_entry_pos:16 -------------------------------------------
[ 514]-gmd---max passcount in gm:517 -------------------------------------------
[ 514]----LEVEL DONE -------------------------------------------
[   0][client timer adjust 2]--last adjust:0------fps:[50]
[   0][ctx sdak]cc - p:1 new_entry_pos:16
[   0][client timer adjust 2]--last adjust:0------fps:[60]
[   0][ctx sdak]cc - p:1 new_entry_pos:16
[   0][client timer adjust 2]--last adjust:0------fps:[70]

why is the client still transmitting an sdak with 16?

do I need to clear the libnet buffer between levels????

how would I even do this???? i did it and it works....
-------------------------------------------------------------------------
my sync thingy works very good now!!!!

still some fine tuney stuff

-----------------------------------------------------------------------------
kill the xinc and yinc when level done...don't carry over to next level...
-----------------------------------------------------------------------------
it should already be done, but it is not...
I don't know why its happening, but at least its happening exactly the same on client and server
does it do the same in local mode??? No, it does not....moving on for now


--------------------------------------------------------------------------------
When the 3rd level start the server player has become inactive on the client
--------------------------------------------------------------------------------
because of the errors in the logs and the fact the both game_moves are identical
I think that the steps were missed.
I'll try increasing the client delay between levels...that al_fixed the problem.
maybe I could also delay the server player from starting until they were sync'd too...

--------------------------------------------------------------------------------
al_fixed a bug i introduced by removing start_mode = 2 from run game
turns out it is need to prevent the game move array from being erased by start mode
--------------------------------------------------------------------------------


what now, brown cow?

save a version...201711111111...lucky or what


-------------------------------------------------
some main thing to do before a release


-------------------------------------------------
try to make the client and server IP stuff easier
-------------------------------------------------
right now the server does not need anything, you just run it

the client needs the IP of the server,
but I could program in 192.168.1.x and 192.168.0.x
to search and that might take care of most stuff

how can i find out my own IP address?

it would be nice if libnet would do it....


I used this in the server_listen function right after I got a connection
printf ("Connection received from %s\n", net_getpeer (newconn));
it gave me the IP and port of the client that connected


Here is what I have so far for the client:

- you can start a client from the commandline and specify and IP like:
pm.exe -c 192.168.1.135
- that IP is saved to the config file

or

- you can select JOIN NETWORK GAME from the menu

- both cases the server IP is read from the allegro.cfg file with a default if it isn't found
- then if it does not succesfully connect it searches from 192.168.1.2 to 192.168.1.255
- if that is successful it is written back to the config file

test erase and supply good on command line...works
test erase and supply bad on command line...works
test supply bad
test erase and run from commandline

all this works good.

As far as the server side is concerned, I can't find a way to find out its IP in the game.
But I don't really need to.


Its as good as it is going to get....


------------------------------------------------------
- clean up the display a bit in client and server
------------------------------------------------------

On the client only show clf_errors if true...done

calculate minimum clf also....but don't show by default
-- add int c_sync_min; to player struct in pm.h
-- init to 99 in init_player_before_level_entry(int p) in player.cpp
-- add this on server where cdat is rx'd if (c_sync < players[p].c_sync_min) players[p].c_sync_min = c_sync;
-- edit the display in scrn

wtf is difference between client_lead_frames and csync?

csync is part on the player_structure and is set on the server  when cdat is rx'd

client_lead_frames is global var and is calculated on the client  when sdat is rx'd

I should re-use the variable in the player struct for the client
they are used on a client anyway...

there are three csync errors when starting

the first 3 entries in game move (lev start p0 start p0 color)
are rx'd on the client the same frame as the passcount, which are both zero
is this a problem?

clf errors are cleared when the player becomes active???
and init player before level entry is called

1st question - is getting move the same passcount as current an error??

server_sync to border bar? ...done

the client display has been cleaned up good.

now do server and fileplay

make a global int show_debug_overlay
toggle it with a function key

done..................

---------------------------------------------------------------
- when too many clients try to join a server gracefully decline
---------------------------------------------------------------
there are only 8 spots available and the server is always 0

test all the modes

good join---

when server full, dies on client with no info??

could be beacuse client has used up players not server....

the server replies with server full.....

when the client get a denies packet it sets the the fps timer from it
is that is zero, it borks!!!!!
ok that's al_fixed now

what happens when the client is denied...ok all good now

one thing left to do...
when level done, you need to free up all the control method 9's for new players....
on the server only



------------------------------------------------------
- what happened to my bombs! when lit only fuse?
------------------------------------------------------

---------------------------------------------------------------
- find out how far behind can you actually join a netgame...
---------------------------------------------------------------

---------------------------------------------------------------
- friendly fire or coop vs deathmatch!!!
---------------------------------------------------------------

check for some bullet collsions

I think I broke the sync...

disabled player bullet collision checks and sync is good..

does active local player mean the same on client and server???
I put it on the debug diaplay and it is what I expected

I think the problem here is that I don't know who's bullet it is
is there any way I can tell???

pbullet know who fired them by  int p = pbullet[b][1];

test all 4 ways (even thoug if d == 0) s doesn't matter

d0 s0 -- nothing
d0 s1 -- nothing
d1 s0 -- d only
d1 s1 -- both

this is done for now...later I will need to put way to change these without re-compiling




----------------------------------------------------------------------
when level done, you need to free up all the control method 9's for new players....
on the server only, NO on BOTH, duh!!!
----------------------------------------------------------------------


---------------------------------------------------------------
- find out how far behind can you actually join a netgame...
---------------------------------------------------------------
here is a dumb question

why does the client start passing frames right away?
it seems like an easy way to miss some game moves
if they are not received before the passcount blows past them

why doesn't a joining client catch up on the game moves, before he starts to chase?

what if I run the function

void client_control(void)

or a modified version of it

in my own seperate loop, until its mostly caught up..

void client_chase_control(void) // run it its own stand alone loop, where


run it until caught up, how to tell

when the packet of moves are small, like less than 10
nep but only after a sdat packet is received

last_sdat_size

start it out large and only overwrite it when an sdat is received
when it gets less than 10, you are good to go...

make  client_chase_control(void) block until above condition

I thinks the problem I was having was receiving extra sdat pakets that i did not need
and the code would spend a lot of time trying to enter 100 game moves one at time that were
not needed.

I put in some code to ignore them, depending on their entry position and clients new_game_move entry pos

It seems to work a lot better now.....I can chase and join from many frames and moves in the future



sometimes it goes out of sync when new clients are joining...need to troubleshoot
it only appears tp happen when a client quits and then re-joins on the same game
when I shut down the client game and restart and join, I have no sync errors
- so what am I not re-setting properly in between....

what happens when I hit ESC on a server, the game is done for everyone!!

what happens when I hit ESC on a client

client sends to server like any control
server puts it in game array like always

when read from there by  proc_game_move(void)

the player is set inactive...
here is where I need to make sure, everything gets reset....
or I could do it when the client is started from the menu...
(don't need to from commandline as its always a new fresh start)

yes, do it when client start from menu....

actually that just calls client_init

how about from there??
did a full player_init of all players there...
lets see what that does...sems to have done the trick....


------------------------------------------------
is the server getting bogged down with doing server things??
how can I tell?

what is skipped on fps?  Its the number of frames skipped per second.
Normally when running my game I never see i past 0
But when  the server is getting bogged down, it was around 20

- do some experiments and see what it takes to affect it...

- what if I disabled all logging??  doesn't seem to help

Before I do anything I should profile the code...
how do I do that again???

in loop there are a lot of these

      move_lifts();                    //prof[1] = prof_timer;
      proc_item_collison();            //prof[2] = prof_timer;
      proc_item_move();                //prof[3] = prof_timer;
      proc_lit_bomb();                 //prof[4] = prof_timer;






my notes from when I profiled the code lat time showed that the only thing that took
and measureable time was the blit to screen.

look like the timer only has a resolution of 10msec
the best I can do is let it run for a few thousand frame and get the average

wide open no draw stuff:  4msec
wide with all draw stuff:  7msec

wide open no draw stuff and frame delay: 24msec

If my game runs at 40 fps, each frame should take: 1000 msec/40 = 25 msec

There is no point trying to measure something that takes < 10 msec with a 10 msec timer.....

---------------------------------------------------------------

lets look at the logs...........


what if I increase the sdat sync packet from every 10 to every 20 frames if no other data is sent
there is only one number to change and I did it...






---------------------------------------------------------------
-------make the netplay logs prettier
---------------------------------------------------------------

also more easily readable

will help in trouble shooting

standard format

[%4d] passcount

[S or C] server or client // do ireally need this??

[] description // would be nice if it was al_fixed width



fix all logging not covered with defines

Client Mode started
Client Initialized

start with CJON and SJON


done good up to here......

looks real pretty....

next a simple one ctx

three places

game controls changed on client....
i really changed this fucntion a lot and simplified it...
it had a different send cdat for reg cmove and one for ESC cmove....

test... harder to quit....al_fixed..


now cdat is done and looks good.


how about sdak that should be simple....

2 places

once in client when rx'd

once of server

done:


I think the format has gelled....

on the server [%4d] rx sdak from p:%d --- \n", passcount, p, );
on the client [%4d] tx cdat --- \n", passcount);

on the client you never have to mention what player you are dealing with
on the server you do....


---------------

sdat

server send

one to send new data
one for sync if no new data

client rx
only one...



-----------------------------------------------------------------------
-the p that is passed with sdat is never used
-----------------------------------------------------------------------
-the server sends sdat to a specific player
-the game moves that it contains are all tagged with the player number...

even better, when returning the sdak, the same p is returned...cool


1 - server sends to players[p].who and also send p
2 - client rx's does not used p until replying with sdak then send p
3 - server uses passed p

alternatively server could figure out p based on who
if i do this first then i can remove the rest backwards..

when server receives sdak figure out p based on who......done
reset who to 99 on server when client leaves.....done

next remove sdak sending p
removed in two place on client tx
one in chasw control
one in reg control

removed in one place on server rx


next remove sdat sending p

on server in 2 places

on client in 2 places

done.....
-----------------------------------------------------------------------
-the p that is passed with sdat is never used
-----------------------------------------------------------------------




client chase doesnt have good sdat and sdak logging


I have done logging for the following:

#define LOGGING_NETPLAY // for startup and initialization
#define LOGGING_NETPLAY_JOIN
#define LOGGING_NETPLAY_cdat
#define LOGGING_NETPLAY_sdak
#define LOGGING_NETPLAY_sdat

how about this for my client logs

sdat rx and sdak tx on same line cause they always happen on same passcount
no, because later I will want to show lots of stuff in between
make it line up with start....


logs are good up to here.

added player active and inactive, color and level done to  LOGGING_NETPLAY
they all look good


what next?

how about some game move entry shit

that only really matters on the client...
the server has got it covered.....

added log for :
- entering x new moves
- skipped entering x old moves




what if a made a function that would process an sdat packet when it was received
because I have 2 places that I do that...in proc control and chase proc control


read a game step from packet and enter it into game array with checks and logging

void read game step(int step);

done and patched in in 2 places....



--------------------------------------------------------------------------------------
if I think my server is slowing down, make a hot key to disable the screen on server
or maybe I could make the server only process packets???
does the server need to run the game, yes others must sync to it...
but that doesn't mean that the server has to run the draw code....



-------------------------------------------------------------------------------------

another saved state...........

2017113_1159



------------------------------------------------------------------------------------------
I've been thinking about a huge change I want to make:

Intead of drawing on the screen buffer (which is the same size as screen)
I want to draw on a huge buffer...(the size of the level background)



the way it is now:
- at the start of the level the entire background of blocks are drawn to the background bitmap which is 2000x2000
- every frame I blit a section of this to the screen_buffer (screen size)
- then I draw players, enemies, items, lift only if they are on this smaller screen buffer
- then I add the screen overlays, borders, etc.
- then I blit the screen buffer to the screen

the way I want to change it to:
- at the start of the level the entire background of blocks are drawn to the background bitmap which is 2000x2000
- every frame I blit the entire background bitmap (2000x2000) to buffer bitmap (2000x2000)
- then I draw ALL players, enemies, items, lift
- then I take the section that I want around my active player and blit it to a screen_buffer
- then I add the screen overlays, borders, etc.
- then I blit the screen buffer to the screen

The advantages:
- greatly simplified drawing of players, enemies, items, lifts
  (no longer do I have to determine if they are on the players screen and only draw them then)
  (no longer do I have to use the offsets of the players screen to determine when to draw them)

- To make a view screen I just need to take a sub bitmap of the main one

- I can easily make multiple screens (like split screen)

- The map can just be a scaled version of the main buffer

- I can do zoom easily (like if I want to double all the shapes)

- I can even do a dynamic zoom, depending on level, or when you are in a level...


The disadvantages:

- every frame I need to copy a 2000x2000 bitmap and a screen size bitmap

- things might get slow

- ??? any others

- i need to re-do everything, well a lot anyway


----------------------------------------------------------------------

Do it, but leave a way back in case its too slow....

First, what bitmaps are we talking about.....

   // BITMAPS
   l2000 = al_create_bitmap(2000,2000);
   scrn_buffer = al_create_bitmap(SCREEN_W,SCREEN_H);
I need to add
level_buffer = al_create_bitmap(2000,2000);
done

edit draw_background()

void draw_background(void)
{
   blit(scrn_buffer, screen, 0,0,0,0, SCREEN_W,SCREEN_H); // screen buffer to screen
   get_new_background();
}

  get_new_background()
  does a lot of stuff to set players[p].WX and WY

  then grabs a piece of l2000 at puts in in screen_buffer

  I modified it to also copy all of l2000 to level_buffer

---------------
next - draw_player done...


now that I am drawing block and player to level_buffer, try displaying it...
it fucking works!!!

right now I am only doing
blit(level_buffer, screen, 0,0,0,0, SCREEN_W,SCREEN_H); // level buffer to screen
in draw background

next draw_items(); -- done

next draw_pbullets(); --- done

next draw_enemy(); --- done

next draw_ebullets --- done

next draw_lifts(); --- done


what now?

everything else need to go on the screen buffer, they are overlays.....

proc_screen_msg();

now is when I fill screen buffer...then the rest if the existing code will work as is....

make a new function
void get_new_screen_buffer(void)



look like it all done!!!!


now to take it for a test run ...

double size!!!!



make function 'get_new_background' do exactly that and only that...done



make function 'get_new_screen_buffer'
- sets the player window
- grabs the screen_buffer from the level_buffer


make function 'blit_buffer_to_screen' ...done

this draw code is much tighter...

comment out old draw in:

player..done
enemy..done
ebullet..done
pbullet..done
item..done
lift..done

now finally for some fun!!

change the funtion get_screen_buffer to get different sizes

-----
things to fix

messages that pop up when a player does something are in the wrong place.....al_fixed

cloner timer numbers are in the wrong place...
the problem is that enemies can't draw from their move functions, it will never be seen

ill have to move the draw stuff from emove to edraw....done
the only enemy that does this is cloner.....
the only item that does this is key animation..do nothing for now...


---------------------------------------
its looking good for now, but the math to figure out the scroll window with a zoomed buffer is too much for me right now...
---------------------------------------

i could try to figure out how to exactly double the size, and see how that differs from the original.


- start out with knowing your zoom factor, lets say 2 for now
- now, how big is the screen buffer, lets say 1280 x 1024
- divide that by the scale factor (640 x 512) and that how big of a window I need to grab from the level_buffer


(SCREEN_W - bw *2) / scale factor
 1280 - 14*2 /2 = 626

(SCREEN_H - bw *2) / scale factor
 1024 - 14*2 /2 = 498


test this....that works great, but now how do I move it....


time for another snapshot......
20171114


---------------------------

I ran the profiler in Dev-Cpp

It says that 99.4 % of time is spent in frame_delay...



----------------------------------

new draw method


- kinda make stimp and stamp, obsolete, or at least they could be re-written

- redo level_map
- mostly done
- could rename all map_100x to just map_x
map100 is gone


what about set_map_var

void set_map_var(void)

editor uses it too...?

it looks like its all stuff for level editor, I'll move it there

never mind theres some needed stuff...

mostly maps is good....


map_size to do bounds check just like map_move.done

map_size to have finer control make it a float...
why dont I just make it the size of the map and keep it an int???


maps is getting better, removed all legacy shit


now make the size thingy more smooth.. done



removed even more map stuff...



fix these function to match others in loop

         if (--bottom_msg > 0) draw_bottom_msg();
         else bottom_msg = 0;
         if (--pop_msg_count > 0) draw_pop_msg();
         else pop_msg = 0;
         if (top_display_on) draw_top_display();
         if (game_map_on) draw_map();

done and it looks a lot better



------------------------------------------
the players window has a small rectangle in the middle where it doesn't scroll
use that to set the map position...

eg if player is moving left and scrolling the have the map on the right...etc

or maybe just if player is covered by map?

--------------------------------------



---------------------------------------------------------------------------
Why, when a level has two starts, one is used at level start and after death another is used???
----------------------------------------------------------------------------
where is after death?

regular start code:

   for (int c=0; c<500; c++)  // cycle blocks
      if (item[c][0] == 5) // get start block
      {
         start_x = itemf[c][0]; // start position x
         start_y = itemf[c][1]; // start position y
      }

after death start code:

            for (int c=0; c<500; c++)  // get start and time
               if (item[c][0] == 5)
               {
                  players[p].PX = itemf[c][0];
                  players[p].PY = itemf[c][1];
                  break; // get out of loop

al_fixed by removing break.....



why don't I make a fucntion...get player start pos

void get_player_start_pos(int p)
{
   for (int c=0; c<500; c++)  // get start and time
   if (item[c][0] == 5)
   {
      players[p].PX = itemf[c][0];
      players[p].PY = itemf[c][1];
   }
}

done...

----------------------------------------------------------------------------
How does level_done work?
----------------------------------------------------------------------------

- when player hits the item 'exit';  'level_done = 1' is set...
- in proc_controller, if you are not a client, a level exit game_move is entered
- in proc_game_move when level_done is read the function proc_level done is called



------------------------------------------------------------------------


I should get back to the netplay thing....

what if I run the profiler on the server?

look like e6400 is just slow...
ran it as a client and it was doing the frame skip thing there too...

it still shows 99% of time is spent in proc_frame_delay...

E6410 as a client is showing frames skipped too.


I should put the develepment environment on these computer and see what the profiler says there....


E6400 already had it...

looks like the bigest function is get_new_background


running file play mw_51_2.gm on mi3

running profile with no frame delay or drawing
30% enemy collision 30%
10% proc_controller 10%
7%  enemy_trakbot    7%
6%  find_closest_player_quad
5%  proc game_move

running profile with no frame delay but still drawing
14% draw enemy
12% enemy collision
7%  enemy trakbot
5%  draw_items
5%  proc_game_move


I just looked in game move...
does it really look back to the start every time?

--------------------------------------------------------------------------------------
does proc_game_move look back to the start everytime??
--------------------------------------------------------------------------------------
yes, but I al_fixed it to only look back 20


--------------------------------------------------------------------------------------
I could make a seperate log file...or the same that loggs when a frame is skipped or not....
--------------------------------------------------------------------------------------
done.
on E6400 it gets to about 1700 then skips mostly every other frame, sometimes skips 2
also it skips the first 17 frames or so...


why???




--------------------------------------------------------------------------------------
get an older laptop and try the profiling there
--------------------------------------------------------------------------------------
4230j

skipped up to 16..
skipped 77, 1800, 2019, 3612,

does not seem to have the frame skip issue...

...now what?....

my testing computers should be non laggy, no?


swap out one of the laptops, for 4230j



---------------------


set the firewall off for private networks on both mi3 and 4230j
now both can ping

testing



--------------------------------------------------------------------------------------
how do I set up a share in win7
--------------------------------------------------------------------------------------

4230j
\\4230j\pm_client3


right click on folder and go to properties->sharing
click share, choose everyone, click add, change permissions to read/write



right click on folder and go to share with
choose everyone, click add, change permissions to read/write
this sets up the long share...\\4230j\\Users\m\Desktop\pm_client3




right click on folder and go to properties->sharing
click advanced
check share this folder
click permissions
for everyone check full control

click ok, click done

under password protection click link "network and sharing center"

turn off password protected sharing

----------------------------------
easy way...

right click on folder and go to properties->sharing
click advanced
check share this folder
click permissions
for everyone check full control
click ok, click ok

click share then add everyone with full control

under password protection click link "network and sharing center"

turn off password protected sharing











------------------------------------------------------------------------------
quite often client will not connect first time, then scan and scan fails
on the server it says 'connection received' everytime

what if i waited longer...
changed try delay to 20 from 10



------------------------------------------------------------------------------








---------------------

testing netplay again

4230j is server
mi3 is client


server skipped a few frames
client skipped a lot...why???

it is not working good at all....


---------------------------------------------------
what are the different type of netplay errors and what do they mean?
did a bunch of documening in netplay.txt
---------------------------------------------------



---------------------------------------------------
test increasing CONTROL_LEAD_FRAMES
---------------------------------------------------
with 7 i get a lot less errors
but its mostly unplayable


---------------------------------------------------
test putting multiple blits in get_new_background
---------------------------------------------------

have to disable draw skip...

ran for 10s

with 10 blits on mi3   - uses .49% in draw background
with 10 blits on mi3   - uses .45% in draw background

with 10 blits on 4230j - uses % in draw background

shows nothing for get_background in profiles
slows down to 25fps and 25 frame skip (funny that should add up to 50 not 40)
removed on 4230 and it runs very fast...

ran profiler with only 1 and got .07%

i don't know why...???

5 fs=20 fr=40
6 fs=40 fr=40
7 fs=36 fr=36
8 fs=32 fr=32
9 fs=29 fr=29
10 fs=25 fr=25





-----------------------------------------------------------------
how about if cysnc errors occur on the client (that where they're bad)
have the client replay everything

this should be very fast, if you don't draw....

I'm not sure my method of running the game while syncing or catching up is right.

Why don't I:

- catch up on game moves (like I do, but show what's going on.)
- catch the game up to there with no drawing


void race_to_passcount(int passcount)
{
  need to load level and setup shit...



modify current loop...

use global value
int race_to_passcount;

if rtp dont draw anything and no frame_delay and no packet processing or input, just game move


---------------------------------------

in logging if c rx sdat with 0 moves no error...done


clean up debug display.....done

show fps on debug screen...done

clean up moves loading screen...done

---------------------------------------------------------------------------------------
here's a thought, instead of messing with the timer to chase, how about skip the draw
---------------------------------------------------------------------------------------

now look at your max fps....

looks like it goes to 7000 at least...set some bounds checking in 2nd place
maybe it wasn't...i was looking before the bounds check....

now set in both places to 3000...done
still goes out of sync...


what if I disable the FPS adjusting shit temporarily....

its all in client...i think




----------------------------------------------------------------------

I have screwed something up and now the game goes out of sync

I tried going back, but I can;t make it work

server and client good

when client quits and comes back (either from menu or new start, level is different)






------------------------------------------------------------------------
20171118 (sat)

I am going to figure out why the game is not sysncing anymore....

server: 4230j
client: mi3
level:7

ran server and played for 10s

when client joined immediately had 27 cs errors

the server lost track of what client aleady had and sent again

right about when the player went active...


changed this back.....that fixed it!!!!

//   for (int x=game_move_entry_pos; x>game_move_entry_pos-20; x--)  // only look back 20 steps at most
   for (int x=game_move_entry_pos; x>0; x--)  // only look back 20 steps at most


-----------------------------------------------------------------
make a screen notification for player joining or leaving the game
-----------------------------------------------------------------
done...
uses
int show_player_join_quit_timer = 0;
int show_player_join_quit_player = 0;
int show_player_join_quit_jq = 0;
and

void show_player_join_quit(void)
{
   show_player_join_quit_timer--;
   int jq = show_player_join_quit_jq;
   int p = show_player_join_quit_player;
   int color = players[p].color;

   int stretch = (SCREEN_W / 200) - 1; // (SCREEN_W / text length*8) -1

   if (jq) sprintf(msg, "Player %d joined the game!", p);
   else    sprintf(msg, "Player %d left the game!", p);
   rtextout_centre(scrn_buffer, msg, SCREEN_W/2, SCREEN_H/3, color, stretch, 0);
}
called from draw top_display like:
if (show_player_join_quit_timer) show_player_join_quit();

in "void proc_game_move(void)"
these are set...

                  show_player_join_quit_timer = 80;
                  show_player_join_quit_player = p;
                  show_player_join_quit_jq = 0;


here is some code where i figured out how to strecth in and out the message:


//   sprintf(msg, "ratio %f", ratio);
//   rtextout_centre(scrn_buffer, msg, SCREEN_W/2, SCREEN_H-400, color, 3, 0);

/*

   // scale is already a float

   // here is what i want

  when ratio < .3

  when ratio > .7


   if (ratio < .3)
   {
        float sa = .3 - ratio;  // starts at 0 and increases to .3
        stretch -= sa;
   }


   sprintf(msg, "ratio %f", ratio);
   rtextout_centre(scrn_buffer, msg, SCREEN_W/2, SCREEN_H-400, color, 3, 0);

   if ((ratio > .9) && (ratio <=  1)) stretch -=3;
   if ((ratio > .8) && (ratio <= .9)) stretch -=2;
   if ((ratio > .7) && (ratio <= .8)) stretch -=1;


   if ((ratio > .2) && (ratio <= .3)) stretch -=1;
   if ((ratio > .1) && (ratio <= .2)) stretch -=2;
   if ((ratio >  0) && (ratio <= .1)) stretch -=3;

*/



/*
   if (ratio > .7)
   {



     float sa = (.3 - ratio) * 3 * stretch;   // starts at 0 and increases max stretch
     stretch = sa;
*/
/*
        float old_stretch = stretch;

        float sa = 1 - ratio;             // starts at 0 and increases to .3
        float sa2 = sa * 3;                // starts at 0 and increases to .9
        float sa3 = sa2 * stretch;         // scale it to the max stretch 0-stretch
        stretch = sa3;

        printf("ratio:%1.2f  os:%1.2f ns:%1.2f sa:%1.2f sa2:%1.2f sa3:%1.2f, t:%d\n",
                ratio, old_stretch, stretch, sa, sa2, sa3, t);




}


   if (ratio < .3)
   {

      float sa = (.3 - ratio) * 3 * stretch;   // starts at 0 and increases max stretch
      stretch -= sa;




        float old_stretch = stretch;
        float sa = .3 - ratio;             // starts at 0 and increases to .3
        float sa2 = sa * 3;                // starts at 0 and increases to .9
        float sa3 = sa2 * stretch;         // scale it to the max stretch 0-stretch
        stretch -= sa3;

        printf("ratio:%1.2f  os:%1.2f ns:%1.2f sa:%1.2f sa2:%1.2f sa3:%1.2f  \n",
                ratio, old_stretch, stretch, sa, sa2, sa3);

   }
*/




and this is what it all boils down to: 3 lines

   if (ratio > .7) stretch =   (1 - ratio) * 3 * stretch;
   if (ratio < .3) stretch -= (.3 - ratio) * 3 * stretch;
   if (stretch < .1) stretch = .1;



i have re done it again to add ypos moving


   float ratio = (float)t / 80;
//   if (ratio > .7) stretch =   (1 - ratio) * 3 * stretch;
//   if (ratio < .3) stretch -= (.3 - ratio) * 3 * stretch;

   int y_pos = SCREEN_H/3;

   if (ratio > .7)
   {
        float ra1 = 1 - ratio;             // starts at 0 and increases to .3
        float ra2 = ra1 * 3.33;                // starts at 0 and increases to .999

        stretch =  ra2 * stretch;
        y_pos = y_pos - 80 + ra2 * 80;


/*        float sa = 1 - ratio;             // starts at 0 and increases to .3
        float sa2 = sa * 3;                // starts at 0 and increases to .9
        float sa3 = sa2 * 80;         // scale it to the max stretch 0-stretch

        y_pos = y_pos - 80 + (1 - ratio) * 3.3 * 80;
*/
   }


   if (ratio < .3)
   {
        float ra1 = .3 - ratio;                // starts at 0 and increases to .3
        float ra2 = ra1 * 3.33;                // starts at 0 and increases to .999

        stretch -=  ra2 * stretch;
        y_pos += ra2 * 80;

//      stretch -= (.3 - ratio) * 3 * stretch;
//      y_pos +=  (.3 - ratio) * 3.3 * 80;


   }




   if (stretch < .1) stretch = .1;



   if (jq) sprintf(msg, "Player %d joined the game!", p);
   else    sprintf(msg, "Player %d left the game!", p);
   rtextout_centre(scrn_buffer, msg, SCREEN_W/2, y_pos, color, stretch, 0);




final result...


   float stretch = ((float)SCREEN_W / 200) - 1; // (SCREEN_W / text length*8) -1
   float ratio = (float)t / 80;
   int y_pos = SCREEN_H/3;
   int y_pos_move = 80;


   if (ratio > .7)
   {
        float ra1 = 1 - ratio;                 // starts at 0 and increases to .3
        float ra2 = ra1 * 3.33;                // starts at 0 and increases to .999
        stretch =  ra2 * stretch;
        y_pos = y_pos - y_pos_move + ra2 * 80;
   }
   if (ratio < .3)
   {
        float ra1 = .3 - ratio;                // starts at 0 and increases to .3
        float ra2 = ra1 * 3.33;                // starts at 0 and increases to .999
        stretch -=  ra2 * stretch;
        y_pos += ra2 * y_pos_move;
   }

   if (stretch < .1) stretch = .1;

   if (jq) sprintf(msg, "Player %d joined the game!", p);
   else    sprintf(msg, "Player %d left the game!", p);
   rtextout_centre(scrn_buffer, msg, SCREEN_W/2, y_pos, color, stretch, 0);


finally am i done with this????



-----------------------------------------------------------------
players health is not showing
-----------------------------------------------------------------
made the function draw_percent_bar take an extra varibale ALLEGRO_BITMAP *
so it can draw on the level_buffer for player draw
and on the screen buffer for top display...
done


-----------------------------------------------------------------
no sound when players hit with player bullets...
-----------------------------------------------------------------
done

-----------------------------------------------------------------
-----------------------------------------------------------------

sync is working a lot better.....

also i have clf set to 7....

maybe i could do something with the proc_game_move to check for passcount
so it doesn't search all the way to the start...
do i really need to do this?

maybe, every passcount, every player searches back to the start....
leave it for now....


--------------------------------------------





-----------------------------------------------------------------
when a player becomes active, the server forgets its game_moves position and sends it all over again
-----------------------------------------------------------------
is it: "init_player_before_level_entry(p);"

yes al_fixed that by making another similar
"void init_player_before_netplay_becoming_active_entry(int p)"

that doesn't clear:
//   players[p].game_move_entry_pos = 0; // server only  ( for client game_move data sync )
//   players[p].server_last_sdat_sent_frame = 0; // only server uses it, to keep track of when last sdat was sent to client

-----------------------------------------------------------------



with clf set to 5 i get clf errors more often

checking the logs, it lloks like sometime cync just get to zero...

what if a i made a function to show statistics of csync
like histogram...how many at each value
average
min
max

this is on the client...

in cs_hist[100];

for (int c=0; c<100; c++) cs_hist[c] = 0; // clear

int cs = players[p].c_sync;

if ((cs > -10) && (cs < 90)) cs_hist[cs+10]++;


-------------------------
int cs_hist[10000][2]



---------------------------------------------------------------
once when sync was lost late into a netgame with a few client join and re-joins
---------------------------------------------------------------
CLF = 5

client csync hit a -1
at the same time on the server, in a single frame: 6603

and one had c_sync of 7

server:
6600] tx sdat  to  p:3 start:1370  number of entries:2
[6600] rx sdak from p:3  nep:1371  client passcount:6599
[6600] rx sdak from p:3  nep:1372  client passcount:6599
[6600] rx sdak from p:3  nep:1372  client passcount:6599
[6600] rx cdat from p:3 move: 1 pc:6604 c_sync:4
[6601] tx sdat  to  p:3 start:1372  number of entries:1
[6602] tx sdat  to  p:3 start:1372  number of entries:1
[6603] tx sdat  to  p:3 start:1372  number of entries:1
[6603] rx sdak from p:3  nep:1372  client passcount:6601
[6603] rx cdat from p:3 move: 0 pc:6606 c_sync:3
[6603] rx sdak from p:3  nep:1373  client passcount:6603
[6603] rx sdak from p:3  nep:1373  client passcount:6603
[6603] rx cdat from p:3 move: 6 pc:6608 c_sync:5
[6603] rx cdat from p:3 move: 4 pc:6610 c_sync:7
[6604] tx sdat  to  p:3 start:1373  number of entries:3
[6605] tx sdat  to  p:3 start:1373  number of entries:3
[6606] tx sdat  to  p:3 start:1373  number of entries:3
[6607] tx sdat  to  p:3 start:1373  number of entries:3
[6608] tx sdat  to  p:3 start:1373  number of entries:3
[6608] rx sdak from p:3  nep:1373  client passcount:6606
[6608] rx cdat from p:3 move: 0 pc:6611 c_sync:3

client:
[6605] tx cdat - move: 4
[6606] rx sdat start:1372  number of entries:1 [skipping]
[6606] tx sdak nep  :1373
[6606] tx cdat - move: 0
[6607] rx sdat start:1373  number of entries:3 [entering]
entering move:1373 -- pc:6606 type:5 d1: 3 d2: 0--entered:frame lead:[-1] <--- [ERROR!]
[6607]--[error!!!] entering pc:6606 less than passcount:6607
entering move:1374 -- pc:6608 type:5 d1: 3 d2: 6--entered:frame lead:[1]
entering move:1375 -- pc:6610 type:5 d1: 3 d2: 4--entered:frame lead:[3]
[6607] tx sdak nep  :1376
[6607] rx sdat start:1373  number of entries:3 [skipping]
[6607] tx sdak nep  :1376
[6607] rx sdat start:1373  number of entries:3 [skipping]
[6607] tx sdak nep  :1376

---------------------------------------------------------------
---------------------------------------------------------------


---------------------------------------------------------------
once when sync was lost early into netgame with only 1 client join
---------------------------------------------------------------


client had a lot of low csync then finally a few bad ones...

[1405] tx cdat - move: 6
[1406] rx sdat start:162  number of entries:1 [entering]
[1406] entering move:162 -- pc:1408 type:5 d1: 1 d2:38--entered:frame lead:[2]
[1406] tx sdak nep  :163
[1407] rx sdat start:162  number of entries:2 [entering]
[1407] entering move:162 -- pc:1408 type:5 d1: 1 d2:38--entered:frame lead:[1]
[1407] entering move:163 -- pc:1410 type:5 d1: 1 d2: 6--entered:frame lead:[3]
[1407] tx sdak nep  :164
[1408] rx sdat start:163  number of entries:1 [skipping]
[1408] tx sdak nep  :164
[1409] rx sdat start:163  number of entries:1 [skipping]
[1409] tx sdak nep  :164
[1409] tx cdat - move: 38
[1411] rx sdat start:164  number of entries:1 [entering]
[1411] entering move:164 -- pc:1414 type:5 d1: 1 d2:38--entered:frame lead:[3]
[1411] tx sdak nep  :165
[1412] rx sdat start:164  number of entries:1 [skipping]
[1412] tx sdak nep  :165
[1412] tx cdat - move: 6
[1413] rx sdat start:164  number of entries:1 [skipping]
[1413] tx sdak nep  :165
[1415] tx cdat - move: 4
[1416] rx sdat start:165  number of entries:1 [entering]
[1416] entering move:165 -- pc:1417 type:5 d1: 1 d2: 6--entered:frame lead:[1]
[1416] tx sdak nep  :166
[1416] tx cdat - move: 36
[1417] rx sdat start:165  number of entries:1 [skipping]
[1417] tx sdak nep  :166
[1418] rx sdat start:165  number of entries:2 [entering]
[1418] entering move:165 -- pc:1417 type:5 d1: 1 d2: 6--entered:frame lead:[-1] <--- [ERROR!]
[1418]--[error!!!] entering pc:1417 less than passcount:1418
[1418] entering move:166 -- pc:1420 type:5 d1: 1 d2: 4--entered:frame lead:[2]
[1418] tx sdak nep  :167
[1418] tx cdat - move: 4
[1419] rx sdat start:166  number of entries:2 [entering]
[1419] entering move:166 -- pc:1420 type:5 d1: 1 d2: 4--entered:frame lead:[1]
[1419] entering move:167 -- pc:1421 type:5 d1: 1 d2:36--entered:frame lead:[2]
[1419] tx sdak nep  :168
[1419] tx cdat - move: 1
[1420] rx sdat start:166  number of entries:2 [skipping]
[1420] tx sdak nep  :168
[1421] rx sdat start:167  number of entries:2 [entering]
[1421] entering move:167 -- pc:1421 type:5 d1: 1 d2:36--entered:frame lead:[0] <--- [WARNING!]
[1421]--[warning!!!] entering pc:1421 same as passcount:1421


server:

[1406] rx sdak from p:1  nep:162  client passcount:1404
[1406] rx sdak from p:1  nep:162  client passcount:1405
[1406] rx cdat from p:1 move: 6 pc:1410 c_sync:4
[1407] tx sdat  to  p:1 start:162  number of entries:2
[1407] rx sdak from p:1  nep:163  client passcount:1406
[1408] tx sdat  to  p:1 start:163  number of entries:1
[1409] tx sdat  to  p:1 start:163  number of entries:1
[1409] rx sdak from p:1  nep:164  client passcount:1407
[1410] rx sdak from p:1  nep:164  client passcount:1408
[1410] rx sdak from p:1  nep:164  client passcount:1409
[1410] rx cdat from p:1 move:38 pc:1414 c_sync:4
[1411] tx sdat  to  p:1 start:164  number of entries:1
[1412] tx sdat  to  p:1 start:164  number of entries:1
[1413] tx sdat  to  p:1 start:164  number of entries:1
[1413] rx sdak from p:1  nep:165  client passcount:1411
[1415] rx sdak from p:1  nep:165  client passcount:1412
[1415] rx cdat from p:1 move: 6 pc:1417 c_sync:2
[1415] rx sdak from p:1  nep:165  client passcount:1413
[1416] tx sdat  to  p:1 start:165  number of entries:1
[1417] tx sdat  to  p:1 start:165  number of entries:1
[1417] rx cdat from p:1 move: 4 pc:1420 c_sync:3
[1418] tx sdat  to  p:1 start:165  number of entries:2
[1418] rx sdak from p:1  nep:166  client passcount:1416
[1418] rx cdat from p:1 move:36 pc:1421 c_sync:3
[1419] tx sdat  to  p:1 start:166  number of entries:2
[1419] rx sdak from p:1  nep:166  client passcount:1417
[1420] tx sdat  to  p:1 start:166  number of entries:2
[1420] rx sdak from p:1  nep:167  client passcount:1418
[1420] rx cdat from p:1 move: 4 pc:1423 c_sync:3
[1421] tx sdat  to  p:1 start:167  number of entries:2
[1421] rx sdak from p:1  nep:168  client passcount:1419
[1421] rx cdat from p:1 move: 1 pc:1424 c_sync:3
[1422] tx sdat  to  p:1 start:168  number of entries:2
[1422] rx sdak from p:1  nep:168  client passcount:1420
[1423] tx sdat  to  p:1 start:168  number of entries:2
[1423] rx sdak from p:1  nep:169  client passcount:1421
[1424] tx sdat  to  p:1 start:169  number of entries:1
[1424] rx sdak from p:1  nep:170  client passcount:1422
[1424] rx cdat from p:1 move:33 pc:1427 c_sync:3

---------------------------------------------------------------
---------------------------------------------------------------



---------------------------------------------------------------
on client i am make csync = 0 an error, is it really?
---------------------------------------------------------------

how does the loop flow:

void read_game_step_from_packet(int x, int clf_check)
is called by

void client_control(void)
and
void client_chase_control(void)

which is called by:
void proc_controllers(

which is called from loop:

      move_lifts();
      proc_item_collison();
      proc_item_move();
      proc_lit_bomb();
      proc_lit_rocket();
      proc_player_carry();
      proc_controllers();
      player_move();
      update_animation();
      enemy_move();
      enemy_collision();
      proc_ebullets();
      proc_pbullets();


i guess i didn't need to go that far down the rabbit hole....

while still in
void proc_controllers(
the gamemove is pulled from the game array....

so i guess that means that csync 0 is not an error!!!

change this in the code and the doc..done

---------------------------------------------------------------
---------------------------------------------------------------

---------------------------------------------------------------
Can I change CONTROL_LEAD_FRAME on the fly??
like if the client gets warnings increment it?
---------------------------------------------------------------

---------------------------------------------------------------
Can I make a display like the join quit, only for player died?
---------------------------------------------------------------
or maybe reuse it?

where do I hook into the game?

void proc_player_health(void)
only sets health to zero

event(21, al_fixtoi(players[p].PX), al_fixtoi(players[p].PY), 0, 0, 0, 0);  // player death

why can't i figure out where this comes from??

it is in void proc_player_health(void)
players[p].paused = 200;
is processed in player_move
done and looking good!!!

---------------------------------------------------------------
---------------------------------------------------------------



test some more....
tested for a bit and didn't get any errors!!!

lets bring in client 2....

---------------------------
ran s7 + 2c
2nd client had cysnc errors of -1
but was also dropping frames

client2 (E6410)
[4881] rx sdat start:250  number of entries:2 [entering]
[4881] entering move:250 -- pc:4882 type:5 d1: 2 d2: 5--entered:frame lead:[1]
[4881] entering move:251 -- pc:4884 type:5 d1: 2 d2:36--entered:frame lead:[3]
[4881] tx sdak nep  :252
[4883] rx sdat start:251  number of entries:1 [skipping]
[4883] tx sdak nep  :252
[4884] rx sdat start:252  number of entries:1 [entering]
[4884] entering move:252 -- pc:4886 type:5 d1: 2 d2: 4--entered:frame lead:[2]
[4884] tx sdak nep  :253
[4886] rx sdat start:252  number of entries:2 [entering]
[4886] entering move:252 -- pc:4886 type:5 d1: 2 d2: 4--entered:frame lead:[0] <--- [WARNING!]
[4886] entering move:253 -- pc:4887 type:5 d1: 2 d2: 6--entered:frame lead:[1]
[4886] tx sdak nep  :254
[4886] rx sdat start:252  number of entries:2 [skipping]
[4886] tx sdak nep  :254
[4888] rx sdat start:253  number of entries:2 [entering]
[4888] entering move:253 -- pc:4887 type:5 d1: 2 d2: 6--entered:frame lead:[-1] <--- [ERROR!]
[4888] entering move:254 -- pc:4890 type:5 d1: 2 d2:38--entered:frame lead:[2]
[4888] tx sdak nep  :255
[4888] rx sdat start:253  number of entries:2 [skipping]
[4888] tx sdak nep  :255
[4890] rx sdat start:254  number of entries:1 [skipping]
[4890] tx sdak nep  :255
[4890] rx sdat start:254  number of entries:1 [skipping]

if I'm not mistaken, the errors and warnings are for moves that have already been entered.....
its like a race condition

server sends 1
clinet rx 1 and sdak
server sends 2, including last one..because the sdak packet is still in transit...

the game_move array is still perfectly sync'd
because the function that enters them does not care...

al_fixed by making the function :
void read_game_step_from_packet(int x, int clf_check)

skip entering or error checking for dupliactes....

test.....working the best its ever done.....






---------------------------------------------------------------
bombs don't seem to hurt player
---------------------------------------------------------------
void proc_lit_bomb(void)

do_bomb_damage(c);

its working, but i want to debug it more
draw the lit bomb range when lit....
alredy done???

added some code in item draw to draw a rectangle around every bomb
and change the color if a player of enemy is in the range
this is working great...the bomb's damage area is perfect

now about the damage...right now the player takes 3 damage when caught in a blast.
what else can i do?

have a multiplier based on the damage size of the bomb?
have a multiplier based on the distance from the bomb?

either of those sound good....


how about damage range divided by distance???

damage range is an int from 20 to 800 and is the size of the damage box

distance can be calculate by atan or pyth

800 damage / 800 distance = 1

800 damage / 20 distance = 40

test this in item draw....

outer edges to about halfway = 1

next 1/4 in = 2

and so on

I should set a max of 4 and multiplay by 20
....done


what to do about the red and orage rectangle that show the damage?
right now they snap to the block that will be removed
that is nice but they move kind of blocky
the new draw thing i use is smoother...

keep them both on for now...



---------------------------------------------------------------
what about the collisions of enemy bullets?
---------------------------------------------------------------

re-doing that function.....


testing with arch wagon
bullet speed can be  .8 to -20

with collision box 5 a 10 bullet hits ~95%
with collision box 5 a 20 bullet hits ~50%

with collision box 6 a 10 bullet hits ~99%


This works all the time...only problem is it might be too accurate!

// new collision box is based on bullet speed and has both x and z component
al_fixed ax = abs(e_bullet_fxinc[b]);      // enemy_bullet_collision_window x
al_fixed ay = abs(e_bullet_fyinc[b]);      // enemy_bullet_collision_window y

// enforce some minimums
if (ax < al_itofix(3)) ax = al_itofix(3);
if (ay < al_itofix(3)) ay = al_itofix(3);

// check for collision with players
for (int p=0; p<NUM_PLAYERS; p++)
   if ((players[p].active) && (!players[p].paused))
   {
      al_fixed px = players[p].PX;
      al_fixed py = players[p].PY;7
      if ((x > px-ax) && (x < px+ax) && (y > py-ay) && (y < py+ay)) // did player get hit?


looks good...

when does archwagon decide to shoot? +4 -4 from players y
 temp change to 10 for bullet testing....

actually changed it to seperate upper and lower box

      int swl = 10;
      int swh = 6;
      Ei[EN][3] = 2; // wagon with arrow ans
      if (Ei[EN][2]) // attempt shoot right
         for (int p=0; p<NUM_PLAYERS; p++)
            if ((players[p].active) && (!players[p].paused) )
               if ((EXint > al_fixtoi(players[p].PX)  - Ei[EN][17]) && (EXint < al_fixtoi(players[p].PX) ))
                  if ((EYint > al_fixtoi(players[p].PY)  - swh) && (EYint < al_fixtoi(players[p].PY) + swl ))
                  {
                     fire_enemy_x_bullet(EN, EXint, EYint, p);


that seems to work good...

now test the trakbot.....and canon, all done, all look good.

check out player bullets...
proc_pbullet does not do the collision checking
A function called enemy_collision called from main loop

It gets even weirder:

If a player's bullet hits an enemy, Ei[EN][31] is set
every enemy processes this and most just die,
but cannon can get even stronger when hit

If an enemy collides with a player, Ei[EN][22] is set with p+1
Then the enemies all have a function they call:
"enemy_player_hit_proc(int EN)"
That checks the player collision hold off and applies damage to the player

---------------------------------------------------------------------------
void enemy_player_hit_proc(int EN)
is called by every? enemy procedure, why don't I move it to common?
----------------------------------------------------------------------------

all of the bullet and collision stuff seems good now
----------------------------------------------------
what about the enemy defined collision box
put in some view code for cannon and i'll test it.
it works exactly like it should, how ever, i think that most
enemies shoud all have 10 set...
cannon should increase when bigger...done

now, if the collison box is bigger they should be easier to hit also!!!
done....

check and see what cbs are in a level....

type 9 (cloner)   are all zero
type 7 (podzilla) are all zero

I could fix this in PDE...do it...done but its still bad
must be hard coded into the creators.....done...


an interesting side effect of these changes, if the collision box is set to zero
the enemy cannot be killed by a bullet




--------------------------------------------------------
how much damage do enemies and bullets do to the player?
--------------------------------------------------------
each bullet type has a al_fixed damage

each enemy has a health decrement (0-10) that occur when player touches it
the hold off till player can get hurt again is 60 (hardcoded into program



---------------------------------------------------------
why cant the player navigate small openings anymore?
----------------------------------------------------------

I think if the player snapped to wall when moving up against them that might help.

when moving right x_pos stops at 8 9 0
when moving left  x_pos stops at 7 8 9 0 1

made that work awesome

now fix when moving up and hitting ceiling
finally all the player moving with blocks is good

how about player on a fast sproingy not getting blasted through bricks???
tested good!!!!!!

how about player with a fast rocket hitting wall in all directions....
sticks a little in the wall but can get out OK

what does a player riding a rocket do when hitting items??

works:
bonus
message
key
bomb
rocket
mine
exit

does not work:
door

does not work cause you need to fall on it:
sproingy
switch




now how about player with lifts....

cases:



player riding lift..good

player riding up   and hitting ceiling solid...good
player riding down and hitting ceiling solid...good

player riding up   and hitting ceiling semi..good
player riding down and hitting ceiling semi..good


---------------------------------------------------------------------
player riding lift up and hitting another lift going up slower
- if player is going up and hits lift above, will be knocked through
---------------------------------------------------------------------


---------------------------------------------------------------------
player riding lift up and another faster lift passes through going up
 - player will stay on lift with lower #
---------------------------------------------------------------------

-----------------------------------------------------------------------
player riding a lift down passing another lift
 - player will stay on lift with lower #
-----------------------------------------------------------------------


-----------------------------------------------------------------------
player riding up to 1 block directly below a ceiling
- player does not fall off
-----------------------------------------------------------------------


-----------------------------------------------------------------------
player being pushed left and right by a lift
done goodly
----------------------------------------------------------------------


-----------------------------------------------------------------------------------
Did you know there is also code in move_lifts, related to player ride?????
lets see if I can get rid of it....or move it to player move
-----------------------------------------------------------------------------------



      // check if player riding this lift
      for (int p=0; p<NUM_PLAYERS; p++)
         if (players[p].active)
            if (d == players[p].player_ride-32)
            {
               // moving right
               if ((lifts[d]->fxinc > al_itofix(0)) && (!is_right_solid(al_fixtoi(players[p].PX), al_fixtoi(players[p].PY))) )
                  players[p].PX  += lifts[d]->fxinc;
               // moving left
               if ((lifts[d]->fxinc < al_itofix(0)) && (!is_left_solid(al_fixtoi(players[p].PX), al_fixtoi(players[p].PY) )) )
                  players[p].PX  += lifts[d]->fxinc;
               // align with fy
               players[p].PY  = lifts[d]->fy - al_itofix(28); // align with fy
          }

when disabled they player falls through the lift from above

try to put it in player_move....look like I got it...done


-----------------------------------------------------------------------
when you walk off the edge of a lift you start falling fast, not like regular falling
----------------------------------------------------------------------

when you are riding a lift your yinc climbs to max....

i reset it when you fall off but that's not good enough...


seperate out the cases in player move so that

- riding lift does all its own checks???

right now x move checks are done by riding lift and regular x move
can that be simplified??? no...
actually the riding lift part moves the player because he is riding a lift
the regular part deals with the player running into of being pushed by a lift


player is falling...
player starts riding lift between 4 and 5
has y inc

it was a snap to bug....

well I redid lots of the move player code...and its as good as it can fet for now

can't break away when being pushed right by a lift....
edited the snap to thing and its good now....


----------------------------------------------------------------------
just as a lark, what if I draw a rect in players color around the lift player is riding....
----------------------------------------------------------------------
very easily done and looks cool....done........


-----------------------------------------------------------------------
Change exit all dead to have an amount of dead that you need to get below
-----------------------------------------------------------------------

right now its and int called all dead

 if ( (item[x][8]) && (num_enemy) ) event(3, itx, ity, 0, 0, 0, 0); // not all dead yet

change it to the number of enemy that can be left alive...

0 = all dead
1 = 1 still alive...etc



made a new entry in int edit_int_slider
case 47: sul=100;  sll=0; sinc=1;  sdx=item[num][8]; break;  // exit with x enemies left

added a new entry in:
void fill_smsg(int bn, int num)
if (bn == 47) sprintf(smsg, "Exit with %d enemies left",item[num][8]);

added new entry in:
void update_var(int bn, int num, float f)
if (bn == 47) item[num][8] = (int)f;

modified:

void edit_item
            case 3: // exit
               new_button(xa, ty+((a+1)*bts), xb, ty+((a+2)*bts)-2, 26, num, type, obt, 0,15,13,14,0,0,0,0);

// need to replace this button
//               new_button(xa, ty+((a+2)*bts), xb, ty+((a+3)*bts)-2, 3, num, type, obt, 0,15,13,14,0,0,0,0);


// with a slider like this
               edit_int_slider(xa, ty+(a+2)*bts, xb, ty+((a+3)*bts)-2, 47, num, type, obt, 0,12,0,11,0,0,0,0);
               a += 3;


done...........and working......



go the fuck to bed......saved snapshot....20171119 really late at night



------------------------------------------------------------------------

run some netgame tests....


-----------------------------------------------------------------------------------
lift bug - when jump and hitting lift from side in level 12, player is snapped weirdly
-----------------------------------------------------------------------------------

seems to only occur when hitting lift on right side...
seems to only occur when hitting a lift with x size more than 1
i think i am checking for a collision with the wrong side!!!
actually I snapping to the left side + 21,
to fix it now I am snapping to left side + width
done.....




-----------------------------------------------------------------------------------
lift bug, single step lift crashes hard when player touches it
------------------------------------------------------------------------
game crashed hard.....again
maybe its my fancy single step lift...

and then it doesn't????

sometimes crashes when load level




-----------------------------------------------------------------------------------
exiting podzilla cannot be killed, use glt to fix
-----------------------------------------------------------------------------------

glt found 276 cloners and podzilla total

when I looked for any enemy with cbs != 10 I only got 180 matches
any nothing that wasn't a cloner or podzilla....

OK I'm ready to make the switch....set them all to 10!!
It has been done......

-----------------------------------------------------------------------------------
While I am at it I should fix the exits in glt also
-----------------------------------------------------------------------------------
item[x][0] = 3 // exit

old method
item[x][8] all dead (0) = no

new method
old ones that have 0 should be set to 100
old ones that have 1 should be set to 0

found 44 reg and 22 all dead
ready to convert.....done


-----------------------------------------------------------------------------------
i should set up some test levels to make sure everything keeps working
-----------------------------------------------------------------------------------


-----------------------------------------------------------------------------------
error reading items in level001 !!!!
-----------------------------------------------------------------------------------
I did a paste from disk to level001 and saved it and now I get error when I try to open it
reproduce...
restore level...paste from file again...save and quit level...all good...???




-----------------------------------------------------------------------------------
What kills lift lines
-----------------------------------------------------------------------------------
bombs - good
switches - good
keys - good
bombable blocks - good

breakable blocks - hit by pbullet ...not good - al_fixed
breakable blocks - hit by ebullet ...not good - al_fixed



--------------------------------------------------------------
Need to make a bunch of things changeable from within the game
And also store them in the config file
--------------------------------------------------------------
int deathmatch_pbullets = 1;
int suicide_pbullets = 1;
float scale_factor = 1;

debug overlay

etc...



--------------------------------------------------------------

back to netplay testing....

level 12

server: 4230j
client1: mi3
client2: E6410
played till timer said 1200
game moves:4000

clients could both rejoin at the end


zaiden and played a few game and everything worked good
he was on the server and I was on mi3

4230j lost sync at some point, but we weren't looking


--------------------------------------------------

I want some way to get the levels in a good order.

Make a group of levels?

Make a master playlist of a group of levels??

What I don't want to do i spend time renaming and re-sorting levels

How about in game menu, I use the shift key to go +/- 10 levels
and the alt key to go +/- 100 levels
done

------------------------------------------------------------------------------------------
On game menu "Start Level" press the left and right arrow keys to set the starting level
Hold SHIFT to move 10 levels at a time or CONTROL to move 100 levels at a time.
-------------------------------------------------------------------------------------------

put the best finished levels at 200 and up

but how am I going to do that?  manualy renaming them??

Make a level shuffler thing in your game editor code.

It needs to be meta, not store in the game code or in a level, but somewhere else.


Imagine a list of levels that can be scrolled down.

Each entry will have a picture of the level, and a text blurb about the level contents
kind of like what I have in the game menu...:)

maybe more like a grid

and you can resize the grid

then you can drag and drop to rename levels

you can see which ones are blank

say your display is 2000x1000 and each map is 100x100 (20x10) grid

OK, im going to do this...
-----------------------------------------------------------------------------------------
I made an awesome level viewer and mover....
It's in its own source file called e_lev.cpp (170 lines)
-----------------------------------------------------------------------------------------

time for a new snapshot.....before I start messing with the levels....

20171120


I'm going to put all of my finished levels from 201 on wards
testing
201-good
202-good

208-good


I'm going to put all my other levels like
beginning demo levels
unfinished ideas
at 140 and up...

Test levels and other random stuff from 360 up.



------------------------------------------------------------
what if i made a file select routine that looked like lev?
------------------------------------------------------------
int level_select_dialog(void)...done...sweet


----------------------------------------------------------------
fix exit display about number of enemies left
---------------------------------------------------------------
done

------------------------------------------------------------------------
make everything that changes the play_level, save it in the config file
------------------------------------------------------------------------
set_start_level(start_level); done in a bunch of places....
done
how about when starting the level editor from command line...good
how about when choosing level with gui from command line...good
how about when starting level from command line...good

what else do I have....

maybe, its just when sometimes the game is started and it doesn't show the
current start level, but when you go to change it at was actually there...?

when level editor starts from command line...done



---------------------------------------------------------------
when setting the fuse length on bombs, it used to be set to 200 max
i wanted a really long bomb so i changed the upper limit to 2000 in sliders
and now i cant set any smaller resolution than about 8
---------------------------------------------------------------










---------------------------------------------------------------
when editing lifts, inserting a new lift step is very bad!!
---------------------------------------------------------------






-----------------------------------------------
pod creator does not leave pod with proper rotation
but changing rotation in pod editor does
--------------------------------------------------------

its because it uses   int get_rot_from_xyinc(int EN)
which I have modified in the game to used al_fixed point...

i don't know if I want to spend all the time replacing floats in the editor

int get_rot_from_xyinc(int EN)
{
   al_fixed xlen = Efi[EN][2];
   al_fixed ylen = Efi[EN][3];
   al_fixed angle = fixatan2(ylen, xlen);
   return al_fixtoi(angle) - 64;
}

int e_get_rot_from_xyinc(int EN) // modified version for the editor only which still uses floats
{
   al_fixed xlen = al_ftofix(Ef[EN][2]);
   al_fixed ylen = al_ftofix(Ef[EN][3]);
   al_fixed angle = fixatan2(ylen, xlen);
   return al_fixtoi(angle) - 64;
}


done......




---------------------------------------------------
still have some player issues...
look at level 204


---------------------------------------------------
player does funny things in semi solid block, like snapping to edges, etc.
---------------------------------------------------


---------------------------------------------------
player can be pushed sideway into solid blocks, by lifts...
-------------------------------------------------------


make a test level

copy a level to 390...started claering sections, then game borked hard

now I can't load or run level 390, borks hard


maybe I need to fix the lift bullshit first....

here's how to reproduce the error....

got to level 361 in level editor
save as level 390
erase some lifts
save level
zoom full screen

then it borks and any loading of that level borks...

S level viewer in level editor to show lift types...done

turn on the error checking in load level...


it borks at the reading lifts part...


level 361 has first lift named 'lift' and the last ste is a type 0 (which should not exist)

I could run glt and get a lots of data on lifts
-check to see if I have other illegal steps
-check to see if the number of steps is the same as what it says in the header (dumb, of course it will...)



what if I replace the dynamic creating of lifts with static, like I do with everthing else...

for example

lift now has text and 4 ints ingore text for now

50 lifts x 4 = 200
each lift with 50 steps...
total 54 * 200 = 10,800

50 lifts x 4 = 200
500 shares lift steps = 2000
total 2200



level 208 has 3 lifts and it dies after showing first lift...

can't view is with glt or S or lift viewer
lift 1 has 2 loop to zero at the end

when I switch to lift 2 borks

I can run the level fine
all lifts work

I can view all three lifts in lift viewer now ???

in glt lift 0 has 11 steps
prints up to 2nd to last step then doesn't print last step (10)

lift viewer shows 11 steps, but the last 2 are both step 9 (move to zero)

cant view with S, dies at the same place...

made more detailed step display...it dies because last step is all borked
and the text description fails...



what does this mean and how can i fix it???

run glt without the type display and count illegal steps...

i get 7 bad steps....

now how about only display bad stuff in glt...






does every lift have 40 steps?
does it have an array of 40 pointers to lift steps?


it looks ure like I have an array of 40 pointer to lifts

and an array of pointers 40 x 40 for lift steps

remind me why i did it this way again?

I use 40 + 160 = 200 pointers to things
then i dynamically create them as neccesary.

why don't i just have the arrays of real data statically created...


use the same sizes

40 lift with 40 step available for each






I can still use the structure that I already have
just modify it...


declare will change from:

struct lift
   {
      al_fixed fx;
      al_fixed fy;
      al_fixed fxinc;
      al_fixed fyinc;
      int x1;
      int y1;
      int x2;
      int y2;
      int width;
      int height;
      int color;
      int current_step;
      int num_steps;
      int limit_counter;
      int limit_type;
      char* lift_name;
   };
extern struct lift *lifts[40];
struct lift_step
   {
      int type;
      int val;
      int x;
      int y;
   };
extern struct lift_step *lift_steps[40][40];




        to:



struct lift
   {
      al_fixed fx;
      al_fixed fy;
      al_fixed fxinc;
      al_fixed fyinc;
      int x1;
      int y1;
      int x2;
      int y2;
      int width;
      int height;
      int color;
      int current_step;
      int num_steps;
      int limit_counter;
      int limit_type;
      char* lift_name;
   };
extern struct lift lifts[40];
struct lift_step
   {
      int type;
      int val;
      int x;
      int y;
   };
extern struct lift_step lift_steps[40][40];


in main from:

int num_lifts;
struct lift *lifts[40];
struct lift_step *lift_steps[40][40];

to:
int num_lifts;
struct lift lifts[40];
struct lift_step lift_steps[40][40];



            what about the text...

            that needs to change from

                 char* lift_name;

                 to char lift_name[40]




            i think that everywhere lifts and lift_steps are
            referred to in code will not have to change





the code in construct lift and step could be modified...like this

old:
int construct_lift(int l,char* lift_name,int width,int height,int color,int num_steps)
{
   //  allocate new lift
   int ret = 0;
   if ((lifts[l] = (struct lift*) malloc(sizeof(struct lift)))) ret = 1;

   //  allocate space for string
   lifts[l] -> lift_name = (char*) malloc(strlen(lift_name)+1);
   strcpy(lifts[l] -> lift_name, lift_name);

   lifts[l] -> width = width;
   lifts[l] -> height = height;
   lifts[l] -> color = color;
   lifts[l] -> num_steps = num_steps;

   lifts[l] -> x1 = 0;
   lifts[l] -> y1 = 0;
   lifts[l] -> x2 = 0;
   lifts[l] -> y2 = 0;
   lifts[l] -> current_step = 0;
   lifts[l] -> limit_type = 0;
   lifts[l] -> limit_counter = 0;
   return ret;
}

new:
int construct_lift(int l,char* lift_name,int width,int height,int color,int num_steps)
{
   strcpy(lifts[l]->lift_name, lift_name);

   lifts[l]->width = width;
   lifts[l]->height = height;
   lifts[l]->color = color;
   lifts[l]->num_steps = num_steps;

   lifts[l]->x1 = 0;
   lifts[l]->y1 = 0;
   lifts[l]->x2 = 0;
   lifts[l]->y2 = 0;
   lifts[l]->current_step = 0;
   lifts[l]->limit_type = 0;
   lifts[l]->limit_counter = 0;
   return 1
}

old:
void destroy_lift(int lift)
{
   if (lifts[lift] != NULL)  // only free if non null pointer
   {
      // first free the string
      free(lifts[lift] -> lift_name);
      // then free the lift structure
      free(lifts[lift]);
   }
}
new:
void destroy_lift(int l)
{
   lifts[l]->width = 0;
   lifts[l]->height = 0;
   lifts[l]->color = 0;
   lifts[l]->num_steps = 0;
   lifts[l]->x1 = 0;
   lifts[l]->y1 = 0;
   lifts[l]->x2 = 0;
   lifts[l]->y2 = 0;
   lifts[l]->current_step = 0;
   lifts[l]->limit_type = 0;
   lifts[l]->limit_counter = 0;
   strcpy(lifts[l]->lift_name, "");
}





old:
int construct_lift_step(int lift, int step, int x, int y, int val, int type)
{
   int ret = 0;
   if ((lift_steps[lift][step] = (struct lift_step*) malloc(sizeof(struct lift_step)))) ret = 1;
   lift_steps[lift][step] -> x    = x;
   lift_steps[lift][step] -> y    = y;
   lift_steps[lift][step] -> val  = val;
   lift_steps[lift][step] -> type = type;
   return ret;
}
new:
int construct_lift_step(int lift, int step, int x, int y, int val, int type)
{
   lift_steps[lift][step]->x    = x;
   lift_steps[lift][step]->y    = y;
   lift_steps[lift][step]->val  = val;
   lift_steps[lift][step]->type = type;
   return 1;
}


old:
void destroy_lift_step(int lift, int step)
{
   if (lift_steps[lift][step] != NULL)
      free(lift_steps[lift][step]);
}

new:
void destroy_lift_step(int lift, int step)
{
   lift_steps[l][a]->x    = 0;
   lift_steps[l][a]->y    = 0;
   lift_steps[l][a]->val  = 0;
   lift_steps[l][a]->type = 0;
}






old:
void erase_lift(int lift)
{
  // erase the lift
   destroy_lift(lift);

   for (int a=0; a<40; a++) destroy_lift_step(lift, a);

   // slide down to close hole in pointer array
   for (int a=lift; a<num_lifts; a++)
   {
      lifts[a] = lifts[a+1];
      for (int b=0; b<40; b++)
         lift_steps[a][b] = lift_steps[a+1][b];
   }

   // set last lift pointer to NULL
   lifts[num_lifts] = NULL;

   // set the lift steps to NULL ?? WTF is this fuckery?

   for (b=0; b<40; b++)
      lift_steps[num_lifts][b] = NULL;

   // one less lift
   num_lifts--;
}


new:
void erase_lift(int lift)
{
   // slide down to close hole in array
   for (int a=lift; a<num_lifts; a++)
   {
      lifts[a] = lifts[a+1];
      for (int b=0; b<40; b++)
         lift_steps[a][b] = lift_steps[a+1][b];
   }

   // erase last lift
   destroy_lift(num_lifts);

   // erase last lift's steps
   for (int a=0; a<40; a++)
      destroy_lift_step(num_lifts, a);

   // one less lift
   num_lifts--;
}


at  line 800


old:

            // reallocate space for string
           free(lifts[current_lift] -> lift_name);
            lifts[current_lift] -> lift_name = (char*) malloc(strlen(lifts[current_lift] -> lift_name)+1);
            strcpy(lifts[current_lift] -> lift_name, fst);


new:
            strcpy(lifts[current_lift] -> lift_name, fst);




that looks like all the changes that need to be made in nlv


filecom....
save: no changes
load: calls construct lift and construct lift step
no changes needed...

should I pull the trigger and do it???

yes!!!!!


----------------------------------
still to look at...

zoom full screen...
copy and paste from sel...seems good on 4 lift copy

copy and paste from disk..seems to work good

cant paste more than 20 lifts...???
only from fsel paste...al_fixed

clear...does not clear properly
ok where is zoom full screen?
calls do_clear...
compares the x1 and y1 set in lift
then calls erase lift....

does x1 and x2 get set for sure in lifts??
show in S, they are definitely set...

what about erase...
erase changes numlifts, which is used in the iterate loop in do clear
yes that was it!....

still doesn't erase last one...

how does erase lift deal with only 1 lift?
or if last lift is erased?

erasing all works good, until done with clear then only gets the lower numbered one of 2...

with 3 the middle is left...

only does odd numbers...
i shouldn't do the sort after each removal....

how hard could that be...

found a better solution, when erasing multiple lifts, iterate the loop backward, because lifts get removed from the end...
fixed......


find all referneces to destroy_lift and replace with clear...done

---------------------------------------

-------------------------------
when leaving lift editor with ESC, trap while ESC so I don't quit level editor....done
-------------------------------

------------------------------------
should zero lift at init...done
---------------------------------





-----------------------------------------
now see if there are any bugs in lifts in the editor...
-----------------------------------------------


-----------------------------------------------
create new lift is bad, way too laggy..al_fixed
uses same function as edit "edit lift step"
-----------------------------------------------


-----------------------------------------------
when done creating lift, go immed to the lift viewer...
what calls lift creator?
PDE create...
button in lift_viewer

does create_lift return new lift # ??
no but if successful can use num_lifts -1...
done in both places...!!!
-----------------------------------------------

lets look at the inserting, deleting and moving steps....

right clicking on a step and choosing insert-
-put a new step before the chosen step...seems to work..
-insert at step 0.. seems to work
- can't insert at last position though, only second to last

maybe thats good....

I might need to enforce that step 0 is a move and that the last step is a loop to zero...
in that case I don't want to allow anything to take last place
what if I made another last step called stay here forever? later maybe...

so how about if I make it so you cant insert or delete in postion 0...only move...
done

made it so that step 0 can only choose move...done
made it so that last step does not have any pop up menu so nothing van be done to it....


make it so that move from pop_up menu snap to lift position and sets good clip rect...
when mouse goes to getxy it is on buttons...
do I need to set it when its on...?? no use position_mouse(x,y)...done
sets good clip rect...done


make it so that move from map, show the lift like the other does...done


---------------------------------------------------------------------------

I hope that makes the lift work better...
I am going to erase the bad ones detected with glt and hope I don't get any more!!!



when I erased and moved a bunch of levels, then I copied the dir to E6410 and did some editting there.

when I copied everything back from E6410 I got all the old levels that I had deleted...

now I should erase every level below 100...yes do it...

got to go to work...

20171117 7:00 AM

----------------------------

also kill 101-108 they have been moved...don




look at bad named levels


0131?? gone

033 moved to 282
036 move to 283
probably erase later...

renamed and moved them all to:

282 and up.....

erased them all...dups






erased all lifts that had errors in glt....done



now when I create a level i get step 1 which has to be a move
and step 2 loop to start

I cant insert before 1, or 2...need to fix so i can insert before 2...

fixed....


---------------------------------------------------------------------------------
I want a create mode where I can continually enter new steps, until cancelled....
---------------------------------------------------------------------------------




---------------------------------------------------------------------
cannons are not that accurate since fixed replacement....
---------------------------------------------------------------------
void fire_enemy_bulleta

- calulates the x and y distance from enemy to player
- gets the angle with atan
- uses sin and cos to get xinc and yinc

why do I even need trig?

just scale the distances....


try writing a replacement for this and check accuracy....

I will be hard to get a consistant speed....

I have done it!

Here is an awseome replacement that is more accurate:


void fire_enemy_bulleta(int EN, int EXint, int EYint, int bullet_ans, int p)
{
   extern int e_bullet_active[50], e_bullet_shape[50];
   extern al_fixed e_bullet_fx[50], e_bullet_fy[50], e_bullet_fxinc[50], e_bullet_fyinc[50];


/* old
   al_fixed xlen = abs(players[p].PX - Efi[EN][0]);
//   if (xlen == al_itofix(0)) xlen = al_ftofix(0.00001);
   al_fixed ylen = abs(players[p].PY - Efi[EN][1]);
//   if (ylen == al_itofix(0)) ylen = al_ftofix(0.00001);

*/

   al_fixed xlen = players[p].PX - Efi[EN][0];
   al_fixed ylen = players[p].PY - Efi[EN][1];
   al_fixed speed = Efi[EN][7];

/*
   // old method
   al_fixed angle = fixatan(fixdiv(ylen, xlen));
   al_fixed xinc = fixmul(fixcos(angle), speed);
   al_fixed yinc = fixmul(fixsin(angle), speed);
*/

   // new method
   al_fixed hy_dist =  fixhypot(xlen, ylen);
   al_fixed scaler = fixdiv(hy_dist, speed);

   al_fixed xinc1 = fixdiv(xlen, scaler);
   al_fixed yinc1 = fixdiv(ylen, scaler);


/*   printf("xinc:%d yinc:%d\n", xinc, yinc);
   printf("xinc:%f yinc:%f\n", al_fixtof(xinc), al_fixtof(yinc));

   printf("xinc1:%d yinc1:%d\n", xinc1, yinc1);
   printf("xinc1:%f yinc1:%f\n\n", al_fixtof(xinc1), al_fixtof(yinc1));
  */

   for (int z=0; z<50; z++)  // find empty e_bullet
      if (!e_bullet_active[z])
      {
         e_bullet_active[z] = 1;
         e_bullet_shape[z] = 1000+bullet_ans;
         e_bullet_fx[z] = al_itofix(EXint);
         e_bullet_fy[z] = al_itofix(EYint);

          // new
          e_bullet_fxinc[z] = xinc1;
          e_bullet_fyinc[z] = yinc1;


/*  old
         if (EXint <  al_fixtoi(players[p].PX)) e_bullet_fxinc[z] = +xinc;
         if (EXint >  al_fixtoi(players[p].PX)) e_bullet_fxinc[z] = -xinc;
         if (EXint == al_fixtoi(players[p].PX)) e_bullet_fxinc[z] = 0;
         if (EYint <  al_fixtoi(players[p].PY)) e_bullet_fyinc[z] = +yinc;
         if (EYint >  al_fixtoi(players[p].PY)) e_bullet_fyinc[z] = -yinc;
         if (EYint == al_fixtoi(players[p].PY)) e_bullet_fyinc[z] = 0;
*/


         switch (bullet_ans)
         {
            case 54: event(17, EXint, EYint, 0, 0, 0, 0); break; // green
            case 55: event(18, EXint, EYint, 0, 0, 0, 0); break; // cannonball
            case 20: event(19, EXint, EYint, 0, 0, 0, 0); break; // twirly
         }
         z=50;
      }
}


----------------------------------------------------------------
change set seek to use no trig method...done
----------------------------------------------------------------
void seek_set_xyinc(int EN, int EXint, int EYint)
{
   int p = find_closest_player(EXint, EYint);

/* old
   al_fixed xlen = abs(players[p].PX - Efi[EN][0]);
   if (xlen == al_itofix(0)) xlen = al_ftofix(0.001);
   al_fixed ylen = abs(players[p].PY - Efi[EN][1]);
*/

// new
   al_fixed xlen = players[p].PX - Efi[EN][0];   // get the x distance between enemy and player
   al_fixed ylen = players[p].PY - Efi[EN][1];   // get the y distance between enemy and player
   al_fixed hy_dist =  fixhypot(xlen, ylen);     // hypotenuse distance
   al_fixed speed = Efi[EN][5];                  // speed
   al_fixed scaler = fixdiv(hy_dist, speed);     // get scaler
   al_fixed xinc = fixdiv(xlen, scaler);         // calc xinc
   al_fixed yinc = fixdiv(ylen, scaler);         // calc yinc

   Efi[EN][2] = xinc;
   Efi[EN][3] = yinc;

/* old
   al_fixed angle = fixatan(fixdiv(ylen, xlen));
   al_fixed xinc = fixmul(fixcos(angle),  Efi[EN][5]);
   al_fixed yinc = fixmul(fixsin(angle),  Efi[EN][5]);

   if (Efi[EN][0] < players[p].PX) Efi[EN][2] = +xinc;
   if (Efi[EN][0] > players[p].PX) Efi[EN][2] = -xinc;
   if (Efi[EN][1] < players[p].PY) Efi[EN][3] = +yinc;
   if (Efi[EN][1] > players[p].PY) Efi[EN][3] = -yinc;
   */
}


----------------------------------------------------------------
what if a make cannon and podzilla have a prox that will not fire bullet unless player in range?
----------------------------------------------------------------





going to work and taking e6410

20171124...



---------------------------------------------------------------------------------
create mode where I can continually enter new steps, until cancelled....
---------------------------------------------------------------------------------

made a new function:
void insert_steps_until_quit(int lift, int start_step)

hijack the button create for now....

only inserts at current step

inserts at last pos all the time..steps get enetered bacwards...


looks like it got it working....

need to make a real button for it...

need to call it from map right click on lift step...sorta done 2 things are fighting over mouse_b & 2
- actually right click of step in list and right click of lift in map, should both call the same popup menu..




------------------------------------------------------------------------------------------------
bug.. when insert from step popup menu is cancelled it leaves a hole...
------------------------------------------------------------------------------------------------

make a function insert new stp that handles the cancell...

this is the code from step popup


                     case 5: // insert step
                        lifts[current_lift].num_steps++;
                        construct_lift_step(current_lift, lifts[current_lift].num_steps-1, 0,0,0,0);
                        for (x=lifts[current_lift].num_steps-2; x>=step; x--)
                        {
                           lift_steps[current_lift][x+1].x    = lift_steps[current_lift][x].x ;
                           lift_steps[current_lift][x+1].y    = lift_steps[current_lift][x].y ;
                           lift_steps[current_lift][x+1].val  = lift_steps[current_lift][x].val ;
                           lift_steps[current_lift][x+1].type = lift_steps[current_lift][x].type ;
                        }
                        get_new_lift_step(step);
                     break;



void insert_steps_until_quit(int current_step)
{
   int quit = 0;
   while (!quit)
   {
      lifts[current_lift].num_steps++; // one more step

      // slide steps up to make room for new step
      for (int x=lifts[current_lift].num_steps-2; x>=current_step; x--)
      {
         lift_steps[current_lift][x+1].x    = lift_steps[current_lift][x].x ;
         lift_steps[current_lift][x+1].y    = lift_steps[current_lift][x].y ;
         lift_steps[current_lift][x+1].val  = lift_steps[current_lift][x].val ;
         lift_steps[current_lift][x+1].type = lift_steps[current_lift][x].type ;
      }

      if (get_new_lift_step(current_step) == 99)
      {
         // slide steps back down to close hole
         for (int x = current_step;  x < lifts[current_lift].num_steps-1; x++)
         {
            lift_steps[current_lift][x].x    = lift_steps[current_lift][x+1].x ;
            lift_steps[current_lift][x].y    = lift_steps[current_lift][x+1].y ;
            lift_steps[current_lift][x].val  = lift_steps[current_lift][x+1].val ;
            lift_steps[current_lift][x].type = lift_steps[current_lift][x+1].type ;
         }
         current_step--;
         lifts[current_lift].num_steps--; // one less step
         quit = 1;
      }
      else
      {
         current_step++;
      }
   }
}


new function is called insert_lift_step
it will call    get_new_lift_step(current_step)


int insert_lift_step(int lift, int step)
{
    // inserts a step in 'lift' before passed 'step'
    // updates the number of steps
    // handles cancelling properly
    // return 1 if step created; 0 if cancelled

   int ret = 0;
   lifts[lift].num_steps++; // one more step

   // slide steps up to make room for new step
   for (int x=lifts[lift].num_steps-2; x>=step; x--)
   {
      lift_steps[lift][x+1].x    = lift_steps[lift][x].x ;
      lift_steps[lift][x+1].y    = lift_steps[lift][x].y ;
      lift_steps[lift][x+1].val  = lift_steps[lift][x].val ;
      lift_steps[lift][x+1].type = lift_steps[lift][x].type ;
   }

   if (get_new_lift_step(step) == 99)
   {
      delete_lift_step(lift, step);
      ret = 0;
   }
   else
   {
      ret = 1;
   }
   return ret;
}

all done with making functions...

this look a lot better now



also I need a delete_step that closes the hole...
do i already have one??

no...
do this first...seems to work....

void delete_lift_step(int lift, int step)
{
   for (x=step; x<lifts[lift].num_steps-1; x++)   // slide all down
   {
      lift_steps[lift][x].x    = lift_steps[lift][x+1].x ;
      lift_steps[lift][x].y    = lift_steps[lift][x+1].y ;
      lift_steps[lift][x].val  = lift_steps[lift][x+1].val ;
      lift_steps[lift][x].type = lift_steps[lift][x+1].type ;
   }
   lifts[lift].num_steps--;
}


---------------------------------------------------------------------------------------------------------
right click to pop up same menu on map as on buttons...
-------------------------------------------------------------------------------------------------------

moved popup menu into its own function the pasted it in in both places...

seems good...

what about all the places I commented out mouse_b2 to exit??
it seems to work just fine with only ESC to exit
leave them for now...


what about the create button that i hijacked to create steps in a loop?


I could add it to the pop up menu where insert is...

like "insert step before step 4"
      "insert nultiple steps before step 4"



------------------------------------------------------------------
bug when inserting muliple cant insert any but move...??
------------------------------------------------------------------
actually it works, but there is no indication that it does
because the step list is not drawn in multiple step entry...


--------------------------------------------------
dont allow entering of step 4 loop to zero...done
--------------------------------------------------

--------------------------------------------------
get rid of global current_lift....done!!!
--------------------------------------------------

fast draw lift draw a bullseye???
what calls fdl?
getxy

done.............


looking good!!!!!


20171125 in leth

moved list of step buttons down so title shows and made colors look good..done


-------------------------------------------------------------------------------------
maybe i could make getxy, not redraw all the time unless mouse was moved...done and looks good
-------------------------------------------------------------------------------------

-------------------------------------------------------------------------------------
in getxy when moving lifts, show lift lines for all lifts....done
-------------------------------------------------------------------------------------
where else are lift lines drawn??
in lift editor...fill_ll()
also made bullseye work for lift...


-------------------------------------------------------------------------------------
edit_float is only used in pde...move there...done....
-------------------------------------------------------------------------------------


-------------------------------------------------------------------------------------
see if i can make sliders have smaller inc with large numbers, like bomb fuse....
-------------------------------------------------------------------------------------

have come up with a good solution, hold shift while on mouse button and
mouse wheel inc and dec by sinc...

also al_fixed the round and cleaned up the function edit_int_sliders...

make it so wheel doesn't screw up ESC exit...
changed it so that while wheel it pressed...al_fixed
it is the shifts
//      while ((key[KEY_LCONTROL]) || (key[KEY_RCONTROL]))
that screws up the ESC quit, even if I call clear_keybuf() after...
final...made mouse_b 4 (the wheel button) need to be pressed to do fine adjust....


-------------------------------------------------------------------------------------
make editors not redraw the buttons unless mouse moves...
lift_editor done
enemy and items done...
looks good.


-------------------------------------------------------------------------------------
make text message have nice text entry like lift....
-------------------------------------------------------------------------------------
this is what is used to edit the lift text line

            strcpy(fst, lifts[lift].lift_name);
            if (popup_dialog(edit_text_line, 2) == 3)
            {
               strcpy(lifts[lift].lift_name, fst);
            }
            clear_keybuf();

will it work for text line that have CR?? no


what if a pass it a multiple lines things. it shows good with a ^ where the line break is
but i still can't hit enter...

150 lines in craete msg
50 line in dpm (display
30 line in show cursor

too complicated for now..it just works for now leave it.
-------------------------------------------------------------------------------------------

20171127
back at home monday morning




----------bug---------------------
why can't clients connect?
they get join packet...
amybe its cause the level is too high: 211 ng 006 good

006:
got reply from server at: 192.168.1.107
[   0][CJON] client is requesting join server with color:9
[   0][SJON] client received join invitation from server!
------------ level:6 frame_rate:40 player_num:1 color:10
[   0] player array state

211:
got reply from server at: 192.168.1.107
[   0][CJON] client is requesting join server with color:9
[   0][SJON] client received join invitation from server!
------------ level:-45 frame_rate:40 player_num:1 color:10
[   0] player array state

looks like when I send a byte in a packet, its a signed 8 bit byte ranging from -127 to +128

make this bigger...2 bytes...

CJON same
SJON change on server...done
SJON change on client...done
----------bug-al_fixed--------------------




I want to do some statistics for a netgame...

when the game is done on client:

show the number of...extra sdat

int client_statistic[10];
declared in main
externed in pm.h

cleared right after SJON rx'd...for (int x=0; x<10; x++) client_statistic[x] = 0;

displayed in control when alp client become inactive..stick in it the log

client_statistic[0] = total sdat packets rx'd
client_statistic[1] = skipped sdat packets

--------- Client Statistics ---------
-------------------------------------
sdat packets rx'd:[234]  skipped:[112]

total number of moves made by each player

number of cdat packets sent
client_statistic[2] = total cdat packets tx'd

client_statistic[3] // passcount when client joined


client_statistic[4] // moves entered
client_statistic[5] // moves skippped

client_statistic[6] // total sdak packets tx'd

-------------------------------------
--------- Client Statistics ---------
-------------------------------------
total frames:[5047]  frame when client joined:[4754]
cdat packets tx'd:[75]
sdat packets rx'd:[177]  skipped:[75]   [42 percent skipped]
moves entered:    [108]  skipped:[158]   [59 percent skipped]
sdak packets tx'd:[177]

looks good so far... what else could I add...
the min, max and average snycs
doesn't work across level done....


the difference between when the game is running and chasing...


up to when control method make player active is chasing

coming along....

reset when alp goes active...

sdat's rx'd in sync are not counted becaus ethey are rx'd by chase fnx....al_fixed...


i want more data about what happens in chase....

what if I raise the max fps?  lets try 6000..works
I disabled it and it went to 26000 but still worked


log the first section of just catching up on game moves

starts at sjon

logging is getting better.....

good for game move sync and chase...



20171128

mi3 crashes like bsod bad...???
did it again, i reseated all the cards, memory, etc, lets try again...

in logging passcount always come first
how about next is always nep

do it in sdak's....done..looks good...
how about more...

lets try crx sdat...done...

now the step 1 is good, lets move on to step 2...chase....



mi3 keeps crahing hard...tried to update graphics driver.. uninstalled old
while installing new bsod..left it with no driver, just generic win driver...
lets see how that goes... one more hard reboot and mi3 is done a dev machine...


step 2...chase....

need to show fps...



need to show how many frames passed since last sync???
only matters if not enough moves to trigger sync...??


made void client_timer_adjust(void) because it is called twice and is exactly the same....looks good.


do step 3 where player becomes active....done...

looking good up to here....

-------------------------------------------------------------------------------------------------------------------
next...do you know why some game moves are rejected as duplicate, when there doesnt seem to be any reason for it?
-------------------------------------------------------------------------------------------------------------------

make blocked for dup look just like entered....??? sorta done...

later its work time....


-------------------------------------------------------------------------------------------------------------------
make my log files save in their own dir "logs" with YYYYMMDDHHMMSS.txt filename...done
look into time.h in C
-------------------------------------------------------------------------------------------------------------------



-------------------------------------------------------------------------------------------------------------------
look into the logs where large sync dies a figure out what to log to see why
-------------------------------------------------------------------------------------------------------------------
add server sync to fps adjust line....


here is an example....


[42379][client timer adjust]--------------------server_sync:203---------------------fps:[243]
[42400][client timer adjust]--------------------server_sync:182---------------------fps:[222]
[42421][client timer adjust]--------------------server_sync:161---------------------fps:[201]
[42442][client timer adjust]--------------------server_sync:140---------------------fps:[180]
[42463][client timer adjust]--------------------server_sync:119---------------------fps:[159]
[42484][client timer adjust]--------------------server_sync:98---------------------fps:[138]
[42505][client timer adjust]--------------------server_sync:77---------------------fps:[117]
[42526][client timer adjust]--------------------server_sync:56---------------------fps:[96]
[42547][client timer adjust]--------------------server_sync:35---------------------fps:[75]
[42568][client timer adjust]--------------------server_sync:14---------------------fps:[54]
[42589][client timer adjust]--------------------server_sync:-7---------------------fps:[33]
[42610][client timer adjust]--------------------server_sync:-28---------------------fps:[12]
[42631][client timer adjust]--------------------server_sync:-49---------------------fps:[4]
[42652][client timer adjust]--------------------server_sync:-70---------------------fps:[4]
[42673][client timer adjust]--------------------server_sync:-91---------------------fps:[4]
[42694][client timer adjust]--------------------server_sync:-112---------------------fps:[4]
[42715][client timer adjust]--------------------server_sync:-133---------------------fps:[4]
[42736][client timer adjust]--------------------server_sync:-154---------------------fps:[4]
[42757][client timer adjust]--------------------server_sync:-175---------------------fps:[4]
[42778][client timer adjust]--------------------server_sync:-196---------------------fps:[4]
[42799][client timer adjust]--------------------server_sync:-217---------------------fps:[4]
[42820][client timer adjust]--------------------server_sync:-238---------------------fps:[4]
[42841][client timer adjust]--------------------server_sync:-259---------------------fps:[4]
[42862][client timer adjust]--------------------server_sync:-280---------------------fps:[4]
[42883][client timer adjust]--------------------server_sync:-301---------------------fps:[4]
[42904][client timer adjust]--------------------server_sync:-322---------------------fps:[4]
[42925][client timer adjust]--------------------server_sync:-343---------------------fps:[4]


what if I lower how often it adjusts?  like from 21 currently to every frame?
why am i not doing it every frame?


what exactly is happening?

its like last_sdat_fpc is not getting updated ...

it looks like the passcount sent by sdat is hitting 65535
need to increase passcounts in packets to 3 bytes




cdat tx uses 3 bytes
sdak tx uses 3 bytes
sdat rx 3 b

they all use 3 bytes..

do I need 4?

is 3 screwed up?....

did the following code and it seems to work....


               printf("3 byte test\n");

               int t = 70000;

   printf("%d\n",t);

   unsigned char sh_b = (unsigned char) (t/65536);
//   PacketAddByte(sh_b);
   printf("%d\n",sh_b);

   t -= sh_b * 65536;
   unsigned char hi_b = (unsigned char) (t/256);
//   PacketAddByte(hi_b);
   printf("%d\n",hi_b);

   t -= hi_b * 256;
   unsigned char lo_b = (unsigned char) t;
//   PacketAddByte(lo_b);
   printf("%d\n",lo_b);


   unsigned char byte_sh = (unsigned char)sh_b;
   unsigned char byte_ho = (unsigned char)hi_b;
   unsigned char byte_lo = (unsigned char)lo_b;
   int b = (byte_sh*65536) + (byte_ho*256) + byte_lo;

   printf("%d\n",b);


int Packet3ByteRead(void)
{
   unsigned char byte_sh = (unsigned char)PacketGetByte();
   unsigned char byte_ho = (unsigned char)PacketGetByte();
   unsigned char byte_lo = (unsigned char)PacketGetByte();
   int b = (byte_sh*65536) + (byte_ho*256) + byte_lo;
   return b;
}

void PacketAdd3Bytes(int b)
{
   int t = b;

   unsigned char sh_b = (unsigned char) (t/65536);
   PacketAddByte(sh_b);
   t -= sh_b * 65536;

   unsigned char hi_b = (unsigned char) (t/256);
   PacketAddByte(hi_b);
   t -= hi_b * 256;

   unsigned char lo_b = (unsigned char) t;
   PacketAddByte(lo_b);
}


------------------
so then what is the problem with 65535???

maybe its setting the timer too fast????




try removing the 20 frame hold off on adjust with no sdat
took a lot longer for the sync to lower and died before it got there bsod

try setting to 5.. no

at start fps 112000 it goes 9000 frames before rx sdat..



[110005][client timer adjust]---ldf:121307-----------server_sync:11302---------------------fps:[11342]
[110005][ 75] rx sdat with 0 entries -- [sync]
[110005][ 75] tx sdak
[110010][client timer adjust]---ldf:121327-----------server_sync:11317---------------------fps:[11357]

[114400][client timer adjust]---ldf:121327-----------server_sync:6927---------------------fps:[6967]
[114400][ 75] rx sdat with 0 entries -- [sync]
[114400][ 75] tx sdak
[114405][client timer adjust]---ldf:121347-----------server_sync:6942---------------------fps:[6982]

[118695][client timer adjust]---ldf:121347-----------server_sync:2652---------------------fps:[2692]
[118697][ 75] rx sdat with 0 entries -- [sync]
[118697][ 75] tx sdak
[118700][client timer adjust]---ldf:121367-----------server_sync:2667---------------------fps:[2707]


[121355][client timer adjust]---ldf:121367-----------server_sync:12---------------------fps:[52]
[121360][client timer adjust]---ldf:121367-----------server_sync:7---------------------fps:[47]
[121365][client timer adjust]---ldf:121367-----------server_sync:2---------------------fps:[42]
[121370][client timer adjust]---ldf:121367-----------server_sync:-3---------------------fps:[37]
[121375][client timer adjust]---ldf:121367-----------server_sync:-8---------------------fps:[32]
[121380][client timer adjust]---ldf:121367-----------server_sync:-13---------------------fps:[27]
[121385][client timer adjust]---ldf:121367-----------server_sync:-18---------------------fps:[22]
[121390][client timer adjust]---ldf:121367-----------server_sync:-23---------------------fps:[17]
[121395][client timer adjust]---ldf:121367-----------server_sync:-28---------------------fps:[12]
[121400][client timer adjust]---ldf:121367-----------server_sync:-33---------------------fps:[7]

[122905][client timer adjust]---ldf:121367-----------server_sync:-1538---------------------fps:[4]
[122905][ 75] rx sdat with 0 entries -- [sync]
[122905][ 75] tx sdak
[122910][client timer adjust]---ldf:121387-----------server_sync:-1523---------------------fps:[4]


the problem is how many frames it races past waiting for sdat from server

in the example above its:

4395
4295



do you ever show the actual fps...? its always there...
calculated in a timer interupt and extern it fps...

show it in logs with adjust fps...look like it maxes out aroun 12000fps...

how should I handle the chase...?

every frame, check how far behind I am by comparing my passcount with the latest one in game_moves....

if I am > 50 ahead set the fps to fast...if not use regular control...




how log does it take to adjust the timer....


how can I count the number of local frames that pass between getting sync ....


one of my bad assumptions is that the passcount for the last game move would be the lastest passcount...its not
it will only be the last move made...

can i add it to the sjon reply?? sure...done


how about a wait for sync function???

don't do the slow chase until you get a sync...

could it be that i'm adjusting based on last_sdat_fpc every frame, when I should only be doing it when sdat is rx'd???





im startimg to think that adjusting the timer might not act fast enough...
do I have another method i can use...like skipping frames, or pausing...???


int chase_to_passcount;

every frame this is checked against passcount

if passcount is less than this, play this frame with no draw and no frame_delay..


void proc_frame_delay(void)
{
   if (passcount < chase_to_passcount) // skip draw and wait
   {
      draw_frame = 0;
      frames_skipped++;
      return;
   }
   if (passcount <=  timer_passcount) // skip frame
   {
      draw_frame = 0;
      frames_skipped++;
   }
   else draw_frame = 1;
   while (passcount > timer_passcount); // delay if too far ahead so timer catches up
}

show SJON passcount on client....

it looks like even though it chases there, fps_chase is still getting set...



when I race to the passcount, then I need to set the passcount in the timer thingy

sorta works now....but sometimes overshoots...

I thinks I can say that it gets the tyhe CHASE TO PASSCOUNT DONE part good.

but after that it overshoots....

log some shit after that




game sync now has more steps


1 - game move bulk sync
2 - race to passcount
3 - sync from there
4 - regular game...



whenever I get a snyc packet, I want to know how many frames have passed since the last sync packet...
that number is sync_delay



20171201


left a netgame running overnight
server[4230j] is at time:23950
client[mi3] died so hard that windows rebooted (recovered from unexpexted...]

try to join the server again...

now client won't show anything , won't init graphics...reboot again...


pulled the video card...just using on board graphics..first boot bsod
second boot, no graphics in pm again..

maybe not bad video card....

ran the intel graphic drive and now I have a good 2 screen setup....


-------------------------------------------------------------------------------------
Make keys so that they can either work like original and remove a rectangular block
or new mode where they only remove their colored key block in the range specified
all I would need is a bool value, and keep the same block range....
--------------------------------------------------------------------------------------


-------------------------------------------------------------------------------------
Make screen shot blindly save without prompt just like log...done
--------------------------------------------------------------------------------------

back to the netgame thingy

am I reaching the end on my log file? what is its size?? 10M!! that should do...

get some times...

in SJON, also send the number of server game moves...done

looks good up to end of chase to passcount..

at that point I want to know how long it took...
i also want to know how far behind we are now in passcount and game moves

passcount done...

game_moves done...

how long...done..

display number of frames since last sync, but do it in sdat rx....

cleaned up how stuff is logged when sdat rx'd...looks good

now still have more log clening up to do like what are the 2 client toimer adjust???


[46729][378] tx sdak
[46729] tx cdat - move: 22
[46730][client timer adjust]---lsf:[46730] lsl:[46729] sync_delay:[1] server_sync:[0] fps_chase:[40]  fps_act:[40]
[46730][client timer adjust]---number_of_local_frames_since_last_sync:[1]
[46730][377] rx sdat with 1 entries -- [skipping] -- local frame since last sync[  1]
[46730][378] tx sdak
[46731][client timer adjust]---lsf:[46731] lsl:[46730] sync_delay:[1] server_sync:[0] fps_chase:[40]  fps_act:[40]
[46731][client timer adjust]---number_of_local_frames_since_last_sync:[1]


time for work

20171201 7:00 AM

I found the game move duplicate error:

// check to see if already in game move array (duplicate)
   if ((game_moves[x][0] = g0) && (game_moves[x][1] = g1) && (game_moves[x][2] = g2) && (game_moves[x][3] = g3))
   {
      client_statistic[5]++;  // moves skippped

"=" is assignment
"==" is comparison......duhhhh!


switch the order of rx sdat and game move entry...done

put timer adjust after sdat rx so it happens on same loop...


that actually work better

now for each passcount
1st rx sdat
2nd game move enter
3rd timer adjust


that stuff looks great...



to do:  no indication when racing...

make the step header and timers all use the same function and look good.

do I need frames since last sync in regular game...no...done

rename client_chase_control to bulk_game_move_sync...done







20171202
--------------------------
made a funtion to print a nice section header in log file....


I have a server game that's been running for time:37848 or 630 min

lets try to join...

to 2:15 to join
colors were funny and client could only jump and fire, not move left or right...

log is 20171202063516

the funny colors and no move still persist....

my cfg file seems to be erased....al_fixed
later make sure we can recover from this...



back to the log cleanup...


first section....done

second section...start..done
second section...finish..done
add time...done
add sdat rx'd while racing maybe later...


third section .. named chase and lock
start, finish and time done
anything else to show??


make a funtion to show sdat rx;d and game mopve ebneterd

use it while race and chase ..done..

looks really good so far

step 4 in the game....
start done
end...done
time..done

I want to show more at the end...

cdat's sent

total frames
frame when client started
frame the player played

errors?

min sync
max sync

kill client stat..move inline
not killed but not used either...comment it out..done

add errors...show c_sync_err and c_sync_min...done

any other errors on client...i dont think so...


------------------------------------
after race, calc avg fps and show...done
------------------------------------

------------------------------------
change bulk display to count down...done
------------------------------------

------------------------------------
have display during chase use countdown...done
------------------------------------


looking good!!!



make the player join and color use nice stuff too...
active
inactive
color change
level done
all done...


make the header function control how many blank lines above and below....done


make indented reg game sdat, move, adjust...done



disbable logging and see what slips through....done


I am finished with cleaning up the logs....



----------------------------------------


making a backup

20171202



now lets see what happens when level done.....
level 366

client tries to chaselock but goes negative
- reset chase to passcount on level done....done...much better

reset client stats in proc_level_done

make level done really big...done



put strecthtext first and remove the 1200 delay in that fucntion...done

try to speed up the rejoin


the server spends 1 s  doing this....

 if (ima_server)
   {
      for (int c=0; c<100; c++)
      {
         void server_send_sdat(void);
         server_send_sdat(); // keep running this until all clients are caught up
         rest (10);
      }
      void server_flush(void);
      server_flush();




find a way to check if server is done (all client caught up...)...not trivial

for now, send twice and move on.. see if that works...

      void server_send_sdat(void);
      server_send_sdat();
//      server_send_sdat();

when I do this the client gets to 0 but never rejoins....??
the server shows that the client goes active????



i don't know why....

try adding delay
1000 and it works...

removed the server_send_sdat(); and it still works!!!

how low of delay can i go??

500..good
200..good
50..good
10..no
20..good
15..good
12..good
10.. sometime passes, sometimes fails

lets go with 20



next reduce the client wait from 2000 to 500
500..good

200..good
0...no

100..good
50..both
go with 100...


seems to work now and it a lot faster...


-----------------------------------------------------------
why does clients last keypress carry over to new level?
-----------------------------------------------------------

where can I reset it...


test to confirm...yes tha's how it is...

server also???...looks like it...


single player???..no...


-----------------------------------------------------------
when do game keys get saved....???
change save game moves to timstamp filename
done
-----------------------------------------------------------
log players data with every frame.....

it looks like comp_move is not being cleared
cleared that.

also added code when setting players keys from comp move in game array
to set all to 0 if none found

also cleared they players ket in init before level entry....

finally this bug is done......




now what????





played a long 4 player game lev 209
at the end the 3 clients agreed, but the server was the only different one.

no errors on the clients but server had 1 error for a used client

when client quit and rejoined they now look like the server...
20171202-1919


goddam 4230j has bad time..keeps changing even when running
changed the HD to 4230i still called 4230j...see if that's better..



the server logging is lacking....
the server is much simpler than the client so it should be easier

its all there..pretty simple

server rx's sdaks..
server rx's cdats..

cleaned up a bit...





what if i try changing some variables??

20 frame sync hold off on server
try 10...

CONTROL_LEAD_FRAMES = 5
what if i tried 3 or 4


there is a 4 frame holdoff on re-sending sdat that I'm not convinced is set up right or is needed


-----------------------------------------------------
server is flagging a c_sync error when c_sync == 1
is this really an error???
-------------------------------------------------------

according to the code it shouldn't get added to game_move array unleSs its > 1
why does it seem to be working then???

hard to tell...i'm going to allow 0 and 1 for now

with CONTROL_LEAD_FRAMES = 2
I get no errors on server but som eon client...
lets try 3...
none on server
only 1 -1 on client

set to CONTROL_LEAD_FRAMES = 4 or 5 to be really safe


------------------------------------------------------------------------------------------
I just figured out you can pass the hostname instead of ip to start a client game!!!!!!!
-------------------------------------------------------------------------------------------

what is the difference in code in libnet between a channel and a connection?
connection is what I use...


-----------------------------------------------------------
goddamn mi3 croaked for the last time, its now sidelined
----------------------------------------------------------

trying i990
new win 7 ultimate install
need network driver...done

can't see second montor and game wont display properly

need graphics driver...
radeon driver v 17.11.1
insatlled ms .net frame work 4.5 .... i don't like this
and ms visual C redist 2015

seems to be working now:

i990  main dev machine (192.168.1.104)
E6410 pm_client2 (192.168.1.131) portable dev machine
4230j pm_client3 (192.168.1.170) usually server test machine
E6430 pm_client4(192.168.1.147) studio computer





----------------------------------------------------------
the log files are getting out of hand... they are huge..like 172 M for 250 files
it increased the size of the game folder 10 x
deleted them for now, they are backed up with last version...
----------------------------------------------------------







----------------------------------------------------------------------------------
try to replace the network low level stuff with channels instead of connections
----------------------------------------------------------------------------------

make a new project to test this...


at what point did I first use libnet??
it was probably when i was in college, maybe 2001-2002???
20020522 no mention of where it came from or anything useful...



set up some parallel stuff in the game and test it there....


command line server and clinet and pass some shit around....with channels






         if (strcmp(argument_array[1],"-x") == 0 )  // test channel server
         {
            if(NetworkInit()) printf ("Error initializing network\n");
            NET_CHANNEL *chan;
            char buffer11[32] = "Data to send s1";
            char buffer12[32] = "Data to send s2";
            char buffer13[32] = "Data to send s3";
            char buffer2[32] = "";
            int x;

            chan = net_openchannel (NetworkDriver, "");
            net_assigntarget (chan, "");

            int quit = 0;
            while (!quit)
            {
               if (key[KEY_ESC]) quit = 1;

               x = net_receive (chan, buffer2, 32, NULL);

               if (x > 0) printf ("Received data: %s\n", buffer2);
               if (x < 0) printf ("Error receiving data.\n");

               if (key[KEY_1]) net_send (chan, buffer11, strlen (buffer11) + 1);
               if (key[KEY_2]) net_send (chan, buffer12, strlen (buffer12) + 1);
               if (key[KEY_3]) net_send (chan, buffer13, strlen (buffer13) + 1);
            }
            exit(0);
         }

         if (strcmp(argument_array[1],"-z") == 0 )  // test channel client
         {
            if(NetworkInit()) printf ("Error initializing network\n");
            NET_CHANNEL *chan;
            char buffer11[32] = "Data to send c1";
            char buffer12[32] = "Data to send c2";
            char buffer13[32] = "Data to send c3";
            char buffer2[32] = "";
            int x;

            chan = net_openchannel (NetworkDriver, "");
            net_assigntarget (chan, "192.168.1.170");

            int quit = 0;
            while (!quit)
            {
               if (key[KEY_ESC]) quit = 1;

               x = net_receive (chan, buffer2, 32, NULL);
               if (x > 0) printf ("Received data: %s\n", buffer2);
               if (x < 0) printf ("Error receiving data.\n");

               if (key[KEY_1]) net_send (chan, buffer11, strlen (buffer11) + 1);
               if (key[KEY_2]) net_send (chan, buffer12, strlen (buffer12) + 1);
               if (key[KEY_3]) net_send (chan, buffer13, strlen (buffer13) + 1);
            }
            exit(0);
         }
      }



this works!!!

the server rx but the client doesnt...



when I first receive something i need to get the address...

	char address[32], *newnick;
	int x = net_receive (listenchan, buffer, SIZE-1, address);


who?

in this case, the server address is known and set by the clients

when the server gets a new connection it needs to get the client address and save it...done..



im going to need to implement my own kind of listening connection thing on the server

need an array to store channels


typedef struct chan_list_t {
	struct chan_list_t *next;
	NET_CHANNEL *chan;
	char *nick;
} chan_list_t;

chan_list_t *channellist = NULL;
NET_CHANNEL *listenchan;


NET_CONN *ListenConn = NULL;                  // The listening connection
NET_CONN *ClientConn[MAX_CLIENTS] = {NULL, }; // A connection for every client
int ClientNum = 0;


NET_CHANNEL *ListenChannel = NULL        ; // listen channel
NET_CHANNEL *ClientChannel[32] = {NULL, }; // array of channels



its working good....


server keeps running and accepts new connections
clients join and quit

the client knows the ip of the server only

the server gets the IP of the client when they join



-----------------------

now lets try a packet exchange......

i bet that listen is eating all my subsequnet attmepts....
no I needed to update the address with what the server sent me...

packets are not being read...it was packet size...


---------------------------


the packet exchange is going good now.


what if I make some ifdefs and have either the channel or the connection stuff running...

I will need to rename all the interface fucntions to be the same...


already all the packet functions are the same

server_init
server_listen
server_send
server_receive

I think I have server done...and it complies with no errors

client_init
client_send
client_receive

done....

after some bug checking I made nc_client and nc_server use the functions above

then I switched to connections to see if it still worked....


there is a bug...

when client is waiting for server response, chan blocks, but conn passes through

make chan pass through also and call in loop....

/* Check for a repsonse from the server.
    0 = ok
	 1 = no response yet
   -1 = error */
int ClientCheckResponse(void)

how is it called in connection mode?

its called in a loop in user land with a delay and try different IP's

works perfectly with my little test program...



now for a real test.....

lets bounce a packet back and forth as fast as we can, incrementing the payload each bounce
and timing it....


client sends poop and peep with 2 byte packet set to 0
server returns and incs count
when it gets to 1000 it is stopped...

time with print was from 3000-5000ms for 1000
time with no print was from 200-800ms

now lets try it with the conn

70-110 ms


results:

CONN
packetsize = 2 bytes
number of packets = 1000
number of runs
avg 90 ms
min 70
max 110

CHAN
packetsize = 2 bytes
number of packets = 1000
number of runs
avg 90 ms
min 50
max 190


----------------------------

lets try the netgame with chan!!!!

the server never receives the CJON

does it need to do something with saving the address....no it was not setting packetsize when receiving

the game works just the same with chan as conn

CONTROL_LEAD_FRAMES = 2 cause lots of errors, 3 had none, but didn't try too long...


So there you have it...I have wasted a whole day to test a theory....a game theory...mu ha ha !!!!!

to wrap up this test I could move nc_client and nc_server into some other file....
they are only 50 lines long each...
they should got in the respective client and server files....

do it....done....


Other network thoughts....


I could probably improve my network performance if a ran the network code more than once per frame
Ideally in another paradijm, I could run it in its own thread, but that's beyond me now....

how about in the timer check thingy, call it in the middle of the wait...

it look like I might have to make another timer than runs at a mutiple of fps_timer...
so that i would get a tick in the middle of a passcount...

or make a faster timer, say every 5 ms

the faster time would be sync'd to passcount, once per frame, every time it passed through

when sitting and waiting in proc_frame delay it could call the network stuff once every 5 ms or until time ran out..

what network stuff would you call??

all of it? or is there stuff that woudl be bad for to call more often....

at the highest level, all network stuff is called from proc_controllers in loop


void proc_controllers()
{
    if (ima_server) server_control(); // runs only once per frame
    if (ima_client) client_control(); // runs only once per frame

these defintely are only once per frame:
    if (players[p].control_method == 3) server_local_control(p);
    if (players[p].control_method == 4) client_local_control(p);



server_control calls server_send_sdat which has a re-transmit hold off based on passcount
so this should be good.. it would snd more data anyway if called when passcount has not changed...


server_control calls ServerListen, but that should be ok to be called more often

server_control then runs the big receive loop, which processes all the packet it could receive

         if(PacketRead("cdat"))
should be ok


         if(PacketRead("sdak"))
should be ok



         if(PacketRead("CJON"))  // sent by client wanting to join
should be OK


client_control calls bulk_game_move_sync but only on passcount 0, and it blocks
should be ok

then it does the big packet recieve loop

      if(PacketRead("sdat")) is the only packet it can recieve

moves are enetered, sync is calculated
should be good...

it also does client_timer_adjust every frame...


void client_timer_adjust(void)
{
   if (passcount == chase_to_passcount)
   {
      int gmb;
      gmb = client_wait_for_sync();           // blocks until sync packet rx'd
      server_sync = last_sdat_fpc - passcount;
      fps_chase = passcount_timer_fps + server_sync;

this could be true and run more than once if called multiple time per paccount
except that it blocks until sync rx'd, by then passcount should have moved on

should be good..


so i can call

    if (ima_server) server_control(); // runs only once per frame
    if (ima_client) client_control(); // runs only once per frame

more than once per frame and all should be good.


- make timer than runs at 5ms

- in proc_frame_delay

set 5ms timer to 0
run the netstuff
check if past fps_timer
check if past 5ms timer
run again or quit...

do i need to make a timer?  just use rest (5)...


//old
   while (passcount > timer_passcount); // delay if too far ahead so timer catches up


//new
   while (passcount > timer_passcount) // delay if too far ahead so timer catches up
   {
      if (ima_server) server_control();
      if (ima_client) client_control();
      al_rest(0.005);
   }


looks good, server 4230j is skipping some frames, but i990 is not
client c_sync is better
server runs extra 0-4
client runs extra 1-4

lets try al_rest(0.01);
about the same

lets try al_rest(0.02);
still server skipping frame
server always 0,2,0,1
client mostly 1 with ocassional 2 or 0

lets try once only with a pause before...

   while (passcount > timer_passcount) // delay if too far ahead so timer catches up
   {
      j++;
      al_rest(0.005);
      if (ima_server) server_control();
      if (ima_client) client_control();
      while (passcount > timer_passcount); // delay if too far ahead so timer catches up


   }
   printf("[%d]",j);


this works the best...
server is not skipping...

client and server both run it one extra time only
on client c_sync is a solid 3 and min is also 3...

try lowering clf by 2 from 4 to 2....

c_sync is between 0 and 1 with min 1
mostly 1 though


this is awesome!!!!!!!!

back to work.....


------------------------------------------------------------
fix the command line args so that I can use different 1 arg flags...done
------------------------------------------------------------


------------------------------------------------------------
when I fixed the item viewer to not redraw unless the mouse moved
now it doesn't redraw when a button is pressed...
removed the code for that.. the problem is that the button and slider functions
draw and process, so i can't just not call them or they wont work...
also did the same for lifts....
lets hope i don't forget in the future and do it again....
-------------------------------------------------------------

------------------------------------------------------------------------------------
comment out code that looks for different server if can't get response...
would rather have it quit immediately.....all it was was on line to disable...
------------------------------------------------------------------------------------

------------------------------------------------------------------------------------
client check response in channnel causes bsod if fails..al_fixed...
------------------------------------------------------------------------------------


-------------------------------------------------------
player sometimes carries exploding bomb after death to start...done
-------------------------------------------------------
to test make a long bomb or use any item...
dies while holding fire
see what happens....reproducable....
make player drop item when dies....done



-------------------------------------------------------------------------------
when 2 player are fighting over who is holding an item the higher numbered player wins
if the other player keeps fire pressed as if they were still hold the item,
later when the other player lets go, the first player will have it
-----------------------------------------------------------------------------
reproducable....

when setting player carry can you check to see if anothe player is already carrying...
except for lit rocket, both can ride that.....

done and tested




---------------------------------------------------
I want to make the player jump more like it was in very eary versions
now the min jump is not much different than the max jump...
---------------------------------------------------
in the earliest game I could find...19980922
he can jump amlost 5 blocks
(if he's standing next to a 5 high wall, he can't quite jump onto it...)

shortest jump is 1 block


the next one i found, (with source) 19981122_playable
the values are:

1.15 initial x speed
3.0 max x speed
0.06 accel
0.3 de-accel
0.05 jump sinc
0.10 fall sinc
5.0 p move y


in the code:


xmove
         if ((key[left_key]) || (joy_left))
            {
               left_right = 0;
               if (left_speed < initial_x_speed) left_speed = initial_x_speed;
               else
                  {
                     left_speed += accel;
                     if (left_speed > max_x_speed) left_speed = max_x_speed;
                  }
            }
         else
            {
               left_speed -= de_accel;
               if (left_speed < 0) left_speed = 0;

            }

same for right
then add left_xinc and right_xinc to get real x_inc



ymove
when jump starts, jump_count is set to 1.57 (pi/2)
when fall starts, fall_count is set to 1.57 (pi/2)


         if (jump_count)
            {
               jump_count -= jump_sinc;
               if (jump_count < .1)
                  {
                     jump_count = 0;
                     fall_count = 1.57;
                  }
               else
                  {
                     if (!jump) jump_count -= (jump_sinc*4); /* jump released */
                     if (is_up_solid(PXint,PYint))
                        {
                           jump_count = 0;
                           fall_count = 1.57;
                        }
                     else PY -= (sin(jump_count) * pmovey);
                  }
            }
         else   /* not jump  */
            {
               if (fall_count)
                  {
                     fall_count -= fall_sinc;
                     if (fall_count < .1) fall_count = .1;
                     PY += (sin(1.57 - fall_count) * pmovey);
                     PYint = PY;




------------------------
now what values am I using?

I can easliy jump on a 5 block but not a 6
min jump is 3 blocks

   al_fixed gravity = al_ftofix(.60);
   al_fixed slow_gravity = al_ftofix(.32); // used when jump is held
   al_fixed initial_jump_velocity = al_ftofix(-8.6);
   al_fixed terminal_velocity = al_ftofix(7.8);

   al_fixed x_accel = al_ftofix(.12);
   al_fixed max_x_velocity = al_ftofix(4);
   al_fixed initial_x_velocity = al_ftofix(1.15);



differences:

now max speed is 4 instead of 3
now accel is .12 instead of .06
de-accel not listed is (accel x 2) which is .24 instaed of .3

ymove does not use sin...

lets make some changes...
try accel .06...too slow
try .8


re-added left_xind and right x_inc
cause I don't like how player immediately changes direction...
i like this better.....


now lets fuck with y move....

i don't want to mess with gravity, that affects fall as well
just adjust initial jump speed and slow gravity

done and its lots better

now the left and right xinc are building up when blocked.. need to zero them...

and lift push x and y to use left and right xinc done....


have I screwed up sproingy...yes.... they assume that slow gravity is used...

max the value 0-200 to get more fine control...

the problem is that the sproingy viewer snaps to block, but really shouldn't
get my own version on draw crosshairs to fix this....done

now all the sproingy are are wrong...starting to, they all need to be aprox 2.2 time bigger



20171207




what if I made the left and right solid checks, return the ammount that he is stuck
and then it can be subtracted.

maybe I could check the solid thing everytime, not just when moving

it will be true if he is just standing by a wall



add lift check to left and right
fix all calls to them...
make it so when lift is pushing then check for block collision with lifts...








--------------------------------------------------------------------------------
what about checking to see if the player is stuck and killing him...
look in all 4 directions..done
this actually works pretty good and I think I'll keep it
--------------------------------------------------------------------------------




---------------------------------------------------
player can be pushed sideway into solid blocks, by lifts...fixed
-------------------------------------------------------
more accurately, he doesn't, but some snap to lift side gets him...
when player is being pushed by lift, check to see if solid..done



---------------------------------------------------
when riding rocket through semi solid, player fires...fixed
---------------------------------------------------
removed the check in player move, now does all that stuff even if riding rocket...
was that wise???...its seems to work...no keep the check in...
now all player move for lit rocket is in proc_lit_rocket...





-------------------------------------------------------------------------
make it so that when LIFE changes automatically show the LIFE bar
-------------------------------------------------------------------------
make new var in player called old LIFE
replace all times when player takes damage and health display is manually set...done




-------------------------------------------------------------------------
add damage if player is being pushed by a lift into a solid block!!!! ...done
add event for this...
-------------------------------------------------------------------------


add event for stuck in blocks..done....


---------------------------------------------------
if player goes even a little sideways in semi solid on rocket== boom
---------------------------------------------------
i would need to redo my if solid funtions to check for semi or not...
maybe they could return 2 for semi???
semi are between 32 and 63
changed if solid  d l r to return 2 if semi
now need to make sure compares are doing it right......done
all is working good...
with one line change id proc lit rocket I can make rockets go in all direction
in semi solid, but for now its set to all but down....


20171208 03:30
another day...

I'm going to fix semi solid today








------------------------------------------------------------
change when player stuck to catch when stuck in semi also...done
------------------------------------------------------------
like when u = solid and d l r are anything solid









---------------------------------------------------
change is up solid to be like the other checks
---------------------------------------------------

old:
1 solid
2 lift
 and you have the option if lift and semi check

new:

1 solid
2 lift
32 lift num


what if I remove lift_check and semi check from all 4 is_xx_solid
and let the calling code deal with it...

radical... start with up...

1,1 lift and semi
1, 0 lift no semi



// both (1,1)
replace    if (is_up_solid(EXint, EYint, 1,1, ))
with       if (is_up_solid(EXint, EYint))
- flapper


// lift no semi yes (0,1)
replace   if (!is_up_solid(EXint, EYint, 0, 1))
with      if ( (is_up_solid(EXint, EYint) == 1) || (is_up_solid(EXint, EYint) == 2))
or
with      if ( is_up_solid(EXint, EYint) && (is_up_solid(EXint, EYint) < 32))
-trakbot x 2

replace   if (!is_up_solid(EXint, EYint, 0, 1))
with      if (!( (is_up_solid(EXint, EYint) == 1) || (is_up_solid(EXint, EYint) == 2)))
- trakbot x 2



// lift yes semi no (1,0)
replace    if (is_up_solid(EXint, EYint, 1, 0))
with       if ( (is_up_solid(EXint, EYint) == 1) || (is_up_solid(EXint, EYint) > 31) )
- block walker
- archwagon


// lift no semi no (0,0)
replace     if (is_up_solid(EXint, EYint))
with        if (is_up_solid(EXint, EYint) == 1)
-cannon
-bouncer


item_move
//  if (!is_up_solid(x,y,0,0)) itemf[c][3] += al_ftofix(.1); // de-accel
  if (!is_up_solid(x,y) == 1) itemf[c][3] += al_ftofix(.1); // de-accel

//                     if (is_up_solid(x, y, 0, 0))
                     if (is_up_solid(x, y) == 1)

prco_lit_rocket

//         if ( ((itemf[c][3]<al_itofix(0)) && (is_up_solid(     x, y, 0, 0 ) == 1)) ||
         if ( ((itemf[c][3]<al_itofix(0)) && (is_up_solid(     x, y) == 1)) ||



player move

//            if (is_up_solid(al_fixtoi(players[p].PX), al_fixtoi(players[p].PY) + 2, 1, 0)) // look for collision above
            if (is_up_solid(al_fixtoi(players[p].PX), al_fixtoi(players[p].PY) + 2) == 1) ||
            if (is_up_solid(al_fixtoi(players[p].PX), al_fixtoi(players[p].PY) + 2) > 31 ) // look for collision above



did this realy make anything simpler???

add back lift check, like all the others...



// both (1,1)
//    if (is_up_solid(EXint, EYint))
    if (is_up_solid(EXint, EYint, 1))
- flapper done


// lift yes semi no (1,0)
replace    if (is_up_solid(EXint, EYint, 1, 0))
with       if ( (is_up_solid(EXint, EYint) == 1) || (is_up_solid(EXint, EYint) > 31) )
then       if ( (is_up_solid(EXint, EYint, 1) == 1) || (is_up_solid(EXint, EYint, 1) > 31) )
or        if ( (is_up_solid(EXint, EYint, 1)) && (is_up_solid(EXint, EYint, 1) != 2) )
- block walker done
- archwagon done


// lift no semi no (0,0)
replace     if (is_up_solid(EXint, EYint))
with        if (is_up_solid(EXint, EYint) == 1)
then        if (is_up_solid(EXint, EYint, 0) == 1)
-cannon
-bouncer


// lift no semi yes (0,1)
replace   if (!is_up_solid(EXint, EYint, 0, 1))
with      if ( (is_up_solid(EXint, EYint) == 1) || (is_up_solid(EXint, EYint) == 2))
or
with      if ( is_up_solid(EXint, EYint) && (is_up_solid(EXint, EYint) < 32))
then      if (is_up_solid(EXint, EYint, 0))

-trakbot x 2 done

replace   if (!is_up_solid(EXint, EYint, 0, 1))
with      if (!( (is_up_solid(EXint, EYint) == 1) || (is_up_solid(EXint, EYint) == 2)))
then      if (!is_up_solid(EXint, EYint, 0))
- trakbot x 2 done




item_move
//  if (!is_up_solid(x,y,0,0)) itemf[c][3] += al_ftofix(.1); // de-accel
  if (!is_up_solid(x,y) == 1) itemf[c][3] += al_ftofix(.1); // de-accel
  if (!is_up_solid(x,y, 0) == 1) itemf[c][3] += al_ftofix(.1); // de-accel

//                     if (is_up_solid(x, y, 0, 0))
                     if (is_up_solid(x, y) == 1)

this shit is all figured out....
all 4 checks are the same and have lift check as a parameter....

now lets change it again....
if they all had semi check as a parameter, my code on the other side would be cleaner....

no if ==1 ==2 < 31 etc...unless needed, just ask for what you want when calling....


what it a



-------------------------

















---------------------------------------------------
player does funny things in semi solid block, like snapping to edges, etc.
---------------------------------------------------
snap to edges...

it goes deeper than just that,
what do I want to do when player is stuck in blocks?
solid blocks?
semi solid blocks?

---------------------------------------------------
when player is stuck in blocks he can jump through solid
because of snapping
---------------------------------------------------
this has been al_fixed....



---------------------------------------------------
when player is stuck in blocks he can move side to side with left and right
---------------------------------------------------
both semi and solid...fixe by setting left accel and riught accel to zero if block detected



I have al_fixed the semi problem....yay....





I am now in the middle of the riding lift through blocks bug...
but I have to go to work....

08/12/17 07:01


new save....









----------------------------------------------
player pushed downward by lift...
damage??
push through semi???
----------------------------------------------
actually player rides the lift downward through both
this needs to be al_fixed.....


when lift going up, get picked up and pushed through blocks

wehn lift going down, same...

I think the things I need to change are in the lift ride section



when a player is riding a lift...
- still process the xmove as normal
- add lift's xinc to player...or maybe player's xinc would be better
- still process x wall collisons the same as when not riding lift

-ymove is different
- allow jump if riding lift
- add lift's yinc to player.. or maybe snap to position

- if going up process up collision and make player fall off lift..maybe damage too (one hit)

- if going down process down collision and leave player on blocks...


seperate all riding lift stuff out of y move and make a paralle version for that...



old y move (for ref , in case I fuck it up....)


         if ((players[p].yinc < z) && (!players[p].player_ride))  // if rising and not riding lift
         {
            if (players[p].jump) players[p].yinc += slow_gravity; // if jump pressed, apply less gravity
            else players[p].yinc += gravity;                      // apply regular gravity
         }
         if (players[p].yinc < z)                                 // if still rising
         {
            players[p].PY += players[p].yinc;                     // apply yinc
            x = al_fixtoi(players[p].PX);
            y = al_fixtoi(players[p].PY);
            int a = is_up_solid(x, y+2, 1);                       // look for collision above
            if ((a == 1) || (a > 31))                             // solid or lift only
            {
               players[p].PY -= players[p].yinc;                  // take back move
               players[p].yinc = z;                               // kill upwards motion
               players[p].PY = al_itofix(((y/20) + 1) * 20);         // align with ceiling
            }
         }
         if (players[p].yinc >= z)                                // falling or steady
         {
             if (!players[p].player_ride)                         // if not riding lift
             {
                players[p].yinc += gravity;                       // apply gravity to yinc
                if (players[p].yinc > terminal_velocity)          // check for terminal velocity
                   players[p].yinc = terminal_velocity;
                players[p].PY += players[p].yinc;                 // apply yinc
             }

            x = al_fixtoi(players[p].PX);
            y = al_fixtoi(players[p].PY);
            if (int a = is_down_solid(x, y, 1))                   // check for floor below
            {
               if ((a == 1) || (a == 2))                          // solid or semi-solid
               {
                  players[p].yinc = z;                            // kill downwards motion
                  players[p].PY = al_itofix(y - (y % 20));           // align with floor
               }

/*
               if (a > 31) players[p].player_ride = a;
               else players[p].player_ride = 0;





                  // check if being pushed downwards by lift





               if (a > 31)
               {
                  // check to see if block floor below
                  if (is_down_solid(x, y, 0))                   // no lift check
                  {

                     // squish
                  }
                  else
                  {
                     players[p].player_ride = a;            // number of lift he's riding
                  }

  */


               if (players[p].jump) // if jump pressed
               {
                  x = al_fixtoi(players[p].PX);
                  y = al_fixtoi(players[p].PY);
                  int a = is_up_solid(x, y, 1);
                  if ((a == 0) || (a == 2)) // only jump if nothing above
                  {
                     players[p].player_ride = 0;
                     players[p].yinc = initial_jump_velocity;
                     event(15, al_fixtoi(players[p].PX), al_fixtoi(players[p].PY), 0, 0, 0, 0);
                  }
               }
            }  // end of if floor below
         } // end of if falling or steady





in the not riding section we need a check to see if we should set player_ride

not only in the down section , but in all....



looking good....

sometimes player snaps weirdly when getting off lift going down onto block...al_fixed

when picked up by lift going up, small snap...done


looking really good....





add hurt to getting squished up and down


if ride up and hit solid
                  else // player knocked off lift due to collision above
                  {
                      players[p].player_ride = 0;
                      // take some damage
                      players[p].LIFE -= al_itofix(1);
                      event(35, al_fixtoi(players[p].PX), al_fixtoi(players[p].PY), 0, 0, 0, 0);

if riding and lift collison from above

                      players[p].player_ride = 0;
                      // take some damage
                      players[p].LIFE -= al_itofix(1);
                      event(35, al_fixtoi(players[p].PX), al_fixtoi(players[p].PY), 0, 0, 0, 0);






if not riding and standing on block and lift collision by lift going down.....


lift move 10
down hurt = 11
up hurt = 9

lift move 20
down hurt = 5
up hurt = 4

lift move 29
down hurt = 4
up hurt = 3

looks good.....

test left and right riding, collison and getting pushed
all looks good..

what about running when moving on lift, how it that handled?
so that no animation happens when riding?

look in draw player.....done

fix items riding lifts...snapping....

which one moves first...
lift then item...

player carrying item....
where set item pos...

player carry
then player move


player carry looks trivial enough to move to after player move.....done

when lifts pick up items from below, or apps through from above kill the snapping....done...


just broke bunch of stuff

test...

throw item up through lift
lift carry item


cant throw up while riding lift....


players yinc goes to max when riding lift.....al_fixed


items not pushed off lift moving left, right good....al_fixed

cant be between 2 lifts without dying....al_fixed

snap to when item falling onto lift....done


this took many hours but i think its finally done.....


09/12/17 11:19

made a new backup

20171209



what next....looks like everything on bugs is done....



---------------------------------------------------------------
remove the counting of player bullets...done
---------------------------------------------------------------




---------------------------------------------------------------
fixed a bug in level viewer, replaced SCREEN_W with 1280 and SCREEN_H with 1024

---------------------------------------------------------------


try a window 2048x1152, ng need to go about 10 smaller on each


---------------------------------------------------------------
in set a screen mode with SCREEN_W > 2000 the scroll screen thing doesn't work properly..al_fixed
---------------------------------------------------------------



---------------------------------------------------------------
scale factor does not preserve aspect ratio if set too small
---------------------------------------------------------------
make a function  called set_scale_factor
save scale_factor to config file.....

non blocking
will require key_held globals...
do for both speed and size
just like map...done


---------------------------------------------------------------
- in lift editor fix the create steps in a loop and create button
- in lift editor when creating a new lift can only add steps from menu, not pop up (until more steps are added)
---------------------------------------------------------------

what about if by deflaut mutiple steps....


changed from :
//         case 5: insert_lift_step(lift, step); break;

        to:
         case 5: insert_steps_until_quit(lift, step); break;

in pop up menu..works....

added insert_steps_until_quit(lift, step); to creator...works good there

removed call in create button...done

make exception for lift with only 2 steps in pop-up menu..done

when doing insert_steps_until_quit() popup menu has lift drawn on it....
move pop to above mouse, unless at bottom of screen...done



---------------------------------------------------------------
thought this was a bug but its all good...
lifts can fall faster than items...not sure if that matters
I like that item fall slower than player so that you can interact
better with them, even though that defies physics...
---------------------------------------------------------------


---------------------------------------------------------------
rotate text for vertical lifts!!!  ... done
---------------------------------------------------------------
how many places do I draw on lift...lots probably....
rotate the entire string, or each letter
only rotate if width = 1;


---------------------------------------------------------------
disable speed adjust in netplay  client always, server needed for testing
---------------------------------------------------------------



---------------------------------------------------------------
pm -u find a way to gracefully fail if share not there.....
----------------------------------------------------------------
unable to do... trying checking to see if exists, but that takes as long as the other way
the system gives a huge pause when looking for a share that is not there....







the latest version of allegro 4 is 4.4.2 and there is a dev pack for it...

what version am i using???? 4.2.2

I should try it....

looks like it works...
the color are still messed in full screen though..

If I could redo the first 8 and the last 10 colors, the rest of the pallete look OK.
colors 0-9 and 246-255

even though I change them in palette, they still don't show properly....


---------------------------------------------------------------
- make a way to access some new features (Use allegro's built in gui dialog stuff...)
-- deathmatch and suicide mode, server ip...done
---------------------------------------------------------------

make a gui to edit config stuff....
patch it into....command line flag for now....

I am amazed at how much I made use of the gui already
especially bitmap and block stuff, i have menu and everything....

I have deathmatch and suicide done and also saving to config file...

what else should be in there???
server name...as a text field...done...

under screen mode in option menu add:netgame config
done... till I think of more things to add to config..


---------------------------------------------------------------
need to pass values of sucide and deatmatch in SJON packet
---------------------------------------------------------------
done and tested

---------------------------------------------------------------
you can keep shooting the other player after he's dead....fixed
---------------------------------------------------------------

---------------------------------------------------------------
lost the bullet recoil for player on player...done
---------------------------------------------------------------
its because its applied to xinc and yinc
tried to apply directly to PX and PY but that looks blocky and dumb
need to add to left and right xinc
looks good, might be to much recoil
player's bullet travells at 12 pix/frame
recoil is set to 1/3 of that 4 fix/frame


---------------------------------------------------------------
when you kill player with a lot of right of left xinc it carries over to after death..fixed
---------------------------------------------------------------


11/12/17 03:20


---------------------------------------------------------------
if you die on a lift moving left right, you stop moving with the lift, but your feet start walking
if you die on a lift moving up down you freeze in place
---------------------------------------------------------------
how about when dying set riding lift to 0..better..done


-------------------------------------------------------------------------
make -c work without args, same with -s...done
-------------------------------------------------------------------------


---------------------------------------------------------------
no effect when player is shot from below when riding lift
---------------------------------------------------------------
fixed by making player_ride = 0
and adding yinc immediately
and raising y recoil from bullet_speed/3 to bullet_speed/2
looks good..

does extra running only happen in netgame....yes


made stop sounds into a function

in proc_level health added check for inactive player


---------------------------------------------------------------
when clicking on slider bar mouse snaps to left edge and value changes right away..fixed
---------------------------------------------------------------




---------------------------------------------------------------
sometime lev viewer does not show mouse nicely
---------------------------------------------------------------
also other viewers too...
show the mouse longer???
or not hide at all?

was :

      show_mouse(screen);
      al_rest(0.005);
      show_mouse(NULL);


works:
      show_mouse(screen);
      al_rest(0.02);
      show_mouse(NULL);

also works:
      show_mouse(screen);
//      al_rest(0.02);
//      show_mouse(NULL);

but its still sluggish
its like something is now taking a lot of time....


in item viewer i changed 10 to 20

      show_mouse(screen);
      al_rest(0.02);
      show_mouse(NULL);

but its still laggy

its like something is now taking a lot of time....

common to both is button and slider viewers

how about check in buttons for mouse move and don't draw unless moved

make a global function called mouse_change


int old_mouse_x;
int old_mouse_y;
int old_mouse_b;

int mouse_changed(void)
{
   int change = 0;
   if (old_mouse_x != mouse_x)
   {
      old_mouse_x = mouse_x;
      change = 1;
   }
   if (old_mouse_y != mouse_y)
   {
      old_mouse_y = mouse_y;
      change = 1;
   }
   if ( (old_mouse_b) != (mouse_b) )
   {
      old_mouse_b = mouse_b;
      change = 1;
   }
   return change;
}


completely removed show mouse from item viewer and it still looks good

buttons or sliders must be doing it...

doesnt work in lift viewer...


added if (mouse_changed) to button drawing
now only one button will redraw in between mouse changes...
need to put it where they are called...

done but now button miss getting clicked on unless held for a bit


what if i go back to alleg 4.2 and try that....al_fixed it

the item and lift viewer looks a lot nicer now with if(mouse_changed)





---------------------------------------------------------------
when server quits on client, you need to CTRL-ALT-END to quit game
---------------------------------------------------------------
make a client time_out....
make server send a server quit packet....


server now puts quit in game_moves


{
   set_comp_move_from_player_key_check(p); // but don't set controls !!!
   if (key[KEY_ESC])
   {
      players[p].comp_move = 127;

//      extern int game_exit;
//      game_exit=1;
   }


it should be propogated to clients before server processes it...

                  // what to do if server became inactive and is alp.. nothing different here

                  // what to do if server became inactive and is not alp...
                  if ( ((ima_client) && (p == 0)) || // server quit on client or
                      (p == active_local_player)) // local player quit
                  {
//                     if (ima_server)
 //                    {

   //                  }

                     players[p].active = 1;          // re-enable
                     players[p].control_method = 0;  // return to local mode
                     if (ima_client) ima_client = 0;
                     if (ima_server) ima_server = 0;
                     game_exit = 1;
                     resume_allowed = 0;

seems to work



time for me to get ready for work...

11/12/17 06:54

make a new backup

20171211


made an icon for the program
cropped a 20x20 square from exported sprites and saved as png
opened in gimp -- layer,transparency, color to alpha, black, saved back to orignal
went to a website to convert png to ico
added in dev-cpp project options


12/12/17 03:54


maps and background fill is called from init setup and in loop after loading new level
removed all mention of it...


---------------------------------------------------------------------------
make auto full screen work by setting window just smaller than desktop size...

put screen setup stuff in screen file....done

make a command line set screem thing
-b 2344 2345

just set and let init screen handle it....
---------------------------------------------------------------------------

12/12/17 06:05

-------------------------------------------------------------------------
when returning from level editor to game, menu items need to be updated
like screen size, and start level and speed...done
---------------------------------------------------------------------------

12/12/17 06:15

---------------------------------------------------------------
current level disappers when going to options menu...fixed
---------------------------------------------------------------

12/12/17 07:06

---------------------------------------------------------------
show level data erases too much on the right...fixed
---------------------------------------------------------------


time to go.....


13/12/17 04:37


---------------------------------------------------------------
why does level less than 100 exit instantly??...fixed
---------------------------------------------------------------
only one level does this...level 4

level 206 goes to 215 without stopping, each level quits instantly
level 215 shows lots of items in position 0

all items are at position 0 when level starts...
i must have removed something that sets this

void maps_and_background_fill()
{
   // add this to load
   for (int x=0; x<500; x++) // set all of itemf[500][4] to 0
      for(int y=0; y<4; y++)
         itemf[x][y] = al_itofix(0);

   for (int x=0; x<500; x++)
      if (item[x][0]) // only if active clear x y
      {
         itemf[x][0] = al_itofix(item[x][4]);
         itemf[x][1] = al_itofix(item[x][5]);
      }


   // this is already done at load
   for (int d=0; d<num_lifts; d++)
   {
      lifts[d].fx = al_itofix(lift_steps[d][0].x); // set  x
      lifts[d].fy = al_itofix(lift_steps[d][0].y); // set  y
      lifts[d].fxinc = al_itofix(0); // set xinc
      lifts[d].fyinc = al_itofix(0); // set yinc

      lifts[d].current_step = 0;  // mode 0
      lifts[d].limit_type = 5;  // type wait for time
      lifts[d].limit_counter = 0;  // 0 = no wait! immediate next mode
   }


   // this is done elsewhere
   clear(scrn_buffer);
   for (int x=0; x<100; x++) // fill maps and background
      for (int y=0; y<100; y++)
      {
         int c = l[x][y];
         if (c < NUM_SPRITES) blit(memory_bitmap[c], l2000, 0, 0, x*20, y*20, 20, 20);
         if (c == 169)        blit(memory_bitmap[0], l2000, 0, 0, x*20, y*20, 20, 20); // map transluscent
      }

   // do I need to do this between levels ??? yes.... where
   for (int c = 0; c < 50; c++)
   {
      e_bullet_active[c] = 0;
      e_bullet_shape[c]  = 0;
      e_bullet_fxinc[c]  = al_itofix(0);
      e_bullet_fyinc[c]  = al_itofix(0);
      e_bullet_fy[c]     = al_itofix(0);
      e_bullet_fx[c]     = al_itofix(0);
      for (int y=0; y<6; y++)
         pbullet[c][y] = 0;
   }
}

void clear_bullets(void)
{
   for (int c = 0; c < 50; c++)
   {
      e_bullet_active[c] = 0;
      e_bullet_shape[c]  = 0;
      e_bullet_fxinc[c]  = al_itofix(0);
      e_bullet_fyinc[c]  = al_itofix(0);
      e_bullet_fy[c]     = al_itofix(0);
      e_bullet_fx[c]     = al_itofix(0);
      for (int y=0; y<6; y++)
         pbullet[c][y] = 0;
   }
}




13/12/17 06:08


---------------------------------------------------------------
test what happens if no config file and make it all good..done
---------------------------------------------------------------

defaults
speed = 4;
level = 1;

keys...good

sound

make new sections in cfg file

[GAME]
color = 7
start_level = 1
speed = 40


[GAMECONTROLS]
p1_up_key = 9
p1_down_key = 11
p1_right_key = 12
p1_left_key = 10
p1_jump_key = 75
p1_fire_key = 3
p1_map_key = 13
p1_menu_key = 59

[SOUND]
sound_on = 1
se_scaler = 3
st_scaler = 0

[SCREEN]
dsx = 2048
dsy = 1152
gfx_card = 2
sx = 2032
sy = 1136
scale_factor = 1.010000

[NETWORK]
server_IP = 4230j
deathmatch_pbullets = 1
suicide_pbullets = 1


[LEVEL_EDITOR] remove
disable for now...done
remove from menu...done


add a function to get all the config values

void get_config_values(void)
{

}




13/12/17 07:53


go to work....






-------------------------------------------------------------
some of the time draw doesn't need to reload level_buffer
-------------------------------------------------------------


when level not found... reset num_lifts..done

and dont display menu map...



how many custom handlers for screen size do I have in the game....

in frame and title

   if (md == 9) // 1400x1050
   if (md == 8) // 1280x1024
   if (md == 4) // 1024 x 768
   if (md == 3) // 800 x 600
   if (md == 2) // 640 x 480

anywhere else in game...?? md is used..??


here is what I need to do...
- based on SCREEN_H I need to decide how big to draw the map
- i guess also bases on SCREEN_W if skinny...


to test this I should make a way of changing the SCREEN_W and H while displaying the screen....

changed
void frame_and_title(void)
{
   int ft_SCREEN_W = SCREEN_W;
   int ft_SCREEN_H = SCREEN_H;


I now have a nice way of testing the change i make

redo how the map is drawn


frame and title don't even draw the map....????

draw_level in file...???

moved a bunch of draw functions from file to scrn



its usually called like this...in main
      slow_load_and_draw_level(start_level);
      frame_and_title();
      show_level_data(SCREEN_W/2 + md*50 + 2, 140);

find out the difference between slow_load_and_draw_level(start_level) and and draw_level


slow, calls load, then draw


what is up with l2000?  i would like to not use it in the game at all.

use level_buffer....

later i might do the same with level editor.....


make a replacement for draw level that uses level_buffer
and the normal game draw routines...


where do the blocks get drawn on the level???


l2000 gets blitted to level_buffer

where to do the blocks get drawn to l2000?

it turns out it happens in stimp....



so this is the draw procedure...
level loaded

blocks drawn to l2000 by stimp

every frame:

level_buffer direct copy from l2000
draw everything on level_buffer

grab a peice of that for the screen display
draw the overlay on that.....



i need to make a better place than stimp to draw all the block on the l2000

i have: add_eilp_to_l2000();

how about add blocks to l2000

modify add_eilp_to_l2000();

void add_eilp_to_l2000();

void add_l_to_l2000();

already have what I need:

void restore_l2000(void) // used by stimp
draws block and lift lines

commented out:
stimp
stamp
void add_eilp_to_l2000 killed....

made new function that will do it all...

void draw_level2(ALLEGRO_BITMAP *bmp, int mx, int my, int ms, int blocks, int items, int enemies, int lifts, int players)

have all of the draw and slow draw and load figured out....



next get the map size on the menu right......

md and mx are set in frame and title

are used in draw_level..

ill make draw level do its own thing....


the drawing routines are cleaned up a lot....

I still want to do the stimp and stamp

the longest text of level data is
99 Block Walker (15 char) 15 x 8 = 120

use that to determine the spacing


I still want to do the stimp and stamp


find a place to put the player standing on a block

get his position on the screen when the level starts (usually near the middle but not always)

divide that motion by x equal steps

for the map i will need 8 points

x and y pos and size


14/12/17 07:43

this has been taking a long time......


15/12/17 02:44


I need to make a bridge between my normal drawing during the game
and my map drawing on the menu screen

the first is when I am zoomed on more
the second is when I am zoomed out more

they both meet when the level is the same size as the full screen

they both use level buffer as the source

do either cause errors when they go to far?


15/12/17 03:19

removed slow draw and load level
and replaced it in 3 place with just load level

added set player pos to load level

should also add set ememies and items init rot to load.....



------------------------------------------------
items and enemies dont have proper rotation
------------------------------------------------

not set properly in lev editor....

enemy bouncer
- always does seek first thing
- unless seek count is set to zero
- does not show rotation until seek is done...


set_xyinc_rot(num, get100_x*20, get100_y*20);

the level editor is still using floats....


   // temp hack because level editor is still using floats....

int e_get_rot_from_xyinc(int EN) // modified version for the editor only which still uses floats
{
   al_fixed xlen = al_ftofix(Ef[EN][2]);
   al_fixed ylen = al_ftofix(Ef[EN][3]);
   al_fixed angle = fixatan2(ylen, xlen);
   return al_fixtoi(angle) - 64;
}

this was already done...just need to change...
     get_rot_from_xyinc(int EN)
to e_get_rot_from_xyinc(int EN)


I should us glt to fix all bouncers
cannons??? no, their rot is based on the player


set cannons and bouncers bounce count to 0 in PDE
so that they don't seek first thing...done

use glt to set Ei[EN][7] all to zero for bouncers 4 and cannons 6
done....

use glt to fix all existing bouncers initial rot...done....


cannons needs a way to set to stationary
how about set speed = 0 then move direction??

yes that works


setting the speed on cannon does funny things...
set to zero does not seem to

when you change speed on cannon, x and y inc change too, where????

   if (bn == 22) // scale bouncer speed
   {
      float old_speed = Ef[num][5];
      Ef[num][5] = f;
      float ratio = Ef[num][5] / old_speed;
      Ef[num][2] *= ratio;
      Ef[num][3] *= ratio;

      if (f == 0)
      {
         Ef[num][2] = 0;
         Ef[num][3] = 0;
      }

   }

fixed... now can set speed to zero and don't have to get new direction..

if set bouncer speed to zero, cannot set rot with direction but who cares!


also rocket's rot is set good in lev editor and shows
works good in game, but shows wrong rot in game...

look like item[x][2] = 2;    // rotate draw is not set... why???
not set in PDE...changed

use glt to fix all....done

15/12/17 05:24

back to screen stuff....



copy paste from before last bug fix:


I need to make a bridge between my normal drawing during the game
and my map drawing on the menu screen

the first is when I am zoomed on more
the second is when I am zoomed out more

they both meet when the level is the same size as the full screen

they both use level buffer as the source

do either cause errors when they go to far?


make the map thing work, forget about player for now...


how about starting the level from the map and then stretching into it...

see if I can make the regular draw routine work that small...


that would involve making the sacle factor smaller..

remove limits and see what makes it crash


how about detect if the window we want is smaller that the screen_buffer

done and works great.....

it should be easy to get this to play nice with the map now....





15/12/17 06:58


time for work




15/12/17 11:55
back for lunch

made a new back up 20171215



need some global variables,


to know where the menu map is (this will be the initial position)
int menu_map_x;
int menu_map_y;
int menu_map_size; // convert to scale factor
to convert map_size to scale_factor
scale_factor = (float)menu_map_size / 2000;

and to control the stimp....

what are the final values?

based on where the player is in the level


moving scale factor

final_scale_factor (the one we use now)
map_scale_factor (the one at the beginning)


when you start the game (transition from menu to pm_main)
set scale_factor to map_scale factor

i need to separte the final scale from the current scale


scale_factor
scale_factor_current
scale_factor_inc

scale_factor - the one that gets set by the user

scale_factor_current - the one that is used to draw



this seems to work good...

there is a huge jump when the screen size gets to the size of the screen buffer

also inc should be logarithmic or based on a percent of the difference.

it goes too fast at small values and too slow at large values....




i think it looks funny because the player positions should be the center of the zooming in


- find out where that will be once everything has been zoomed in
-









here is the old stimp and stamp


extern float steps;
void stamp(void)   // stretch animated shrinkage of play screen to map
{
       extern int mx, my;
       add_eilp_to_l2000();
       WX = (int)players[0].PX  - (SCREEN_W/2)-10; // set window from players[0] -> PX ,players[0] -> PY
       WY = (int)players[0].PY  - (SCREEN_H/2)-10;
       if (WX < 0) WX = 0;
       if (WX > 1999 - SCREEN_W) WX = 1999 - SCREEN_W;
       if (WY > 1999 - SCREEN_H) WY = 1999 - SCREEN_H;
       if (WY < 0) WY = 0;

      if (1)
         {
            int x;
            float inc1 = (0-WX)/steps;
            float inc2 = (0-WY)/steps;
            float inc3 = (2000-SCREEN_W)/steps;
            float inc4 = (2000-SCREEN_H)/steps;
            float inc5 = (mx-0)/steps;
            float inc6 = (my-0)/steps;
            float inc7 = (md*100-SCREEN_W)/steps;
            float inc8 = (md*100-SCREEN_H)/steps;


            float s1 = WX;
            float s2 = WY;
            float s3 = SCREEN_W;
            float s4 = SCREEN_H;
            float s5 = 0;
            float s6 = 0;
            float s7 = SCREEN_W;
            float s8 = SCREEN_H;
            ALLEGRO_BITMAP *ht;

            ht = al_create_bitmap(SCREEN_W, SCREEN_H);

            for (x = 0; x<=steps; x++)
               {

                  stretch_blit(l2000, ht,(int)s1,(int)s2,(int)s3,(int)s4,(int)s5,(int)s6,(int)s7,(int)s8);

                  rectfill(ht,(int)(s5-inc5), (int)s6     , (int)(s5-inc5+s7-inc7), (int)(s6-inc6),         0);
                  rectfill(ht,(int)(s5-inc5), (int)(s6+s8)  , (int)(s5-inc5+s7-inc7), (int)(s6-inc6+s8-inc8), 0);

                  rectfill(ht,(int)(s5-inc5), (int)(s6-inc6), (int)s5,  (int)(s6-inc6+s8-inc8), 0);
                  rectfill(ht,(int)(s5+s7)  , (int)(s6-inc6), (int)(s5-inc5+s7-inc7), (int)(s6-inc6+s8-inc8), 0);

                  blit(ht, screen, 0, 0, 0, 0, SCREEN_W, SCREEN_H);

                  rest((int)(x/steps*50));

                  s1+=inc1;
                  s2+=inc2;
                  s3+=inc3;
                  s4+=inc4;
                  s5+=inc5;
                  s6+=inc6;
                  s7+=inc7;
                  s8+=inc8;


               }

       }
}
void stimp(void)   // stretch map animated growage of map to play screen
{
   extern int mx, my;
   add_eilp_to_l2000();

   int SW = SCREEN_W;
   if (SW > 2000) SW = 2000;
   int SH = SCREEN_H;
   if (SH > 2000) SH = 2000;

   WX = al_fixtoi(players[0].PX) - (SW/2)-10; // set window from PX,PY
   WY = al_fixtoi(players[0].PY) - (SH/2)-10;

   if (WX < 0) WX = 0;
   if (WX > 1999 - SW) WX = 1999 - SW;
   if (WY > 1999 - SH) WY = 1999 - SH;
   if (WY < 0) WY = 0;

   int x;

   float inc1 = (0-WX)/steps;
   float inc2 = (0-WY)/steps;
   float inc3 = (2000-SW)/steps;
   float inc4 = (2000-SH)/steps;
   float inc5 = (mx-0)/steps;
   float inc6 = (my-0)/steps;
   float inc7 = (md*100-SW)/steps;
   float inc8 = (md*100-SH)/steps;

   float s1 = 0;
   float s2 = 0;
   float s3 = 2000;
   float s4 = 2000;
   float s5 = mx;
   float s6 = my;
   float s7 = md*100;
   float s8 = md*100;
   ALLEGRO_BITMAP *ht;

   ht = al_create_bitmap(SW, SH);

   blit(screen, ht, 0, 0, 0, 0, SW, SH);

   for (x = 0; x<=steps; x++)
   {
      stretch_blit(l2000, ht,(int)s1,(int)s2,(int)s3,(int)s4,(int)s5,(int)s6,(int)s7,(int)s8);
      blit(ht, screen, 0, 0, 0, 0, SW, SH);

      rest((int)(x/steps*50));

      s1-=inc1;
      s2-=inc2;
      s3-=inc3;
      s4-=inc4;
      s5-=inc5;
      s6-=inc6;
      s7-=inc7;
      s8-=inc8;
   }
   restore_l2000();
}



i don't really want to do this while the level is playing

or do I

i could get the player to join when the zoom is done...

if the player leaves the level continues...???



16/12/17 02:49

---------------------------------------------------------------
add bullets to draw level2
---------------------------------------------------------------
added... needed to make them optional, like only if resume allowed...done


---------------------------------------------------------------
changed the draw order in loop so that player get drawn last, on top of everything else
---------------------------------------------------------------



then I want to fix the line of players on the menu...

start with the biggest one first the zoom out towards the corner...

the bigest one should not change with screen size....



i am trying to get a smooth scale change

from 5 to small when the loop goes from 0 - 10

if I do 5/(loop + 1)

the change is very fast at the beginning... 5, 2.5, 1.6, 1.25

if I do a al_fixed step like .5

      al_fixed sc = f5 - fixmul(al_itofix(a), sc_step);

the change is slow to start then fast at end...5, 4,5, 4,0, 3,5

what can I do to split the difference

5  steps = 460 - 316 = 144
10 steps = 460 - 265 = 195
12 steps = 460 - 208 = 195
15 steps = 460 - 253 = 207
20 steps = 460 - 250 = 210


16/12/17 07:02

i have fixed the line of players on the menu screen...it only took 4 fucking hours!!!
for 50 fucking lines....



moving on....


today I want to get stimp and stamp done

they are going to be stand alone cut scenes between the menu and the game....


they will not run when the game is running....



16/12/17 08:21

it took over an hour to figure out why I couln't predict where the player would be when the game started

i got it now....

adjusted to the right size of rect for player start

also the detection doesn't work when the level is smaller than the screen and get centered....


now what?

find the players position on the menu map.... and mark it....done

16/12/17 09:07

that only took 40 minutes....



how many steps to get from here to there?


enlarge the map level, centered on the start, moving to the second position.


now I need to make a funtion that will draw the level, centered on a specfic bkoc....



draw_level_centered(bmp, int screen_x, int screen_y, int level_x, int level_y, al_fixed scale)
{
    // draws the level on the bmp so that the level_x,y are at screen_x, y
    //

}

16/12/17 13:19

done and damn does it ever look good....

when stamping and the level gets smaller than the screen, clear to avoid smearing
done


I want to make the zooming use a percentage rather than an increment
go at what seems to be a constant speed

   float sc = (float)size / 2000;
   float scf = scale_factor_current;

   float sc_inc = (scf - sc) / num_steps;

   for (int steps = 0; steps<num_steps; steps++)
   {
      sc += sc_inc;

sc *= .98 or something....


// find out what the inc needs to be...

   float sc = (float)size / 2000;
   float scf = scale_factor_current;
   float sc_inc = (scf - sc) / num_steps;



this works great...

   float a, per = 1.000;
   do
   {
       per += .0001;
       a = sc * pow(per, num_steps);
   }
   while (a < scf);


   for (int steps = 0; steps<num_steps; steps++)
   {
      sc *= per;




----------------------------------------------------------------------------------------------
i am finally done with the screen stuff, unless I find a bug
16/12/17 14:41

------------------------------------------------------------------------------------


make backup

20171216


-----------------------------------------------------------------------------
scale factor smooth change...done
-----------------------------------------------------------------------------



cleaned up some draw functions in level editor

void draw_big_no_lifts(void) in nlv

      case 10:
         clear(l1000);
         stretch_blit(l2000, l1000, 0, 0, 2000, 2000, 0, 0, 1000, 1000);
      break;
      case 7:
         clear(l700);
         stretch_blit(l2000, l700, 0, 0, 2000, 2000, 0, 0, 700, 700);
      break;
      case 6:
         clear(l600);
         stretch_blit(l2000, l600, 0, 0, 2000, 2000, 0, 0, 600, 600);
      break;
      case 4:
         clear(l400);
         stretch_blit(l2000, l400, 0, 0, 2000, 2000, 0, 0, 400, 400);
      break;

and void draw_big(void) in fnx does the same....

where are these used???

they both draw on level_2000 then blit to the smaller maps...


first step

make draw_big take over what draw_big no lifts does with a parameter

draw big (int draw_lifts)
remove  void draw_big_no_lifts(void) done

change to use my other draw level stuff from game

done... draw_big is now very small


16/12/17 16:15






now having troubles with items and enemnies showing in editor because f's are not set
for items did this in item sort

make sort fix this...so they will draw...done

enemies and items don't erase.. need to kill the f as well????
blocks dont show in level editor???
the problem is that the level editor does everything on l2000
but the draw routines in the game expect that l2000 just has blocks and lift lines backgound
solution, make the draw big routine redraw l2000


this has all been al_fixed....


16/12/17 20:05

map translucent blocks.. do they even do anything
I can't view them in the level editor
remove them and do glt to set them all to 0


it has been a very productive day...

tomorrow...



make the selection window in zoom full screen the right size
...make the exit window the right size

-------------------------------------------------------------------------------------
when game first starts make the scale_factor_current = scale_factor...done
--------------------------------------------------------------------------------------

level done stimp.....done

17/12/17 04:24

make fruit carryable...done
make bonus event show only health...done

remove bullet and timer bonus from level editor
set PDE 20 to zero

16 in a row
2 rows + 6

still shows

erase all variables, still shows....

sort PDE???

how far back do I have to go to find that??? ..done

I should make the sort routine put
line 1 = creators
line 2 = items
line 3 = enemies


step 1 sort all creator to the start
step 2


step 1 put everything at 50+
step 2 move creators to 0+
step 3 move items to 16+
step 4 move enemies to 32+


done

why don't I have a way to edit the PDE text???

patched it in from a previous version and fixed it up.

needed while (key...s added and marked text entry pos..
works great and the whole text edit thing is 130 lines....

I am done with PDE for now...

17/12/17 08:06

health + should show in green and health - in red....

made a new event 7 for h-

I should make a nice funtion to replace the 20 times i do this...

         case  23: slide_bmsg();sprintf(b_msg[0], "Enemy killed by bomb!"); bottom_msg = 120; bottom_msg = 120; erase_last_bmsg(); break;


void new_bmsg(char *nb);

void new_bmsg(char *nb)
{
    slide_bmsg();
    sprintf(b_msg[0], nb);
    bottom_msg = 120;
    erase_last_bmsg();
}

case  23: new_bmsg("Enemy killed by bomb!"); break;

done and it looks alot better....

patch in event 7 where player takes damage

player touched mine
player hit by bullet
player hit by enemy
player stuck
player squished
what about bomb damage??? done

disabled a bunch screen messages, they were cluttering up the display

all that's left is H+ and H-

fix their colors....done

why doesn't player take bomb damage??? looks like he does to me...

17/12/17 10:03


---------------------------------------------------------------
when going from playing a level to level editor, bullets are shown...fixed
---------------------------------------------------------------


-------------------------------------------------------------------------------------
Make keys so that they can either work like original and remove a rectangular block
or new mode where they only remove their colored key block in the range specified
all I would need is a bool value, and keep the same block range....
--------------------------------------------------------------------------------------

add a button for this

default 0 normal, like old

when setting block range don't change blocks

done

17/12/17 11:02

missed health- for deathmatch...done



-------------------------------------------------------------------------------------
change the door shapes, I've never really been satisfied with them
how about a swirling vortex in for door and out for exit....
how about marking them somehow so you can tell they are a matched set ...done
-------------------------------------------------------------------------------------
made 2 new ans
83 in
84 out

made a new PDE door that uses 83

overrode the draw for doors and always use these ans now
also draw the exit and text in and out and line connecting them
and won't activate unless up is pressed....wow!

17/12/17 14:54

maybe the lines won't show unless you are standing on the door

maybe I could make it an option to blindly teleport or require up pressed



go through all the levels with glt and get rid of any timer or bullet bonus....done

change glt to restore start level after its done...done

i can make a carryable door now.....do it....done

can I carry the exit as well??

not unless you link it to to another item...

It would be so cool to have a two way door...2 door linked that you could got back and forth and move both ends

make an item that can do this


how will you handle the linking?


make a button that chooses the item to link to

then the second on can link back, or link to yet another one...


modify the door to do this

the exit can be another door..

if the other door has no exit then it is a one way door..


use a variable in door...lets say 10

call it the exit link...

store item number to exit to like 1024 + item num

item can be any item...

if the door has no exit link then it does nothing

if the exit link = -1


-----------------------------------------------
extend the shit out of doors
-----------------------------------------------

- can be:
- a one way door
- a two way door
- an exit only

- chooseable ans
- press up or down to activate or always activate
- link to destination door
- show line to dest always, never, only when player touches
- stationary, fall or carry
- cycle through colors and number to match in to out

where to start?

what variables are currently used?

0 = type
1 = draw item
2 = draw type
3 = fall/carry
4 x pos
5 y pos

6 door dest x
7 door dest y

new vars

8 use dest (if 1 use dest)
9 linked item number


8 type
0 - normal, old style, use 6,7 for dest and ignore the rest
1 - new style, use linked item for dest
2 - exit only

9 linked item number

-add button to door
- static destination
- linked item destination
- exit only

-add button and a way to set linked item
- re-purpose get new destination button to either do that or set linked item

- door can be both an in and an out
- many items can point to the same item as destination
- a 2 way door can be made by linking 2 type 1's to each other
- a 3 or more way ring can be made the same way


make a funtion like getxy, but that lets you choose a single item...

int get_item(void)
{

}

18/12/17 04:27

made that work get_item


now make the code work....

i think the 2 way door triggers return immediately...

make it a 2 part move
- press up gets you in
- release up gets you out

I need a var in item, called up pressed
if up pressed set up pressed

                      if (players[p].up) item[x][10] = 1;
                      if ((!players[p].up) && (item[x][10] == 1)) // up was just released
                      {
                         item[x][10] = 0;

done
bug..if up pressed then walk away, come back and immediate enter

                      if (players[p].up) item[x][10] = passcount;
                      if ((!players[p].up) && (item[x][10] == passcount-1)) // up was just released
                      {
                         item[x][10] = 0;
that fixed it...



2 part door works....

3 part door....works

all moveable...change to use f position...done

code looks good, now fix draw...

al_fixed dest doors are drawn by old regular code..

new style are drawn by new code, but ans is ignored

i should make old style show dest also....done

now back to level editor to fix view there...looking good
need to redraw after buttons pressed...done...


now patch in some ans chages and respect them in draw...

creators

- regular old style door with al_fixed dest exit
- new door with linked item exit (one way)
- new door with linked item exit (2 way)

- patch in the immediate or button pressed stuff....
use 11 (0-immed, 1 = up 2 = down)
now make it work in game...seems to work just fine


- show line to dest always, never, only when player touches
use 12 (0 = never, 1= always, 2 = when player touches)

use player color...done

this is looking good.....

time for work

18/12/17 06:53

make a new backup....

20171218



---------------------------------------------------------------------------------------------
what if I changed the key hold off...done  19/12/17 01:42
---------------------------------------------------------------------------------------------
make the enter immediate and then not trigger on next
next on needs to have player let go of key and then repress

basically when sending to an exit, check if the key needed to
trigger it is already pressed..

then wait until it is not

old method (waited until release
/*
                        // to prevent immediate triggering of destination door, wait for release
                        if (players[p].up) item[x][10] = passcount;
                        if ((!players[p].up) && (item[x][10] == passcount-1)) // up was just released
                           do_entry = 1;
*/

new method (waits at dest until release and re-press)

                        // to prevent immediate triggering when destination door, wait for release and re-press

                        // if key held is old, ignore
                        if (item[x][10] && item[x][10] < passcount-1) item[x][10] = 0;

                        // up pressed and !pressed last frame
                        if ((players[p].up) && (!item[x][10])) do_entry = 1;

                        if (players[p].up) item[x][10] = passcount;
                        else item[x][10] = 0;


in dest...
                           // set key held for dest door to prevent immediate re-trigger
                           item[li][10] = passcount;



-------------------------------------------------------------------------------------------
stimp and stamp are very slow on slower hardware...
i should make the delay based on time rather than raw speed...  done  19/12/17 01:49
-------------------------------------------------------------------------------------------


---------------------------------------------------------------
if player paused don't animate walk....done
---------------------------------------------------------------


---------------------------------------------------------------------------------------------
make a function like shows all lifts, but shows all items...done 19/12/17 02:57
enemies done too...19/12/17 03:11
---------------------------------------------------------------------------------------------

this will really help in my trouble shooting......


---------------------------------------------------------------------------------------------
why doesn't item sort work like i though it would? ...done 19/12/17 03:14
---------------------------------------------------------------------------------------------
why does a newly created item not end up at the end of the list???
because item sort's secondary sort criteria is animation shape
removed that....now only sort by type....


--------------------------------------------------------------------------------
major bug - entering new items causes sort, which fucks up my linked items
done 19/12/17 04:27

--------------------------------------------------------------------------------
I could make a unique identifier in door items that doesn't change with sort
I could re-do sort to not fuck up the links


when setting a link to an item, also put the linked_item numer in the link items[15]
the linked item will have its own number in 15
then after sort...


look for door links and fix them

look for doors that 15 does not match number
if found then look for any door that links to that number
update that number in the source doors
upadte that number in final door.


at start of sort:

   // to not break linked items
   for (int c=0; c < 500; c++)
      if (item[c][0] == 1) //door
         item[c][15] = c; // tag this door with its original item number

at end of sort:

   // to not break linked items
   for (int c=0; c < 500; c++)
      if ((item[c][0] == 1) && (item[c][8] == 1))           // if door && exit mode == link
      {
         int link = item[c][9];                             // look for doors with that link in 15
         for (int d=0; d < 500; d++)
            if ((item[d][0] == 1) && (item[d][15] == link)) // found a door with link in 15
               item[c][9] = d;                              // update to new link number
      }

   // erase what we put in 15
   for (int c=0; c < 500; c++)
      if (item[c][0] == 1)     // door
         item[c][15] = 0;



---------------------------------------------------------------
bug? you can carry a door through itself...done 19/12/17 04:43
---------------------------------------------------------------
that's probably not a good things
how about if you enter a door you must drop the door if you are carrying it..

that was easy...done

how about also if you are carrying a door, you are prevented from entering it
that's ok but I still can't see when I throw a door up beause I enter it right away
use the <down> enter mode



doors are so awesome now!

I want to make them different colors, like I did with players

new shape...just a static door

when you open it, then the animation sequence runs
- the door opens
- the player shrinks and goes in

at the other end
- the door opens
- the player grows and comes out...


I need to make a new player state like paused...
- the level does not stop!!
- player is frozen and cant move (controls are inactive)

actually just like paused, only you don't die at the end.

how about when you hit ESC you get a little pop up menu
exit game, or quit and the game keeps running but you are not
participating....

add a new varible to player struct
int paused_type; // 1 = death wait 2 = door move
done....

now when enter door
set the pause and move player to new pos...

this broke my key holdoff that assumed next frame stuff...


add variable to player struct
int door_destination_item;



in player paused stuff, its not getting a final time through to reset everything....

saved time for work

19/12/17 07:42



2 way doors cannot use immediate trigger ot wi loop forever back and forth
not really a bug, just the way it is...


--------------------------------------------------------------------
when a player enters a door they should snap to it...done
and center the draw shpe on the line..done
--------------------------------------------------------------------

--------------------------------------------------------------------
bug-- if player quits in the middle of a door travel loop..fixed 19/12/17 13:46
even starting a new game won't get them out!!!
added  players[p].paused = 0;
to void init_player_before_level_entry(int p)
----------------------------------------------------------------------
do set rot from xinc for player when travelling...done

make the speed constant
when entering, find the distance

   al_fixed xlen = players[p].PX - Efi[EN][0];   // get the x distance between enemy and player
   al_fixed ylen = players[p].PY - Efi[EN][1];   // get the y distance between enemy and player
   al_fixed hy_dist =  fixhypot(xlen, ylen);     // hypotenuse distance
   al_fixed speed = Efi[EN][5];                  // speed
   al_fixed scaler = fixdiv(hy_dist, speed);     // get scaler
   al_fixed xinc = fixdiv(xlen, scaler);         // calc xinc
   al_fixed yinc = fixdiv(ylen, scaler);         // calc yinc
   Efi[EN][2] = xinc;
   Efi[EN][3] = yinc;

made this work good

19/12/17 14:52

try to carry item through door

it works, but its not shown till the end...look in item draw...or move
al_fixed... in proc item_move and proc item carry

19/12/17 15:23

you can carry a door through another door, that's cool...






what if I made my door travel thing way more complicated

like:
step 1 - freeze align with door and shrink and rotate

step 2 - travel

step 3 - unshrink and unrotate


------------------------------------------------------------------------------
make the get_item function better..it is very nice now
if cancelled don't change anything..done
if linked item = -1 dont actually use it in the code... done
also if dest x y out of bound don;t use...done
show the entry position.....
--------------------------------------------------------------------------


make a few creators...

- one way al_fixed position door (isn't that what I already have??) yes 209
- one way linked exit door 210
- two way linked doors 211

does PDE really need to set unused to 9999? takes a long time to scroll try 999
al_fixed...

why does by PDE creator make new doors at the start but other methods are at the end??
al_fixed...

made all three new creator work good...

next I need to make some new shapes and shit...

wasn't that how all this started?  you just wanted a new shape for door?!!

full closed door = 448

regular door open and = 5

new open only = 85
new close only = 86

patch shape in draw...done
make door stretch when player is touching...done

20/12/17 05:32



now make the new seq....

make modes for player_paused...


paused
paused_type

paused_mode
paused_mode_count

just use paused as a flag, not a counter

set the mode to 4 and the count to 20

that mode runs the counter down to 0 then next mode --

until mode == 0

can still use paused as count with xinc, yinc

just add modes and mode_count

no i guess you can't

also add
door_xinc
door_yinc
door_num_steps

to use in the proper mode...

this is what I added to player struct..

   int door_xinc;
   int door_yinc;
   int door_num_steps;

   int paused_mode;
   int paused_mode_count;


now patch it in to work as is...

add to player struct

al_fixed draw_rot
al_fixed draw_scale




---------------------------------------------------------------
fix the draw player and draw lit rocket to not use pivot...done 20/12/17 06:55
---------------------------------------------------------------
draw item does not use anything different for rocket
item move does not touch lit ricket
player carry does not touch lit ricket
in proc_lit_rocket

players[p].PX = itemf[c][0];
players[p].PY = itemf[c][1];
player_move does not touch rocket

proc lit rocket now sets the rot and scale
proc player carry resets it if not carrying


the modes things for door in working good...
now patch in some size changes for door modes....

i can't change the scale, because proc player carry resets it...!!!


time for a backup and work

20171220

----------------------------------------------------------------------------
i can't change the scale, because proc player carry resets it...!!!
fixed 20/12/17 08:43  dont reset if in paused mode...
----------------------------------------------------------------------------


is the code unneseccarily complex beacuse I am using the legagy doors too?
maybe....


i am adding

//   int dest_source_door_item;

   int door_start_item;
   int door_end_item;

to player struct

so that I can animate the exit door if there is one...

end door will be the same as source door if al_fixed, but add 2000 to item...
do i need that???  yes...no....
as long as I know the sent door i can figure out the dest item...

change in proc item collisn


when I'm creating door ami I doing it right with shapes???

fix the draw door to use what in item...done


rotate the player in prepartion for zoom


added    int door_draw_rot;
to player struct

set at door entry

now move to it slowly...

added    int door_draw_rot_inc;
to player struct

al_fixed player struct to this:
   al_fixed door_draw_rot;
   al_fixed door_draw_rot_inc;

looks really good now....

enter shrinks, rotates, and opens door

zoom keeps rot and size

exit unshrinks, unroates, and closes door...


what else do i need to do before doors are done...

patch in different shapes/ans

shape is being used dynamically

need a place to store the shape that its derived from

13 - base shape or ans

448 for blue door
83 for ans etc...

+1000 for color shifted custom shapes

make a new shape closing double doors too much work...

can't see mouse on bitmap copy...or select...al_fixed by removing show_mouse(NULL);


20/12/17 11:38

add 13 to creators...done

make+like bouncer....
bn 13 and 14

bn 52 door shape

done..now can choose 1083 ans or 448 door shape

make the draw code respect this...

draw_items still draws from item[][1]

exit position for al_fixed:
- use same as ent
- always use tan with out written on it...1004 shape or 1084 ans


after all this I still like the new shape better.

by design, can't change the exit door of static or exit only

should I remove the old style al_fixed destination doors?

I could convert them all in glt


then there would only be:

a door with an exit
a door with no exit (exit only)

8 would be
0:(no exit, link item nopt valid)
1: link item valid

in glt i would need to find all doors
if 8=0 make a new item and link it.

how to do this....
first try it on a test level like 1 or 2

i feel confident enough to run glt on everything...done

now check for any 8=0's if none chanhe all 2's to zero's

now all link invalid are 0

change in editor to prevent 2 from being set...
0 = exit only
1 = linked item exit

done

now change in code

item collision..done
item draw..done
change creators
old one... delete
new ones al_fixed..
pde done..
change in item viewer...

now it all looks good...

what about a button "go to linked item" "move linked item"?


---------------------------------------------------------------
should I kill left and right xinc when i go in door.probably...done 20/12/17 16:07
---------------------------------------------------------------
when I come out...


---------------------------------------------------------------
when moving door, in level editor, move is not shown...
---------------------------------------------------------------
does move need to draw big?
maybe just needs to set f's..yes..done20/12/17 16:12



---------------------------------------------------------------
when changed door from fixed to linked, can set to item that is not a door like 0;
---------------------------------------------------------------
what if i made it link to itself...if immed..dies there...
even if up still dies there

---------------------------------------------------------------
make doors be able to handle a zero move, like linked to themselves
---------------------------------------------------------------
done.. added code to prevent move if num steps is 0 or very high
21/12/17 02:52



--------------------------------------------------------------------------------
bug, when final lift moves before player can get there, then what??
--------------------------------------------------------------------------------
maybe I could make the option to diable shown moves
or make it dependant on if the dest link is stat
test it first...yes its bad when door is moving
test to see if both ent and exit are stat before move, else instant..done
21/12/17 03:29


---------------------------------------------------------------
players health bar not drawn??? only when changed ..done 21/12/17 03:34
---------------------------------------------------------------
so if you get hit by ane enemy and take 0 damage bar is not shown


---------------------------------------------------------------
when in item viewer and run create and no creator exists, blank item is created
---------------------------------------------------------------
done 21/12/17 03:38



--------------------------------------------------------------------------------
bug lift viewer make lifts inside out
create lift look bad with huge lift to start
--------------------------------------------------------------------------------

have i messed with getxy???

also view lifts make lifts inside out??
its fine in lift viewer, but once you leave they are backwards


why does lift_viwer create and destroy bitmaps....
what call it...


in:
void set_lift(int lift, int step)
{
   int c;
   while ((lift_steps[lift][step].type != 1) && (step > 0) ) step--;
   lifts[lift].x1 = lift_steps[lift][step].x;
   lifts[lift].y1 = lift_steps[lift][step].y;
   lifts[lift].x2 = lifts[lift].x1 + lifts[lift].width*20;
   lifts[lift].y2 = lifts[lift].y1 + lifts[lift].height*20;
   lifts[lift].fx = al_itofix(lifts[lift].x1);

a + was set to - ??? al_fixed...

now getxy....

commented out these 2 lines:
//                lifts[sub_type].x1 = dx * 20; // so fast_draw does the bulleye correctly
//                lifts[sub_type].y1 = dy * 20;

all good now  21/12/17 04:15


---------------------------------------------------------------
when touching multiple doors, all are marked, show which one will be triggered only
---------------------------------------------------------------
in proc_item_collision and item draw
first clear marked doors
mark the first door he see as the one
done...21/12/17 04:28


-----------------------------------------------------
what if i added the option to other enemy and item viewer, like lifts has
-the ability to mouse over and moves thing on the map screen??
-----------------------------------------------------
done for doors...21/12/17 05:29
this is so awesome and was actually quite easy to do...


-----------------------------------------------------
what if I can make it generic and let all items use it....
at least just to move their position... thats all im doing here...
-----------------------------------------------------
it has been patched in for all items..this is so fucking cool!!!
and easy...like yo mamma...21/12/17 05:50

what if a make it able to cross item types...
that seems to work...

what about co-located items...
if same type can access with next and prev buttons

if dif type, need to use prev and diff from another item of same type...
but that's no different from the way it was...

this all looks very good...

now can you patch in some specific items...

like keys block range....

upper left = move
lower right = resize

almost done...having some issues with redraw...

the only way i can get it to look nice is the redraw every time I eneter the routine..

I can only pass back the item number

what if a pass back the some more info...

actually the problem is that this function has no memory
if it had a global to tell what was selected last and if it changed...


time for work... last day of school for kids...21/12/17 07:00

time for a backup...

20171221 the winter solstice...!!


global int last_item



what if:

send num with flags

return num with flags

main code strips and saves flags, then sends them again

like + 1000 = kkbur  + 2000 = klr, etc...

then if they are different flag a redraw.. where??
probably in main so fnx can draw over it

make global...

obj
type
num
draw flag

and last of the same..

check if they are different and redraw...

what could change that requires a redraw?
- num changed
- num + secondary item changed

retrun num + secn item

I think i got it:

fnc return num + flags ; like secondary thing selected
main check if this has changed from last time and redraws
this seems to be working good.

the only other items:

sproingy, to adjust
bombs for damage range
rockets for same
rockets for direction

the only one that is even useful is sproingy

what about enemies, the same way???

wouldn't that be nice?

screen modes for the level editor

1000 and 700 defintely
600 and 400 could probably go...
but they still work, so why bother
the only thing that wont is the new level mover thing
that requires exactly 1280 x 1024 or it looks bad...
block and bitmap both require 480



in item viewer common buttons
give the option to only do one type or all types

lock type
lock num
next and prev types



---------------

i lost some notes beacuse i was editing the changes file in the wrong folder...
I have the item viewer thing done for sproingy
it took over 2 hours...

then i made move_enemy_with_map

made the base move part work
made podzilla and cloner move extra stuff also

working on podzilla, trigger box move

it is drawn diffenrlt in titler than i wold think

test to find out what's right...

show in game and test...


this is where we check for collision

   if (Ei[EN][5] == 0) // only trigger from mode 0
   {
      int x1 = Ei[EN][11]*20 - 10;
      int y1 = Ei[EN][12]*20 - 10;
      int x2 = Ei[EN][13]*20 + 10;
      int y2 = Ei[EN][14]*20 + 10;

      for (int p=0; p<NUM_PLAYERS; p++)
         if ((players[p].active) && (!players[p].paused))
         {
            int px = al_fixtoi(players[p].PX);
            int py = al_fixtoi(players[p].PY);
            if ((px > x1) && (px < x2) && (py > y1) &&  (py < y2))
            {
               Ei[EN][5] = 1; // triggered! mode 1;
               Ei[EN][6] = 0;  // zero counter
            }
         }
   }

this is how I draw the test rect...

         if (Ei[e][0] == 7) // podzilla
         {
            int x1 = Ei[e][11] * 20;
            int y1 = Ei[e][12] * 20;
            int x2 = Ei[e][13] * 20 + 20;
            int y2 = Ei[e][14] * 20 + 20;
            rect(level_buffer, x1, y1, x2, y2, 10);
        }


this is how I draw it in titler
            // draw trigger box
            rect(screen, (Ei[num][11]+1)*db, (Ei[num][12]+1)*db, Ei[num][13]*db, Ei[num][14]*db, 14);

changed to

            int x1 = Ei[e][11] * db;
            int y1 = Ei[e][12] * db;
            int x2 = Ei[e][13] * db + db;
            int y2 = Ei[e][14] * db + db;
            rect(screen, x1, y1, x2, y2, 14);



now what does getbox do???
al_fixed return from podzilla getbox that was subtracking 1

all looks good now

now patch in in the moves stuff!!!!!

22/12/17 09:09

22/12/17 09:33

the move stuff is patched in

different from key block range
- ul moves ul corner
- lr moves lr corner
- else where moves entire thing

where as key block range is
- ul moves entire thing
- lr adjusts lr corner

need to do something with mouse snap wghen clinking...nah..its ok

this is working good!!!!

I do this twice now.. is there a way to make it its own function??
probably not

do bounds check to prevent inverted boxes....done

how does all this shit work when size = 1....good
lr triggers last and box is able to be resized...
what else can i do??

kbr is bad with size 1

change kbr to same as pdt...done

it would be nice to do the mouse snap thing...done...

change the mouse pointer when we are going to stretch or move...done for podzilla


next cloner trigger box...

should be a lot like pod trigger box...

type 9
uses 11,12,13,14

patched in with one line, same as podzilla

now I need to fix just like podzilla.


check for collision...al_fixed

draw test rect...good

titler...done

getbox...good...


that was very easy to override...

if more of them have the same variables they will be easy to override....

next the cloner's source and dest boxes...

they are in the al_fixed/float section of enemy...

i should just do one then convert to other at the end...

22/12/17 12:53

time to go in the house and see what's up....



---------------------------------------------------------------
when player leaves rocket he still has left and right xinc ... need to zero...done 22/12/17 13:44
---------------------------------------------------------------

---------------------------------------------------------------
when door stretches can still see old door behind it...done 22/12/17 13:50
---------------------------------------------------------------



cloner source box

int x1 = al_fixtoi(Efi[e][6])/20;    // source x
int y1 = al_fixtoi(Efi[e][7])/20;    // source y
int x2 = x1 + al_fixtoi(Efi[e][2])/20;   // sizes
int y2 = y1 + al_fixtoi(Efi[e][3])/20;
int x3 = al_fixtoi(Efi[e][8])/20;    // dest x
int y3 = al_fixtoi(Efi[e][9])/20;    // dest y

button to get new source area, needs to also set fix...done in creator and both sliders buttons


check the sizes of cloner sources

why are they not ints....



at the top of z_emove documnet what variables are used...
maybe move cloners boxes to int sections...

I am thinking of using

15 16 17 18 19 20


20 is used as rot


who uses rot?

cannon, bouncer, trakbot,


I think it would make more sense
to have rot in the al_fixed section like

now...
Efi[EN][11] = scale multiplier
Efi[EN][12] = scale;
Efi[EN][13] = rot inc

change to:

Efi[EN][11] = scale multiplier
Efi[EN][12] = scale;
Efi[EN][13] = rot inc
Efi[EN][14] = rot

then I would free up a huge block of ints from 4 - 21


ok move it

in the draw code use EFi[EN][14]...done

fix bouncer move...

Ei[EN][20] = get_rot_from_xyinc(EN);


int get_rot_from_xyinc(int EN)
{
   al_fixed xlen = Efi[EN][2];
   al_fixed ylen = Efi[EN][3];
   al_fixed angle = fixatan2(ylen, xlen);
   return al_fixtoi(angle) - 64;
}

al_fixed get_rot_from_xyinc(int EN)
{
   al_fixed xlen = Efi[EN][2];
   al_fixed ylen = Efi[EN][3];
   al_fixed angle = fixatan2(ylen, xlen);
   return angle - al_itofix(64);
}

let these co-exist for now, until i can kill the one that returns int...can't

I am so sick of E floats...lets kill them!!!!!!

what actually uses them...probably lots of stuff

first move ei20


changed 3 function that return rot in int form to al_fixed....


   Efi[EN][14] = e_get_rot_from_xyinc(EN);
   Ef[EN][14] = al_fixtof(e_get_rot_from_xyinc(EN));


game looks good with new rot stuff:
     bouncer, cannon, trakbot and podzilla...


now how about lev editor?


I should run glt and set all the floats...done...not sure how it worked....

now all the places that show enemies

i think i am done here...

next move the cloners stuff to

15 16 17 18 19 20


right now it uses:


            int x1 = al_fixtoi(Efi[e][6])/20;    // source x
            int y1 = al_fixtoi(Efi[e][7])/20;    // source y
            int x2 = x1 + al_fixtoi(Efi[e][2])/20;   // sizes
            int y2 = y1 + al_fixtoi(Efi[e][3])/20;
            int x3 = al_fixtoi(Efi[e][8])/20;    // dest x
            int y3 = al_fixtoi(Efi[e][9])/20;    // dest y


they are all in 2000 format, but i want them in 100 format


run this through glt....


Ei[y][15] = al_fixtoi(Efi[y][6])/20;    // source x
Ei[y][16] = al_fixtoi(Efi[y][7])/20;    // source y

Ei[y][17] = al_fixtoi(Efi[y][8])/20;    // dest x
Ei[y][18] = al_fixtoi(Efi[y][9])/20;    // dest y

Ei[y][19] = al_fixtoi(Efi[y][2])/20;    // w
Ei[y][20] = al_fixtoi(Efi[y][3])/20;    // h


Ef[y][2] = 0;
Ef[y][3] = 0;
Ef[y][6] = 0;
Ef[y][7] = 0;
Ef[y][8] = 0;
Ef[y][9] = 0;


level 1 only for now

titler draw code...done

draw new source button and dest...good...

creator...done

cloner line...good (as good as they ever were)

will it work to the edges???..no -2 for x1 and y1 done.....



---------------------------------------------------------------
when you start level editor reset animation sequences...done
---------------------------------------------------------------
actually i just fixe the fucntion that resets the zz passcounts
to also set the index and the shape in zero



23/12/17 02:50

make sure that cloner source box is good...
tested good in level

now make the draw boxes good...


23/12/17 06:01
i think I am completly done with the enemy and item map move stuff...


next...door colors....


I am going to make some dynamically created array of door shapes like player...



void fill_player_bitmap(void)

   for (int x=0; x<16; x++) // player bitmaps
      for (int y=0; y<32; y++)
         player_bitmap[x][y] = al_create_bitmap(20,20);


ALLEGRO_BITMAP *player_bitmap[16][32];


add

ALLEGRO_BITMAP *door_bitmap[16][8];

initial setup:

   for (int x=0; x<16; x++) // player bitmaps
      for (int y=0; y<8; y++)
         door_bitmap[x][y] = al_create_bitmap(20,20);

make funtion to fill them and for now, show them

use same color scheme as player....

void fill_door_bitmap(void)

23/12/17 06:37
this is good enough for now to move on
i mean it works perfectly, the only issue is the solid blue 12 color

now I want to use these newly created bitmaps.....

pick an int to use for color...14
set the color picker to set it...done

next change draw item...

I'm going to have to animate this my self....

or could cheat and copy from 1083

tell me more....

in the draw code

how does zz work?? great!!!

now make the door color thing work in level editor..
need a redraw...done

draw item for viewer???

i got rid of one more place that custom draws items..

lets get rid of one more..

make a funtion to put the proper draw item shape in dtemp...

or make it return it....actually use already existing global dtemp



I have simplified my item drawing a lot

now there is one function to determine the draw shape:
"void get_draw_item_shape(int i)"

that is called by only 2 things:
"void draw_items(void)" in the game and
"void draw_item_shape(int num, int x, int y)" in the level editor




also can't set the other shape now...
should i bother fixing that???

lets look into that....
now that the draw only happens in one place....

newly created door have a color = 0, which doesnt not draw well...

why? fixed to make it 1 if 0

right now door draw completely ignores 1 and 13
shape is entirely chosen by color from door_bitmap


should i bother with the old door shapes???

the fancy door open stuff is still there,
it requires that 13 be set to 448
but it uses 1 to draw so its never seen

fixed it so that its seen now

that looks good

also made the door stay large by still triggering that player was on it
by removing player_puased from the collison check in draw item

wow...

what if I made these door colorfull also....

448 to 454 (7 shapes)

ALLEGRO_BITMAP *door_bitmap[2][16][8];

this looks so awesome.....

all the door colors of both type of shapes look really good.

I should set the default color in creators to not zero...done

i should change the button colors in the viewer...done....

the words OUT don't quite fit on dtemp....al_fixed

then I am really done.........23/12/17 10:41


make new backup  20171223...


---------------------------------------------------------------
bug...older doors tha have ans 1084 can not change ans now
fix with glt change all 1084 to 1083....done 23/12/17 18:12
---------------------------------------------------------------

---------------------------------------------------------------
single block cloners don't seem to clone anymore...
looks like cloner's haven't been glt'd...done 23/12/17 18:27
---------------------------------------------------------------



---------------------------------------------------------------
I don't like how you can carry items into walls, but its nice for bombs
---------------------------------------------------------------
---------------------------------------------------------------
when player drops item he is carrying, check that its not in a wall and fix it if it is
---------------------------------------------------------------
where can i detect that an item has just been dropped....
there is a perfect place in player_carry
aslo disallowed throwing item up if item is too stuck..done
24/12/17 05:12

---------------------------------------------------------------
make a nice graphical level selector..done
--------------------------------------------------------------
run it from main menu with a key short cut...U
now fine tune it...
re do it completely...
make it only show levels that exist
make it scale to different screen sizes, automatically.
to start with, based on the screen size, and number of levels found
choose the grid array size and level size

- do file_find and fill array just like glt does
- choose lev size (20x20) 50x50, etc
- choose grid layout (10 across 3 down, etc)

- draw the level grid
- process mouse clicks...

you make it sound so easy.....

the problem with this is that it breaks the "no mouse in the game"
thingy i got going.....
well you could always navigate with the keys....

next draw the grid over to the side and patch in a big view of selected...done.

now all that is left is to decide how big each part should be
and draw a legend...

make the big map 1/3 of the SCREEN_W..
are we assuming that SCREEN_W > SCREEN_H??
to test this I could put all the level icon in a bitmap array...
then I could redraw quickw for testing....

---------------------------------------------------------------
draw_level2 has weird artifacts at low stretching....nothing I can do
it is just what stretch blit and stretch sprite do...
avoided by only choosing multiples of 20 for the map icons...
---------------------------------------------------------------

--------------------------------------------------------------
start visual level select with up on top menu item...done
---------------------------------------------------------------

---------------------------------------------------------------
make vls start with current level...done
---------------------------------------------------------------

---------------------------------------------------------------
The layout of visual level select could be better..
the selection map looks goos in all screen resolutions
but the icon grid sometimes draws over it

make the icon grid, and especially the selection frame,
fit in the space its supposed to...
---------------------------------------------------------------
a good example to fix is 1024x768

the selection frame is 16 pixels, so I will need to adjust the level grid to
have a border of 16 pixels in all directions

look a lot better but now i still have to reserve more space for sel map
look at 800x600

reserved 16 more for frame..never collide now

now I can either center the sel map or make it bigger

i vote bigger...unless it goes off bottom of screen....

fuck does this ever look good....

make the legend the same size as the map...

25/12/17 04:57

visual level select is perfectly done 25/12/17 07:17
this took a long time.. i would estimate 10 hours
but it looks gorgeous and works in many screen sizes...


------------------------------------------------------------------
in level editor viewer, sometimes does not rerdaw unless mouse moved
I know that the way its supposed to be, but sometimes i get a blank
button array
when first started
when new item from map edit
made redraw also trigger mouse change so buittons get redrawn ... done
------------------------------------------------------------------
25/12/17 07:27


-----------------------------------------------------
in doors make an option to force instant
-----------------------------------------------------
right now if both doors are stat the move routine runs
if either door is not stat the instant move routine runs

I want to be able to
- 0 automatic
- 1 force instant
- 2 force move
use item[x][7]
done 25/12/17 07:56
----------------------------------------------------



----------------------------------------------------
when copying a door, prompt to move of leave dest???
this must be wrong....
----------------------------------------------------
commented that code out...
now just makes an exact copy of the door....
done 25/12/17 08:01





I am sure I have introduced bug into:

full screen mode copy and paste

doors and cloners.....

with doors, its very complicated...
their old links will most likely not be valid....
not sure what to do there...



with cloners, it should be simpler...
just change the boxes to the new variables..


               if (Ei[draw_item_num][0] == 9) // cloner
                  if (alert("Move cloner boxes?", NULL, NULL, "Move", "Leave", 'M', 'L')==1)
                  {
//                     Ef[first_empty][6] = Ef[draw_item_num][6] + 20*(x100 - Ef[draw_item_num][0]/20);
  //                   Ef[first_empty][7] = Ef[draw_item_num][7] + 20*(y100 - Ef[draw_item_num][1]/20);
    //                 Ef[first_empty][8] = Ef[draw_item_num][8] + 20*(x100 - Ef[draw_item_num][0]/20);
      //               Ef[first_empty][9] = Ef[draw_item_num][9] + 20*(y100 - Ef[draw_item_num][1]/20);

                     Ei[first_empty][15] = Ei[draw_item_num][15] + x100 - (int)Ef[draw_item_num][0]/20 ;
                     Ei[first_empty][16] = Ei[draw_item_num][16] + y100 - (int)Ef[draw_item_num][1]/20 ;
                     Ei[first_empty][17] = Ei[draw_item_num][17] + x100 - (int)Ef[draw_item_num][0]/20 ;
                     Ei[first_empty][18] = Ei[draw_item_num][18] + y100 - (int)Ef[draw_item_num][1]/20 ;

                  }

done in do_copy and do fcopy also ... should be good...
also remove door dest change in docopy too...

25/12/17 08:19

done....for now

fcopy cloner does not put boxes in right place...
but podzilla does???!!
it was how it was saved to disk...
check that for door also...removed.



now when i come back...

why doesnt fcopy or other copy show??


25/12/17 08:43


26/12/17 07:07 its fucking -37 outside!!!
---------------------------------------------------------------
when creating a sproingy, first adjust is bad, jumps all over
fixed, by making intial create use 40 rather than 14
---------------------------------------------------------------


I am getting random crashes now...


could it be the visual level select?
could it be the new graphics card??
could it be fsel??



fcopy draws good now...
this is drawn in the zoom 100 code:
draw_sprite(screen, ft_bmp, x1*db, y1*db);


make regular copy work too...good

I also refactored zoom full screen a lot

now I need to find out where the bitmaps are created and destroyed....

use ft_bmp for both...

for file...
create when load...already done

destroy at the end of zoom full screen like...
if (ft_bmp != NULL) al_destroy_bitmap(ft_bmp);



tried this:

   if (ft_bmp != NULL) printf("not NULL\n");
   if (ft_bmp == NULL) printf("NULL\n");

   if (ft_bmp != NULL) al_destroy_bitmap(ft_bmp);

   if (ft_bmp != NULL) printf("not NULL\n");
   if (ft_bmp == NULL) printf("NULL\n");

   al_destroy_bitmap(ft_bmp);

   if (ft_bmp != NULL) printf("not NULL\n");
   if (ft_bmp == NULL) printf("NULL\n");

no matter what, it always shows 3 NULLS or 3 not NULL's


and it still crashes...

now ft_bmp is created when either copy of fcopy mode is started


refactored even more...

looks real good....

maybe the crashes are because the copy stuff needs to also populate Efi
al_fixed in both copy and fcopy


only problem is copy preview shows everything, even if they actually won't be copied....
make a new function "draw_sel" to fix this....

i think i've got it, but i need to fix...

the fcopy also respects the block. item, enemy lift buttons.


all that is working good now, only problem is the crashes


only seems to happen when leaving zoom 100

also as soon as I clicked the paste selection button


also when I clicked the file paste selection button


if I don't do any paste, i don't crash

look up ft_bmp.. all good

found a bug where load selection initially clears temp values
it was free(pmsg when it should be free(ft_pmsg)

still crashes though...

what if it has something to do with lifts???


that all looks good....

 im done chasing this bug for now


 26/12/17 15:12

26/12/17 17:43



what if i put a bunch of debug stuff in the code to see what gets called last....

looks like it just load sel..now it won't die

wtf have you done to the game...won't play now...


made a level with too many lifts ans its doing bad things....

in zoom full screen can make a max of 39 lifts then stops creating more...

regular creator...

al_fixed a nasty bug about creating more lift than i have space for

zoom full screen cant get to 100,100..fixed





---------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------
enemies still use floats in the editor....!!!!
they can use them, but lets see if we can't avoid saving them..
actually what's happening is that they are still saved as floats by level editor
(the only thing that saves them, btw)
in game they are read and converted to al_fixed

in level editor they are read, and live as both....
that is whats confusing....

what do I need to do to get rid of floats in level editor....

they are actually saved as ascii text in level
then the text is converted to al_fixed or float...

what does PDE use? al_fixed

saved as int and read back as int...seems to work
how is it editted???
converted to float and passed to edit_float

I could do the same with sliders....??

The fastest and best way would be to comment out
the Ef declaration then find and fix

at some point I will need to read all as floats
then write them all back as ints
I should do this first...with glt

then I can convert them to float for use in lev edit
till i root all of that out...

1 - make a backup of all levels (or everything...)
2 - change the way they are saved



made a backup 20171226

use glt to just load and save
make the changes in filecom...


save will change from
-----------------------
fprintf(filepntr,"%f\n",Ef[c][x]);
to
fprintf(filepntr,"%d\n",al_ftofix(Ef[c][x]));


then load will change from
----------------------------
Ef[c][x] = atof(buff); // floats
Efi[c][x] = al_ftofix(Ef[c][x]) ; // also get al_fixed
to

Efi[c][x] = atoi(buff);       // al_fixed
Ef[c][x] = al_fixtof(Efi[c][x]); // also convert to floats

then save will change to
---------------------------
fprintf(filepntr,"%d\n", Efi[c][x]);

then from this point they will be saved as al_fixed....

this is step 1 to rooting them out....


I have done this....

now any changes that level editor does to floats will be lost.....



comment out Ef and root them out

also do ft_Ef

done with enemy float replacement!!!!!!

pod extended pos 1 block too far???

what happened to bullet recoil??..al_fixed


26/12/17 21:40


pod extend 1 block too far?? made better than snap to block
show pod extended pos...

26/12/17 23:13

bedtime


27/12/17 05:37

how does pod move in the game...
no recalc just straight adding and substarcting

in game I have:
"create_pod" which calls
"move_pod_extended" which calls
"recalc_pod"

looks like it only done in one place

unfortunately it still uses floats, lets fix...done and tested 27/12/17 06:01

now lets fix where rockets rotation is set..done and tested 27/12/17 06:11

// new
void set_rocket_rot(int num, int x2, int y2)
{
   al_fixed xlen = al_itofix(x2) - al_itofix(item[num][4]);      // get the x distance between item and x2
   al_fixed ylen = al_itofix(y2) - al_itofix(item[num][5]);      // get the y distance between item and y2
   al_fixed rot = fixatan2(ylen, xlen) + al_itofix(64);
   item[num][10] = al_fixtoi(rot) * 10;
}


/* old
void set_rocket_rot(int num, int x2, int y2)
{
   double angle, angle2, angle3, xlen, ylen;
   double pi = 3.14159265358979323846;
   int x1 = item[num][4];
   int y1 = item[num][5];
   xlen = abs(x2 - x1);
   ylen = abs(y2 - y1);

   if (xlen == 0) xlen = .00000000000000000001;
   angle = atan(ylen/xlen);

//    II | I
//  -----+----
//   III | IV

   if ((x2 >= x1) && (y2 <= y1)) // QI
      angle +=0;
   if ((x2 < x1) && (y2 <= y1)) // QII
      angle = pi-angle;
   if ((x2 < x1) && (y2 > y1)) // QIII
      angle+= pi;
   if ((x2 >= x1) && (y2 > y1)) // QIV
      angle = 2*pi-angle;

   angle2 = angle * (64/(pi/2));
   angle3 = angle2 + 192;

   angle3 = 256 - angle3;
   if (angle3 > 255) angle3-=256;
   if (angle3 < 0) angle3+=256;

//   sprintf(msg,"xlen:%f ylen:%f hypot:%f ", xlen, ylen, hypot);
//   textout_ex(screen, font, msg, 10, 10, 10, 0);
//   sprintf(msg," angle:%f  angle2:%f  angle3:%f ", angle, angle2, angle3);
//   textout_ex(screen, font, msg, 10, 20, 10, 0);
//   tsw();

   item[num][10] = (int)(angle3*10);

}

fix rotation of rocket in item title viewer

al_fixed get item shape to rotate...
now looks wrong in other places...al_fixed 27/12/17 06:31

now make door shape change on button....done

i spent a lot of time makind a small custom draw proportional font to draw in item shape
the size is 4 pixels high and the width ranges from 1 for "I" to 5 for "W"
not all letters are done...
it looks good on IN and OUT for doors...27/12/17 08:42





now i'm going to fix pmsg

pop msg need to be put on the actual screen and not the overlay
add position, size, up to trigger....

start with draw on level_buffer

where are they drawn now??

in a function draw_pop_msg called in main loop draw section...

move to draw item...

right now when collision some global stuff is set:

                  case 10: // pop-up message
                  {
                     extern int pop_msg;
                     extern int pop_msg_count;
                     pop_msg = x+1;
                     pop_msg_count = 120;
                  }
                  break;


I am going to use some variables in the item for this...


8 and 9 are used for color

i will use 6 for timer and 7 for timer count down
if (6 then draw and dec count)

on collision set 6 from 7

the message is drawn good now


now I need to add some buttons and sliders

slider for message delay (40-200) 7

make creator have min 40...done


now I need to make it have a specific place on the level....

use 10, 11 ?? sure why not....

first set them in glt...done
then use 10, 11 to draw...done
then edit in viewer...done
make a button set message position.. done

then fine tune the actual screen position...done



/* old

void draw_pop_msg()
{
   extern int pop_msg;
   extern int pop_msg_count;
   if (--pop_msg_count > 0)
   {
      int c = pop_msg-1;
      int x = SCREEN_W/2;
      int y = 40;

      int len = strlen(pmsg[c]);
      char dt[20][80];
      int row = 0, col = 0;
      int longest_line_len = 1; // default
      int num_lines = 0;
      int xpos_c = x;
      int ypos = y;
      int xw;
      int a;
      int tc = item[c][8];
      int fc = item[c][9];
      int px, py, px2, py2;

      for (a=0; a<len+1; a++)
         {
             if (pmsg[c][a] == 13) // line break
               {
                  row++;
                  col=0;
                  dt[row][col] = 0; // in case len = 0
               }
            else  // regular char
               {
                  dt[row][col] = pmsg[c][a];
                  if (col > longest_line_len) longest_line_len = col;
                  col++;
                  dt[row][col] = 0;
               }
         }
      num_lines = row;

      xw = (longest_line_len+1)*4;
      px  = xpos_c-xw-2-8;
      py  = ypos-2-8;
      px2 = xpos_c+xw+8;
      py2 = ypos+(num_lines+1)*8+8;

      a = 7;  // erase
      rectfill(scrn_buffer, px+a,py+a,px2-a,py2-a,0);

      for (a=0; a<8; a++) // frame
         rect(scrn_buffer, px+a,py+a,px2-a,py2-a,fc+a*16);

      for (row=0; row<=num_lines; row++) // text
         textout_centre_ex(scrn_buffer, font, dt[row], xpos_c, ypos+row*8, tc, 0);

   }
   else pop_msg = 0;
}
*/

// new
void draw_pm(int c)
{
   // process the text string into lines and rows and put in temp array
   char dt[20][80];
   int row = 0, col = 0, num_lines = 0;;
   int longest_line_len = 1;
   for (int a=0; a < strlen(pmsg[c]) + 1; a++)
   {
       if (pmsg[c][a] == 13) // line break
      {
         row++;
         col=0;
         dt[row][col] = 0; // in case len == 0
      }
      else  // regular char
      {
         dt[row][col] = pmsg[c][a];
         if (col > longest_line_len) longest_line_len = col;
         col++;
         dt[row][col] = 0;
      }
   }
   num_lines = row;

   // x positions
   int pxw = (longest_line_len+2)*8;  // width is set from longest text line
   int px1 = item[c][10]*20;          // item sets left edge with specified corner block
   int px2 = px1 + pxw + 8;           // right edge depends on text width
   int pxc = px1 + pxw / 2;           // text center position

   // y positions
   int py1 = item[c][11]*20;          // item sets top edge with specified corner block
   int py2 = py1 + (num_lines+3) * 8; // bottom edge is set from number of lines of text

   int fc = item[c][9];               // frame color
   for (int a=0; a<8; a++)            // frame
      rect(level_buffer, px1+a, py1+a, px2-a, py2-a, fc+a*16);

   int tc = item[c][8];               // text color
   for (row=0; row<=num_lines; row++) // text
      textout_centre_ex(level_buffer, font, dt[row], pxc+4, py1+row*8+9, tc, 0);

}

remove some old variables..done

                     extern int pop_msg;
                     extern int pop_msg_count;

then show in titler...done

slide down message after button row...done

then in create, prompt to set position...done

reduce the min time to 1 for instant messages
but leave default...done

now make the text editor slow the fuck down...done

then clean up edit text...done

why does edit add l to start??? .. idk.. need to clear keybuff

then get rid of dpm and use the other..no its ok






make the titler know the size of the message and
show as a guide


ok maybe ill make dpm generic...

i could use some vars in msg to keep track of its size...
12 and 13 (in 2000 format)

set them when displaying msg for now in lev edit..done

now show in titler....rect done...

I want the edit text to run in place in the viewer

step 1 - dont erase screen when editing text
step 2 - make dpm clear just that section.. done

step 3 move to the edit menu place

can I use txc??? probably...


now creator needs to be al_fixed...done

looking really good...

now when getxy with msg, use that as cursor....

can i get it with dpm????

that works awesome now....

put edit message button at bottom of list...done


now make it line up with next stuff


void draw_pmsg(int c, int x, int y)
void dpm(int c, char *f, int xpos_c, int ypos)
void draw_pop_message(int c)
why do I have three of these?  at least one must go...

got rid of
void draw_pmsg(int c, int x, int y)

also i don;t draw after buttons now, i let title take car of that
or is it viewer??

now the only thing that draws pmsg in lev editor is dpm

how many times is it called?

twice..
once from edit_pmsg_text
once from viewer

they both need to line up...not bad...done

make the text editor disallow many ascii things....
anything below 32 except for 13 and make ESC abort...done

now i would like to mark the message while editing done and looks good

next make it so I can move the message with map move...done

i love how awesome this new message stuff is...

lets test it out on a level....it works so good!!!!!



then put all creator together at the start in nev...done

bug...

when creating a new msg, or moving location with getxy,

we also see the message....al_fixed
created a new fake subtype 1010 to send to getxy





-------------------------------------------------------------------------------------
somehow show what blocks are removed with keys
-------------------------------------------------------------------------------------
can I do this with my fancy new draw_level_thing?

blocking or non blocking?

immediate efffect or animated
i could have the key float over to the affects block and show them erasing
modify the zoom to keep it on screen....
use the same method I just created for doors....

non blocking for sure...
make the key move to the block range and then remove blocks

make an option for immediate

make an option to be triggered by up or down

make an option to show lines to where the block range is...


how to start with keys...

add some code to draw, because it gets called every time, wait, that's not true....

add to item_move






remove the old key animation thingy

#ifdef KEY_ANIMATION

                     extern int timer_passcount;
                     int temp_timer_passcount = timer_passcount;
                     int WX, WY;
                     float x1 = itemf[x][0];
                     float y1 = itemf[x][1];
                     float x2 = (item[x][6] + item[x][8]) * 10;
                     float y2 = (item[x][7] + item[x][9]) * 10;
                     float xsize = x2-x1;
                     float ysize = y2-y1;
                     float vx=x1;
                     float vy=y1;
                     float xinc;
                     float yinc;
                     float bsize;
                     int steps;
                     int div;
                     int shape, a, b;
                     if (fabs(xsize)>fabs(ysize)) bsize = fabs(xsize);
                     else bsize = fabs(ysize);

                     // get the proper player shape
                     int pans = 9 - (p*3);
                     if (players[p].up)   pans+=1;
                     if (players[p].down) pans+=2;
                     int ans_pos = (al_fixtoi(players[p].PX)/4) % zz[4][pans];
                     int p_shape = zz[ans_pos+5][pans];

                     div = (int)(12+bsize/2000*112);
                     steps = (int)(bsize/div);

                     xinc = xsize/steps;
                     yinc = ysize/steps;

                     // move to the key's destination
                     for (b=0; b<steps; b++)
                     {
                        vx += xinc;
                        vy += yinc;
#ifdef DUMB
                        al_poll_duh(dp);
#endif

                        WX = (int)(vx-SCREEN_W/2);
                        WY = (int)(vy-SCREEN_H/2);

                        if (WX < 0) WX = 0;
                        if (WX > 2000-SCREEN_W) WX = 2000-SCREEN_W;
                        if (WY > 2000-SCREEN_H) WY = 2000-SCREEN_H;
                        if (WY < 0) WY = 0;

                        blit(l2000, scrn_buffer, WX, WY, 0, 0, SCREEN_W, SCREEN_H);

                        // draw player
                        if (players[p].left_right) draw_sprite(scrn_buffer, memory_bitmap[p_shape],al_fixtoi(players[p].PX)-WX, al_fixtoi(players[p].PY)-WY);
                        else draw_sprite_h_flip(scrn_buffer, memory_bitmap[p_shape], al_fixtoi(players[p].PX)-WX, al_fixtoi(players[p].PY)-WY);

                        // draw key
                        shape = zz[5][item[x][1]-1000];
                        draw_sprite(scrn_buffer, memory_bitmap[shape], (int)vx-WX, (int)vy-WY);

                        // enemy_draw_and_collision();
                        // draw_items();

                        blit(scrn_buffer, screen, 0, 0, 0, 0,SCREEN_W, SCREEN_H );
                        rest(2);
                     }

                     // rotate the key
                     for (b=0; b<60; b++)
                     {
#ifdef DUMB
                        al_poll_duh(dp);
#endif
                        rest(8);
                        a = item[x][1];
                        if (a < NUM_SPRITES) shape = a; /* bitmap */
                        if (a > 999) shape = zz[5][a-1000]; /* ans */
                        blit(memory_bitmap[0], screen, 0, 0, (int)vx-WX, (int)vy-WY, 20, 20);
                        rotate_scaled_sprite(screen, memory_bitmap[shape], (int)vx-WX, (int)vy-WY, al_itofix(0), al_ftofix(1));
                     }
#endif
                     // remove the key
                     item[x][0] = 0;

                     if (item[x][10]) // matching keyed blocks only
                     {
                        int key = item[x][1] - 1039;

                        // red = 0...

                        for (c = item[x][6]; c <= item[x][8]; c++)
                           for (y = item[x][7]; y <= item[x][9]; y++)
                           {
                              if ((l[c][y] == 188 + key) || (l[c][y] == 204 + key) || (l[c][y] == 220 + key))
                              {
                                 l[c][y] = 0;
                                 blit(memory_bitmap[0], l2000, 0, 0, c*20, y*20, 20, 20); // remove from background
                              }
                            }

 /*
// what is the key color and what blocks match it

red    blocks =  188, 204, 220   key ans 39
green  blocks =  189,
blue   blocks =  190,
purple blocks =  191,

   */


                     }
                     else
                     {
                        // remove all blocks in range
                        event(2, itx, ity, p, item[x][1], 0, 0); // send player and item shape
                        for (c = item[x][6]; c <= item[x][8]; c++)
                           for (y = item[x][7]; y <= item[x][9]; y++)
                           {
                              l[c][y] = 0; // remove from block array
                              blit(memory_bitmap[0], l2000, 0, 0, c*20, y*20, 20, 20); // remove from background
                           }
                     }

                     draw_lift_lines(); // in case removing the key blocks erases lift lines












#ifdef KEY_ANIMATION
                     // move back to the player's location
                     int kdb = 1; // to double return speed set db to 2
                     for (b=0; b<steps; b+=kdb)
                     {
#ifdef DUMB
                        al_poll_duh(dp);
#endif
                        vx -= (kdb*xinc);
                        vy -= (kdb*yinc);
                        WX = (int)(vx-SCREEN_W/2);
                        WY = (int)(vy-SCREEN_H/2);
                        if (WX < 0) WX = 0;
                        if (WX > 2000-SCREEN_W) WX = 2000-SCREEN_W;
                        if (WY > 2000-SCREEN_H) WY = 2000-SCREEN_H;
                        if (WY < 0) WY = 0;

                        blit(l2000, scrn_buffer, WX, WY, 0, 0, SCREEN_W, SCREEN_H);

                        // draw player
                        if (players[p].left_right) draw_sprite(scrn_buffer, memory_bitmap[p_shape],al_fixtoi(players[p].PX)-WX, al_fixtoi(players[p].PY)-WY);
                        else draw_sprite_h_flip(               scrn_buffer, memory_bitmap[p_shape],al_fixtoi(players[p].PX)-WX, al_fixtoi(players[p].PY)-WY);

                        // draw key
                        shape = zz[5][item[x][1]-1000];
                        draw_sprite(scrn_buffer, memory_bitmap[shape], (int)vx-WX, (int)vy-WY);

                        // enemy_draw_and_collision();
                        // draw_items();

                        blit(scrn_buffer, screen, 0, 0, 0, 0,SCREEN_W, SCREEN_H );
                        rest(2);
                     }
                     blit(l2000, scrn_buffer, WX, WY, 0, 0, SCREEN_W, SCREEN_H);

                    rest(300);
                    timer_passcount = temp_timer_passcount;

#endif





there it is for posterity.....


we have used 4 5 6 7 8 9 10

how about 11 to show that key is in move....
11 can be the number of steps, counted down
while xinc and yinc are applied....

collision will need to set this up

item move will need to process this...done

done

i have the first crude part done...

the key moves to the destination then the block are removed

27/12/17 22:58



time for a backup and bed....


20171227


28/12/17 06:27

in key i would like to rotate, but 10 is used...move 10 to 12?

or just use 12 for this one???

no, move it...

in sliders changed in 2 places
in item move changes one

tested...done

next patch in rotate

that works awesome...

pad a few frames at the end...

the key thing is done perfectly....28/12/17 08:54


------------------


----------------------------------------------------------------
fix item draw all in level editor to use good shape...done
how many places do I draw enemy?
in the game...look like only once
made get_enemy_draw_shape(int e)
just like for items....
in level editor
void show_all_enemies(void)
void get_draw_item_shape(int i)

in lev edit I have :

void draw_enemy_shape_l2000(int e)
and
void draw_enemy_shape_l2000(int e) is used nowhere, remove... done

void get_enemy_draw_shape(int e) // the only place this gets done

called once in game to to use in "void draw_enemy(void)"
and once in level editor to use in "void draw_enemy_shape(int e, int x, int y)"
lets call this done....28/12/17 10:03
----------------------------------------------------------------


I am going to work on the help stuff....

right now it has a fixed width of 640

make a command line flag to start it instantly... -h



----------------------------------------------------------------
make exits show if they will work, or require more enemies to be killed
made lock to draw on exit...done
why is exit_enemy_left a global?
why doesn't it work?
do i need to to display in event??
done...28/12/17 10:48
----------------------------------------------------------------





what are all the tags i can use in help??



<section>  marks sections with text that comes after

<lxx>  line with color xx (left just)
<cxx>  line with color xx (centered)

<axx>  ans xx (left just)
<acxx> ans xx (centered)

<sxxx> left just shape xxx

<msxxxxxxxxx....> 20 shapes three digits each


i want to add code to stack tags on a single line....

like 2 ans

or ans then text then ans then more text.....

had to replace all < in my text...done....

refactored help and its a lot nicer now

make sure to leave lots of space after the last section
or you will crash when scrolling to the end.....no I al_fixed that...

now back to editing.....

show more enemies ...

why don't the colors line up with the players color bitmap index??


colors and color names are good..fixed

I have to show the health bar....done


I have made some awesome progress on the help stuff...

29/12/17 00:02

time for bed....



29/12/17 08:59


more work on help...


to get an image into the help screen....

1 - capture the screen with windows ALT-PRINTSCREEN
2 - open in paint and crop to exact size I need
3 - save as 24 bit bmp
4 - import like this...


   ALLEGRO_BITMAP * test;
   test = load_bitmap("status_window24.bmp", NULL);
   if (!test) printf("failed to load\n");
   else
   {
      draw_sprite(screen, test, 10, 10);
   }
   al_destroy_bitmap(test);
   tsw();



i just spent another three hours messing with help...


what do I really need to add


add history page...


test in 98, xp, 8, 10


add to netgame section




make screen resolution its own section...

modified the screen mode dialog to filter out bad choices

now all I have is auto windowed, 8 bit color and a few good resolutions...nice

do I even need to call it "screen resolution" any more

its more like window size....



make a section for command line parameters..done


changed config file from allegro.cfg to pm.cfg




bug... when exiting after help bsod...
probably due to help lines being over 2400 and
help string was only 2400..
increased to 5000...



help is just about done...

still do history


did a backup 20171230



30/12/17 07:38

remove bullet bonus from enemies in help..done

draw proper shape on bouncer and cannon buttons....done

remove bullet bonus from enemy sliders...done

do I need to remove collison box from enemies?? in sliders
remove collison box from sliders for all enemies
i feel like I want to keep collision box... anything less than 4 and enemy can never be killed
no leave it....
it should be a common enemy button....


cleaned up the enemy button drawing ...

could do the same for items...



30/12/17 10:20

i need to get ready to go to Athena's for new years......


make a backup to all computers....

I think I will eventually have to convert my game away from 256 color mode....

------------

not gone yet...

Tested on an XP machine (pfv)
- the fullscreen desktop thing works great on XP....
- lets test netgame....
set up \\pfv\pm_client6


visual level thingy seems to mess with my stuff loading..
one more change...only load it when its needed, but flag it so we don't load it twice...done
30/12/17 12:35


pfv server, i990 cant seem to connect

i990 server, pfv connects good.

do I have a firewall on pfv???, no it is disabled

pfv can ping i990, but i990 cannot ping pfv

pfv hostname was not the same as ip???

try with IP...works good...

so now I know that netgame will work on xp....

i feel bad that i disbled full screen mode...
lets see if I can re-enabled it if XP is detected....
where and how....

IT WORKS BUT NOT FROM COMMAND LINE

GOT TO NOW NOW

SHE'S HERE!!!!!

30/12/17 13:37

did some item viewer button color stuff
while I was on the road

int edit_int_slider(int x1, int y1, int x2, int y2,
                    int bn, int num, int type, int obt,
                    int q0, int q1, int q2, int q3, int q4, int q5, int q6, int q7 )

does more than ints, i'm going to rename it to: mdw_slider...done

the same new new_button....and color_select and draw_slider

draw slider -> draw_slider_bar (more accurate)

now they look like this:

mdw_slider
mdw_button
mdw_colsel

and they line up nicely....

al_fixed button list in nlv


why are next and prev switched???
al_fixed common button for both nlv and item

q0 background color does nothing for button...

in sliders it works

in button it works...



I have determined that the back ground color q0 has no effect
q0 background (no effect)
q1 is the buttom color
q2 is the text color
q3 is the slider bar color (no effect on buttons)
q4 is the draw mode (in or out)

when sliding the type in out cahnges....


made draw frame common function


now trying to make fill smgs a common function
are there any same numbers???yes
and make update var?? no..

made fill smsg for button and for slider
cause they share some numbers...

took out rits global varibable about redraw buttons
later found out if buttons are resized they leave ttrace of old...

not a big deal, re-size buttons was always, just a gimmick
it doesn't work good with lift viewer, or pop-message

door type: normal | exit only


I spent a lot of time messing with buttons and sliders...
here is the final result....
both buttons and slider have a common fucntion that draws the frame
q0 - background color is ignored
the background is not erased at all
q4 has been added as draw mode (rect in or out)
however I like in so much that they all use that.
q2 - text color, looks best white (15) most of the time
q3 - slider bar color looks best white
color select uses none of the q's

so.....
q0 - background ignored
q1 - frame is the most important color
q2 - text 90% white
q3 - slider bar color 100% white
q4 - draw mode 100% 1

the buttons and slider look great
the code is much cleaner

moving the fuck on.....
I will need to come back and finish...

button sizes
in 640 they got off bottom
put spaces in sections for items
figure out a good bts size adjust for smaller like 640
wait...if I adjust bts I mess with pop message...


make pop message viewer use real buttons
and get the dynamic spacing right

where is the spacing done?
hardcoded into title_obj
display_pop_message(num, pmsg[num], txc, 266); // show the message
what if I move that to where the buttons are?


hardcoded into :
int edit_pmsg_text(int c, int new_msg)
{
   int my = 266;  // message y


display pmsg erases 48 lines bove it...

al_fixed all that shit...

to make archwagon's 22 button's all fit in SCREEN_H 480
need to make bts = 14
default = 18
in SCREEN_H > 1000 bts 40 works

where is bts set??

lift editor sets it to 20...
main sets it to 12
edit item sets it to 18
that is where I will do it..done


why do cloners mostly have 0 sizes after convert
look like it was only level 202...al_fixed


test xp..good
make fullscreen mode work good in XP again...done

from command line now you can enter
-b 0 0 to get fullscrseen mode
if xp it does real fullscreen at dektop size
if not it does a window just smaller than desktop sixe

also added -b with only one arg
0 or anything that atoi says is zero run auto fullscreen mode
otherwise tries to match common screen sizes 800x600 etc..
if that fails, sets square mode, 500x500 etc...

also added to the set gfx mode filter, if xp fullscreen modes...

all seems to work good now....



01/01/18 23:23


bugs, when in a small screen mode and setting the scale factor very zoomed in
then changing to a large screen mode, the scale factor is
more than noramlly can be set...
the bounds check is not done until scale is changed....fixed

make a creator for a single door not linked to anything
creator?, maybe just pde..done



flapper
use accel
make up and down bobbing with flap
fix shapes to look better


how about a prox to follow in the y axis?
right now, looks for closest player and adjust to be 80 above.

how about y stays the same unless a player is close(prox), then adjusts


right now the shape is completely controlled by free running ans

i want to run it myself

make a counter to inc shape

used 4 as my ans seq counter
used 5 as the current seq

seems to work good...

now instead of bounce in x, can I use accel?
what do I do when hits wall?
set speed to 0
change direction
right now direction is only by xinc...


I'll need a variable for left/right...
another variable for max speed
an even yet another for accel

if left,
add accel to xinc up to max speed
apply xinc check for collison left
if collision set right and xinc 0




30 collision box
31 health bonus


make both yincs. regular and flap check for collision..done

looking good...
need to add to viewer

Efi 5 x speed
Efi 6 accel

Ei 6 direction

Ei 7 distance above player

flap y variaton??

what if flap then coast....on 3

what if I combine both yincs? player seek and flap, then do bounds check??..done


am i happy with flapper?

mechanics seems good

still could make shape better


things to add...


player y seek...
all the time? or when player detected...
use same trigger box as bullet

if not detected no y move

need prox thingy


added the prox thingy....


now add some sliders

1st max xspeed and accel

Just call it x speed


initial direction, why don;t i just use 2 like arcwag..dore

messed with the shape, its better...

I am calling flapper done.....

04/01/18 07:19

this took a couple of days....



made a backup 20180104


04/01/18 20:38

today i tested with my new work laptop with windows 10
the netgame seemed to work great...


all my flappers do the flap thing at exactly the same time


make the counter al_fixed and add.....??

they don't seem to find the player very good




----------------------------------------------------------
bug when deleting item from viewer, no redraw??..fixed
----------------------------------------------------------


----------------------------------------------------------
viewer does not update when bomb range changed...fixed
----------------------------------------------------------


----------------------------------------------------------
msg creator is bad...moved new msg to my =200...done
----------------------------------------------------------



---------------------------------------------------------------
door line colors...use source or dest..dest...done
---------------------------------------------------------------

---------------------------------------------------------------
why can't I see the message when dragging it?..done
---------------------------------------------------------------

---------------------------------------------------------------
allow lit bombs to be embedded in walls...done
---------------------------------------------------------------
06/01/18 05:49


---------------------------------------------------------------
items sliding on ground do not stop completely...fixed
---------------------------------------------------------------
06/01/18 06:11


---------------------------------------------------------------
in level editor can go to -1 on main level display...
only when SCREEN_W > 2000...fixed
---------------------------------------------------------------
06/01/18 06:20

---------------------------------------------------------------

carry a door through a door
flaky and only work sometimes
you need to be carrying a door then touch a door with a lower item number
so that door is marked as touched, but you are still carrying the other door.
make it a property of a door, if that door can be carried through other doors


I just realized that this marked door stuff can only choose one
does not work with multiple players...only one door can be marked for all players

need to make marked door a property of player.done

now the draw code doesn't need to check if player touching door
it just looks at marked_door...

renamed players[p].player_carry to players[p].carry_item

made it so that if player is carrying a door, it will never be the marked door

now any door can be carried through any other door...

now make a way to disable that....

at do enter stage check if item has carry through door set and drop it if it doesnt
thus works for all items
any item that used to be able to choose fall|stat|carry can now also choose carrry through door

default door color not zero

---------------------------------------------------------------
done 06/01/18 07:47



---------------------------------------------------------------
when dropping item make sure its not in a wall...
---------------------------------------------------------------
done 06/01/18 09:35



---------------------------------------------------------------
why do lifts show numbers in level editor
also in game before game is started...
---------------------------------------------------------------
done 06/01/18 09:50


-------------------------------------------------------------------
why do bombs not respect stationary
i set it to automatically promote to carry when lit
-------------------------------------------------------------------
fixed 07/01/18 08:31



-------------------------------------------------------------------
in viewers use arrow keys for next, prev
-------------------------------------------------------------------
done 07/01/18 08:41


-------------------------------------------------------------------
lifts look messed up in lift viewer...
-------------------------------------------------------------------
done 07/01/18 08:44


---------------------------------------------------------------
pod set extended position is not correct..
i forgot to calc num_steps
also redraw after recalc pod...done
---------------------------------------------------------------
done 07/01/18 10:34



---------------------------------------------------------------
fuck it, i'm going to make a global redraw int...

calling it 'Redraw' with a capital...

redid
mdw_slider
mdw_colsel
to no return value and just used global Redraw
al_fixed in lift viewer and regular viewer


now to fix the weird return flags from map_move


            int flags = move_enemy_with_map(obt, type, num);
            if (old_flags != flags)
            {
               old_flags = flags;
               Redraw = 1;
            }

            while (flags >= 1000) flags -= 1000;
            num = flags;
            type = Ei[num][0];  // if type has changed

use redraw and just return num
its need to know what the mouse was on before..keep it the way it was...

made another global Map_move_obt that keeps track of
what object map move was on the previous time it was ran.
now map move takes care of setting redraw and only returns num
---------------------------------------------------------------
done 07/01/18 11:04


---------------------------------------------------------------
make level select use game keys as well as arrows...
---------------------------------------------------------------
done 07/01/18 11:22


---------------------------------------------------------------
make a alert 3 when quiting level editor
prompt to save or discard changes...
---------------------------------------------------------------
done 07/01/18 11:41


---------------------------------------------------------------
make grapical level select trigger from enter on menu
instead of up on menu
---------------------------------------------------------------
done 07/01/18 11:52


---------------------------------------------------------------
found a bad level, had invalid enemy caused crashes
made some enemy check in glt to cath bad enemy data
---------------------------------------------------------------
done


---------------------------------------------------------------
map move and size...
map has dediceted key for size "S"
what if someone wanted to use that for something else??
map moves between 4 different corner and top middle, then off
can I make it auto? with the hystersis window?
found a good way to do it...
in get new background i find where the player is drawn on the screen buffer
and save it in the player struct
then in set map pos i see if the map will be drawn on the player and move it if it will be
I also made the map screen sizes have only 3..
I find the minimum of SCREEN_W and H then divide by 2, 3 or 4.
need to make a new key for map size...how about F4...
what about F3 for the map key... is it really a player control?
that was really easy to do...
---------------------------------------------------------------
07/01/18 17:47



maps are looking really good for now....





make a backup...

20180107...

working on help file
al_fixed XP screen mode, system req
working on map move
removed map key stuff

---------------------------------------------------------------
move server_control and client_control from proc_controls to main loop.
still will only get called once per frame
put it just before procontrolls so it gets called in same order...
---------------------------------------------------------------

---------------------------------------------------------------
removed all map_key stuff...
menu key does nothing, fix it
added it to player struct and player_key_check...
---------------------------------------------------------------
done 08/01/18 05:52

---------------------------------------------------------------
add to door viewer
if exit only, show source door...
---------------------------------------------------------------
done 08/01/18 06:49




---------------------------------------------------------------
add to viewer
when mouse over or click on legend
highlight the thing in the map...

where would that go???

what if I move the stuff I do in title about map legend to viewer
or make it its own function

what I did what add parameters to title_obj
legend_highlight and highlight_color

they work good for object position now...

it will be harder to tell what line of text on the legend is selected
beacause they change based on how many lines
the min is 2 with just legend title and location
the max is 5 with cloner (3 extras)

i could make another global..num_legend_lines...
set by title and used by viewer
done.


now all items and enemies have a nice legend blinking highlight thing
---------------------------------------------------------------
done 09/01/18 06:40



add common button to viewers

map adjust mode-
off
this item only
this type only
everything


make map move work with enemies and items
merge both...


add item to enemy....

modify the passed and returned num....

if < 1000 enemey
if > 999 item - 1000
done


now make the first thing it does if check to see if its on the thing we sent it
if it is

next check to see if obt lock or type lock is on

if not its free reign to detect waht we are on...



1st - check if currently selected obt has any extras that mouse is on
- if it does then that's what get selected

2nd - check for enemies and items
only do this if lock is not on

this is done 09/01/18 20:20
now to make the lock button
re-purpose the move button
when 'L' is pressed object is locked



what if we can switch to lift viewer too?

make function object_viewer(obt, type, num)
that can handle items, enemies and lift, and switch betwen all of them

change edit object into this...

only called from edit menu

made object_viewer(obt, num);

that is the only way that items, enemies and lift get viewers....

lift viewer is just patched into the start...
need to make a way to switch in and out of it..

make lift viewer return something
1 = normal exit
1000-1099 switch to enemy
2000-2499 switch to item

i will probably need to cut it up and paste the peices into object viewer....


bedtime
09/01/18 21:51

make backup...
20180109


10/01/18 03:49

object viewer is getting large....

463 lines title_obj
600 lines move_obj_with_map
450 lines object viewer
445 lift_viewer


I think i've got it...
now object viewer can switch between all 3 type, no prob....
10/01/18 05:23

now to make lock for lifts...done
also locks to current lift
10/01/18 05:41

clean up and comment...done

// number of lines
430 lift_viewer
450 title_obj
560 move_obj_with_map
460 object viewer

make a lock button and make the key set in one place...
now its in three place?

2 in lift viewer
- once to prevent other object from being selected
- one to prevent other lifts form being selected

3 times in map_move for each object that might get switched to...
added #define MAP_LOCK_KEY KEY_Z to pm.h



fuck it, I can do this later....going to snuggle my wifey

10/01/18 06:41




---------------------------------------------------------------
mouse doesn't show as much as i would like in viewer
removed show mouse(NULL) from title
now nothing hides the mouse and its much better
---------------------------------------------------------------
done 10/01/18 11:47


---------------------------------------------------------------
in viewer going from msg to other item bsod
in
void display_pop_message(int c, char *f, int xpos_c, int ypos, int redraw_map, int show_line_breaks)
{
   if (f != NULL)
   {
added a check if NULL
---------------------------------------------------------------
done 10/01/18 11:59


---------------------------------------------------------------
hard time getting out of viewer with esc...
---------------------------------------------------------------
done 10/01/18 14:00


---------------------------------------------------------------
when you select an enemy with a large trigger box
ik kind of takes over, and its hard to select anything else

I could make things with range only adjustable by their corners

start with prox, easy...done

next cloner src and dest


I am resizing from ul and lr, but maybe would be better to
move from ul and resize from lr

i like that better

trigger
cloner src and dest done

next is key block range
these are all done..

I want the mouse adjust thing to look better

made the mouse sprite center on db, db looks better

if cloners trigger, source or dest are on the same start block they all will move..
al_fixed so only one can be active

make it so lr box triggers one lower, so that single block ranges
can still be moved and resized
---------------------------------------------------------------
done 11/01/18 02:37




---------------------------------------------------------------
in regular edit mode, how to i deal with stacked objects?

original method:

         for (d=0; d<500; d++) // check for item
            if (item[d][0]) // if active
            {
               a = item[d][4];
               b = item[d][5];
               if ( (x2000 > a) && (x2000 < (a+18)) && (y2000 > b+4) && (y2000 < (b+16)) )
               {   // mouse is on item d
                   point_item_type = 2;
                   point_item_num = d;
               }
            }

         for (e=0; e<100; e++) // check for enemy
            if (Ei[e][0]) // if enemy active
            {
               a = al_fixtoi(Efi[e][0]);
               b = al_fixtoi(Efi[e][1]);
               if ( (x2000 > (a+2)) && (x2000 < (a+18)) && (y2000 > (b+2)) && (y2000 < (b+18)) )
               {   // mouse is on enemy e
                   point_item_type = 3;
                   point_item_num = e;
               }
            }

         for (d=0; d<num_lifts; d++) // check for lifts
         {
            a = lifts[d].x1;
            b = lifts[d].y1;
            if ( (x2000 > a) && (x2000 < (a+10)) && (y2000 > b) && (y2000 < (b+10)) )
            {   // mouse is on lift e
                point_item_type = 4;
                point_item_num = d;
            }
         }







first re-factor:

         int moi=0;
         int mi=0;
         int mi2=0;
         int moe=0;
         int me=0;
         int me2=0;
         int mol=0;
         int ml=0;


         for (d=0; d<500; d++) // check for item
            if (item[d][0])
            {
               a = item[d][4];
               b = item[d][5];
               if ( (x2000 > a) && (x2000 < (a+19)) && (y2000 > b) && (y2000 < (b+19)) )
               {
                   moi++;
                   if (moi == 1) mi = d;  // 1st found
                   if (moi == 2) mi2 = d; // 2nd found
               }
            }

         for (e=0; e<100; e++) // check for enemy
            if (Ei[e][0])
            {
               a = al_fixtoi(Efi[e][0]);
               b = al_fixtoi(Efi[e][1]);
               if ( (x2000 > (a)) && (x2000 < (a+19)) && (y2000 > (b)) && (y2000 < (b+19)) )
               {
                   moe++;
                   if (moe == 1) me = e;  // 1st found
                   if (moe == 2) me2 = e; // 2nd found

               }
            }

         for (d=0; d<num_lifts; d++) // check for lifts
         {
            a = lifts[d].x1;
            b = lifts[d].y1;
            if ( (x2000 > a) && (x2000 < (a+19)) && (y2000 > b) && (y2000 < (b+19) ))
            {
                mol++;
                ml=d;
            }
         }

         sprintf(msg, "mouse is on %d items, %d enemies, %d lifts",moi, moe, mol);
         textout_ex(screen, font, msg, 100, 100, 15, 0);


         // which one wins?
         int mm = mouse_x % 20;

         // if only item, then item wins
         if ((moi) && (!moe) && (!mol))
         {
            point_item_type = 2;
            if (moi == 1) point_item_num = mi;
            if (moi == 2)
            {
               if ((mm > -1) && (mm < 10)) point_item_num = mi;
               if ((mm > 9 ) && (mm < 19)) point_item_num = mi2;
            }
         }

         // if only enemy, then enemy wins
         if ((!moi) && (moe) && (!mol))
         {
            point_item_type = 3;
            if (moe == 1) point_item_num = me;
            if (moe == 2)
            {
               if ((mm > -1) && (mm < 10)) point_item_num = me;
               if ((mm > 9 ) && (mm < 19)) point_item_num = me2;
            }
         }

         // if only lift, then lift wins
         if ((!moi) && (!moe) && (mol))
         {
            point_item_type = 4;
            point_item_num = ml;
         }


         // if item and enemy only
         if ((moi) && (moe) && (!mol))
         {
            if ((mm > -1) && (mm < 10))
            {
               point_item_type = 2;
               point_item_num = mi;
            }

            if ((mm > 9 ) && (mm < 19))
            {
               point_item_type = 3;
               point_item_num = me;
            }
         }

         // if item and lift only
         if ((moi) && (!moe) && (mol))
         {
            if ((mm > -1) && (mm < 10))
            {
               point_item_type = 2;
               point_item_num = mi;
            }

            if ((mm > 9 ) && (mm < 19))
            {
               point_item_type = 4;
               point_item_num = ml;
            }
         }


         // if enemy and lift only
         if ((!moi) && (moe) && (mol))
         {
            if ((mm > -1) && (mm < 10))
            {
               point_item_type = 3;
               point_item_num = me;
            }

            if ((mm > 9 ) && (mm < 19))
            {
               point_item_type = 4;
               point_item_num = ml;
            }
         }

         // if all three !
         if ((moi) && (moe) && (mol))
         {
            if ((mm > -1) && (mm < 6))
            {
               point_item_type = 2;
               point_item_num = mi;
            }

            if ((mm > 5 ) && (mm < 12))
            {
               point_item_type = 3;
               point_item_num = me;
            }

            if ((mm > 11) && (mm < 18))
            {
               point_item_type = 4;
               point_item_num = ml;
            }
         }
         sprintf(msg, "mouse_x %4d %2d ",mouse_x, mm);
         textout_ex(screen, font, msg, 100, 108, 15, 0);


much better second re-factor:

         int max_ob = 20;                  // max objects to find
         int ob = 0;                       // objects found
         int mo[max_ob][2];                // array of objects found
         for (a=0; a<max_ob; a++)          // clear array
         {
             mo[a][0] = 0;
             mo[a][1] = 1;
         }
         for (d=0; d<500; d++) // check for item
            if ((item[d][0]) && (ob < max_ob))
            {
               a = item[d][4];
               b = item[d][5];
               if ( (x2000 >= a) && (x2000 <= (a+19)) && (y2000 > b) && (y2000 < (b+19)) )
               {
                   mo[ob][0] = 2;
                   mo[ob][1] = d;
                   ob++;
               }
            }
         for (e=0; e<100; e++) // check for enemy
            if ((Ei[e][0]) && (ob < max_ob))
            {
               a = al_fixtoi(Efi[e][0]);
               b = al_fixtoi(Efi[e][1]);
               if ( (x2000 >= (a)) && (x2000 <= (a+19)) && (y2000 > (b)) && (y2000 < (b+19)) )
               {
                   mo[ob][0] = 3;
                   mo[ob][1] = e;
                   ob++;
               }
            }
         for (d=0; d<num_lifts; d++) // check for lifts
         {
            a = lifts[d].x1;
            b = lifts[d].y1;
            if ( (x2000 >= a) && (x2000 <= (a+19)) && (y2000 > b) && (y2000 < (b+19) ) && (ob < max_ob))
            {
                mo[ob][0] = 4;
                mo[ob][1] = e;
                ob++;
            }
         }
         /*sprintf(msg, "mouse is on: %d objects", ob);
         textout_ex(screen, font, msg, 100, 100, 15, 0);
         for (a=0; a<ob; a++)
         {
            sprintf(msg, "%d %d ", mo[a][0], mo[a][1]);
            textout_ex(screen, font, msg, 100, 108+a*8, 15, 0);
         } */

         // which one is the winner?
         if (ob)
         {
            int mm = mouse_x % 20;         // mouse position relative to block boundary
            int ss = 20/ob;                // step space
            int of = mm / ss;              // convert to offset into ob array
            point_item_type = mo[of][0];
            point_item_num  = mo[of][1];
            //sprintf(msg, "mm:%2d ss:%2d of:%2d  ", mm, ss, of);
            //textout_ex(screen, font, msg, 100, 92, 11, 0);
         }
---------------------------------------------------------------------------------
done 11/01/18 04:07

-------------------------------------------------------------
map map lock button and type lock
map lock will do what the key already does:
lock to a specific object and not let the map change that
it can still be changed with the next and prev buttons or keys
within the saem type.
this wil allow stacked items of the same type to be accesesed

type lock will only allow a specific type to be changed to...
when type lock is clicked the current type is locked
why do I need this???
the other lock will do this already

add to common buttons
make a global variable



PREV | LOCK | NEXT
MOVE| CREATE | DELETE
VIEWER HELP | DOOR HELP
get rid of copy to draw item....
done...
now do for lift viewer


-------------------------------------------------------------
delete lift can set invalid lift
-------------------------------------------------------------
al_fixed

-------------------------------------------------------------
when switching to lift viewer from map, lift number can be wrong
-------------------------------------------------------------
al_fixed

-------------------------------------------------------------
done 11/01/18 06:03


am i finally done with map move and lock and such??

what are other possible thing to adjust with map?

archwag bullet prox
archwag jump b4 wall
archwag jump b4 hole

trakbot bullet prox

flapper trigger box
flapper height above player

bomb and rocket damage range
its good for now....

make message use ul corner too...
done




---------------------------------------------------------------
make step buttons use sliders

1st move step

ill have to pass both lift numn and step num to slider

use type for lift
use num for step


old void fill_smsg_slider(int bn, int num)
new void fill_smsg_slider(int bn, int type, int num)

old void update_var(int bn, int num, float f)
new void update_var(int bn, int type, int num, float f)


   if (bn == 70) lift_steps[type][num].val =(int)f;       // lift step move


seems to be working, but still needs polish

on lift steps, I have current lift and highlight lift ??
mark both...

step_pointer

current_step

old_step




what sets current lift?
make it so clicking on steps with either mouse button sets current lift
and also the map move stuff

what sets step_pointer?, only if mouse on steps


show both in draw steps...


in 640x480  i can only see 21 steps at bts = 12

in 800x600  i can only see 31 steps at bts = 12

in 1024x768 i can only see 39 steps at bts = 12

in 1280x1024 i could probaly see 60



in 640x480  i can only see 32 steps at bts = 8
in 800x600  i could probably see 47 steps at bts = 8



I just made both steps and upper buttons use the same bts
in 640x480  i can see 43 steps at bts = 8
in 640x480  i can see 37 steps at bts = 9
in 640x480  i can see 32 steps at bts = 10


in 800x600  i can see 39 steps at bts = 11


can i dynamically set bts based on how many steps and SCREEN_H

6 is useable but just barely
7 is a little better

the dynamic setting of lift button size is done
works in all screen sizes
---------------------------------------------------------------
done 11/01/18 20:18



when adding new lift steps, menu can get off screen
especially with prox and dist from step list

make add new lifts step use sliders like lift viewers does


edit_int is almost done
there are only 6 calls to it
3 in create new lift setp
2 in pde
1 to set animation speed in bitmap



looking into redraw while addind lift steps...

why does lift viewer has its own set of bitmaps for each db??
removed all ll bitmaps
removed lift_set_initial_not_in_file(lift) and replaced with set_lift(lift, 0)
removed fill_ll
removed fast_draw_lifts

changed getxy to not have its own custom lift line drawing thing
also changed getxy to show items and enemies
now though, getxy updateds position for item, enemy, lift as
you are moving it...even if getxy is cancelled the new positions stay...
not a big deal, but I al_fixed it anyway...

make set lift step clip to map...done

testing all the timgs about lifts...

create new, good...


I have 2 versions of move lifts...make only one..done


make insert step appear under the list (or above)
make it appear under the step that we are inserting before....
i now show it on the list of step and it looks good!!

isn't bts extern?

try it for lift stuff...
set it in lift_editor
done

i can insert steps past step 40?
need to prevent this....done


having trouble lining up the insert step menu on the step buttons
thought I had it, but then bts changed...

works when bts == 18
int ty = 37 + (9 + pstep) * bts;


why is it so hard?

this code is what draws the step buttons:

in lift_editor right after the upper buttons are drawn:
step_ty = 46 + 7 * bts;
draw_steps(step_ty, lift, current_step, step_pointer);

in redraw_lift_viewer
   set_bts(lift);
   int step_ty = 46 + 7 * bts;
   draw_steps(step_ty, lift, step, step);     // show lift steps

this is how I calulate what step the mouse is on in lift_editor

         if ((mouse_x > txc-95) && (mouse_x < txc+95) && (quit != 1) )
         {
            // calculate step
            int step = (mouse_y - step_ty) / bts -2;

the bts was changing after inserting new step, so I just redraw the step in insert

seems to be a lot better now...

what about the menu text...

everything about lifts in the editor is very beautiful and awesome
the code has been refactored and is lovely
it took a few days, but its all done now
--------------------------------------------------------
13/01/18 04:33


---------------------------------------------------------------------------------------
added db = 1100 mode for level editor
why don't I dynamically do this????
where...
ALLEGRO_BITMAP lefsm defined in main externed in pm
created at sc change
how much space for buttons don i need?
640 - 480 = 160...no
640 -  400  = 240
800 -  600  = 200
1024 - 700  = 324
1280 - 1000 = 280
the min that works is 200..
removed all custom bitmaps:
l1000
l700
1600
l400
that was easy, I should have done it a long time ago....
---------------------------------------------------------------------------------------
done.... 13/01/18 05:27




to get an image into the help screen....

1 - capture the screen with windows ALT-PRINTSCREEN
2 - open in paint and crop to exact size I need
3 - save as 24 bit bmp
4 - import like this...


   ALLEGRO_BITMAP * test;
   test = load_bitmap("status_window24.bmp", NULL);
   if (!test) printf("failed to load\n");
   else
   {
      draw_sprite(screen, test, 10, 10);
   }
   al_destroy_bitmap(test);
   tsw();



allegro.cc web site
make a new screen shot done
make an icon 32/32 done


edit my personal info....












-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------
orignal

A really cool platform game like Bubble Bobble, Lode Runner, or Super Mario.

Its completely free!!

Features:
 - the game works identically in Linux and Windows
 - two players can play at the same time
 - 35 huge levels (plus you can build more!)
 - 3 difficulty levels (easy, normal, hard)
 - user defineable setup for keyboard and/or joystick
 - sound effects and a soundtrack by Russel Hoy
 - bombs you can carry and throw
 - rockets you can ride and steer
 - lots of bad dudes and items that are completely customizable with the level editor
 - zooming game map (looks cool)

And the best feature of all: The Level Editor to make your own levels!

System Requirements:
Processor: Pentium or better
You can get more speed by choosing a smaller screen size (but its more fun to play with larger one)
Memory: 8M (might work with less, never tried)
Disk Space: 5M

If you download it, please take a few minutes to send me some feedback.

And if you create new levels, you simply must send them to me as well.  The only levels I get to play are ones that I created myself, and how challenging could that be?

Send your comments to:
mweiss001@gmail.com
Email me your new levels as e-mail attachments.

Happy gaming.

P.S. How this game came to be.
I was sitting there one night, playing Bubble Bobble, (I had just discovered MAME) and I decided to search the internet for some game tools.  What I found was djgpp, Allegro, and thus began my introduction to the open source movement.  I love it.  I can't stress that enough.  Open systems are so awesome, adjectives fail me.  I had been trying to write a video game since elementary school in the 70's when I taught myself BASIC on the Commodore PET.  Then I moved to the Apple II and learned some assembly, but I still couldn't write the game I wanted.  As soon as it got barely complex enough to be interesting, it ground to a halt.  So with djgpp and Allegro I finally had all the tools I needed.  The only catch was, I had to learn C.  Which I did.  It is the most elegant language I've used yet, just learning it helped me program more methodically, logically, elegantly, than I ever did in BASIC or assembly.  I wrote this game as I was learning C in the late 90's.

I have been making minor improvements to the game, and in
the next release I will have network multiplayer capability.

The project is completely C++ now and although I don't use any objects, I would like to redo a lot of the project with objects someday...

Thanks to using 99% Allegro functions to create the program,
I was able to port it to linux with only minor changes.

Russel Hoy wrote some music for the game that I use as background music for the game.  I use the music library DUMB
to play the music in both windows and linux. I have not been
able to get a hold of Russell for years now, if anyone knows
how to contact him please let me know.

-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------------

copy of the reviews.....




******** by yohosuff
There are some very fun aspects to the game, such as latching onto a rocket and steering it around the level. :) But there's a bug in the martian's movement Try jumping to the right whilst holding a spring. :o
********** by rkarloff
Former version was awesome years ago without the music and other plusses, it just got even better ! As for the retro graphics, I like them very much and consider it to be one of the BEST aspects in the game to keep the old-school feel.
********** by Daniel Schlyder
Lovely game and excellent music! I'm sure some won't give it a chance due to the extreme retro graphics, but I found them quite charming, and the gameplay is wonderful.
********** by Robin Allen
I love this game, it's so different. From the psychadelic neon graphics to the awesome dreamy music and fun, flowing gameplay I really can't find anything wrong with it. Excellent work.
******** by miran
Gameplay is exceptionally good, there are lots of levels and there's a level editor. Sound and music are also very nice. Too bad the overall impression is spoiled by not really more than average graphics...
******** by Andrei Ellman
A nice platform/puzzle game. Needs more polish and there's still a few small bugs, but I'm hooked.
********** by Ender Wiggin
The graphics are a little bit confusing but it's definitely a great game.
********** by Oscar Giner
Excelent game. Very addictive and with a wonderful gameplay. Simple but smooth animated graphics. The editor is also great.
********** by Todd
I like this game! The graphics aren't the best, but it's the gameplay that matters. You won't find many freeware platformers of this quality.
********** by georgi
Rating: Idea(100%) Graphic(75%) Sound(90%) Playable(75%) Dificulty(medium)
********** by KaBlammyman
This game is very well done. This is a must download. If you like platform games, no, if you like computer games, get this game!
********** by hex2bit
Very nicely done. This is a classic example of games like Lode Runner or Crystal Cave. There are lots of baddies, unique items like: springs, bombs, and switches, and many levels to test your skills. It's a must download for fans of this genre of game. Rating: A+













Project Info:



-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------
edited


A really cool platform game like Bubble Bobble, Lode Runner, or Super Mario.

Its completely free!!

Features:

 - many fun and challenging levels
 - lots of items and enemies that are completely customizable with the level editor
 - bombs you can carry and throw
 - rockets you can ride and steer
 - moveable lifts you can ride
 - switches that change blocks solid and back
 - springs that let you jump very high
 - keys that open locked blocks
 - doors to transport you to other places in the level
 - cloner that copy enemies and items
 - podzilla plants that pop up and shoot at you
 - helpful pop-up messages to help you figure stuff out

 - a LAN networked game mode with up two eight players

 - user defineable setup for keyboard and/or joystick
 - homemade sound effects
 - a music track by Russel Hoy
 - a fancy scrolling help screens with images and animations

 - the game can handle almost any screen resolution you can throw at it
 - it will adapt and re-size

 - very smooth moving graphics
 - you can zoom in or out to make the amount of level shown on the screen bigger or smaller
 - you can adjust the frames per second to anything you like
 - you can choose betwen 15 differnt colors for your player
 - a nice graphical level selector

And the best feature of all: The Level Editor to make your own levels!

If you create new levels, please send them to me.
The only levels I get to play are ones that I created myself, and how challenging could that be?

System Requirements:
Works on Window 7 and XP
95% works on Windows 10
ubunutu 16.0.4


I still use Allegro 4.2, and 256 color mode with palettes.
So full screen mode only works on XP and ubuntu
On Window 7 and 10 you can use whatever size of window you want and it works fine.

On Windows 10 I have done limited testing, but the game works fine.
Only in some of the other code where I draw lines and rectangles,
is quite slow on Windows 10.  But that will rarely be an issue.
The netgame works just fine across XP, 7 and 10;

If you download it, please take a few minutes to send me some feedback.

Send your comments to:
mweiss001@gmail.com
Email me your new levels as e-mail attachments.

Created with:

Allegro 4.2.2
Dev-C++ 4.9.9.2
MinGW
libnet-0.10.11
DUMB-0.9.3

Russel Hoy wrote some music for the game that I use as background music for the game.
I use the music library DUMB to play the music in both windows and linux. I have not been
able to get a hold of Russell for years now, if anyone knows how to contact him please let me know.


See the help file for more details




-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------






linux

ubuntu 15.1


installing samba

in software center
edit-> software sources
changed to main server

apt-get update


none of this works...
looks like samba is already installed..\\


sudo nano /etc/samba/smb.conf

set the following:

server string = %h
security = share
guest only = yes

comment out all lines in [printers] and [print$]

add a share at the bottom like this:

[pm_client7]
read only = no
guest only = yes
path = /home/m/Desktop/pm_client7

save the file and restart samba like this:

'sudo service smbd restart'.. this line does not work...



fuck it i'm getting 16.04.3 and starting from scratch...

downloaded rufus 2.18 to make bootable USB

initalling 16.0.4.3

chose update while installing...




from desktop

create folder

share it

prompt to install samba and restart session

downloaded and extracted allegro 4.2.3

went to that dir with terminal and ran
./configure

then make

ran into some errors.....


sudo apt-get install
that worked...

liballegro4.4 - portable library....

libaldmb1 - DUMB allegro version

libnet ???

copied to ubuntu desktop

chown -R m:m libnet



then i renamed linux.mak to port.mak and put it 1 dir up

does not work...


can i compile my game with libnet???


can i define it out??
yes...

how about sound...yes

now if remove all from linker will it still run...


orignal linker


"C:\Dev-Cpp\lib\libaldmb.a"
"C:\Dev-Cpp\lib\libdumb.a"
"C:\Dev-Cpp/lib/libnet.a"
"C:\Dev-Cpp/lib/libwsock32.a"
"C:\Dev-Cpp/lib/liballeg.a"

removed all but:
"C:\Dev-Cpp/lib/liballeg.a"

still compiles and runs...woo hoo
lets see if my game can back its self up to pm_client7...yes it can


when you put these lines back in Dev-Cpp, they need to go in this order and before liballeg.a
"C:\Dev-Cpp\lib\libaldmb.a"
"C:\Dev-Cpp\lib\libdumb.a"





apt-get install liballeg4-dev

trying to compile from the command line

g++ zfnx.cpp


I can make a file with nano...

put some commands in it
run it with bash xxx



sometimes it crashes really hard...
graphical level select does not work
once it said float exception
how to recover from fullscreen crash
CTRL-ALT-F1
drop to hard terminal
CTRL-ALT-F7 or F8 to return






most of the game works great....
lets see if I can get sound working....

how about I get libdumb1-dev
or libaldmb1-dev for allegro...this one





look for header files in:
/usr/include

found allegro.h and aldumb.h

look for lib files in:
/usr/lib/x86_64=linux-gnu


found libaldmb.a
also libaldmb.so
also libdumb.a


this is my compile line

g++ -Wall

e_bitmap.cpp e_bled.cpp e_editor.cpp  e_fnx.cpp e_glt.cpp e_guifnx.cpp e_item.cpp
e_lev.cpp e_menu.cpp e_nev.cpp e_nlv.cpp e_pde.cpp e_sel.cpp e_sliders.cpp e_special.cpp
yfilecom.cpp zbullets.cpp zcontrol.cpp zemove.cpp zfile.cpp zfnx.cpp zitem.cpp zlifts.cpp
zloop.cpp zmain.cpp zmenu.cpp zplayer.cpp zscrn.cpp zsound.cpp





This i what I needed to do to get my game to compile in linux:


ubuntu 16.0.4.3 desktop

made a folder on the desktop and shared it
promtpted to install samba, did it

set up may game to sync to that dir: \\4230-3\\pm_client7

changed owner and permissions for that dir:
as root:

chown -R m:m /home/m/Desktop/pm_client7
chmod -R 777 /home/m/Desktop/pm_client7

installed allegro with:
apt-get install liballeg4-dev

then i compile from the command line

g++ -Wall  <list of sourec files> `allegro-config --cflags --libs` -o pmlin


 -I/usr/include-L/usr/lib/x86_64-linux-gnu -laldmb -ldumb -lalleg -o pmlin


this line says it can't find -lalleg
g++ -Wall e_bitmap.cpp e_bled.cpp e_editor.cpp e_fnx.cpp e_glt.cpp e_guifnx.cpp e_item.cpp e_lev.cpp e_menu.cpp e_nev.cpp e_nlv.cpp e_pde.cpp e_sel.cpp e_sliders.cpp e_special.cpp yfilecom.cpp zbullets.cpp zcontrol.cpp zemove.cpp zfile.cpp zfnx.cpp zitem.cpp zlifts.cpp zloop.cpp zmain.cpp zmenu.cpp zplayer.cpp zscrn.cpp zsound.cpp -o pmlin -I/usr/include -L/usr/lib/x86_64-linux-gnu -lalleg



convert windows text file to unix text file:
tr -d '\15\32' < winfile.txt > unixfile.txt



al_fixed the sources so that I can compile sound without dumb...

I can now compile the game and sound works (but not DUMB) in linux!!!

I spent a lot of time chasing some obscure bug, pm.h was not being included in zsound.cpp
it was the first include line, but acted like it was not there until I included allegro.h first



now back to the compile line...

this works:
-I/usr/include -L/usr/lib/x86_64-linux-gnu -lalleg -o pmlin

so does this:
`allegro-config --cflags --libs` -o pmlin

when this line is run from the command line: allegro-config --cflags --libs
I get:
-I/usr/include
-L/usr/lib/x86_64-linux-gnu -lalleg

in /usr/include I find allegro.h

if I remove -I/usr/include and use just -L/usr/lib/x86_64-linux-gnu -lalleg -o pmlin
it still works

if I just use -lalleg -o pmlin
it still works

does not match exactly what is in  /usr/lib/x86_64-linux-gnu
there its: liballeg.so

tried:  -liballeg -o pmlin
can't find it

found this:
[...] The linker handles an archive file by scanning through it for members which define symbols
that have so far been referenced but not defined. But if the file that is found is an ordinary bject file,
it is linked in the usual fashion. The only difference between using an -l option
and specifying a file name is that -l surrounds library with lib' and.a' and searches several directories

this works: /usr/lib/x86_64-linux-gnu/liballeg.so -o pmlin


lets try dumb again. armed with my new knowledge...and the zsounds.cpp pm.h fix...

these are the packages I installed:

how about I get libdumb1-dev
or libaldmb1-dev for allegro...this one

i think that the second one was already loaded by the first? not sure...

what should I link with??


found libaldmb.a
also  libaldmb.so
also  libdumb.a


lets try -laldmb
this is what works -ldumb -laldmb -lalleg

I had the same stupid bug in zmain.cpp where pm.h was not being included
until I put include allegro.h before it...

now the game works with sound in linux!!!!!!

this is my compile line:

g++ -Wall

e_bitmap.cpp e_bled.cpp e_editor.cpp  e_fnx.cpp e_glt.cpp e_guifnx.cpp e_item.cpp
e_lev.cpp e_menu.cpp e_nev.cpp e_nlv.cpp e_pde.cpp e_sel.cpp e_sliders.cpp e_special.cpp
yfilecom.cpp zbullets.cpp zcontrol.cpp zemove.cpp zfile.cpp zfnx.cpp zitem.cpp zlifts.cpp
zloop.cpp zmain.cpp zmenu.cpp zplayer.cpp zscrn.cpp zsound.cpp

-ldumb -laldmb -lalleg -o pmlin


-------------------------------------
I'm happy!!!!

now I really need to get libnet working....



first try to compile it in linux..

I followed my old instructions and was able to compile it with MINGW




put libnet in pm dir and synced over to lin

changed the owner and permissions




this is the original makefile
--------------------------------------------------------------

# Portability makefile -- helper for other makefiles

# Linux version

TARGET = LINUX

LIBDEST = /usr/local/lib/$(LIBFILENAME)
INCDEST = /usr/local/include/$(INCNAME)
EXE_SUFFIX =
RM_F = rm -f
CP_F = cp -f

CC = gcc
WARNING_FLAGS = -Wall -Werror -Wno-unused -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations
LDLIBS = -lpthread
LINK_ALLEGRO = `allegro-config --libs`
ARFLAGS = rs

LIBNAME = net
LIBFILENAME = lib$(LIBNAME).a
INCNAME = libnet.h
LIBDIR = $(BASE)/lib
LIBSRC = $(LIBDIR)/$(LIBFILENAME)
INCDIR = $(BASE)/include
INCSRC = $(INCDIR)/$(INCNAME)


this is my edit
--------------------------------------------------------------

# Portability makefile -- helper for other makefiles

# Linux version

TARGET = LINUX

LIBDEST = /usr/lib/x86_64-linux-gnu/$(LIBFILENAME)
INCDEST = /usr/include/$(INCNAME)
EXE_SUFFIX =
RM_F = rm -f
CP_F = cp -f

CC = gcc
WARNING_FLAGS = -Wall -Werror -Wno-unused -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations
LDLIBS = -lpthread
LINK_ALLEGRO = `allegro-config --libs`
ARFLAGS = rs

LIBNAME = net
LIBFILENAME = lib$(LIBNAME).a
INCNAME = libnet.h
LIBDIR = $(BASE)/lib
LIBSRC = $(LIBDIR)/$(LIBFILENAME)
INCDIR = $(BASE)/include
INCSRC = $(INCDIR)/$(INCNAME)


----------------------------------

lets try it...


got some errors

remove -Werror






i am going to fix my includes:

none in pm.h ... done

each cpp file will have

allegro first

then c libs

lastly pm.h








n_network.h...
nothing

n_network.cpp...done
//#include <allegro.h>
#include <libnet.h>
//#include <stdlib.h>
//#include "n_network.h"
#include "pm.h"
#ifdef NETPLAY


n_packet.cpp...done
//#include <allegro.h>
//#include <string.h>
#include "n_packet.h"
#include "pm.h"
#ifdef NETPLAY

n_packet.h...done
nothing


n_server.cpp...done
#include <allegro.h>
#include <libnet.h>
#include "n_network.h"
#include "n_server.h"
#include "n_packet.h"
#include "pm.h"
#ifdef NETPLAY
#ifdef CONNECTION

n_server.h...done
nothing



n_client.cpp...
#include <allegro.h>
#include <libnet.h>
#include "n_network.h"
#include "n_client.h"
#include "n_packet.h"
#include "pm.h"
#ifdef NETPLAY
#ifdef CONNECTION

n_client.h...done
nothing


yfilecom.cpp....done
#include "pm.h"

zbullets.cpp...done
#include "pm.h"

zcontrol.cpp...done
#include <math.h>
#include "pm.h"

zemove.cpp...done
#include <math.h>
#include "pm.h"


zfile.cpp...done
#include "pm.h"

zfnx.cpp...done
#include <math.h>
#include "pm.h"

zitem.cpp...done
#include "pm.h"

zlift.cpp...done
#include "pm.h"

lift.h nothing

zloop.cpp...done
#include "pm.h"

zmain.cpp...done
#include "pm.h"

zmenu.cpp...
#include "pm.h"

zplayer.cpp...done
#include "pm.h"

zscrn.cpp...done
#include <math.h>
#include "pm.h"

zsound.cpp...done
#include "pm.h"

e_bitmap.cpp...done
#include "pm.h"

e_bled.cpp...done
#include "pm.h"

e_editor.cpp...
#include "pm.h"

e_fnx.cpp...
#include "pm.h"

e_glt.cpp...done
#include "pm.h"

e_guifnx.cpp...done
#include "pm.h"

e_item.cpp...done
#include "pm.h"

e_lev.cpp...done
#include <math.h>
#include "pm.h"

e_menu.cpp...done
#include "pm.h"

e_nev.cpp...done
#include "pm.h"

e_nlv.cpp...done
#include "pm.h"

e_pde.cpp...done
#include "pm.h"

e_sel.cpp...done
#include "pm.h"

e_slider.cpp...done
#include <math.h>
#include "pm.h"

e_special.cpp...done
#include "pm.h"

all done.....

end result....
all cpp files include pm.h
pm.h has no includes
nothing needed allegro.h

now lets see if it compiles on linux...


-----------------------------------------------------------

now where am i going to put that library and header??

they're already where I would expect them to be

add -lnet to line

now i get the error

libnet.a  undefined reference to symbol 'pthread_create@@GLIBC_2.2.5'

added -lpthread to the end of the line


HOLY FUCKING SHIT!!!!  I GOT IT!!!!
THIS COULD VERY WELL BE THE MOST EXCITING THING I HAVE
EVER ACCOMPLISHED WITH THIS PROJECT!!!!!
NETPLAYER ACROSS WINDOWS AND LINUX!!!!!!
14/01/18 12:21

This calls for a celebration..


-----------

do i need the allegro.h at the top of every file
test it..maybe????



this is the final compile line:

g++ -Wall

e_bitmap.cpp e_bled.cpp e_editor.cpp e_fnx.cpp e_glt.cpp e_guifnx.cpp e_item.cpp
e_lev.cpp e_menu.cpp e_nev.cpp e_nlv.cpp e_pde.cpp e_sel.cpp e_sliders.cpp
e_special.cpp yfilecom.cpp zbullets.cpp zcontrol.cpp zemove.cpp zfile.cpp
zfnx.cpp zitem.cpp zlifts.cpp zloop.cpp zmain.cpp zmenu.cpp zplayer.cpp
zscrn.cpp zsound.cpp n_network.cpp n_packet.cpp n_client.cpp n_server.cpp

-ldumb -laldmb -lalleg -lnet -lpthread -o pmlin


what warnings does g++ show that I sould care about? not much...
-Wno-write-strings



OK i'm brave, lets kill the ubuntu and start over...


---------------------------------------------------------------------
------------ Linux --------------------------------------------------
--------------------------------------------------------------------

Tested on ubuntu 16.04 LTS

Did a full install of ubuntu, erased everything on disk.

Overview of Steps:

1 - Install libraries
2 - Compile the game
3 - Run

Installing Allegro and DUMB

from a terminal:

- update the apt cache: 'sudo apt-get update'

- install allgero: 'apt-get install liballegro4-dev'

- install DUMB: 'apt-get install libaldmb1-dev'










- set up a share for project files
made a folder on the desktop 'pm_client7' and shared it
prompted to install samba, did it with no problems
needed to restart session
shared again, checked:
'allow other to create and delete files in this folder'
'guest access (for people without an account)'
clicked 'create share'
chose 'set permissions automatically'

set up may game to sync to that dir: \\4230-3\\pm_client7
sync'd all the files to there

changed owner and permissions for that dir and everthing in it:
as root:
chown -R m:m /home/m/Desktop/pm_client7
chmod -R 777 /home/m/Desktop/pm_client7

- install libnet  (from my local copy of the sources)
from a terminal go to the folder 'libnet' in the game folder
'make lib'
'sudo make install'
puts libnet.h in /usr/include/
puts libnet.a in /usr/lib/x86_64-linux-gnu/

you now have all the prerequistes to compile the game

in a terminal navigate to the 'src' directory of the game
run the bash script cb like this './cb'

this is the compile line:

(it has no line breaks, but I have put some here for readablity)

----------------------------------------------------------------------------------------
g++ -w
e_bitmap.cpp e_bled.cpp e_editor.cpp e_fnx.cpp e_glt.cpp e_guifnx.cpp e_item.cpp
e_lev.cpp e_menu.cpp e_nev.cpp e_nlv.cpp e_pde.cpp e_sel.cpp e_sliders.cpp
e_special.cpp yfilecom.cpp zbullets.cpp zcontrol.cpp zemove.cpp zfile.cpp
zfnx.cpp zitem.cpp zlifts.cpp zloop.cpp zmain.cpp zmenu.cpp zplayer.cpp
zscrn.cpp zsound.cpp n_network.cpp n_packet.cpp n_client.cpp n_server.cpp
-ldumb -laldmb -lalleg -lnet -lpthread -o ../pmlin
----------------------------------------------------------------------------------------

-w (no warnings)

-ldumb -laldmb (these are for DUMB, they need to go before allegro)

-lnet -lpthread (these are for libnet)

-o ../pmlin (put the executable in the parent directory)

convert windows text file to unix text file:
tr -d '\15\32' < winfile.txt > unixfile.txt

to run the game go to the parent directory and type './pmlin'






---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------


test compress...

on ubuntu
right click on the folder and compress to tar.gz


full screen thing for linux as well as xp done



working on trakbot still.....
15/01/18 06:57

make a new backup...

20180115






-------------------------------------------------------------
trakbots get stuck on corners, mostly high speed ones
-------------------------------------------------------------
still working on it




I want to make a test system for collisions
a stand alone function do at the end on fnx



I want to be able to look at the data for trakbot
as it makes its choices

the problem is when the modes are switched

the old mode should set the position so that the next mode can just continue...
but it doesn't work like that

so I want to see exactly waht is being set...


in trakbot

show mode, and x and x pos each frame..


made some new solid functions


      switch (mode)
      {
         case 0:                                                  // floor right
            Ei[EN][2] = 1;                                        // no h flip
            Efi[EN][14] = al_itofix(0);                              // rotation = 0 deg
            Efi[EN][0] += Efi[EN][2];                             // +xinc

            if (!is_down_solidf(Efi[EN][0], Efi[EN][1], 0))
            {
               mode = 3;                                          // next mode (lwall down) (cw)
               Efi[EN][14] = al_itofix(32);                          // 45 deg
               Efi[EN][0] += al_itofix(5);                           // push ahead to make sure we stick to new wall
               Efi[EN][0] = fixmod(Efi[EN][0], 20) ;              // align x
               break;
            }
            if (is_right_solidf(Efi[EN][0], Efi[EN][1], 0))
            {
               mode = 1;                                          // next mode (rwall up) (ccw)
               Efi[EN][14] = al_itofix(224);                         // 315 deg
               Efi[EN][0] += al_itofix(5);                           // push ahead to make sure we stick to new wall
               Efi[EN][0] = fixmod(Efi[EN][0], 20);               // align x
            }
         break;
         case 1:                                                  // rwall up
            Ei[EN][2] = 1;                                        // no h flip
            Efi[EN][14] = al_itofix(192);                            // rotation = 270 deg
            Efi[EN][1] -= Efi[EN][3];                             // -yinc
            if (!is_right_solidf(Efi[EN][0],Efi[EN][1], 0))
            {
               mode = 0;                                          // next mode (floor right) (cw)
               Efi[EN][14] = al_itofix(224);                         // 315 deg
               Efi[EN][1] += Efi[EN][3];                          // take back yinc
               Efi[EN][1] = fixmod(Efi[EN][1], 20);               // align y
               break;
            }
            if (is_up_solidf(Efi[EN][0], Efi[EN][1], 0))
            {
               mode = 2;                                          // next mode (ceil left) (ccw)
               Efi[EN][14] = al_itofix(160);                         // 225 deg
               Efi[EN][1] += Efi[EN][3];                          // take back yinc
               Efi[EN][1] = fixmod(Efi[EN][1], 20);               // align y
            }
         break;
         case 2:                                                  // ceil left
            Ei[EN][2] = 1;                                        // no h flip
            Efi[EN][14] = al_itofix(128);                            // 180 deg
            Efi[EN][0] -= Efi[EN][2];                             // - xinc
            if (!is_up_solidf(Efi[EN][0], Efi[EN][1], 0))
            {
               mode = 1;                                          // next mode (rwall up) (cw)
               Efi[EN][14] = al_itofix(160);                         // 225 deg
               Efi[EN][0] += Efi[EN][2];                          // take back xinc
               Efi[EN][0] = fixmod(Efi[EN][0], 20); // align x
               break;
            }
            if (is_left_solidf(Efi[EN][0],Efi[EN][1], 0))
            {
               mode = 3;                                          // next mode (lwall down) (ccw)
               Efi[EN][14] = al_itofix(96);                          // 135 deg
               Efi[EN][0] += Efi[EN][2];                          // take back xinc
               Efi[EN][0] = fixmod(Efi[EN][0], 20) -al_itofix(0);               // align x

            }
         break;
         case 3:                                                  // lwall down
            Ei[EN][2] = 1;                                        // no h flip
            Efi[EN][14] = al_itofix(64);                             // 90 deg
            Efi[EN][1] += Efi[EN][3];                             // + yinc
            if (!is_left_solidf(Efi[EN][0], Efi[EN][1], 0))
            {
               mode = 2;                                          // next mode  (ceil left) (cw)
               Efi[EN][14] = al_itofix(96);                          // 135 deg
//               Efi[EN][1] -= Efi[EN][3];                          // take back yinc
               Efi[EN][1] += al_itofix(5);                           // push ahead to make sure we stick to new wall
               Efi[EN][1] = fixmod(Efi[EN][1], 20); // align y
               break;
            }
            if (is_down_solidf(Efi[EN][0], Efi[EN][1], 0))
            {
               mode = 0;                                          // next mode (floor right) (ccw)
               Efi[EN][14] = al_itofix(32);                          // 45 deg
               Efi[EN][1] += al_itofix(5);                           // push ahead to make sure we stick to new wall
//               Efi[EN][1] -= Efi[EN][3];                          // take back yinc
               Efi[EN][1] = fixmod(Efi[EN][1], 20);               // align y
            }
         break;




this is what I had before i changed it even more
16/01/18 04:33


made function that will return the allowed move..

al_fixed is_up_solidfm(al_fixed fx, al_fixed fy, al_fixed fmove)

you pass it how far you want to move and it returns how for you can move before solid.



now I need something slightly different

check down while moving left or right



16/01/18 07:00



ran out of time


just finished modifying all my solid function

now I need to patch them into emove




how do my new funtions handle moving backwards.. negative move
should be impilicit in the name of the function which way it looks





16/01/18 11:36

with the new method I can mode cw around the outside of a single block
mode 0 3 2 1... at speeds up to 20

doesn't work when I pit a ring of block around it....
maybe that will get al_fixed when I make the other way work

ccw inside a rect 0 1 2 3...

do that...

now ccw inside a rect 0 1 2 3
works up to speeds of 40...

now ccw inside a rect 0 1 2 3 with single bloak in center
works up to speeds of 20...


test cw outside single block surounded...
leaves at step 0-3




i think part of my problem is when I am testing for a hole in front of me,
if its a gap... there is only one exact place when the hole will be

when I am scanning a range I might go past that....



from mode 3 to 2
at the end of 3 y gets inc 2 when it shouldn't..

in function is left solid...





test:
cw 0321 single block inside frame, runs at speeds up to 60!!!!

lets try :
ccw 0123 3x3 inner frame with single block in middle
good up to 30...

al_fixed it, now:
ccw 0123 3x3 inner frame with single block in middle.. up to 60!!!!


does it work with fractional xincs?

no, it fucks up bad.....


need a way to


supposed send x = 1.5, solid is at 3, move = 2.3

what actually happens:

starts looking at 1
1 not solid move ++
2 not solid move ++
3 solid return 2

what should happen
return 1.5

how can I fix...
start looking at actuall al_fixed pos
pointless at the fraction wont affect what block....

....
what if we save the extra fraction al bit at the start
.5
then at the end subtract it ... that's so crazy it might just work

doesn't take into account the fractional move bit...


------------

how about at the end we know it absolute level numbers where the next solid is
then see if the actual move and pos is less

at the end

if (dir)


int pos = ix + move; // pos we care about

al_fixed mtp = al_itofix(pos) - initial pos



al_fixed the fractional...


test...

cw  0321 on single block inside 3x3 frame
ccw 0123 in 3x3 frame with single block in middle
good up to 60...fractional too

I think I can implement 4567...done

what else can I test??




line up the movement to the animation:


everytime tb moves 1 pixel get new shape


mod the x or y direclty not / 20

mod with 6;;;

meke trakbot initial direction one of 8 modes..done


remove EXint and EYint...done

seek player wile falling

will closest player work or do they need to be below?
go with closest for now...done...

twirling check??

doesn't seem needed

this was the code:

   if (Ei[EN][5] == mode) Ei[EN][8] = 0;
   if (Ei[EN][5] != mode)
   {
      Ei[EN][5] = mode;
      if (++Ei[EN][8] > 4) // twirling
      {
         Efi[EN][8] = al_ftofix(1.6); // fall
         Ei[EN][5] = 0;
         Ei[EN][2] = 1;
         Efi[EN][14] = al_itofix(0);
      }
   }

basically if we only spend 1 frame in a mode, the counter (Ei[EN][8]) is inc'd

if we do that 4 times in a row, we call that twirling

I can see right now, that this would trigger if we have a really fast trakbot
beacaue they would only spend 1 frame in each direction.

this also was the only place that mode was copied back to Ei[EN][5]
and only if it had changed..

I'm going to leave it out for now and see...


make some tests for trakbot....then call it done if no more bugs are found

bullet prox...should be a circle, not a rect...
where can I fix this...
now I show a cirle in the level editor
tested and made code to show the circle in game
...done


found a case when trakbot will twirl...
initially if mode not set right...
initially if set in space...
if block its on is removed

ok twirl is coming back...done

now when inside single block twriling triggers...al_fixed

now how about fast lifts...

make a frame with 2x2 inside
even at speed 10 still gets 3 moves per mode...

looks good...

i now pronounce trakbots, completely finished and tested....

20180119 07:04

-----------------------------------------------------

make a backup....

20180119

-----------------------------------------------------
fix flappers with glt
-----------------------------------------------------
they have 0 x speed and xinc
what is default???
5 x speed  4
6 x acc    .4
8 flap yinc .76
should I make flappers always seek in yinc?? yes, done
I like that better
done...20/01/18 05:47



---------------------------------------------------------------
remove mtl from blocks
how does that work?
how are the block shown in block selection window??
look like it uses:
swbl[NUM_SPRITES][2];

this sets it in fnx
void set_swbl(int start_shape, int end_shape, int mt)

this calls it in bled
in  'int select_block_proc()' initial setup
set_swbl(32,NUM_SPRITES,1);

it is called 3 times in bled, after soem chage has been made
set_swbl(32,NUM_SPRITES,1);


this calls it in main... (initial setup)
   // automatically set rows to new number of lines here
   set_swbl(0, NUM_SPRITES, 0);  // set swbl
   swnbl = select_window_num_block_lines;

its also called in editor just after select_block_proc() is called:

               select_block_proc();
               // automatically set rows to new number of lines here
               set_swbl(0, NUM_SPRITES, 0);  // set swbl
               draw_select_window();

what is the signifigance of the mt parameter??
it looks like when int select_block_proc() is using it its set like:
set_swbl(32,NUM_SPRITES,1);

and when select_window it using it its set like:
set_swbl(0, NUM_SPRITES, 0);  // set swbl

I can remove the call in editor just before draw_select window calls it, because it called from there

what about swnbl and select_window_num_block_lines???
who really needs them??

swnbl
only main and e_special

select_window_num_block_lines
main
bled
fnx
special

to start with, in main only swnbl...done

find all select_window_num_block_lines
replace with swnbl

I found out why...

swnbl was how many were shown
select_window_num_block_lines was the max amount


make new swnbl and swnbl_cur
done...
nothing in main need to touch these...done
remove all mentions of select_window_num_block_lines

where do I set cur initially
can't set in set_swbl cause that's called by draw and gets reset if I change it...
where does all this happen...
when editor is started draw calls set...done
now find all mentions and see if can reduce some...done
now back to what I was doing before...

figuring out how the blocks are put in swbl
what gets saved with sprit file??
animation sequences...
sa[NUM_SPRITES][2] // shape attributes
bcmt[NUM_SPRITES] // block color map table
was bcmt only used by old map???, yes
can set it bitmap by pressing 'M' and clicking

sa does what???
sa[][0] == 0(block)    1(empty)
sa[][1] == 0(unlocked) 1(locked)
when the list is made...
-1st block locked
-2nd block unlocked
trying to change attributes with bitmap...
need to click and drag rect to change...

set 169 mtl to unlocked and S..doesnt show in list now...
does anything use S or is it just a marker?
what does block editor do?  copy and paste shapes around??
its wrong......
it used to be the first 32 shapes has special types
0  - 7  empty
9  - 15 semi solid
16 - 23 bomb-proof
24 - 31 breakable
but that has changed and now:

0  - 31  empty
32 - 63  semi solid
64 - 95  bombable
96 - 127 breakable
>128 real solid
this has all been al_fixed....
I just set the shapes in didn't want to S or E with bitmap...
---------------------------------------------------------------
20/01/18 07:51




---------------------------------------------------------------
zoom full screen, not detecting enemies in selection window????
---------------------------------------------------------------
fixed detection and bug in pointer_text()
done 20/01/18 08:04



---------------------------------------------------------------
why does CNTRL or SHIFT fuck up key read???
---------------------------------------------------------------
reproduce...
in game CTRL-F8 or CTRL-F7
then ESC doesnt work until another key pressed

its just CTRL...
anytime CTRL is pressed ESC does not work until another key is pressed first...
is it only on win7???
XP doesn't do it...
ubuntu doesn't do it..

on win7...
different kbd..same
disable all in ease of access..same...

its just a win7 thing...

also when I press ALT I can escape until another key is pressed
but with ALT spacebar does nothing...

windows keys take me out of the game
menu key does not

the problem is totally in win 7

   if (key_shifts & KB_SHIFT_FLAG) printf("SHIFT PRESSED\n");
   if (key_shifts & KB_ALT_FLAG)   printf("ALT PRESSED\n");
   if (key_shifts & KB_CTRL_FLAG)   printf("CTRL PRESSED\n");

win7 keeps these pressed even after they are released
XP and ubuntu do not...live with it..too difficult to fix...
---------------------------------------------------------------
20/01/18 08:58



--------------------------------------------------------------
ubuntu floating point execption in grphical level select
the error was looking for levels with .PML should be .pml
--------------------------------------------------------------
fixed... 20/01/18 10:38


--------------------------------------------------------------
when i rearrange and move levels around, they come back when I
sync to work computer and back
make something to tell what levels are similar...
i made an awesome level comparer...done
--------------------------------------------------------------
20/01/18 14:01



---------------------------------------------------------------
move pod extended position is broken...
moves pod position too.
---------------------------------------------------------------
its because i messed with getxy...al_fixed
also cloner destination will be fucked...al_fixed
done 20/01/18 15:11
also rocket dest...
also cannon and bouncer
done
20/01/18 17:52


---------------------------------------------------------------
make it so bomb kills multiple hit enemy (cannon)
done....
---------------------------------------------------------------
20/01/18 17:29



---------------------------------------------------------------
mouse shows during game...fixed
---------------------------------------------------------------
show_mouse(NULL) already in initial setup
added in loop at end of start mode
20/01/18 19:20

---------------------------------------------------------------
made lifts more accurate by setting exact position when switching steps
---------------------------------------------------------------
21/01/18 00:15




backup...
20180121



i don't like how cloner keeps going till all enemies or items are used
add to cloner
max enemies created
how to keep track...
do I have an empty variable in item and enemies I can use???

items 3(draw mode is unused) 15 not used
if I move door color from 14 to 6 i will have 14 empty as well..do it and test
use glt to copy 14 to 6 for all door...done
change draw code to use this...done...
change colsel buttons to use 6..done
edit PDE ..done
edit creators..done

now I have 14 and 15 empty...
what am i going to do with them?

14 - time to die!
15 - who made who?


time to die
a passcount value that when exceeded the item will die!
used by bonus's created from dead enemies
can also be used by cloner created items
if 0 live forever


who made who
link to creator + (1000)
if zero, we came with the level
else the number of the cloner that created us.
used by the cloner to see how many things it has created



add to cloner -
max objects created
time to live for obt created


add to item move
check for expired ttl

// check for expired time to live
if ((item[c][14]) &&  (item[c][14] < passcount)) item[c][0] = 0;

when bonus flower is created from dead enemy, set...
item[c][14] = passcount+200;

that was so easy!!! 2 lines...

it would be nice to have an animation when it disappered...
made animation seq 74 with 10 steps

make a new item type...97

convert to type 97 on expiry and set new expiry to run animation


changed from adding a number to passcount to just a number that decrements
when it gets to 1 is when it dies, because 0 is live forever

item[c][14] = 800; // time to live (20 sec)

      // check for expired time to live
      if (item[c][14])
      {
         if (item[c][14] == 10)
         {
            item[c][0] = 97; // change to 97 - expired animation seq
            item[c][14] = 10; // new time to live = 20
         }
         if (item[c][14] < 10)
         {
            int sq = (10 - item[c][14]) / 1;
            item[c][1] = zz[5+sq][74];
         }
         if (item[c][14] == 1) item[c][0] = 0; // kill it
         item[c][14]--;
      }

done and looks good.....
21/01/18 09:58


now add time to live to cloner
applies to items only for now but could be used on enemies too...


added to cloner

now make a slider and variable for cloner

9 time to live for created objects 0-4800 (120 sec) (0 = live forever)
10 max created object active at one time 0-500 (0 = no limit)

made new slider in cloner

ttl works works for items

now make it work for enemies...


in enemy
if I move extra hits to kill some where else i will have 28 open
then I could use 28 and 29
do it...
where to move to...9...

done in emove...
do it in glt..
copy 28 to 9
erase 28..done
change in sliders..done
28 is now free
29 is used for collison box....!!!!!

lets move bonus around a bit

Ei[EN][24] = bullet bonus
Ei[EN][25] = health bonus
Ei[EN][26] = bonus type
Ei[EN][27] = bonus shape

all I really need is 25 and 27
24 bullet bonus is no longer used
26 bonus type is always 2

new:

move bonus shape from 27 to 24

then 26, 27 are free....

stop using type and always use 2...done

test killing all types of enemies...

in glt erase 26, 27, 28

in pde remove 24 old bullet bonusat 24..done
also in cloner and pod creators...done

----------------
now put ttl in 27
later use 28 for other

use glt to make sure 26, 27, 28 are all zero...done

in cloner set ttl:
Ei[c][27] = Ei[EN][9]; // set time to live

implement it in enemy move...done

now can I do the same as item and make animation?...

yes that's all done now...

now for the second part...
max number of created items

- tag each created item....

item[c][15] = 1000+EN;   // tag with cloner item id
Ei[c][28] = 1000+EN;   // tag with cloner item id

now before create, count how many we have out there....

omg I think it works exacty how I want it.....
21/01/18 12:34



there is more code that uses door color that I need to fix...done
21/01/18 13:35



---------------------------------------------------------------
fix rotation of items and enemies to not use dtemp
makes the shape smaller and dumb
items is not big deal only rocket and it doesnt show
but enemies is noticeable with bounvcers and trakbot 45deg switch mnodes
---------------------------------------------------------------
21/01/18 18:11



---------------------------------------------------------------
make the scaler snap to values, especially 1.00
---------------------------------------------------------------

press and hold F5 and F6 at the same time
returns you to 1.00
21/01/18 20:50


---------------------------------------------------------------

add arrow keys for next prev in lift viewer
done...22/01/18 06:26
---------------------------------------------------------------


---------------------------------------------------------------
I am having some random weird shit going on when deleting in viewer??
take the function from glt that checks for illegal enemies
-make it a stand alone function
-make a similar one for items...
or just use lists...done 22/01/18 06:26
---------------------------------------------------------------


---------------------------------------------------------------
kill all enemy if out of bound in enemy common..done
---------------------------------------------------------------
done 23/01/18 03:20



---------------------------------------------------------------
in zfs cant select enemy in very bottom row (x == 1980)
also sel functions dont work on stuff in first row
like copy...al_fixed 23/01/18 05:08
---------------------------------------------------------------


---------------------------------------------------------------
make zfs function to move selection
also make zfs function copy better...

both of them should copy selection to ft values and then paste back
that way we wont copy a section to and from itself causing loops...

I might also find the bug that causes crashes...

for now do paste...
when button clicked copy to ft

make a new function 'copy sel to ft'
actually just add parameter to 'save selection'
it already fills ft before saving to disk

then use the show_fsel and copy_fsel just like fcopy..

it was easy, but now buttons do not make sense

fcopy is the same as copy

when you click past from disk, loads then uses old copy mode..

tentatively i think it works

i get a rare random crash that I would like to find...

now if I implement a move funtion...

- copy to fsel
- clear sel
- wait for paste and hope it doesn't crash...

done...

all this works good, except for the usual random crash...
---------------------------------------------------------------
done 23/01/18 06:05



working on group edit (randomizer...)
23/01/18 06:12



time for a backup...
20180123




when copying and pasting in zfs i got this crash:
no file save or load...
-------------------------------------------------

Problem signature:
  Problem Event Name:	APPCRASH
  Application Name:	pm.exe
  Application Version:	5.10.1.13004
  Application Timestamp:	5a687906
  Fault Module Name:	ntdll.dll
  Fault Module Version:	6.1.7600.16385
  Fault Module Timestamp:	4a5bdb3b
  Exception Code:	c0000005
  Exception Offset:	0003434c
  OS Version:	6.1.7600.2.0.0.256.1
  Locale ID:	1033
  Additional Information 1:	0a9e
  Additional Information 2:	0a9e372d3b4ad19135b953a78882e789
  Additional Information 3:	0a9e
  Additional Information 4:	0a9e372d3b4ad19135b953a78882e789


  Exception Code:	c0000005
  means acessing memory that i don't have rights to...

  in my example I was not using any msg or lift so, strings related to them should not be the problem...


  start xfs
  select 25 enemies
  move
  paste 5 time
  exit zfs
  start zfs
  select dif 25 enemies
  move
  crash




seems to happen when I leave zfs

this time after a few move when I clicked move it died...

again after a few moves when i clicked move it died...


in the function save_selection
where stuff is copied to ft_

there are limit checks that I feel are not needed...
it should only check when pasted from...
comment them out for now...


move and pasted 25 e twice
leave zfs and come back
sel 25 e and click move
crash

debug print show I got to the end of save_sel and copied 25 e only


could it be ft_bmp???

I destroy it when I leave zfs

when do i create it...

when i do move?? no

when I call draw_fsel...
right after move, paste or load...or when obt buttons change

when do i show ft_bmp...


i got up to draw_fsel9

then line that killed it is:

stretch_blit(temp, ft_bmp, 0, 0, t_w, t_h, 0, 0, ft_w, ft_h);






--------------
now it died on draw_fsel 2
right before al_destroy_bitmap(ft_bmp);


might be where I am declaring it???

might be how many times I'm calling it??


draw_fsel is called 7 times
4 times whenever copy_blocks, copy_items, copy_enemies, copy_lift is toggled
1 when copy is clicked and ft is filled
1 when move is clicked and ft is filled
1 when load is clicked and ft is filled


ft_bmp is:
declared in main
externed in pm.h
in zfs:
-drawn to screen
-destroyed at the very end
in draw_fsel:
-destroyed
-created
-cleared
-stretch_blitted onto


-----------
removed the dstroy at the end of zfs
no crash yet...

removing debug stuff...


---------------------------------------------
make do_fcopy adjust positions instead of deleting lifts
if a step is out of bounds
---------------------------------------------

adding the option to erase if out of bounds or move
item done

enemy main done...

lifts...
limits only apply to ul corner of lift??
its possible for most of the lift to be off screen,
as long as the ul corner is not

i'm gonna leave it like this for now

i'm going to set the default behavour to move for both...

make it so empty block in fsel don't show anything...done

25/01/18 06:10

back to group edit (or randomizer)



make a randomizer function
in zoom full screen
in a selection
randomize archwag x and y speeds..
done for all possible stuff,
need to make a way to access this from the level editor

page for each enemy type
right now the only ones that make sense are:
archwag, bouncer, cannon, trakbot, flapper

show how many of the item
show min and max
have slider for min and max

what about random level position too...done

make a set of tabbed pages for each thing in the select window

for now just make a page for cannon...

how big...
what to call it, group edit...

have different sections....

top one shows how many are in the group

section to randomize position
...

i want to use the same funtion as zfs

when in group edit mode, the menu buttons will be different...
i will keep the same:
selection info, map, selection drawing routines

sliders
base value
add random

buttons..

apply to:

cannon seek speed
cannon bullet speed
cannon extra hits to kill

bouncer seek speed

archwagon x
archwagon y
archwagon bullet speed


trakbot x
trakbot y
trakbot bullet speed

podzilla bullet speed


or:

apply to:
specific item | all items | no items
specific enemy | all enemies | no enemies

x and y position (for everything)

remove logging...done






working on levels...

new backup...

20180126



---------------------------------------------------------------
make a button to set color and shape for both door and linked door
or maybe make that the default behaviour..done
look for any doors with color zero and fix...done
---------------------------------------------------------------
27/01/18 08:11


---------------------------------------------------------------
sometimes mouse pointer gets changed and not changed back
added mouse pointer reset at start of edit_menu and zfs...done
---------------------------------------------------------------
27/01/18 08:14

---------------------------------------------------------------
why does selection window sometimes disappear and won't come back???
I think its when i'm messing with lots of lifts and copying in zfs
hard to reproduce...
did it with moving in zfs..no lifts involved
paste does it too...
clear does not
if i quit before the actual paste it still happens...
if comment out draw_fsel it still happens
pretty sure its something in save_selection(0)
in lifts clear, difference between declaration in main and extern in sel
why does compiler not catch this...
C:\Users\m\Desktop\pm_20180126\src\e_sel.cpp
extern int ft_ls[NUM_LIFTS][40][4];
C:\Users\m\Desktop\pm_20180126\src\zmain.cpp
int ft_ls[20][20][4];
---------------------------------------------------------------
done 27/01/18 09:15




---------------------------------------------------------------
is trakbot extra hard to shoot or is it my imagination??
all have 10 set

player when in single block opening in x axis
can have x from 22 to 37

lowest 1177 highest 1182

exact middle is 1180
so it looks like I can go from +2 to -3

how it the bullet done for up and down?

                        if (players[p].up)
                        {
                           pbullet[b][5] = -players[p].bullet_speed;
                           pbullet[b][2] = x - 5 + (players[p].left_right*10);
                        }
                        else if (players[p].down)
                        {
                           pbullet[b][5] = players[p].bullet_speed;
                           pbullet[b][2] = x - 5 + (players[p].left_right*10);
                        }

what are the exact numbers...

left = 1172 (8 less than center)
right = 1187 (7 more than center)

what if a i make x -4???


left = 1173 (7 less than center)
right = 1188 (8 more than center)


// do some cutom code...

                           if (players[p].left_right) pbullet[b][2] = x+4;
                           else pbullet[b][2] = x-3;

left = 1174 (6 less than center)
right = 1186 (6 more than center)

---------------------------------------------------------------
done 27/01/18 10:40





fix old switches


old blocks
red block -167
red switch 364 365 also 422 423


new blocks
172 green  745 746
173 red    777 778
174 blue   809 810
175 purple 841 842

did glt and removed all...
blanked shapes 167, 364, 365, 422, 423




----------------------------------------------
what is going on with archwagon

where is x speed realy set...

emove only uses 2

sliders uses 12 13 for x speed , y speed


12 uses 6 and 2...why???

can't seem to find another enemy that uses that
closest is flapper that use 6 for x accell

the only things that use 12 are block walker and archwag...

can't find any reason for it, i'm going to fix it...


make lev editor only care about 2
wait i get it......

its done like that because slider can't deal with negative numbers...

what the best way to fix...

actually use 6 for the speed in emove
make 6 always positive

then set 2 depending on direction..

what does PDE have?

standard 2
fast 3

what does glt tell me?

glt assures me that none have 0;;

use glt to set 2 from 6...done


make sure sliders is doing good...done

make emove use 6...al_fixed


-----------------------------------

all levels have been gone through

time for a backup....


20180128




find all the places I need to add back show_mouse(NULL) in editor...
test with ubuntu and e6410

lets start with object viewer...done and looks good
next it looks like sliders...done

now sometimes when i click on buttons...


draw_big good
show_big good
title_obj good
move obt with map....done
lift_viewer..already good

zfs???
paste selection...done

regular editor...seems good

getxy...done
getbox..done
getitem..done

went through the whole bitmap file...

done


in main editor can select block off right and lower edge of screen
when drag selecting...
show x,y when drag selecting...
done

don't show anything past right or lower edge when > 2000
mostly selection and status windows

where does initial positions of them get set???
at beginning of edit menu...al_fixed


make update clear entire screen...
this solves all my problems, but makes it slow and flashy

how about only clear at start on edit menu

then have extern lesw and lesh set.done
proc

acually after all that, all I needed to do was make
draw_item_info(int x,
not mess with the clip rect..
then I just set it at the start of edit menu...
no extern needed...

make it so that when show windows is chosen from menu
to reset the window pos if off screen
done....
29/01/18 06:54



29/01/18 12:25

testing on e6410

hard to see mouse on main editor
increase to 10



what if I do a new block flood fill...

need array f[100][100][5]

initially all set to 0;

get rb from click on level and l[100][100]

initial pos is set to 1
[0] = match

then look in all directions there

loop

search entire array for set blocks [0]

for each found look in all directions for match

if match, set and repeat loop


int x, y; // start pos
int rb = l[x][y]; //block to search for

int f[100][100];
// erase f
for (int a=0; a<99; a++)
   for (int b=0; b<99; b++)
      f[a][b] = 0;

f[x][y] = 1; // set initial block

//loop start

int found;
do
{
   found = 0;
   for (int a=0; a<99; a++)
      for (int b=0; b<99; b++)
         if (f[a][b]) // iterate already marked
         {
            if ((a >  0) && (l[a-1][b]) == rb) // look left
            {
               if (f[a-1][b] == 0) found = 1; // found unmarked
               f[a-1][b] = 1; // mark it
            }
            if ((b >  0) && (l[a][b-1]) == rb) // look up
            {
               if (f[a][b-1] == 0) found = 1; // found unmarked
               f[a][b-1] = 1; // mark it
            }
            if ((a < 99) && (l[a+1][b]) == rb) // look right
            {
               if (f[a+1][b] == 0) found = 1; // found unmarked
               f[a+1][b] = 1; // mark it
            }
            if ((b < 99) && (l[a][b+1]) == rb) // look down
            {
               if (f[a][b+1] == 0) found = 1; // found unmarked
               f[a][b+1] = 1; // mark it
            }

         }
} while (found);

--------------------------------------------
finished and tested new block floodfill
erased old...
29/01/18 20:29




-----------------------------------------------------------------
dont allow cloner to create objects on solid blocks
test to see if it can happen
-----------------------------------------------------------------
make a function:
int is_block_empty(int x, int y, int block, int item, int enemy)
use it in sel random and when cloner creates....
made the cloner craetes version only check for blocks
done..30/01/18 05:53




---------------------------------------------------------------
cant turn off map if you can't cycle all the modes, like when stuck in lower left corner
---------------------------------------------------------------
fixed...30/01/18 06:11





project options:
do not create console window:
default was no, i changed it to yes and no command prompt winow is created when run...
at start, executable size is 2418

turn off generate profiling info..2402
turn off generate debugging info..2022
turn on strip executable..648



when making a release...
remove:
everything in o directory
gmon.out
Makefile.win
pm.layout
pm_private.h
pm_private.rc


298 files 9M

added to winrar and made a rar file 1.94M

ubuntu cannot open this rar

ubuntu makes a tar.gz 2.3M

removed dll, exe and dev from linux version...
now tar.gz is 1.7M

windows lists
298 files 26 folders

linux lists
320 items
???

whatever...
pmlin is 788K




---------------------

01/02/18 08:10

making a nice logo of my initials using spline



i've got it setup on a 200 by 200 grid array

i want to be able to resize it easily for display

i think i won;t touch the original array, ill just make a scaled
array for drawing...

that way I wont lose anything by converting...

if i set up the array so that the center is 0,0 it should make scaling simple...

this has all been doen, and I have spent many hours on it..


what do I need to show it in the game?


initialize it with:
   seed_mdw();
   fill_mdw();

draw it with:
void draw_mdw(ALLEGRO_BITMAP *b, int x, int y, float x_scale, float y_scale, int line_thickness)

it uses global int array:
int points[10][8];


lets put in on the main screen, statically...

in main decalre the array


done


have I really compiled 13,707 time since last release??


20180202 "5.10.1.13707"
20180115 "5.10.1.12151"
20171230 "5.10.1.9621"
20171215 "5.10.1.5641"
20171202 "5.10.1.3842"
20171118 "5.10.1.2047"
20171106 "5.10.1.476"
20170301 "5.10.1.424"
20170108 "5.10.1.422"

20140315 "5.10.1.408"

20100403 "5.10.1.265"



20100227 "5.9.6.3806"
20100208 "5.9.6.3404"
20100131 "5.9.6.3307"

20100117 "5.9.1.3186"
20100116 "5.9.1.3148"
20100115 "5.9.1.3128"
20100110 "5.9.1.2905"

20100107 "5.1.1.2626"
20100105 "5.1.1.2491"
20100102 "5.1.1.2342"
20091215 "5.1.1.750
20091209 "5.1.1.55"






---------------
20180202

signed up for a new website hosting at 000Webhost


mweiss001@gmail.com
zaiden
site\
purplemartians

https://purplemartians.000webhostapp.com/


kill the old angefire...its embarrasing...done

edit



make the video thing in the game....done

made a function:
void screen_shot_for_video(void)
{
   extern int ssfnsn; // screen shot file name sequence number
   ALLEGRO_BITMAP *ss_bmp;
   PALETTE ss_pal;
   get_palette(ss_pal);
   ss_bmp = create_sub_bitmap(screen, 0, 0, SCREEN_W, SCREEN_H);
   char filename[80];
   sprintf(filename, "screenshots\\frame%05d.bmp", ssfnsn);
   save_bitmap(filename, ss_bmp, ss_pal);
   al_destroy_bitmap(ss_bmp);
   ssfnsn++;
}

made a command line arg -v

         // run saved game file and record video
         if (strcmp(argument_array[1],"-v") == 0 )
         {
            load_gm(argument_array[2]);
            printf("running game file:%s\n", argument_array[2]);
            players[0].control_method = 1;
            start_mode = 2; // load level and start, but skip game array erasing
            game_exit = 0;
            making_video = 1;


            char sys_cmd[500];
            sprintf(sys_cmd, "del screenshots\\frame*.*");
            printf("%s\n",sys_cmd);
            system(sys_cmd);

            sprintf(sys_cmd, "del out.mp4");
            printf("%s\n",sys_cmd);
            system(sys_cmd);

            pm_main();

            sprintf(sys_cmd, "screenshots\\ffmpeg.exe -framerate 40 -start_number 000 -i \"screenshots\\frame%%05d.bmp\" -c:v h264 -r 40 -pix_fmt yuv420p out.mp4");
            printf("%s\n",sys_cmd);
            system(sys_cmd);



            exit(0);
         }

in draw_top_display():

         if (making_video)
         {
            screen_shot_for_video();
            printf("Time:[%d%%]\n", passcount*100/last_pc);

            sprintf(msg, "Recording Video From Saved Game  ");
            textout_centre_ex(scrn_buffer, font, msg, SCREEN_W/2, SCREEN_H/2, 15, 0);

            sprintf(msg, "Time:[%d%%] ", passcount*100/last_pc);
            textout_centre_ex(scrn_buffer, font, msg, SCREEN_W/2, SCREEN_H/2+8, 15, 0);

         }

in proc_frame_delay():

   if (making_video)
   {
      draw_frame = 1;
      timer_passcount = passcount;
   }

it can take a long time...
so ill just save a game then use another computer to render the video...

then scale can be changed when the game is recording
the screen size determines the video size



trying a 200 sec game...
200 x 40 = 8000 frames!
started at 4:43 screen 640 on e6410
5:12 play done 8583 frames (2.5 G)
5:14 video done... (26M)
"recording" on video

try again
started at 5:19 screen 800 on e6410
6:10 play done 8583 frames (3.9 G)
6:13 video done...(23M)


--------------
i think the save video thing is done...
probably wont work in linux...



---------------------


make draw_an pass through
so I can call it in a loop

done


now I need a good place to set position and scale...
how about in screen change...

I need:
mdw_logo_x
mdw_logo_y
mdw_logo_scale

did all this...

now its set in set_map_var()
and looks good in all screen modes..



next i made a large mdw_an2 i will use for splash screen

then i'll need one to link 2 to the menu one...

at the very start of the game....
right after the screen is created and we know the screen size...
( i can probably do it in setmapvar)

i need to set the logo vars for splash, link, and menu

then at the start of game menu, i'll do the splash screen and link...


this is all looking good...



now make the main screen, show purple martians then my name....


make the whole splash screen skippable with a key press



can't make the link line up...

make both lb and sb have the same extra padding...
then make them draw_sprite on the screen with a screen buffer...

then make them line up...


made them both size + 20
lb same
sb smaller

fix sb


why all this bullshit with temp bitmaps?

use a screen buffer...

do it with splash first...

i should alreay have one...

done..now there is no splash bitmap ls

can i do the same for map...

menu runs the show...
make menu use screen buffer...

call these from menu:

      draw_level();
      frame_and_title();

edit them to draw on screen_buffer

now only menu calls draw_level and frame_and title
they draw on passed ALLEGRO_BITMAP, which is scrn_buffer
also changed
item_data and enemy_data to draw on passed ALLEGRO_BITMAP
looking good...


the move part works properly...

the problem is that the y_scale is too big at the end

the y scale does not change from 767 to end

dual flip is from 512-768

y = is ran by cos

320-448 (freeze)
xinc stays at 1.0
yinc stays at 1.0

449-512 (align for dual flip)
xinc goes from 1.0 to 0
yinc stays at 1.0


512-576 (dual flip 1st 1/4)
xinc goes from 0 to 1
yinc goes from 1 to 0


576-640 (dual flip 2nd 1/4)
xinc goes from 1 to 0
yinc goes from 0 to -1


640-704 (dual flip 3rd 1/4)
xinc goes from 0 to -1
yinc goes from -1 to 0


704-768 (dual flip 4th 1/4)
xinc goes from -1 to 0
yinc goes from 0 to 1

768-832 (align for map)
xinc goes from 0 to 1
yinc stays at 1


on the last step, yinc still needs to have the scale applied
even though the trig is not applied

its all good now....


now make splash quitable at any time with keypress...done


the mode on splash that spins back to prepare for double flip
looks weird.. the x comes out the immediately goes back the same way...

- i could make it go 270 degrees ...done

am I finally done with splash screen???

where is all the code?

in main and externed in pm.h

ALLEGRO_BITMAP *sb; // mdw logo creator
int mdw_an_seq = 0; // mdw animation sequence number
int points[10][8]; // for mdw logo
int mdw_map_logo_x = 100;
int mdw_map_logo_y = 140;
int mdw_map_logo_th = 1;
float mdw_map_logo_scale = .3;

float mdw_splash_logo_x;
float mdw_splash_logo_y;
int mdw_splash_logo_th;
float mdw_splash_logo_scale;


float mdw_logo_scale_dec;
float mdw_logo_x_dec;
float mdw_logo_y_dec;

setup in set_map_var:

   // splash screen logo position
   mdw_splash_logo_x = SCREEN_W/2;
   mdw_splash_logo_y = SCREEN_H/2;

   // splash screen logo size
   int min_d = SCREEN_H;  // find miniumum dimension
   if (SCREEN_H < SCREEN_W) min_d = SCREEN_W;
   mdw_splash_logo_scale = (float) min_d / 800; // 400 is the exact size, make it bigger for padding
   mdw_splash_logo_th = 2;

   // map screen logo position and size
   int sp = menu_map_x - BORDER_WIDTH;    // how much space do I have between the map and the screen edge?
   mdw_map_logo_scale = (float) sp / 500; // 400 is the exact size, make it bigger for padding
   mdw_map_logo_th = mdw_splash_logo_th;  // same thickness as splash
   mdw_map_logo_x = BORDER_WIDTH + sp/2;
   mdw_map_logo_y = menu_map_y + (int) (mdw_map_logo_scale * 200); // align top of logo with top of map

   // this is the link from splash to map
   mdw_logo_scale_dec = (mdw_splash_logo_scale - mdw_map_logo_scale) / 320;
   mdw_logo_x_dec = (mdw_splash_logo_x - (float)mdw_map_logo_x) / 320;
   mdw_logo_y_dec = (mdw_splash_logo_y - (float)mdw_map_logo_y) / 320;


in z_menu one line call:  mdw_an();


in main, new fucntion: and one line call:
void splash_screen(void)
{
   char msg2[80];
   sprintf(msg, "Purple");
   sprintf(msg2, "Martians!");

   int ms = SCREEN_W/(16*8); // large text size
   int y_shift = 0;
   int y_co = ms*3; // center offset

   int quit = 0;


   if (!quit)
      for (float i=ms; i>.6; i*= .8)
      {
         int col = 8 + (ms - (int)i) * 16;
         y_shift -= (int)(i * 9);

         //printf("%f %d %d\n",i, col, y_shift);
         rtextout_centre(scrn_buffer, msg, SCREEN_W/2, SCREEN_H/2 + y_shift + y_co, col, i, 0);
         rtextout_centre(scrn_buffer, msg2, SCREEN_W/2, SCREEN_H/2 - y_shift - y_co, col, i, 0);
         blit(scrn_buffer, screen, 0,0,0,0, SCREEN_W, SCREEN_H);
         al_rest(0.1);
         if (keypressed())
         {
            quit = 1;
            i = 1000;
         }
      }

   if (!quit)
      for (int i=0; i<50; i++)
      {
         al_rest(0.01);
         if (keypressed())
         {
            quit = 1;
            i = 1000;
         }
      }

   sprintf(msg, "created by:");
   rtextout_centre(scrn_buffer, msg, SCREEN_W/2, SCREEN_H/2, 15, 2, 0);
   blit(scrn_buffer, screen, 0,0,0,0, SCREEN_W, SCREEN_H);

   if (!quit)
      for (int i=0; i<160; i++)
      {
         al_rest(0.01);
         if (keypressed())
         {
            quit = 1;
            i = 1000;
         }
      }

   while (!quit)
   {
      clear(scrn_buffer);
      quit = mdw_an2();
      blit(scrn_buffer, screen, 0,0,0,0, SCREEN_W, SCREEN_H);
      al_rest(0.01);
      if (keypressed()) quit = 1;
   }
   mdw_an_seq = 0;
}


void game_menu(void)
{
   splash_screen();





in initial setup:

   seed_mdw();  // for mdw logo
   fill_mdw();


in fnx:

lots...

void mdw_an(void) is for the map animation
int mdw_an2(void) is for the splash animation


void seed_mdw(void)
hard coded values for the first outer and inner arm and the 'D'

void fill_mdw(void)
sets the rest of the arms from the initial seed


void draw_mdw(ALLEGRO_BITMAP *b, int x, int y, float x_scale, float y_scale, int line_thickness)
this is used by both map and splash to draw all the splines that make the logo

void mfspline(ALLEGRO_BITMAP *b, int *par, int col, int thickness)
called by draw_mdw() to do each spline
-wrapper function for mspline
- progressive draw splines with less thickness and shifts color


void mspline(ALLEGRO_BITMAP *b, int *par, int col, int thickness)
my version of spline with thickness
- which in turn is a wrapper function for spline
- uses thickness to make a thinker spline
- 1 single line
- 2 shifts all values in a 3x3 array and draws the spline 9 time
- 3 shifts all values in a 5x5 array and draws the spline 15 times


-------------

to adjust the spline...
run spline_adjust

copy the numbers and code them into seed_mdw();


yes, I am finally done with logo....

that took about 20 hours over three days...

looks good though...
04/02/18 09:57




make a backup...

20180204...done

re-arrange levels...done 1-40


move doors and keys to level 1...
241



now I have a solid 40 levels from 1 to 40...


when quitting level editor
splash screen runs again...

it only happen with command line
when game starts before menu is run for the first time


make a global int to disable it done


testing netplay...seems broken???


04/02/18 19:00
---------------------------------------------------
ubuntu server level 21 with lift at start
joined with i990 as clienta quickly lost sync, with no errors...


04/02/18 19:05
-----------------------------------------
ubuntu server level 4 with bombs
joined with i990 as client lost sync, with no errors...


04/02/18 19:09
-----------------------------------------
ubuntu server level 12 with no bombs or lifts
joined with i990 as client lost sync, with no errors...


04/02/18 19:13
-----------------------------------------
i990 server level 12 with no bombs or lifts
joined with ubuntu as client lost sync, with 1 client sync error on server


04/02/18 19:13
-----------------------------------------
i990 server on level 12
client e6410 lost sync -  6 errors on client...

changed
#define CONTROL_LEAD_FRAMES
to 4 from 2
left mode CHANNEL



04/02/18 19:34
---------------------------------------
i990 server on level 12 client e6410 no lost sync -  no errors
ran for long time
when client exited, client was left behind but server went to next level
also got a weird expired item, with expired starburst shape that I could carry around and throw...


04/02/18 19:42
---------------------------------------
i990 server on level 4 client e6410 no lost sync -  no errors
ran for long time
when client exited, client was left behind but server went to next level
cannons seem like they don;t know which player to face or seek


04/02/18 19:55
---------------------------------------
i990 server on level 21 client e6410 no lost sync -  no errors
ran for long time
when client exited, client was left behind but server went to next level


lets try ubuntu again...


04/02/18 20:12
---------------------------------------------------
4230-3 server i990 client level 21
lost sync almost immed, no errors


04/02/18 20:16
---------------------------------------------------
4230-3 server i990 client level 12 cloner
lost sync, no errors

does cloner use floats???
should I also use 4.4.2 on win version??
lets see what it breaks...


also re-enable logging and see if anything is missed
done..still bad sync

05/02/18 04:05
--------------------------------
re-enable logging
i990 server l12 e6410 client
lost sync....


revert linker options...
turn on generate profiling info
turn on generate debugging info
turn off strip executable
done

control is run many times per passcount...is that bad???
commented out the code in proc frame delay that does that...


add packet to test if sync is lost
must come from server, beacuse server is ahead
packet should contain players x and y pos, life and num enemies
done

wont fail on win...
set clf to 2
even though i got 4 or 5 client sync errors, syck was good...
got some fails...


going back to test ubuntu...
server i990 client e4230-3 l:12

syck failed once when client died...then ran good for another 400 frame
then syck failed again...px py ne good, life bad....


05/02/18 06:29
2nd time syck failed was right after ubuntu client death
life and ne different...

05/02/18 06:32
3rd time no death ne diff...

05/02/18 06:36
4th time ne dif then life

WTF???



allgero 4.4.2

removed old dev pack
installed new dev pack


old .dll alleg42.dll
new .dll allegro-4.4.2-mt.dll

old linker line: "C:\Dev-Cpp/lib/liballeg.a"
new linker line: "C:\Dev-Cpp/lib/liballegro-4.4.2-mt.a"



old windows version:
------------------
OS detected Windows Vista [ver:6.1]
Allegro 4.2.2, MinGW32


new windows version:
------------------
OS detected [ver:6.1]
Allegro 4.4.2, MinGW32

ubuntu version:
------------------
OS detected Linux [ver:4.13]
Allegro 4.4.2, Unix


test again....

05/02/18 06:58
server i990 client e4230-3 l:12

failed when client shot a bunch and life different
also x different, probably due to bullet recoil...


well I think I know where in the code the problem is:
collision detection


add players[p].num_hits to syck and it failed
at the same time as num_enemy did...

collision checking is what is bad....

05/02/18 07:17

work time


backup time

20180205


05/02/18 12:18


made test level 100 with bouncers
server i990 client e4230-3

killed many for 5000 frames no error

try same with archwagon error



ran again on level 12
got to pc 6000 before client error....
this time it was life


allegrp 4.4.2

makes the mouse hide sometimes



here is my awesome plan...

i can find the bugs with enough logging

i could run a netgame until i get the error then save the game file...

playing it back on win or lin will reproduce the error...


try it...
server i990 client e4230-3 lev 12
had to play for a long time to get syck error 7400

last_level_20180205-173315-lev12.gm

run this and between 4400 and 4500 ne will differ

rename it to tst1



to make slashes work in both windows and linux...
use '/' not '\'

windows will take either
linux won't

don't need to escape either...



al_fixed save and load game for linux

now tst1.gm runs on both...only on linux num enemy ends at 61 and win 60

now find in more detail where they diverge

make play stop at a certain passcount...

test 4450
win 72 t111
lin 72 t110

wtf, whay are the times different??


test 4475
win 72 t111
lin 72 t111


test 4500
win 72 t111
lin 72 t110


according to my data...
on frame 4488...
lin 72-71
win 72-70


find out which enemies it was...

on frame 4487
win 13 and 22 hit
lin 13 only hit

-------win
->13 2 absbx:1609 - EX:1599 = [10] <14> absby:1141 - EY:1144 = [3] <8>
->22 1 absbx:1553 - EX:1545 = [8] <14> absby:1105 - EY:1112 = [7] <8>

-------li
->13 2 absbx:1609 - EX:1599 = [10] <14> absby:1141 - EY:1144 = [3] <8>
->22 1 absbx:1553 - EX:1126 = [427] <14> absby:1105 - EY:977 = [128] <8>

finally i am getting somewhere....

EYint and EXint are what is different...

next follow enemy 22 back in time and find out when it changed

4300
4400 completely different...


????

how can I track this enemy to find out when they differ




it differs at 3200

looks it dies at 3000 because 3100 is missing


dies on frame 3078


[3073] 3 -->EX:573   EY:691
[3074] 3 -->EX:577   EY:694
[3075] 3 -->EX:581   EY:697
[3076] 3 -->EX:584   EY:700
[3077] 3 -->EX:588   EY:703
[3078] 99 -->EX:588   EY:703
[3079] 99 -->EX:588   EY:703
[3080] 99 -->EX:588   EY:703
[3081] 99 -->EX:588   EY:703
[3082] 99 -->EX:588   EY:703
[3083] 99 -->EX:588   EY:703
[3084] 99 -->EX:588   EY:703
[3085] 99 -->EX:588   EY:703
[3086] 99 -->EX:588   EY:703
[3087] 99 -->EX:588   EY:703
[3088] 99 -->EX:588   EY:703
[3089] 99 -->EX:588   EY:703
[3090] 99 -->EX:588   EY:703
[3091] 99 -->EX:588   EY:703
[3092] 99 -->EX:588   EY:703
[3093] 99 -->EX:588   EY:703
[3094] 99 -->EX:588   EY:703
[3095] 99 -->EX:588   EY:703
[3096] 99 -->EX:588   EY:703
[3097] 99 -->EX:588   EY:703
[3098] 99 -->EX:588   EY:703
[3099] 0 -->EX:588   EY:703
[3100] 0 -->EX:588   EY:703
[3101] 0 -->EX:588   EY:703
[3102] 0 -->EX:588   EY:703
[3103] 0 -->EX:588   EY:703
[3104] 0 -->EX:588   EY:703
[3105] 0 -->EX:588   EY:703
[3106] 0 -->EX:588   EY:703
[3107] 0 -->EX:588   EY:703
[3108] 0 -->EX:588   EY:703
[3109] 0 -->EX:588   EY:703
[3110] 0 -->EX:588   EY:703
[3111] 3 -->EX:642   EY:865
[3112] 3 -->EX:646   EY:867
[3113] 3 -->EX:649   EY:870
[3114] 3 -->EX:652   EY:872
[3115] 3 -->EX:656   EY:875


comes back on frame 3111


lin...
dies on frame 3078

comes back on frame 3111
but with dif x y

567 865


looks like the problem is with a newly created enemy

on frame 3111 in cloner enemy 23 is copied to 22
same on both...

enemy 23 is different on lin
lin x510 y682
win x578 y682









i should make editor use screen buffer

with 4.4.2 drawing primitive on screen are slow
noticebale with buttons, sliders, graphical level select...

can I redo gls to use screen buffer???
just as a test...done.. seems faster

can I redo object viewer like that???
not so easy...but worth it...
will fix mouse and button flickering

actually do editor first...

redoing draw_item_info
change all to screen_buffer

draw_item_shape
draw_enemy_shape
pass bmp

i have redone all of edit menu to use scrn_buffer
and it looks good....


next up is zoom full screen...
then lift viewer...
then obt viewer...

zoom full screen is done...
mouse sometime dissapears...al_fixed



now the big ones...
lift viewer and obj viewer..


title_obj...done
crosshairs...and nodb done

lift viewer basic is done...

lets move on to obt..done..

except for bug fixes, i think its done...
main edit, zoom full screen, lift viewer, obt viewer
all use screen buffer
dont need Redraw
draw every frame
msg creator bad...al_fixed...
looking real good...

i should test it on win 10 and see if the rect thing is good....

07/02/18 05:31

viewers have right edge cut off when SCREEN_W > 2000
where is clip set...just before and after call to view_obj
done
07/02/18 05:40




--------------------------------
how am i going to check syck

make a bigger syck packet??


how about one that has 100 enemies...

type = 1 btye
x, y = 8

900 bytes

what is packet_size??

1024??

actually skipped the type...just x and y


looks like its only archwag...

bouncer no cloner no errors
bouncer in cloner no errors
trakbot in cloner failed


cannon good
bouncer good
flapper good

trakbot bad
archwag bad



07/02/18 17:42

I think i foundthe culprit...
fixmul gives different results from linux to windows



what do i do with 8 and 9

set from 1.6 to 0


8 is fall
>0 means in fall
max is 1.6
dec by .05
yinc = 8 * 3



9 is jump
>0 means in jump
max is 1.6
dec by .05




replace with a single int...

jf (jump_fall)

scale by 100

jump = -160
inc by 5 (gravity)
max = 160


archwagon has been rewritten and causes no synce errors now!!!
08/02/18 04:11



moving on to trakbot
when falling bad sync

uses Efi[EN][8] for  falling


Efi[EN][8] += al_ftofix(.015);                                 // add acceleration to fsll
if (Efi[EN][8] > al_ftofix(.8))  Efi[EN][8] = al_ftofix(.8);      // terminal velocity
al_fixed fall_yinc = fmul(Efi[EN][8], Efi[EN][3]) * 4;         // fall_yinc = fall * yinc * 4


.8 * 4 = 3.2

new...

Ei[EN][5]

max fall = 160

inc = 5


fixed trakbot sync....

----------------------------

what else can I check...

block walker has 2 mentions..fixed

flapper has 1.. fixed...


i would like to put a check for items, lifts and all players
like syck


enemy
x,y = 8 * 100 = 800

all players would be (8*8) 64 bytes

all lifts would be (8*40) 320 bytes
all items would be (500 * 8) =  4000 bytes

we can do this at different frames

i can get enemies 800 lift 320 and player 64 in one packet

items will take more than one packet

like 4
125 * 8 = 1000

or 3...
160 1280
160 1280
140 1120


-----------------
new syck packet is:
passcount = 3
players PX, PY, LIFE = 12 * 8 = 96
enemies x y = 8 * 100 = 800
lifts x y = 8 * 40 = 320
----
1219 bytes


libnet set a max or 1024 and I will respect it


new syck packet is:
passcount = 3
players PX, PY, LIFE = 12 * 8 = 96
enemies x y = 8 * 100 = 800
-------
899 bytes



make different types of syck packets

int syck_type

1 = player
2 = enemies
3 = lifts

4 = items 0-124
5 = items 125-249
6 = items 250-374
7 = items 375-499

i have all these checks going 1 per frame and none fail....


lets try a more complicated level...

33 for lifts...no problems

21 for rockets..good

clf from 4 to 3...

some syck are too late to compare, but no syck err

clf from 3 to 2...

server said 1 client sync error, but no syck error!!!
is that the type of error that doesn't matter??
yes, clients input was late to server and was discarded..


damn... this is great...

08/02/18 06:58


08/02/18 16:36
snow day at work

finished help file
and description for allegro.cc
put some logos in the help screens...!


------------------------------------------------------------------------------
when deleting last obt with obt viewer need to redraw...
------------------------------------------------------------------------------
added draw_big(1); in delete code...
08/02/18 16:40



------------------------------------------------------------------------------
in netplay, cannons seem like they don't know which player to face or seek
------------------------------------------------------------------------------
who uses find_closest_player()?
flapper for seek
block walker for follow mode
trakbot for seek while falling
podzilla bullet
podzilla draw rotation
cannon bullet
archwagon follow mode

set_seek(EN)
to find player to seek to
used by cannon and bouncer
i think i al_fixed it, how to test...?
fixed 09/02/18 05:02


------------------------------------------------------------------------------
when client level done, client is left behind but server goes to next level
------------------------------------------------------------------------------
the complicated process of level done:
- in item collision with exit extern int level done is set.
- in proc_controllers()
      if (!ima_client) // server and local only
      {
         extern int level_done;
         if (level_done) add_game_move(passcount, 6, 0, 0); // insert level done into game move
      }

- in proc_game_move(void)  proc_level_done() is called


the game move never gets to the client

what if I cheat and let the client put it in his own array?
i'm not seeing how this could cause problems...
put it in with no clf added... see what happens
that seems to work..game moves are identical
09/02/18 05:33



---------------------------------------------------------------
win 10 takes a long time to load sprit..
added progress bar...not sure if that will makes things worse...
---------------------------------------------------------------
09/02/18 09:49

---------------------------------------------------------------
when player are all in a group a bullet hits them all
fixed by breaking out of loop for e and p bullets player detection.
---------------------------------------------------------------
09/02/18 10:06




---------------------------------------------------------------
----- Add to cfg file  -----------------------------
turn logging off...
logging..done
turn off saving of every game...
auto_game_save..done
splash screen..done
---------------------------------------------------------------
09/02/18 10:47



---------------------------------------------------------------
removed with  global define RELEASE

- logging
comment out in pm.h

- bitmap (keep)
- block
- pde
- glt
- lev viewer


make a global define RELEASE
removed:
-t, -u, -x source copy command line
-g test debug command line
-v commnd line video
F10 debug overlay
---------------------------------------------------------------
done


---------------------------------------------------------------
show scale factor somehow...done
---------------------------------------------------------------
09/02/18 11:17


---------------------------------------------------------------
log syck...done... need to test...
---------------------------------------------------------------
09/02/18 11:33


---------------------------------------------------------------
add to cfg...
control lead frames
syck frequency
done, need to test
---------------------------------------------------------------
09/02/18 11:47


fixed one more syck error with cannons using fmul for size inc...
...fmul...not fixmul...??? wtf
---------------------------------------------------------------
got syck error on ubuntu
enemy type 6 x bad...al_fixed
when multiple hit cannon scaled using fmul... not fixmul, fmul
---------------------------------------------------------------
09/02/18 20:25


---------------------------------------------------------------
when drawing box on editor, erase maps
redraw screen and scroll...done
---------------------------------------------------------------

---------------------------------------------------------------
when moving slider, entire screen is redraw...
refactored slider again, now move uses temp bitmap, nice...

i would like the old mouse pointer to not be drawn when adjusting slider
the problem is that I draw it on the screen buffer, so that it doesn't flicker as much

the only way I can see around it is to have 2 screen buffers

i found a better way...use global Redraw

if mouse on slider bar Redraw = 2 and slider takes care of drawing the mouse

if slider has been moved Redraw = 1 and viewer skips drawing screen buffer till next frame
so we don't see the old slider position

this works great for obj and lift viewer
---------------------------------------------------------------
10/02/18 07:24



---------------------------------------------------------------
getxy...doesn't clear screen
---------------------------------------------------------------
al_fixed 10/02/18 07:41


---------------------------------------------------------------
cloner set dest...
---------------------------------------------------------------
al_fixed 10/02/18 07:42




---------------------------------------------------------------
getbox...
doesn't clear screen nicely...
---------------------------------------------------------------
al_fixed 10/02/18 08:11



---------------------------------------------------------------
convert getbox to use screen_buffer
---------------------------------------------------------------
done 10/02/18 08:11


---------------------------------------------------------------
convert getxy to use screen_buffer
---------------------------------------------------------------
done 10/02/18 08:58


---------------------------------------------------------------
why is podzilla creator trigger box blank???
cloner also...al_fixed
---------------------------------------------------------------




---------------------------------------------------------------
convert getitem to use screen buffer
---------------------------------------------------------------
done 10/02/18 09:51

---------------------------------------------------------------
cloner creator show progress.. leave in cloner viewer
---------------------------------------------------------------
done...10/02/18 10:47

---------------------------------------------------------------
in editor mouse sometime disspears, check show draw item cursor
---------------------------------------------------------------
made a better method of showing the draw item cursor
done 10/02/18 11:27



---------------------------------------------------------------
obt map mover draws off map with extras
can't see message when dragging it....
---------------------------------------------------------------
done 10/02/18 12:15



test all this shit on ubuntu...looks good

how about 10...good

xp...good

seems slow, what if i set rest to 20...same
try 0, maybe a little better

what has these?

patched in mouse_loop_pause:
edit menu
obt viewer
lift viewer
zfs


set to 0 and try...
had to add pause to process scrolledge
good on 7
good on ubu
good on 10...


making a backup and testing and recording netplay
10/02/18 13:52

20180210


20180210-142020-lev22
ran level 22 for 50,000 frames
8 players 5 computers
xp had some syck errors at 10,000
player x
enemy 6 x and y
enemy 3 y
I joined again with and had no problems...


------------------------

well i played some muliplayer with the kids and found a lot of
syck errors....

windows as well as ubuntu...
actually the best performers were i990 as server and ubuntu as client 1


I am thinking of a few possible solutions...

- actually fix the client data when syck finds it bad

- do a complete set of data with syck and compress it...

- in all the muliplications that cause errors, do some sort of rounding
that will leave the errors in the part that got rounded



lz4  can i use it???


looks good....


it want to compress a char..a bunch of bytes...
how do i stuff all my data in a structure like that?
like ints mostly...
kind of like how i stuff them into a packet?? duh...


make a large char

like char upack[65536]

stuff shit into it

lets go with everything...


p[8] the entire player struct
player = 292
players = 2336



40000 - 10000 ints l[100][100]

12800 - 3200 ints Ei[100][32]
 6400 - 1600 al_fixed Efi[100][16]

32000 - 8000 ints item[500][16]
 8000 - 2000 al_fixed itemf[500][4]

  640 -  160 al_fixed 40 lifts just the 4 al_fixed

-------------
just a rough extimate so far

102,000 bytes

what do you think it will compress to...

cant wait to find out

what else need to be put in...

num_enemies..redundant
LIFE..redundant

can't think of anything else...

lets try stuffing enemy data into a string and compressing...
need to load a level first...

lev 39 has 98 enemies


how to i get lz4 into my code...

i got version 1.8.1 for win64

#include "lz4.h"

copied lz4.h to C:\Dev-Cpp\include

copied liblz4.lib to C:\Dev-Cpp\lib

copied liblz4.so.1.8.1.dll to pm main folder


added C:\Dev-Cpp\lib\liblz4.lib to linker line in project

still compiles...

lets try to use it...

get linker error...

pretty sure i need a library in .a format


how about zlib....

looks more wide spread



devpack for zlib 1.2.8 generic not i686 version...


installed dev-pak


in dev-cpp/lib

i had these already:
libzlib-1.2.5.static-mt-a

now I also have:
libz.a
libz.dll.a

and zlib.h in include...


------------
I compressed 12800 bytes from Ei int 227 bytes
using, BEST_COMPRESSION


char str[] = "memmove can be very useful......";
  memmove (str+20,str+15,11);
  puts (str);
  return 0;

now use mem_move to make a longer one...

  CHUNK!!
players                 size 2336       offset 0
int Ei[100][32]         size 12800      offset 2336
al_fixed Efi[100][16]      size 6400       offset 15136
int item[500][16]       size 32000      offset 21536
al_fixed item[500][4]      size 8000       offset 53536
lifts                   size 4000       offset 61536
int l[100][100]         size 40000      offset 65536
players and buf are the same
Ei and buf are the same
Efi and buf are the same
item and buf are the same
itemf and buf are the same
lifts and buf are the same
l and buf are the same
Compressed size is: 5045
Uncompressed size is: 105536
Ratio: 5045 105536 4.780359


this is awsome compression 4.7%

however...5K will not fit in one packet...

and i assume it will be worse when game is running....

i get from 3.78 to 5.48
still way to big...

what can I leave out???


----------------------------------

ok lets think....

how can i split it up among more than 1 packet
kind of like what I already do...



what can fit in 1 packet?

with compression...

players and lifts..
raw 6336
comp 141


l
raw 40000
comp 1300 too big


itemf
8000
900

item
32000
1800


Ei
12800
500






method to split buf among packets

size

size/1000

send with seq num and num bytes


packet type CHNK

int id // CHNK ID
int pid // packet id
int start byte
int end byte
int end byte for this chnk.


8600 bytes

at passcount 200

CHNK id passcount
number of peices in this CHNK
number of this piece
start byte
end byte


server will send all in one frame

client will need to re-assemble

server:

gets the size of the chunk and passcount

divide by 1000 to find how many packet are needed

loops that many times

makes a packet with some data from memove

sets

packet type CHNK
int passcount
int seq
int max seq
int start byte
int end byte
data....



client

rx's packets and contructs chunk

if passcount expires erase all
keeps track of how many pieces it has...
lets say max 16 for now

int chnk_pieces[16];
int last_piece;
int chnk_passcount; // only se

when any piece arrives that has a newer passcount than one in the array,
replace the one in the array.

check to see if complete...
if all pieces in the array have the same id (passcount)
and all of them are there, up to the last piece
and the passcount is less than the current passcount
put them in the buffer and decompress


always seems to come 1 passcount too late on client

if i read more than once per frame it seems to get there on time...
not with many packets...

the other option is to make the client wait...

all the packets seem to come on the same frame...

set clf to 10 just made them all late by 2 frames...

lets go about reassembling them... done


maybe I shouldn't make everything between players the exact same...

292 - 22*4 = 204

only use first 204 of each player


old 2336 / 8 = 292

292 - 88 = 204

204 * 8 = 1632

88 * 8 = 704

105536 - 704 = 104832

and all my offsets are fucked

what if i put player last...

no i can do this...



11/02/18 15:53
it all seems to work


I got a syck check error
about an item type 2 with bad y
but then chnk al_fixed it!!



now I can make chnk test everything and let me know if it fixes anything

or i could only use chnk if syck fails

get client to request chnk...

now that chnk works so good, it could replace chase and sync...

------------------------
i cant belive it that in one session..10 hours or so...
-i researched compression
-started with lz4 but then switched to zlib
-figured out how to use memcpy to copy arrays to binary blocks
-compress the entire game state
-break it up into 1K chucks for packets
-send to clients and have clients re-assemble
-decompress and blast data back into clients arrays



lets try it on all but ubuntu
sudo apt-get install lib32z1-dev
link with -lz


I want chnk to check before erasing data and log what it finds...



-------------
ran a long game
133700 frames
server died
but all was syncing good up until end

133700 frames / 40 = 3342.5 sec / 60 = 55 minutes

--------------

make everytime I declare ALLEGRO_BITMAP to also initialize to NULL

i fucked something up hard....




maybe I'm doing player wrong
maybe I need to get the whole structure
I don't think I can expect the struct to always be in the same order....








optimization tips for me.........

al_fixed and ints take up the same space, why do I bother keeping them different?

enemy could dbe just one long array of ints/al_fixed

same with items...

hell enemies and items could be merged

player struct could be just an array...

not for now....




lets get the whole struct and then copy only what I need....

rewrite packet code to send it all....

12/02/18 07:00

time for work and a backup...


looking at archwagon emove to make ride lifts again...
i don't like the algorithm...
i use an int Ei[][5] for fall/jump (-160 to +160)
i use the yinc Efi[][3] as the scaler
i want to make a seperation of req_move and move
the req_move is made by putting stuff in xinc and yinc
then the code will determine is that is allowed
never mind this noise, i al_fixed it
---------------------------------------------------------------
archwagons don't ride lifts like they used to...fixed
---------------------------------------------------------------
12/02/18 10:18


---------------------------------------------------------------
lev 12 cloner creates flowers from dead enemies with no expiry date
somtimes copies expiring item....
// are we copying something that already has an expiry date?? if so leave it
if (item[b][14] == 0) item[c][14] = Ei[EN][9]; // otherwise set time to live from cloner
---------------------------------------------------------------
fixed...12/02/18 10:26


12/02/18 10:26

rewrite packet code to send all player data...
name variables nicely

done player initial variables, need to test...


i should have lifts, players, enemy items dif cchek done
need to test...
now just prints to screen..later log also

when it works good, can get rid of syck, scaled down version of chck....

12/02/18 11:33


i get all kinds of weird errors

i want to try send a packet to myself and decoding and seeing what errors i get....

where can a i patch that in???


F1.. tested dif test, worked perfectly


I just got rid of 6 ints in player struct that were not used...

// background origin in l2000 (maps to SX, SY)
int WX, WY;

// position and size of players window on screen
int SX,SY,SW,SH; // are these even still used???

new size of 1 player 268 - 67 variables

----------------------------

on ubuntu got some errors about enemy type 0, dead... Efi[12] scale


it is using fixmul...

made my own fixmul that rounds as well...

al_fixed mdw_fixmul(al_fixed a, al_fixed b, float f_round)
{
   float flc = al_fixtof(a) * al_fixtof(b);   // convert to float and multiply
   flc = round(flc/f_round) * f_round; // round
   return al_ftofix(flc);
}

//   Efi[EN][12] = fixmul(Efi[EN][11], Efi[EN][12]); // scale inc
   Efi[EN][12] = mdw_fixmul(Efi[EN][11], Efi[EN][12], 0.00001); // scale inc

when I use 0.00001 I still get errors
when I use 0.0001 I don't





in level 22 with bombs at the start item type 99 error in item[][10] (scale for explosion)

tried to round by 0.0001 then 0.001 still get very few errors...
try aother level 31
then 0.1 and multiple places...just ignore it, its draw only code...


bigger problem, what about when chnk arrives late?

can i delay the client?

can i make the client save a chunk for comparison?

lets test what I have with lots of clients...

i990 server,  pfv, 6410, 6430, ubuntu

mostly got all chunks on time

some clients had player color errors near start...
when is color set??
when player joins??


add to logging...

clients..
chuck received (already shows what frame)
any dif's
percent of late chunks
percent of dif chucks

can i disable syck?  probably.. just comment out for now
stop server from sending...



could this really be the end?

do i have it solved?


new method for join

-- sit there like a dummy...receiving packets
-- when i get a good chunk
-- blast in into memory like i always do
-- do some tweaking for player struct
-- set compmove to same passcount as chnk
-- start playing...


could i do spectator mode?... like doom

13/02/18 07:05

time for a backup

20180213 done



now that I have my entire game state in one chunk,
i should be able to do a dif on it...
but then i would need to keep prevoius states...
how big is chnk 100k...
with compression i'm only sending 5-6k

the only advantage to this is to reduce the ammunt i need to send
and the expense of needing to keep multiple states to dif against


clients will only need one older state...last chnk applied

server will need to keep at least one old state per client...

if this fails, server can always send entire chunk...


i could make my own dif

iterate entire buffer and detect difs
i mostly do this already...


make a stand alone functions to

- put the game_state into a chnk.. done
- get the game state back from a chunk..done
- compare 2 game states and generate dif
- use a dif to update one stae to another


i need to solve how to ignore the parts of player that are necesarily different....

make a shadow players struct and move them there...


or only sync first three...PX, PY, LIFE

only first 45....


-------------
this is what I actually did...

made new player struct player1
copied all member that change into it...
went through all the code and al_fixed all refs

now I need to find out my new sizes...

players is now 1440 - 180 per player - 45 vars

total chnk is now...104640

test that netgame still works and chnks still passed...good


make a function to compare 2 game chunks


it looks like i don't know how to pass pointers to array
unless i globally declare them...

maybe that isn;t the way it works..
maybe you need to send the size as well as the pointer...


ok i've got it...

void get_chunk_dif(char *a, char *b, char *c, int size)
{
   for (int i=0; i<size; i++)
      c[i] = a[i] - b[i];
}








--------------------------

getting lost here.....


when rx chunk and passcount good

compare to current and show dif

optionally copy to cur...

but i want to make allowances in case i need to save cur and then check later...

like when chnk comes late...


on client
if pass % 100 save cur in chunk and mark with passcount

then check if both can be compared...

make a global char client_chnk[] and

I already use dec for this, no....

char client_chnk[CHUNK_SIZE];  // clients state for comparison
int client_chnk_passcount = 0;
int client_chnk_checked = 0;

   if (passcount % 100 == 0)
   {
      // get clients state for comparison
      void state_to_chunk(char * b);
      state_to_chunk(client_chnk);
      client_chnk_passcount = passcount;
      client_chnk_checked = 0;

   }



removed all the old checks
now show diff just uses its own local copies for comparison

i should do a check with memcmp and not even show diff unless it fails...

same with sections in show diff

detect first and do nothing unless bad...



42 bullet speed
44 num hits


now only 44

actually take one off

42 bullet wait
44 num bullets

i till get random differences in players

sometimes, player_health display, butmap index...ect

but they are all before player joins...
need a way o ignore them


need to do the same checks for all other stuff..


then what??  am I good?


14/02/18 07:49

time for worky



what now...

add logging for chnk

add some on screen indication

last chunk good
last chunk dif found but applied
last chunk dif found, could not apply
number of late chunks.



just had a thought...

clf is how far in the future game move is put in array, but that does not
affect how far client is behind server.. how is that determined?

server never changes

clients adjust with this code...


   if (passcount > chase_to_passcount) // past chase
      if (passcount == last_sdat_lpc)  // only if just received sdat; use for sync
      {
         server_sync = last_sdat_fpc - passcount;
         fps_chase = passcount_timer_fps + server_sync;

         if (fps_chase < 4) fps_chase = 4; // never let this go negative
         if (fps_chase > max_fps_chase) max_fps_chase = fps_chase;
         if (fps_chase < min_fps_chase) min_fps_chase = fps_chase;

         install_int_ex(inc_timer_passcount, BPS_TO_TIMER(fps_chase)); // adjust timer


int max_fps_chase = 0;
int min_fps_chase = 99;



if server_sync is positive increase frame rate

if server_sync is negative decrease frame rate

if server_sync is 0 use normal frame rate

this loop looks like it try to make server_sync 0




14/02/18 18:45
got a sync error: server i990 (win7) client pfv(XP)
pop msg var 6 (draw time) server 39 local 40
this makes no sense, its just an int and we are just subtracting from it...


tested with chnk sent every frame..
lets say 5KBytes * 40fps = 200kB/s

what do i need to do it by dif states?

on server, keep last ack dif state for each client

on client keep last good sent dif state from server

server makes a dif state from last ack to now and sents to clients

clients use that dif and last from server toi make new one and apply if necessary



lets get some terms nailed down....


i want to call it state instead of chunk

server will have array

char state[10][100000] (1M) nothing compared to level_bufs (4M)

also

int state_info[10][10];
state_info[p][0] = player_number;
state_info[p][1] = used in this game;
state_info[p][2] = last_acknowledge_state;


loop:

for each active player:
make a dif from current frame back to last ack frame and send it


wait a minute here...

do I need to save states on the server?.. what if i just save the difs?

yes i need to save states on the server

maybe I could save them compressed??


--------------------
bottom line right now is my brute force method works...
I can send every frame and not overload the network

lets say 5KBytes * 40fps * 8 players = 1.6MB/s * 8 = 12.8Mb/s


I don't really need to send so often.. once per sec =

lets say 5KBytes * 1fps * 8 players = 40kBytes/s * 8bits = 320kbits/s


---------------------------

make some global variable to control and check up on sync


for clients

int chnk_count;
int chnk_rx;
int chnk_late;
int chnk_corr;
int chnk_cant_corr;


works good, but should i disable until client joins??

..or can i be really brave and fuck with join...

all i need to do is run a rx loop until i get a good chunk...

break out that into a function


void client_block_until_good_chunk_received(void)


disable bulk game move sync at passcount 0 in client control
disable chase to passcount in SJON rx


add my own stuff at passcount 0 in client control
void client_block_until_good_chunk_received(void)



set passcounts, timer_passcount, game move entry pos...

then start the game in view mode and tell the server to make me active...

-----------


get weird enemy type 4 error that cant be al_fixed...
well I fix them but they git bad again instantly..

its only enemy type 4 and only ypos...why????

other than that the join seems good...

i get lots of sync errors while waiting for join...

put the stuff in log file...done...



how hard is it to revert to the prevoius method....


1 - at the beginning of client control...

//   if (passcount == 0) bulk_game_move_sync();

   if (passcount == 0)
   {
      client_block_until_good_chunk_received();
      passcount = good_chnk_passcount;
      extern int timer_passcount;
      timer_passcount = passcount;
      players1[active_local_player].game_move_entry_pos = server_game_move_entry_pos;

//      void init_player_before_netplay_becoming_active_entry(int );
//      init_player_before_netplay_becoming_active_entry(active_local_player);

   }


2 - in SJON re-enable chase to passcount....


------------------
and now I get no errors....why????


well its easy to switch bteween the two...what am i missing???


also if block errors are detected I need to redraw blocks!duh..
done...


bouncer y makes no sense.....

i like the new method of join...why does it not like me???


16/02/18 07:03

time for a backup and work...


20180216...

   // set the bitmap from animation sequence - always with time
   Ei[EN][1] = zz[0][Ei[EN][3]];

need to reset passcount timers too...
or not use them like this...

fixed, now use passcount mod scheme to set bitmap


------------------

now that that works good, where was I going with this?

i no longer need to chase to passcount or play out the entire level
to get to the same point..

joining a game in progress will be much faster...

now the state is loaded then waits for server to lock

can i do something about that??

skip the wait for sync and make it happen faster...

client send ready with frame x to server and server will make them active??


i want a replay sent frm client to let the server know thay have applied chnk
up to a certain frame or paascount

i already have sdak, lets see if i can reuse it...

i will assume if I have chnk done up to that point that i don't need any
game moves from before that...

      // set player's game move entry pos
      players1[active_local_player].game_move_entry_pos = server_game_move_entry_pos;

      // send ack up to this point
      Packet("sdak");
      PacketAdd3Bytes(passcount);
      PacketAdd2Bytes(server_game_move_entry_pos); // new entry pos
      ClientSend(packetbuffer, packetsize);

this seems to work...


i'm still waiting for server to make client active....

what can I do there?

only wait for 1 good frame, send active in 4 frames...


/*            // if (-2 < sync < 4) add to sync_good_frames or reset
            if ((players1[p].server_sync < 4) && (players1[p].server_sync > -2))
               players1[p].sync_good_frames++;
            else  players1[p].sync_good_frames = 0;

            if ((players1[p].sync_good_frames > 0)  && (players1[p].sync_good_frames < 5)  && (players[p].active == 0))
            {
               sprintf(msg," <---good sync[%d/4]", players1[p].sync_good_frames);
               add_log_entry(msg);
            }
            add_log_entry("\n");

            // if good sync 4 times in row set player active in future
            if ((players1[p].sync_good_frames == 4)  && (players[p].active == 0))
            {
               #ifdef LOGGING_NETPLAY_JOIN
               sprintf(msg,"[%4d] ------player:%d has locked and will become active in 10 frames!\n", passcount, p);
               add_log_entry(msg);
               #endif

               add_game_move(passcount + 9,  2, p, players[p].color);
               add_game_move(passcount + 10, 1, p, 1);
            }
         }  */


            if ((players[p].active == 0) && (players1[p].server_sync < 4) && (players1[p].server_sync > -2))
            {
               add_game_move(passcount + 4, 2, p, players[p].color);
               add_game_move(passcount + 4, 1, p, 1);
               #ifdef LOGGING_NETPLAY_JOIN
               sprintf(msg,"[%4d] ------player:%d has locked and will become active in 4 frames!\n", passcount, p);
               add_log_entry(msg);
               #endif
            }
         }


this works good...

test it on many computers....

not good with more clients

sync seems good but when they move lots of errors...

client past the first one try to move the wrong client

its because when joining, other clients control methods need to be set to 2

when I chunk join

i will need to look for active players and set them to control method 2...

done...

now it all seems to work great...


hostname seems to work from commandline, the same in win and lin

I could use it as the clients name...
if there was only some way that the server could broadcast it...
but the clients need to know it before they can even connect...

i have disabled syck...

change in cfg to chnk_freq..done

logging on server...

don't need to show number of moves on bottom screen...

client show also chnk rx'd not late

---------------

need to redraw level before client joins...done
17/02/18 07:45


what do I need to show on client to let me know how that game sync is going...

            sprintf(msg, "Chunk count:%d rx:%d not_late:%d late:%d corr:%d cant_corr:%d ", chnk_count, chnk_rx, chnk_rx-chnk_late, chnk_late, chnk_corr, chnk_cant_corr);
            textout_ex(scrn_buffer, font, msg, 80, 12, 15, 0);

sprintf(msg, "Chunks:%d rx'd:%d not_rx'd [%d]", chnk_count, chnk_rx, chnk_count-chnk_rx, (chnk_rx * 100) / chnk_count);
sprintf(msg, "Chunks:%d rx:%d not_late:%d late:%d corr:%d cant_corr:%d ", chnk_count, chnk_rx, chnk_rx-chnk_late, chnk_late, chnk_corr, chnk_cant_corr);



---------------------------------------------------------------
run game is not working...
seems to work on single player manual save...
seems to work on single player auto save...

when run from commnd line exits before saving...
al_fixed...lets see how it works now...
all seems good....
17/02/18 08:20
---------------------------------------------------------------


now I want to see if I can influence how far ahead the server is...

clients adjust with this code...


   if (passcount > chase_to_passcount) // past chase
      if (passcount == last_sdat_lpc)  // only if just received sdat; use for sync
      {
         server_sync = last_sdat_fpc - passcount;
         fps_chase = passcount_timer_fps + server_sync;

         if (fps_chase < 4) fps_chase = 4; // never let this go negative
         if (fps_chase > max_fps_chase) max_fps_chase = fps_chase;
         if (fps_chase < min_fps_chase) min_fps_chase = fps_chase;

         install_int_ex(inc_timer_passcount, BPS_TO_TIMER(fps_chase)); // adjust timer


int max_fps_chase = 0;
int min_fps_chase = 99;



if server_sync is positive increase frame rate

if server_sync is negative decrease frame rate

if server_sync is 0 use normal frame rate

this loop looks like it try to make server_sync 0




there is a bug in this code:

      if (passcount == last_sdat_lpc)  // only if just received sdat; use for sync
      {
         server_sync = last_sdat_fpc - passcount;

this part guarantees that server_sync will always be zero...right?

this next part then will never change...right?

fps_chase = passcount_timer_fps + server_sync;


i just tested it and it never seems to change....

what was i really trying to do??

actually lpc != fpc...code is not bad

it looks like i almost always get it on the same frame
the adjust seems to work too.

can I control the adjust?

what if I purposely want it to be more?



      if (passcount == last_sdat_lpc)  // only if just received sdat; use for sync
      {
         server_sync = last_sdat_fpc - passcount;
         fps_chase = passcount_timer_fps + server_sync - 2;

         if (fps_chase < 4) fps_chase = 4; // never let this go negative
         if (fps_chase > max_fps_chase) max_fps_chase = fps_chase;
         if (fps_chase < min_fps_chase) min_fps_chase = fps_chase;

         install_int_ex(inc_timer_passcount, BPS_TO_TIMER(fps_chase)); // adjust timer


this will set it 2 frames ahead...


--------------------------

now i want to experiment with reducing clf...
try from 4 to 2;
and 0 server sync

clf 2 server_sync 0 -- works good

clf 1 server_sync 0 -- corrects 90%

clf 1 server_sync 1 -- all clients cdats arrives too late on server

am i right in assuming that i never want server behind client?
i think so...server has master state and needs to sync it to clients
it simply just has to be ahead...

so server sync needs to be from 0 to some small positive value

also it looks like clf will work with 2, (or maybe server_sync + 2)

I should make a global value server_lead_frames...done


removed a lot of old shit...

clf 2 server_lead_frames 1 -- works

test to see if my chunks all come 1 frame early like i predict...yes...
lets leave it there for now...



---------------------------------------------------------------
client can't quit with ESC??

cdat appears to be sent properly
and rx'd properly

but then the next one, the release of ESC is sent one frame later
but rx'd much later on server...

game move is put in array on server, but never gets synced back to client...
only happens when server_lead_frames > 0;

why don't i enter that game move a few frames in the future?

            // this special case here is to fix bug that occurs when server_lead_frames > 0, then the quit move doesn't get synced back to the client
            if (cm == 127) // client quit
            {
               add_game_move(pc+2, 5, p, cm);  // put in future
               add_log_entry("((quit!!))\n");
            }
---------------------------------------------------------------
al_fixed 17/02/18 09:59


next.. what is client sync error and do i need to show it on clients??
its when a client gets game moves too late, it used to be bad, but now
chunk will fix it...i probably will diasble showing it in future,
but for now I want to see if it accompanies chunk corrections

do I need to show csync and ssync on bottom...no

what could i show instead?

corrections??
failed corrections??
sync good?

sync good = 1;
set to 0 if correction fails
set to 1 if correction applied
set to 1 if no dif found

i went with sync good...
17/02/18 10:33




the things I can adjust for netplayer are:

control_lead_frames = 2
server_lead_frames = 1
chnk_freq = 40

test many....
seems to work good....

add to stats at end of game..done


even though i got no errors on clients the server was missing cdats...
lets try

clf 2 server_lead_frames 0


------------------------
it doesn't matter what level the player has loaded, the server will overwrite!!!

i'm going to try to use wireshark to see how much data i'm using..

fuck it....


--------------------------------------------------------------------------------
when you let go of an item in a solid wall it get bumped up the next higher block
im assuming this only happens for bomb, other stuff cant be stuck in wall...
in player_drop_item:
else itemf[pc][1] += al_itofix(2); // when putting bomb in wall, this stops it from snapping to block above
fixed...17/02/18 14:21
-------------------------------------------------------------------------------

-------------------------------------------------------------------------------
why does controller menu write over map...fixed...17/02/18 14:28
-------------------------------------------------------------------------------

this is how much data I'm using...

game state snapshot "chunk" compressed is 5-6 kilo Bytes

i'm doing 1 per second right now

times 8 players

5000 * 8 = 40kB/s or 320kb/s



----------------------
what happens on level done?
reset a bunch of counters, and invalidated the chunk we were building with packets
leave in the re-sync....
i think that level done is good....17/02/18 16:49

-----------

there is no indication on client when cdats are dropped by the server...

i could add another packet...
serr // server error

and send it to clients when cdat is dropped


also

cerr // client error
to let server know when client has errors, like
- getting chnk late
- getting sdat late


then maybe later i can do something about them...


ima gonna do this....

i was gonna re-use c_sync in player1 but something on client already uses it..
use serr_c_sync_err.

it seems like this is working good...

now can i display it with a timer???

make my own timer...added to player1 struct...done

this looks really good now.....


------------------
now make the client errors get back to the server..maybe later...

ready for a good long test...

17/02/18 17:43


played a long series of levels with kaileb..

errors...on client, player and enemy



need to log better

on clients do the same kind of logging when level done as when player quits...

break it out into a function...


make more logging...done

per level...stats..done


and show on screen also...


add fake keypress testing...done



fails on 2 player



what if i made my own log file viewer....
color coded...
dynamically able to hide/show types of log messages


test with increased clf 3 instead of 2
not a single error

test with many...

worked good on simple levels
but more complex was bad...

what if I stagger my chnk packets among clients
instead of sending them all in the same frame...

on server, keep track of how many byte are sent every frame...done
stagger chunks among clients
based on player num
+ 5 times player num

that seems to work...

make better server logging at end...

per client stuff...
- how many late cdats

these will need to be passed from client to server
- how many late chunks
- how many corr
- how many bad corr..




move some client stats to player1 sruct...
frame when client joined  client_statistic[3]
cdat packets tx'd         client_statistic[2]);


// client side
0 - sdat rx'd total
1 - sdat skipped
2 - cdat tx'd
3 - join frame
4 - moves entered
5 - moves skipped


// common
join frame
quit frame
...done


// server side
sdats tx'd
cdats late..done

   int current_bytes_for_this_frame; ..done
   int total_bytes; ..done
   int total_packets; ..done
   int max_bytes_per_frame; .. done
   int max_packets_per_frame; .. done



make client tell server when it has chunk problems
right now on client the data is in global_shit:

int chnk_pieces[16];
int good_chnk_passcount = 0;
int client_chnk_passcount = 0;
int client_chnk_checked = 0;
int chnk_freq = 10;
int chnk_count = 0;
int chnk_rx = 0;
int chnk_late = 0;
int chnk_on_time = 0;
int chnk_corr = 0;
int chnk_cant_corr = 0;

int client_sync_good;

do i really want to put all that in player1 struct?

just add for server:
int chnk_late = 0;
int chnk_corr = 0;
int chnk_cant_corr = 0;

this all is working good..

lets try a complex level like 39

level 39 i990 server...4 clients..bad!!!

         total game frames.........[6739]                                  |
|        total bytes sent..........[4917843]                               |
|        total packets sent........[16490]                                 |
|        max bytes per frame.......[7225]                                  |
|        max packets per frame.....[17]                                    |
|        average bytes per frame...[729]                                   |
|        average bytes per sec.....[29190]                                 |
+--------------------------------------------------------------------------+
|        Player:1                                                          |
|        frame when client joined..[332]                                   |
|        frame when client quit....[6739]                                  |
|        frames client was active..[6407]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:2                                                          |
|        frame when client joined..[456]                                   |
|        frame when client quit....[6739]                                  |
|        frames client was active..[6283]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[54]                                    |
|        chunk corrections.........[29]                                    |
|        chunk can't correct.......[54]                                    |
+--------------------------------------------------------------------------+
|        Player:3                                                          |
|        frame when client joined..[541]                                   |
|        frame when client quit....[6739]                                  |
|        frames client was active..[6198]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[20]                                    |
|        chunk corrections.........[69]                                    |
|        chunk can't correct.......[20]                                    |
+--------------------------------------------------------------------------+
|        Player:4                                                          |
|        frame when client joined..[1026]                                  |
|        frame when client quit....[6739]                                  |
|        frames client was active..[5713]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[74]                                    |
|        chunk can't correct.......[0]






level 39 i990 server...1 clients..

+--------------------------------------------------------------------------+
|                                                                          |
|                Local Server quit the game. Time: 94889ms                 |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        total game frames.........[3776]                                  |
|        total bytes sent..........[716014]                                |
|        total packets sent........[4163]                                  |
|        max bytes per frame.......[6932]                                  |
|        max packets per frame.....[8]                                     |
|        average bytes per frame...[189]                                   |
|        average bytes per sec.....[7584]                                  |
+--------------------------------------------------------------------------+
|        Player:1                                                          |
|        frame when client joined..[211]                                   |
|        frame when client quit....[3776]                                  |
|        frames client was active..[3565]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[6]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+

level 39 i990 server...2 clients..

+--------------------------------------------------------------------------+
|                                                                          |
|             Local Server(i990) quit the game. Time: 90876ms              |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[39]                                    |
|        total frames..............[3615]                                  |
|        total bytes sent..........[1480842]                               |
|        total packets sent........[7821]                                  |
|        max bytes per frame.......[7066]                                  |
|        max packets per frame.....[9]                                     |
|        average bytes per frame...[409]                                   |
|        average bytes per sec.....[16385]                                 |
+--------------------------------------------------------------------------+
|        Player:1                                                          |
|        frame when client joined..[171]                                   |
|        frame when client quit....[3615]                                  |
|        frames client was active..[3444]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[5]                                     |
|        chunk corrections.........[1]                                     |
|        chunk can't correct.......[1]                                     |
+--------------------------------------------------------------------------+
|        Player:2                                                          |
|        frame when client joined..[299]                                   |
|        frame when client quit....[3615]                                  |
|        frames client was active..[3316]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+


when clients request join I want them to send their hostname up to a max 15 char
done...
18/02/18 11:14

try 3 clients...


+--------------------------------------------------------------------------+
|                                                                          |
|             Local Server(i990) quit the game. Time: 84619ms              |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[39]                                    |
|        total frames..............[3365]                                  |
|        total bytes sent..........[1962285]                               |
|        total packets sent........[9309]                                  |
|        max bytes per frame.......[7190]                                  |
|        max packets per frame.....[10]                                    |
|        average bytes per frame...[583]                                   |
|        average bytes per sec.....[23325]                                 |
+--------------------------------------------------------------------------+
|        Player:1 (pfv)                                                    |
|        frame when client joined..[171]                                   |
|        frame when client quit....[3365]                                  |
|        frames client was active..[3194]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[8]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[336]                                   |
|        frame when client quit....[3365]                                  |
|        frames client was active..[3029]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[36]                                    |
|        chunk corrections.........[12]                                    |
|        chunk can't correct.......[29]                                    |
+--------------------------------------------------------------------------+
|        Player:3 (e6430)                                                  |
|        frame when client joined..[661]                                   |
|        frame when client quit....[3365]                                  |
|        frames client was active..[2704]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[1]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+


this one fell apart near the end...
+--------------------------------------------------------------------------+
|                                                                          |
|             Local Server(i990) quit the game. Time: 134954ms             |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[39]                                    |
|        total frames..............[5378]                                  |
|        total bytes sent..........[3085756]                               |
|        total packets sent........[15142]                                 |
|        max bytes per frame.......[7310]                                  |
|        max packets per frame.....[12]                                    |
|        average bytes per frame...[573]                                   |
|        average bytes per sec.....[22950]                                 |
+--------------------------------------------------------------------------+
|        Player:1 (pfv)                                                    |
|        frame when client joined..[211]                                   |
|        frame when client quit....[5378]                                  |
|        frames client was active..[5167]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[15]                                    |
|        chunk corrections.........[25]                                    |
|        chunk can't correct.......[15]                                    |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[612]                                   |
|        frame when client quit....[5378]                                  |
|        frames client was active..[4766]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[9]                                     |
|        chunk corrections.........[58]                                    |
|        chunk can't correct.......[9]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6430)                                                  |
|        frame when client joined..[1061]                                  |
|        frame when client quit....[5378]                                  |
|        frames client was active..[4317]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[29]                                    |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+


why is cdat late to server always 0?
its because server uses :c_sync_err
and client uses: serr_c_sync_err
al_fixed...

where do i get time???


+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[39]                                    |
|        total frames..............[4526]                                  |
|        total time (seconds)......[113]                                   |
|        total time (minutes)......[1]                                     |
|        total bytes sent..........[2564574]                               |
|        total packets sent........[11791]                                 |
|        max bytes per frame.......[7293]                                  |
|        max packets per frame.....[11]                                    |
|        average bytes per frame...[566]                                   |
|        average bytes per sec.....[22665]                                 |
+--------------------------------------------------------------------------+
|        Player:1 (pfv)                                                    |
|        frame when client joined..[251]                                   |
|        frame when client quit....[4526]                                  |
|        frames client was active..[4275]                                  |
|        cdat late to server.......[30]                                    |
|        chunks late...............[0]                                     |
|        chunk corrections.........[42]                                    |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[496]                                   |
|        frame when client quit....[4526]                                  |
|        frames client was active..[4030]                                  |
|        cdat late to server.......[15]                                    |
|        chunks late...............[21]                                    |
|        chunk corrections.........[37]                                    |
|        chunk can't correct.......[21]                                    |
+--------------------------------------------------------------------------+
|        Player:3 (e6430)                                                  |
|        frame when client joined..[1221]                                  |
|        frame when client quit....[4526]                                  |
|        frames client was active..[3305]                                  |
|        cdat late to server.......[43]                                    |
|        chunks late...............[0]                                     |
|        chunk corrections.........[31]                                    |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+


control_lead_frames = 4
server_lead_frames = 1



stoppped at 73, before it started going funny at around 100
+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[39]                                    |
|        total frames..............[2948]                                  |
|        total time (seconds)......[73]                                    |
|        total time (minutes)......[1]                                     |
|        total bytes sent..........[1746877]                               |
|        total packets sent........[8804]                                  |
|        max bytes per frame.......[7327]                                  |
|        max packets per frame.....[10]                                    |
|        average bytes per frame...[592]                                   |
|        average bytes per sec.....[23702]                                 |
+--------------------------------------------------------------------------+
|        Player:1 (pfv)                                                    |
|        frame when client joined..[171]                                   |
|        frame when client quit....[2948]                                  |
|        frames client was active..[2777]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[15]                                    |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[376]                                   |
|        frame when client quit....[2948]                                  |
|        frames client was active..[2572]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[36]                                    |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6430)                                                  |
|        frame when client joined..[821]                                   |
|        frame when client quit....[2948]                                  |
|        frames client was active..[2127]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[1]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+



ran to 100 and it started being dumb just before 100
+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[39]                                    |
|        total frames..............[4024]                                  |
|        total time (seconds)......[100]                                   |
|        total time (minutes)......[1]                                     |
|        total bytes sent..........[2468106]                               |
|        total packets sent........[11789]                                 |
|        max bytes per frame.......[7191]                                  |
|        max packets per frame.....[10]                                    |
|        average bytes per frame...[613]                                   |
|        average bytes per sec.....[24533]                                 |
+--------------------------------------------------------------------------+
|        Player:1 (pfv)                                                    |
|        frame when client joined..[251]                                   |
|        frame when client quit....[4024]                                  |
|        frames client was active..[3773]                                  |
|        cdat late to server.......[16]                                    |
|        chunks late...............[3]                                     |
|        chunk corrections.........[17]                                    |
|        chunk can't correct.......[3]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6430)                                                  |
|        frame when client joined..[376]                                   |
|        frame when client quit....[4024]                                  |
|        frames client was active..[3648]                                  |
|        cdat late to server.......[32]                                    |
|        chunks late...............[0]                                     |
|        chunk corrections.........[12]                                    |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6410)                                                  |
|        frame when client joined..[421]                                   |
|        frame when client quit....[4024]                                  |
|        frames client was active..[3603]                                  |
|        cdat late to server.......[11]                                    |
|        chunks late...............[0]                                     |
|        chunk corrections.........[58]                                    |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+


I bet I've filled up my game_moves array!!! 10,000 was just not enough...
i just upped it to 1,000,000

add to logging on server.. done


+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[39]                                    |
|        total frames..............[8030]                                  |
|        total moves...............[23073]                                 |
|        total time (seconds)......[200]                                   |
|        total time (minutes)......[3]                                     |
|        total bytes sent..........[10401372]                              |
|        total packets sent........[33349]                                 |
|        max bytes per frame.......[8006]                                  |
|        max packets per frame.....[26]                                    |
|        average bytes per frame...[1295]                                  |
|        average bytes per sec.....[51812]                                 |
+--------------------------------------------------------------------------+
|        Player:1 (pfv)                                                    |
|        frame when client joined..[371]                                   |
|        frame when client quit....[8030]                                  |
|        frames client was active..[7659]                                  |
|        cdat late to server.......[22]                                    |
|        chunks late...............[1]                                     |
|        chunk corrections.........[35]                                    |
|        chunk can't correct.......[1]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (4230-3)                                                 |
|        frame when client joined..[776]                                   |
|        frame when client quit....[8030]                                  |
|        frames client was active..[7254]                                  |
|        cdat late to server.......[22]                                    |
|        chunks late...............[2]                                     |
|        chunk corrections.........[119]                                   |
|        chunk can't correct.......[2]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6410)                                                  |
|        frame when client joined..[1181]                                  |
|        frame when client quit....[8030]                                  |
|        frames client was active..[6849]                                  |
|        cdat late to server.......[510]                                   |
|        chunks late...............[25]                                    |
|        chunk corrections.........[126]                                   |
|        chunk can't correct.......[25]                                    |
+--------------------------------------------------------------------------+
|        Player:4 (e6430)                                                  |
|        frame when client joined..[1870]                                  |
|        frame when client quit....[8030]                                  |
|        frames client was active..[6160]                                  |
|        cdat late to server.......[5]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[90]                                    |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+


18/02/18 12:19
what do you need to do to send only difs?

a high level approach

terms:
state (the full ~100k game state)
- state will have the passcount as ID

dif   (a 100K dif between 2 states)
- dif will have a src and target ID



-server keeps a state for each client
-based on the last acknowledgement


client succesfully applies a dif (or no dif found)
client replys with ack to server
now client uses the current state for the base

when server gets ack from client:
- sets the new base state for client

when its time for the server to send another dif to client:
- make one from the clinets base state and the current state



void state_to_chunk(char * b)
void chnk_to_state(char * b)

void get_chunk_dif(char *a, char *b, char *c, int size)
void apply_chunk_dif(char *a, char *c, int size)



clients code
--------------------

char client_chnk[2][100k];
int client_chnk_id[2]; // passcount id's
0 is the last good state from the server
1 is the next one to compare (made based on passcount mod)

char dif[100k]
int dif_id[2];
0 = src
1 = dst

get dif from packet
will have int src, int dst, and compressed payload...
don't decompress until needed


if (passcount % 40)
{
   state_to_chunk(client_chnk[1]); // get state for comparsion
   client_chnk_id[1] = passcount;  // mark with passcount
}


if ((client_chnk_id[0] == dif_id[0]) &&
    (client_chnk_id[1] == dif_id[1]) )

---------------------------------------------------------------
wait a sec... this is assuming i want to compare to current state...
it would be a lot simpler if I didn't...............
-----------------------------------------------------------------



client code
------------

char client_chdf[CHUNK_SIZE];
int client_chdf_id; // passcount id

char dif[CHUNK_SIZE];
int dif_id[2]; //   (0 = src, 1 = dst)


on client we need to have a stored state to dif from


get dif from packet
will have int src, int dst, and compressed payload...
decompress dif


if(PacketRead("chdf"))
{
   int chdf_src_passcount = Packet4ByteRead();
   int chdf_dst_passcount = Packet4ByteRead();
   int chdf_seq = PacketGetByte();
   int chdf_max_seq = PacketGetByte();
   int chdf_sb = Packet4ByteRead();
   int chdf_sz = Packet4ByteRead();

   printf("[%4d] chdf_src:%d chdf_dst:%d seq:%d num_seq:%d st:%d sz:%d \n", passcount, chdf_src_passcount, chdf_dst_passcount, chdf_seq, chdf_max_seq, chdf_sb, chdf_sz);

   memcpy(chdf+chdf_sb, packetbuffer+22, chdf_sz);  // put the data in the buffer
   chdf_pieces[chdf_seq] = chdf_dst_passcount;         // mark it with chdf_dst_passcount

   // did we just get the last packet?
   int good = 1; // yes by default
   for (int i=0; i< chdf_max_seq; i++)
      if (chdf_pieces[i] != chdf_dst_passcount) good = 0; // no, if any piece not at latest passcount

   if (good)
   {
      sprintf(msg, "[%4d]All chdf packets rx'd for chdf_src:%d to chdf_dst:%d ", passcount, chdf_src_passcount, chdf_dst_passcount);
      printf("%s", msg);

      // decompress chdf to dif
      uLongf destLen= sizeof(dif);
      uncompress((Bytef*)dif, (uLongf*)&destLen, (Bytef*)chdf, sizeof(chdf));
      int cp = destLen;
      if (cp == CHUNK_SIZE)
      {
         sprintf(msg, "good decompress!\n");
         printf("%s", msg);
         dif_id[0] = chdf_src_passcount;
         dif_id[1] = chdf_dst_passcount;
      }
      else
      {
         sprintf(msg, "bad decompress!\n");
         printf("%s", msg);
      }
   }
}


// dif on client will only happen on exact passcount
// but we might rx dif before that and store it until passcount

   if ( (passcount == dif_id[1]) // current passcount is dif target
      && (clientl_chdf_id == dif_id[0]) ) // stored state is dif source
   {
      // apply dif to pos 0
      apply_chunk_dif(clientl_chdf, dif, CHUNK_SIZE);

      // copy back to current game state
      chnk_to_state(clientl_chdf);

      // update passcount
      clientl_chdf_id = passcount;

      // now state is current state

      // send ack to server
      Packet("chak");
      PacketAddByte(active_local_player);
      PacketAdd4Bytes(passcount);
      ClientSend(packetbuffer, packetsize);
   }


server code
--------------
extern vars:
char client_chdf[8][2][CHUNK_SIZE];
int client_chdf_id[8][2]; // passcount id


we need 2 states for each client:
- the last acknowledged one and
- the last one we made a dif with
so that when it is acknowledged, we have a copy to use as the new base



if(PacketRead("chak"))
{
   int p = PacketGetByte();
   int ack_pc = Packet4ByteRead();
   if (ack_pc == client_chdf_id[p][1]) // check to make sure we have a copy of acknowledged state
   {
      // acknowledged state is out new base state
      memcpy(client_chdf[p][0], client_chdf[p][1], CHUNK_SIZE); // copy 1 to 0
      client_chdf_id[p][0] = ack_pc; // new passcount
   }
}


void server_send_chdf(void)
{
   // need to figure out here what time and what player
   // if 40 we will get a number from 0 to 39
   int tp = passcount % chnk_freq; // always 40
   int tp1 = tp/5;    // get a number from 0 to 7 (player number)
   int tp2 = tp % 5;  // get a number from 0-4 (only send on 0's)
//   printf("[%4d] tp:%d tp1:%d tp2:%d  \n", passcount, tp, tp1, tp2);
   if ((tp2 == 0) && (tp1 > 0))
   {
      char dif[CHUNK_SIZE];
      char cmp[CHUNK_SIZE];

      // get current
      state_to_chunk(client_chdf[tp1][1]);

      // make a new dif from base and current
      get_chunk_dif(client_chdf[tp1][0], client_chdf[tp1][1], dif, CHUNK_SIZE);

      // compress dif to cmp
      uLongf destLen= sizeof(cmp);
      compress2((Bytef*)cmp, (uLongf*)&destLen, (Bytef*)dif, sizeof(dif), 7);
      int cp = destLen;

      // break it into smaller chunks here
      int num_packets = (cp / 1000) + 1;

      #ifdef LOGGING_NETPLAY_chdf
      sprintf(msg, "[%4d]chdf send p:%d - raw:%d cmp:%d ratio:%3.2f [%d packets needed]\n", passcount, tp1, CHUNK_SIZE, cp, (float)cp*100 / (float)CHUNK_SIZE, num_packets);
      add_log_entry(msg);
      printf("%s", msg);
      #endif

      int start_byte = 0;
      int end_byte = 0;

      for (int pk=0; pk <num_packets; pk++)
      {
         int ssz = 1000; // default seq size
         if (start_byte + ssz > cp) ssz = cp - start_byte; // last one is smaller

         if (end_byte > cp-1) end_byte = cp-1;
   //      printf("id:%d size:%d   pack_seq:%d  seq_end:%d st:%d  sz:%d\n", passcount, cp, pk, num_packets, start_byte, ssz);

         Packet("chdf");
         PacketAdd4Bytes(client_chdf_id[tp1][0]); // src passcount
         PacketAdd4Bytes(client_chdf_id[tp1][1]); // dst passcount
         PacketAddByte(pk);
         PacketAddByte(num_packets);
         PacketAdd4Bytes(start_byte);
         PacketAdd4Bytes(ssz);
         memcpy(packetbuffer+packetsize, cmp+start_byte, ssz);
         packetsize += ssz;

         if (players1[tp1].control_method == 2)
            ServerSendTo(packetbuffer, packetsize, players1[tp1].who);

         start_byte+=1000;
      }
   }
}

---------------------------------------------
now with all these pieces in place lets test..!!!

18/02/18 15:54

to start with join needs chnk...

lets send chnk also...
but disble rx on regular client loop.done...

it seems to work...
but the sizes are the same...

it looks like i'm diffing everything!!!

src and dst are always 0

maybe i need to kick start it...


show src and dst on send ...


on server when sending set client_chdf_id[tp1][1] = passcount;

that seems to do it... now sizes are more like 1000-2000

try to use chdf for join also

so i can stop sending chnk..done

18/02/18 17:02


-------------------

now do 200 frames of level 39 with 4 clients....


+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[39]                                    |
|        total frames..............[4910]                                  |
|        total moves...............[12203]                                 |
|        total time (seconds)......[122]                                   |
|        total time (minutes)......[2]                                     |
|        total bytes sent..........[2851390]                               |
|        total packets sent........[16224]                                 |
|        max bytes per frame.......[6807]                                  |
|        max packets per frame.....[11]                                    |
|        average bytes per frame...[580]                                   |
|        average bytes per sec.....[23229]                                 |
+--------------------------------------------------------------------------+
|        Player:1 (pfv)                                                    |
|        frame when client joined..[411]                                   |
|        frame when client quit....[4910]                                  |
|        frames client was active..[4499]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[536]                                   |
|        frame when client quit....[4910]                                  |
|        frames client was active..[4374]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6430)                                                  |
|        frame when client joined..[1381]                                  |
|        frame when client quit....[4910]                                  |
|        frames client was active..[3529]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:4 (4230-3)                                                 |
|        frame when client joined..[0]                                     |
|        frame when client quit....[4910]                                  |
|        frames client was active..[4910]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:5 (4230-3)                                                 |
|        frame when client joined..[3066]                                  |
|        frame when client quit....[4910]                                  |
|        frames client was active..[1844]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+


clients 4 and 5 always needed the full sync (they were both ubu)
first time connect was bad...try again

all said sync bad..

after a while some were slow and had errors

+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[39]                                    |
|        total frames..............[8021]                                  |
|        total moves...............[25370]                                 |
|        total time (seconds)......[200]                                   |
|        total time (minutes)......[3]                                     |
|        total bytes sent..........[8864628]                               |
|        total packets sent........[32228]                                 |
|        max bytes per frame.......[7496]                                  |
|        max packets per frame.....[15]                                    |
|        average bytes per frame...[1105]                                  |
|        average bytes per sec.....[44207]                                 |
+--------------------------------------------------------------------------+
|        Player:1 (4230-3)                                                 |
|        frame when client joined..[171]                                   |
|        frame when client quit....[8021]                                  |
|        frames client was active..[7850]                                  |
|        cdat late to server.......[19]                                    |
|        chunks late...............[0]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (pfv)                                                    |
|        frame when client joined..[296]                                   |
|        frame when client quit....[8021]                                  |
|        frames client was active..[7725]                                  |
|        cdat late to server.......[112]                                   |
|        chunks late...............[0]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6410)                                                  |
|        frame when client joined..[502]                                   |
|        frame when client quit....[8021]                                  |
|        frames client was active..[7519]                                  |
|        cdat late to server.......[356]                                   |
|        chunks late...............[0]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+
|        Player:4 (e6430)                                                  |
|        frame when client joined..[906]                                   |
|        frame when client quit....[8021]                                  |
|        frames client was active..[7115]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
|        chunk corrections.........[0]                                     |
|        chunk can't correct.......[0]                                     |
+--------------------------------------------------------------------------+


new
         level.....................[39]                                    |
|        total frames..............[8021]                                  |
|        total moves...............[25370]                                 |
|        total time (seconds)......[200]                                   |
|        total time (minutes)......[3]                                     |
|        total bytes sent..........[8864628]                               |
|        total packets sent........[32228]                                 |
|        max bytes per frame.......[7496]                                  |
|        max packets per frame.....[15]                                    |
|        average bytes per frame...[1105]                                  |
|        average bytes per sec.....[44207]


old
         level.....................[39]                                    |
|        total frames..............[8030]                                  |
|        total moves...............[23073]                                 |
|        total time (seconds)......[200]                                   |
|        total time (minutes)......[3]                                     |
|        total bytes sent..........[10401372]                              |
|        total packets sent........[33349]                                 |
|        max bytes per frame.......[8006]                                  |
|        max packets per frame.....[26]                                    |
|        average bytes per frame...[1295]                                  |
|        average bytes per sec.....[51812]

a little better...


---------------------------------------------------

why do they all say sync bad?

-------------
im back baby, for day 3 of my 3 day long weekend...
19/02/18 03:53

this is what i want to get done today:

- fix logging

- hostname on client display..done

- consolidate packets

- server to drop bad clients



questions:

why do clients say sync bad?
how about they only say if they miss packets

why do some clients fall out of sync like they lose their base state?



-----------


here are some errors that i want to monitor

on client
- when server tells us that cdat was dropped
- when we get late sdats
- when we miss chdf's (can't tell)

- how far behind the server we are running
that should be server sync but its 99...
local vs player??? var
removed global and now use the one in player1 struct..

on client its pointless to show some data for other clients like:
server_sync
clinet_cyns...
removed..


client is looking good...

client needs to tell server when chdf is rx'd late
use cerr..done

how can client now if the sync is going good?

- sensible server sync value
- no late chdf's
- no droped cdats on server...

lets leave it at that and let the server decide..


server monitoring

makes no sense to show c sync stuff...
or active local player..removed

put hostname in player1[0] in server mode...done

clients cant seem to join again...dies waiting for chdf...
its not that can't rejoin, its no player above 1 can join

server never send chdfs...has to do with chdf_freq..al_fixed
need to make the mod thing work with different freq

need to add cync, min, err to client screen, for loacl clinet only..done

what else should server show?



late chdf rx'd by clients

chdf start and dst for clients

num packets needed for each client's dif...

to start with do i have variables for these??


i have chdf_late already in player1
done

now for

int client_chdf_id[8][2]; // passcount id

why are start and dest always the same??

because as soon as one is sent we update start??
no beacuse as soon as client acknowledges state,
dest is put in start for the next one
leave it like this for now..

how about num dif packets?
add to player1 struct..all done

i want server to have running per second stats

packets sent
bytes sent


variables for this...

in player1[0] struct


int packets_this_sec;
int bytes_this sec;

on passcount % 40 display and reset counters

works good...
do the same for rx'd packets and bytes


renamed all these to tx_

   int tx_current_bytes_for_this_frame;
   int tx_current_packets_for_this_frame;

   int tx_total_bytes;
   int tx_total_packets;
   int tx_max_bytes_per_frame;
   int tx_max_packets_per_frame;

   int tx_packets_this_sec;
   int tx_bytes_this_sec;
   int tx_packets_per_sec;
   int tx_bytes_per_sec;


then duplicte to rx_

done...



what else can i log or show?....



run some games for now and we'll see what happens

still want server to drop bad clients...


on this game it looks like pfv was having a hard time keeping up
he was skipping lots of frames

i have no log for pfv beacuse i had to end it badly



+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[17]                                    |
|        total frames..............[11193]                                 |
|        total moves...............[20775]                                 |
|        total time (seconds)......[279]                                   |
|        total time (minutes)......[4]                                     |
|        total tx bytes............[3606818]                               |
|        max tx bytes per frame....[0]                                     |
|        avg tx bytes per frame....[322]                                   |
|        avg tx bytes per sec......[12889]                                 |
|        total tx packets..........[32694]                                 |
|        max tx packets per frame..[0]                                     |
|        total rx bytes............[447945]                                |
|        max rx bytes per frame....[0]                                     |
|        avg rx bytes per frame....[40]                                    |
|        avg rx bytes per sec......[1600]                                  |
|        total rx packets..........[49771]                                 |
|        max rx packets per frame..[0]                                     |
+--------------------------------------------------------------------------+
|        Player:1 (pfv)                                                    |
|        frame when client joined..[171]                                   |
|        frame when client quit....[11193]                                 |
|        frames client was active..[11022]                                 |
|        cdat late to server.......[213]                                   |
|        chunks late...............[10]                                    |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[616]                                   |
|        frame when client quit....[11193]                                 |
|        frames client was active..[10577]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6430)                                                  |
|        frame when client joined..[1101]                                  |
|        frame when client quit....[11193]                                 |
|        frames client was active..[10092]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+


i need the server to drop clients when they act badly

like no response for a long time...how to check that
response to sdat sync packet...
last sdak rx'd

added to player1 struct on server

made a check to drop player with game move




there can only be one!!!!!

void init_player_before_netplay_becoming_active_entry(int p)
only called when control in netplay make player active


void init_player_before_level_entry(int p)
only called once from start mode

it looks like the main difference is that the non-netplay one does this:

players1[p].game_move_entry_pos = 0; // server only  ( for client game_move data sync )
players1[p].server_last_sdat_sent_frame = 0; // only server uses it, to keep track of when last sdat was sent to client


i could make:

init_player(int p, int type)
1 = full
2 = new level
3 = netplay join

done... now there is only one....19/02/18 09:42


drop player seems to work good

show on server on screen display?? no


pfv could not keep up after about 90 sec
but never quit, i think it was still sending sdaks
but not displaying anything because it was so lagged out

maybe I should show last_sdak on server...

also sync was way behind..should also kick for that...

chdf start was probablt bad because pfv could never apply dif
because it was so far behind and kept getting new ones that would overwrite



i wonder if the problem is searching game_moves all the way back to the start...
do i still need to do that??? probably not...






+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[17]                                    |
|        total frames..............[12967]                                 |
|        total moves...............[29978]                                 |
|        total time (seconds)......[324]                                   |
|        total time (minutes)......[5]                                     |
|        total tx bytes............[8517713]                               |
|        max tx bytes per frame....[0]                                     |
|        avg tx bytes per frame....[656]                                   |
|        avg tx bytes per sec......[26275]                                 |
|        total tx packets..........[36974]                                 |
|        max tx packets per frame..[0]                                     |
|        total rx bytes............[531279]                                |
|        max rx bytes per frame....[0]                                     |
|        avg rx bytes per frame....[40]                                    |
|        avg rx bytes per sec......[1638]                                  |
|        total rx packets..........[59033]                                 |
|        max rx packets per frame..[0]                                     |
+--------------------------------------------------------------------------+
|        Player:1 (pfv)                                                    |
|        frame when client joined..[251]                                   |
|        frame when client quit....[12635]                                 |
|        frames client was active..[12384]                                 |
|        cdat late to server.......[282]                                   |
|        chunks late...............[6]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[576]                                   |
|        frame when client quit....[12791]                                 |
|        frames client was active..[12215]                                 |
|        cdat late to server.......[23]                                    |
|        chunks late...............[12]                                    |
+--------------------------------------------------------------------------+
|        Player:3 (e6430)                                                  |
|        frame when client joined..[1083]                                  |
|        frame when client quit....[12396]                                 |
|        frames client was active..[11313]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+



changed game_moves to only look back 100
didn't help...pfv still choked around 70


+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[17]                                    |
|        total frames..............[5247]                                  |
|        total moves...............[13251]                                 |
|        total time (seconds)......[131]                                   |
|        total time (minutes)......[2]                                     |
|        total tx bytes............[2449360]                               |
|        max tx bytes per frame....[0]                                     |
|        avg tx bytes per frame....[466]                                   |
|        avg tx bytes per sec......[18672]                                 |
|        total tx packets..........[14650]                                 |
|        max tx packets per frame..[0]                                     |
|        total rx bytes............[231390]                                |
|        max rx bytes per frame....[0]                                     |
|        avg rx bytes per frame....[44]                                    |
|        avg rx bytes per sec......[1763]                                  |
|        total rx packets..........[25706]                                 |
|        max rx packets per frame..[0]                                     |
+--------------------------------------------------------------------------+
|        Player:1 (pfv)                                                    |
|        frame when client joined..[194]                                   |
|        frame when client quit....[5247]                                  |
|        frames client was active..[5053]                                  |
|        cdat late to server.......[40]                                    |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[456]                                   |
|        frame when client quit....[5247]                                  |
|        frames client was active..[4791]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6430)                                                  |
|        frame when client joined..[863]                                   |
|        frame when client quit....[5247]                                  |
|        frames client was active..[4384]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+



now i'm going to test without pfv
+--------------------------------------------------------------------------+
|                                                                          |
|                                                                          |
|                                                                          |
|                          [12469] LEVEL 17 DONE                           |
|                                                                          |
|                                                                          |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[17]                                    |
|        total frames..............[12469]                                 |
|        total moves...............[17251]                                 |
|        total time (seconds)......[311]                                   |
|        total time (minutes)......[5]                                     |
|        total tx bytes............[1863057]                               |
|        max tx bytes per frame....[0]                                     |
|        avg tx bytes per frame....[149]                                   |
|        avg tx bytes per sec......[5976]                                  |
|        total tx packets..........[32026]                                 |
|        max tx packets per frame..[0]                                     |
|        total rx bytes............[436869]                                |
|        max rx bytes per frame....[0]                                     |
|        avg rx bytes per frame....[35]                                    |
|        avg rx bytes per sec......[1401]                                  |
|        total rx packets..........[48537]                                 |
|        max rx packets per frame..[0]                                     |
+--------------------------------------------------------------------------+
|        Player:1 (e6430)                                                  |
|        frame when client joined..[491]                                   |
|        frame when client quit....[12469]                                 |
|        frames client was active..[11978]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[776]                                   |
|        frame when client quit....[12469]                                 |
|        frames client was active..[11693]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (4230-3)                                                 |
|        frame when client joined..[1181]                                  |
|        frame when client quit....[12469]                                 |
|        frames client was active..[11288]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+

why are all my max's 0?? wrong order again


lets get a few more test computers...


they all quit or were kicked

+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[17]                                    |
|        total frames..............[7255]                                  |
|        total moves...............[44777]                                 |
|        total time (seconds)......[181]                                   |
|        total time (minutes)......[3]                                     |
|        total tx bytes............[3433796]                               |
|        max tx bytes per frame....[6959]                                  |
|        avg tx bytes per frame....[473]                                   |
|        avg tx bytes per sec......[18932]                                 |
|        total tx packets..........[17361]                                 |
|        max tx packets per frame..[379]                                   |
|        total rx bytes............[549786]                                |
|        max rx bytes per frame....[80586]                                 |
|        avg rx bytes per frame....[75]                                    |
|        avg rx bytes per sec......[3031]                                  |
|        total rx packets..........[61086]                                 |
|        max rx packets per frame..[8954]                                  |
+--------------------------------------------------------------------------+
|        Player:1 (4230-3)                                                 |
|        frame when client joined..[211]                                   |
|        frame when client quit....[6183]                                  |
|        frames client was active..[5972]                                  |
|        cdat late to server.......[169]                                   |
|        chunks late...............[19]                                    |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[416]                                   |
|        frame when client quit....[5145]                                  |
|        frames client was active..[4729]                                  |
|        cdat late to server.......[122]                                   |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6400)                                                  |
|        frame when client joined..[610]                                   |
|        frame when client quit....[5145]                                  |
|        frames client was active..[4535]                                  |
|        cdat late to server.......[119]                                   |
|        chunks late...............[3]                                     |
+--------------------------------------------------------------------------+
|        Player:4 (insp9400)                                               |
|        frame when client joined..[786]                                   |
|        frame when client quit....[4697]                                  |
|        frames client was active..[3911]                                  |
|        cdat late to server.......[176]                                   |
|        chunks late...............[2]                                     |
+--------------------------------------------------------------------------+
|        Player:5 (e6430)                                                  |
|        frame when client joined..[1231]                                  |
|        frame when client quit....[5145]                                  |
|        frames client was active..[3914]                                  |
|        cdat late to server.......[118]                                   |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:6 (e4230f)                                                 |
|        frame when client joined..[1396]                                  |
|        frame when client quit....[4995]                                  |
|        frames client was active..[3599]                                  |
|        cdat late to server.......[154]                                   |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:7 (4230a)                                                  |
|        frame when client joined..[1641]                                  |
|        frame when client quit....[5041]                                  |
|        frames client was active..[3400]                                  |
|        cdat late to server.......[210]                                   |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+


lets try without massive key flooding



game worked better..

client 7 had client 6 empty..well control method 0
probably due to game move thing not looking far back enough

client 7 was moving very weird like jumping around then syncing back

when the next level started most of the clients did a hard crash...


+--------------------------------------------------------------------------+
|                                                                          |
|                                                                          |
|                                                                          |
|                          [19557] LEVEL 17 DONE                           |
|                                                                          |
|                                                                          |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[17]                                    |
|        total frames..............[19557]                                 |
|        total moves...............[1794]                                  |
|        total time (seconds)......[488]                                   |
|        total time (minutes)......[8]                                     |
|        total tx bytes............[1825308]                               |
|        max tx bytes per frame....[3704]                                  |
|        avg tx bytes per frame....[93]                                    |
|        avg tx bytes per sec......[3733]                                  |
|        total tx packets..........[29862]                                 |
|        max tx packets per frame..[8]                                     |
|        total rx bytes............[277044]                                |
|        max rx bytes per frame....[99]                                    |
|        avg rx bytes per frame....[14]                                    |
|        avg rx bytes per sec......[566]                                   |
|        total rx packets..........[30774]                                 |
|        max rx packets per frame..[11]                                    |
+--------------------------------------------------------------------------+
|        Player:1 (4230-3)                                                 |
|        frame when client joined..[155]                                   |
|        frame when client quit....[19557]                                 |
|        frames client was active..[19402]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[256]                                   |
|        frame when client quit....[19557]                                 |
|        frames client was active..[19301]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6400)                                                  |
|        frame when client joined..[341]                                   |
|        frame when client quit....[19557]                                 |
|        frames client was active..[19216]                                 |
|        cdat late to server.......[1]                                     |
|        chunks late...............[2]                                     |
+--------------------------------------------------------------------------+
|        Player:4 (insp9400)                                               |
|        frame when client joined..[386]                                   |
|        frame when client quit....[19557]                                 |
|        frames client was active..[19171]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:5 (e4230f)                                                 |
|        frame when client joined..[591]                                   |
|        frame when client quit....[19557]                                 |
|        frames client was active..[18966]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:6 (4230a)                                                  |
|        frame when client joined..[676]                                   |
|        frame when client quit....[19557]                                 |
|        frames client was active..[18881]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:7 (e6430)                                                  |
|        frame when client joined..[681]                                   |
|        frame when client quit....[19557]                                 |
|        frames client was active..[18876]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+



this one went better
no bad things, but next level caused everyone to bork hard

+--------------------------------------------------------------------------+
|                                                                          |
|                                                                          |
|                                                                          |
|                          [6248] LEVEL 100 DONE                           |
|                                                                          |
|                                                                          |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[100]                                   |
|        total frames..............[6248]                                  |
|        total moves...............[239]                                   |
|        total time (seconds)......[156]                                   |
|        total time (minutes)......[2]                                     |
|        total tx bytes............[271130]                                |
|        max tx bytes per frame....[914]                                   |
|        avg tx bytes per frame....[43]                                    |
|        avg tx bytes per sec......[1735]                                  |
|        total tx packets..........[5152]                                  |
|        max tx packets per frame..[8]                                     |
|        total rx bytes............[47244]                                 |
|        max rx bytes per frame....[81]                                    |
|        avg rx bytes per frame....[7]                                     |
|        avg rx bytes per sec......[302]                                   |
|        total rx packets..........[5240]                                  |
|        max rx packets per frame..[9]                                     |
+--------------------------------------------------------------------------+
|        Player:1 (4230-3)                                                 |
|        frame when client joined..[191]                                   |
|        frame when client quit....[6248]                                  |
|        frames client was active..[6057]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[456]                                   |
|        frame when client quit....[6248]                                  |
|        frames client was active..[5792]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6400)                                                  |
|        frame when client joined..[701]                                   |
|        frame when client quit....[6248]                                  |
|        frames client was active..[5547]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:4 (insp9400)                                               |
|        frame when client joined..[866]                                   |
|        frame when client quit....[6248]                                  |
|        frames client was active..[5382]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:5 (e6430)                                                  |
|        frame when client joined..[1431]                                  |
|        frame when client quit....[6248]                                  |
|        frames client was active..[4817]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:6 (e4230f)                                                 |
|        frame when client joined..[1506]                                  |
|        frame when client quit....[6248]                                  |
|        frames client was active..[4742]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:7 (4230a)                                                  |
|        frame when client joined..[1689]                                  |
|        frame when client quit....[6248]                                  |
|        frames client was active..[4559]                                  |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+


what did i break so that next level is bad...

the server will need to clear its client states before new level...

char client_chdf[8][2][CHUNK_SIZE];
int client_chdf_id[8][2]; // passcount id

made a function to clear all clinet and player states...


how hard would it be to put the compare back in...
i want to know when i'm out of sync

just before copy back to current game state



void client_apply_diff(void)
{
   // apply dif to base state
   apply_chunk_dif(clientl_chdf, dif, CHUNK_SIZE);

   // copy back to current game state
   chnk_to_state(clientl_chdf);

   // update passcount
   clientl_chdf_id = passcount;

void show_chunk_dif(char *a, char *b)


that all seems to be working good now...

i want to be able to tell the server when I made corrections...
done



even though e6400 start and end diff looked good on server
server was telling me that up to 11 packets were needed to send dif
nothing on the client showed anything bad either

what else do i need to monitor?

the logs on e6400 show that only 2 packets were being received???


+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[34]                                    |
|        total frames..............[29171]                                 |
|        total moves...............[5425]                                  |
|        total time (seconds)......[729]                                   |
|        total time (minutes)......[12]                                    |
|        total tx bytes............[8581574]                               |
|        max tx bytes per frame....[6029]                                  |
|        avg tx bytes per frame....[294]                                   |
|        avg tx bytes per sec......[11767]                                 |
|        total tx packets..........[57956]                                 |
|        max tx packets per frame..[10]                                    |
|        total rx bytes............[526498]                                |
|        max rx bytes per frame....[378]                                   |
|        avg rx bytes per frame....[18]                                    |
|        avg rx bytes per sec......[721]                                   |
|        total rx packets..........[57959]                                 |
|        max rx packets per frame..[42]                                    |
+--------------------------------------------------------------------------+
|        Player:1 (e6400)                                                  |
|        frame when client joined..[543]                                   |
|        frame when client quit....[29171]                                 |
|        frames client was active..[28628]                                 |
|        cdat late to server.......[1]                                     |
|        chunks late...............[6]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (4230-3)                                                 |
|        frame when client joined..[817]                                   |
|        frame when client quit....[29171]                                 |
|        frames client was active..[28354]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6410)                                                  |
|        frame when client joined..[1047]                                  |
|        frame when client quit....[29171]                                 |
|        frames client was active..[28124]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[1]                                     |
+--------------------------------------------------------------------------+
|        Player:4 (insp9400)                                               |
|        frame when client joined..[1159]                                  |
|        frame when client quit....[29171]                                 |
|        frames client was active..[28012]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:5 (e6430)                                                  |
|        frame when client joined..[1478]                                  |
|        frame when client quit....[29171]                                 |
|        frames client was active..[27693]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:6 (4230a)                                                  |
|        frame when client joined..[1568]                                  |
|        frame when client quit....[29171]                                 |
|        frames client was active..[27603]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:7 (e4230f)                                                 |
|        frame when client joined..[1692]                                  |
|        frame when client quit....[29171]                                 |
|        frames client was active..[27479]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[1]                                     |
+--------------------------------------------------------------------------+


do it again...i don't believe them...they were switched...num cor and num packets




+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[34]                                    |
|        total frames..............[21293]                                 |
|        total moves...............[83789]                                 |
|        total time (seconds)......[532]                                   |
|        total time (minutes)......[8]                                     |
|        total tx bytes............[34383720]                              |
|        max tx bytes per frame....[8918]                                  |
|        avg tx bytes per frame....[1614]                                  |
|        avg tx bytes per sec......[64591]                                 |
|        total tx packets..........[128502]                                |
|        max tx packets per frame..[29]                                    |
|        total rx bytes............[1866247]                               |
|        max rx bytes per frame....[505]                                   |
|        avg rx bytes per frame....[87]                                    |
|        avg rx bytes per sec......[3505]                                  |
|        total rx packets..........[207028]                                |
|        max rx packets per frame..[56]                                    |
+--------------------------------------------------------------------------+
|        Player:1 (e6400)                                                  |
|        frame when client joined..[179]                                   |
|        frame when client quit....[21293]                                 |
|        frames client was active..[21114]                                 |
|        cdat late to server.......[275]                                   |
|        chunks late...............[4]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[280]                                   |
|        frame when client quit....[21293]                                 |
|        frames client was active..[21013]                                 |
|        cdat late to server.......[57]                                    |
|        chunks late...............[5]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (insp9400)                                               |
|        frame when client joined..[366]                                   |
|        frame when client quit....[21293]                                 |
|        frames client was active..[20927]                                 |
|        cdat late to server.......[229]                                   |
|        chunks late...............[5]                                     |
+--------------------------------------------------------------------------+
|        Player:4 (e6430)                                                  |
|        frame when client joined..[675]                                   |
|        frame when client quit....[21293]                                 |
|        frames client was active..[20618]                                 |
|        cdat late to server.......[48]                                    |
|        chunks late...............[5]                                     |
+--------------------------------------------------------------------------+
|        Player:5 (4230a)                                                  |
|        frame when client joined..[918]                                   |
|        frame when client quit....[21293]                                 |
|        frames client was active..[20375]                                 |
|        cdat late to server.......[176]                                   |
|        chunks late...............[5]                                     |
+--------------------------------------------------------------------------+
|        Player:6 (e4230f)                                                 |
|        frame when client joined..[1140]                                  |
|        frame when client quit....[21293]                                 |
|        frames client was active..[20153]                                 |
|        cdat late to server.......[170]                                   |
|        chunks late...............[6]                                     |
+--------------------------------------------------------------------------+
|        Player:7 (4230-3)                                                 |
|        frame when client joined..[1282]                                  |
|        frame when client quit....[21293]                                 |
|        frames client was active..[20011]                                 |
|        cdat late to server.......[1]                                     |
|        chunks late...............[4]                                     |
+--------------------------------------------------------------------------+

this ran will full mega keypress on all clients until around
480s or maybe 65535 game moves???

how do I pass it???

yes, sure enough..game move entry pos is sent as 2 bytes

where?

what don't i just go through all my packet and make
passcounts and gamemove index all 4 bytes

1 =           256
2 =        65,535
3 =    16,777,216
4 = 4,294,967,296

time: at 40fps
2 = 27 min
3 = 116 hours
4 = 1242 days (3.4 years)

moves at 40moves/sec * 8 players = 320moves/sec
2 = 204s 3.4 min
3 = 873 min 14H
4 = 155 days

-------------------

old
               Packet("sdat");
               PacketAdd3Bytes(passcount);
               PacketAdd2Bytes(start_entry);
               PacketAdd2Bytes(num_entries);

                  PacketAdd3Bytes(game_moves[x][0]); // passcount
                  PacketAdd2Bytes(game_moves[x][1]); // type
                  PacketAdd2Bytes(game_moves[x][2]); // data 1
                  PacketAdd2Bytes(game_moves[x][3]); // data 2

new

               Packet("sdat");
               PacketAdd4Bytes(passcount);
               PacketAdd4Bytes(start_entry);
               PacketAddByte(num_entries); // never more than 100

                  PacketAdd4Bytes(game_moves[x][0]); // passcount
                  PacketAddByte(game_moves[x][1]); // type
                  PacketAddByte(game_moves[x][2]); // data 1
                  PacketAddByte(game_moves[x][3]); // data 2


also moves are sent with passcount
but what else goes in data

compmove
color

all the rest can be bytes

done




old

         Packet("sdak");
         PacketAdd3Bytes(passcount);
         PacketAdd2Bytes(nep);


new

         Packet("sdak");
         PacketAdd4Bytes(passcount);
         PacketAdd4Bytes(nep);


also changed cdat to use 4 byte passcount



lets see what I've managed to fuck up!!!


holy shit this is the best evah!!
28 minutes 8 players full crazy mode on a level with 100 enemies

+--------------------------------------------------------------------------+
[68977] PLAYER:0 became INACTIVE                                           |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[34]                                    |
|        total frames..............[68977]                                 |
|        total moves...............[411765]                                |
|        total time (seconds)......[1724]                                  |
|        total time (minutes)......[28]                                    |
|        total tx bytes............[73678770]                              |
|        max tx bytes per frame....[6267]                                  |
|        avg tx bytes per frame....[1068]                                  |
|        avg tx bytes per sec......[-19540]                                |
|        total tx packets..........[459180]                                |
|        max tx packets per frame..[38]                                    |
|        total rx bytes............[9354229]                               |
|        max rx bytes per frame....[528]                                   |
|        avg rx bytes per frame....[135]                                   |
|        avg rx bytes per sec......[5424]                                  |
|        total rx packets..........[849525]                                |
|        max rx packets per frame..[51]                                    |
+--------------------------------------------------------------------------+
|        Player:1 (e6400)                                                  |
|        frame when client joined..[231]                                   |
|        frame when client quit....[68977]                                 |
|        frames client was active..[68746]                                 |
|        cdat late to server.......[182]                                   |
|        chunks late...............[3]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6410)                                                  |
|        frame when client joined..[319]                                   |
|        frame when client quit....[68977]                                 |
|        frames client was active..[68658]                                 |
|        cdat late to server.......[2]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (insp9400)                                               |
|        frame when client joined..[375]                                   |
|        frame when client quit....[68977]                                 |
|        frames client was active..[68602]                                 |
|        cdat late to server.......[62]                                    |
|        chunks late...............[1]                                     |
+--------------------------------------------------------------------------+
|        Player:4 (e6430)                                                  |
|        frame when client joined..[692]                                   |
|        frame when client quit....[68977]                                 |
|        frames client was active..[68285]                                 |
|        cdat late to server.......[11]                                    |
|        chunks late...............[1]                                     |
+--------------------------------------------------------------------------+
|        Player:5 (4230a)                                                  |
|        frame when client joined..[936]                                   |
|        frame when client quit....[68977]                                 |
|        frames client was active..[68041]                                 |
|        cdat late to server.......[10]                                    |
|        chunks late...............[1]                                     |
+--------------------------------------------------------------------------+
|        Player:6 (e4230f)                                                 |
|        frame when client joined..[1042]                                  |
|        frame when client quit....[68977]                                 |
|        frames client was active..[67935]                                 |
|        cdat late to server.......[7]                                     |
|        chunks late...............[1]                                     |
+--------------------------------------------------------------------------+
|        Player:7 (4230-3)                                                 |
|        frame when client joined..[1522]                                  |
|        frame when client quit....[68977]                                 |
|        frames client was active..[67455]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+


i am so very hoppy........



- consolidate packets???
can serr or cerr piggyback with something else?


server could add one byte to sdat and send cdat's dropped there...
client could send dif late with sdak


re-do or mess with the passcount mod for chdf
al_fixed...



now... why do my clients lose their base state?

the only indication I have is the numbers on the server...
the src does not inc and the packet size grows...



+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[30]                                    |
|        total frames..............[46199]                                 |
|        total moves...............[301091]                                |
|        total time (seconds)......[1154]                                  |
|        total time (minutes)......[19]                                    |
|        total tx bytes............[37215000]                              |
|        max tx bytes per frame....[4338]                                  |
|        avg tx bytes per frame....[805]                                   |
|        avg tx bytes per sec......[32221]                                 |
|        total tx packets..........[310439]                                |
|        max tx packets per frame..[40]                                    |
|        total rx bytes............[6993172]                               |
|        max rx bytes per frame....[728]                                   |
|        avg rx bytes per frame....[151]                                   |
|        avg rx bytes per sec......[6054]                                  |
|        total rx packets..........[607197]                                |
|        max rx packets per frame..[65]                                    |
+--------------------------------------------------------------------------+
|        Player:1 (4230-3)                                                 |
|        frame when client joined..[247]                                   |
|        frame when client quit....[46199]                                 |
|        frames client was active..[45952]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (e6400)                                                  |
|        frame when client joined..[698]                                   |
|        frame when client quit....[46199]                                 |
|        frames client was active..[45501]                                 |
|        cdat late to server.......[550]                                   |
|        chunks late...............[2]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6410)                                                  |
|        frame when client joined..[892]                                   |
|        frame when client quit....[46199]                                 |
|        frames client was active..[45307]                                 |
|        cdat late to server.......[49]                                    |
|        chunks late...............[5]                                     |
+--------------------------------------------------------------------------+
|        Player:4 (insp9400)                                               |
|        frame when client joined..[942]                                   |
|        frame when client quit....[46199]                                 |
|        frames client was active..[45257]                                 |
|        cdat late to server.......[7]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:5 (4230a)                                                  |
|        frame when client joined..[1271]                                  |
|        frame when client quit....[46199]                                 |
|        frames client was active..[44928]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:6 (e4230f)                                                 |
|        frame when client joined..[1333]                                  |
|        frame when client quit....[46199]                                 |
|        frames client was active..[44866]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:7 (e6430)                                                  |
|        frame when client joined..[1340]                                  |
|        frame when client quit....[46199]                                 |
|        frames client was active..[44859]                                 |
|        cdat late to server.......[0]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+


+--------------------------------------------------------------------------+
|                                                                          |
|                    Local Server(i990) quit the game.                     |
|                                                                          |
+--------------------------------------------------------------------------+
+--------------------------------------------------------------------------+
|        level.....................[31]                                    |
|        total frames..............[72585]                                 |
|        total moves...............[483572]                                |
|        total time (seconds)......[1814]                                  |
|        total time (minutes)......[30]                                    |
|        total tx bytes............[59386791]                              |
|        max tx bytes per frame....[6375]                                  |
|        avg tx bytes per frame....[818]                                   |
|        avg tx bytes per sec......[-26444]                                |
|        total tx packets..........[499658]                                |
|        max tx packets per frame..[34]                                    |
|        total rx bytes............[11289823]                              |
|        max rx bytes per frame....[474]                                   |
|        avg rx bytes per frame....[155]                                   |
|        avg rx bytes per sec......[6221]                                  |
|        total rx packets..........[980486]                                |
|        max rx packets per frame..[44]                                    |
+--------------------------------------------------------------------------+
|        Player:1 (e6400)                                                  |
|        frame when client joined..[101]                                   |
|        frame when client quit....[72585]                                 |
|        frames client was active..[72484]                                 |
|        cdat late to server.......[521]                                   |
|        chunks late...............[1]                                     |
+--------------------------------------------------------------------------+
|        Player:2 (4230-3)                                                 |
|        frame when client joined..[128]                                   |
|        frame when client quit....[72585]                                 |
|        frames client was active..[72457]                                 |
|        cdat late to server.......[29]                                    |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:3 (e6410)                                                  |
|        frame when client joined..[185]                                   |
|        frame when client quit....[72585]                                 |
|        frames client was active..[72400]                                 |
|        cdat late to server.......[9]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:4 (insp9400)                                               |
|        frame when client joined..[222]                                   |
|        frame when client quit....[72585]                                 |
|        frames client was active..[72363]                                 |
|        cdat late to server.......[31]                                    |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:5 (4230a)                                                  |
|        frame when client joined..[261]                                   |
|        frame when client quit....[72585]                                 |
|        frames client was active..[72324]                                 |
|        cdat late to server.......[44]                                    |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:6 (e4230f)                                                 |
|        frame when client joined..[71]                                    |
|        frame when client quit....[72585]                                 |
|        frames client was active..[72514]                                 |
|        cdat late to server.......[2]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+
|        Player:7 (e6430)                                                  |
|        frame when client joined..[100]                                   |
|        frame when client quit....[72585]                                 |
|        frames client was active..[72485]                                 |
|        cdat late to server.......[4]                                     |
|        chunks late...............[0]                                     |
+--------------------------------------------------------------------------+


it looks like the chak packets are not received on the server
on the client, even though they are recived on the correct passcount
because of the ordering they were not process until the next...fix that...

run game will not work unless can look back to start...fixed

make active player draw on top of rest...done
19/02/18 21:09

what am i going to show on the client to tell if netgame is good?

add to client display corrections...





21/02/18 03:42
started log_file_viewer


every log line will have this format:

[xx][x][x....]
type, player, passcount



make some helper functions to make these

void add_log_entry_position_text(int type, int player, int width, int pos, char *txt, char *border, char *fill)

void add_log_entry_sdat_rx_and_game_move_entered(void)
type 21 and use active active local player

void add_log_entry_position_text(int type, int player, int width, int pos, char *txt, char *border, char *fill)

void add_log_entry_header(int type, int player, char *txt, int blank_lines)




10 - regular netplay
11 - join
20 - game init stuff

25 - client time adjust

27 - chdf
28 - chdf piece
29 - chdf when to apply
31 - show diff1
32 - show diff2
35 - cdat
37 - sdat
38 - game_move
39 - sdak
49 - ending stats



i think I have all the logging entries al_fixed......


spent many hours and now I am up to join

i have the main game init stuff and network init stuff done...

22/02/18 06:01

add to client join waiting for chdf...

JOIN is done....

what next...

timer adjust..exactly one use...
add server lead frames...done


next

cdat...
twice in client:
-send cdat
-rx server cdat error

on server, just ran into multi=-line log msg
changed to single line...


al_fixed bug where server would try to make client that just quit rejoin
now server only does that for control method 2

22/02/18 07:26

cdat looks good


how about game move each...


make a backup and go to work...



LOGGING_game_move is not used
LOGGING_game_move_each is used 4 times


changed to use only game_move
used to be multi-line log msg...al_fixed to single line
now only 1 use of game_move


how about sdak...
only one mention...done

sdat should be done too..

what's left is chdf and dif1 and 2

then i can add more like bytes/frame..etc...


23/02/18 03:01

now onto chdf

server now has 2:
- send chdf
- rx chak

client has lots:

- every chdf packet...commented out for now
- when complete chdf rx'd


added:
#define LOGGING_NETPLAY_chdf_all_packets
once each for server and client

#define LOGGING_NETPLAY_chdf_when_to_apply
once when client is comparing passcounts, base state dif state to determine if to apply dif


#define LOGGING_NETPLAY_chdf
server has 2:
- tx chdf
- rx chak

client has 2:
- rx chdf
- tx chak (apply dif)



why does player change color get logged 3 times when joining...
i should set it when player num is set and forget it...


server sets it locally when send join reply
client sets it when receiving join invitation

remove server send when making client active...done

the only thing now is that saved games will not know what player colors to use...

add to when player comes active??

add to change player state?


right now:

0 = passcount
1 = type 1 (player state)
2 = player num
3 = active or not (0 or 1)

change to:
0 - (inactive)

not 0 = active and player_color;

where do I need to fix this...

remove player_color game move and use player state...


how does server mark at beginning of game_moves?
in loop start mode

               int p = 0; // server and local game always use player 0
               add_game_move(0, 0, play_level, 0); // [00] game_start
//               add_game_move(0, 2, p, players[p].color);  // [02] player_color
//               add_game_move(0, 1, p, players[p].active); // [01] player_state

               add_game_move(0, 1, p, players[p].color); // [01] player_state and color


changed in control game move thingy
what adds those game moves?
server when client comes active...


i think i have it working...
i have given up on game_moves being exactly the same on client...
all that matters is they are exactly the same after chdf

game save will only be expected to work on server

in game moves active happens twice and inactive happens twice...

because server sends it twice...

can I make a hold_off to prevent it being sent again?
add to player1 struct:
int made_active_holdoff;

            if (--players1[p].made_active_holdoff < 0) players1[p].made_active_holdoff = 0;

            if ((!players1[p].made_active_holdoff) && (players[p].active == 0) && (players1[p].control_method == 2) && (players1[p].server_sync < 4) && (players1[p].server_sync > -2))
            {
               players1[p].made_active_holdoff = 6;

------------------
23/02/18 06:10
spent a lot of time on this, but looks like its working good.

i think there may be a weird situation when client will not have all the data for other player coming
active beacuse they got that data in a dif update...??


--------------------

they only thing left to check logs for is
#define LOGGING_NETPLAY_show_dif1
#define LOGGING_NETPLAY_show_dif2

they look good...

test..all good.


----------------------------

now back to log viewer...
23/02/18 06:16




lookin good


23/02/18 07:42



this is my mod to prevent same sdat being sent on consecutive passcounts
because really, if they don't have it by then, it not going to be much good to them late..

this method will only send sdat once with same start and num entries..

cant wait to test and see how it works...



            // try to reduce the number of sdat resends
//            int hold_off = 0;
//            if (!players[p].active) hold_off = 4; // only for inactive players (ones that are chasing)
//            if (players1[p].server_last_sdat_sent_frame < passcount - hold_off ) // holdoff x frame before sending again

/*
            int hold_off = 2;
            if (players1[p].server_last_sdat_sent_start == start_entry) // same start pos
               if (players1[p].server_last_sdat_sent_num == num_entries) // same num entries
                  if (players1[p].server_last_sdat_sent_frame < passcount - hold_off ) // holdoff x frame before sending again

  */

            if ((players1[p].server_last_sdat_sent_start != start_entry) || // dif start pos
               (players1[p].server_last_sdat_sent_num != num_entries))      // dif num entries

            {
    //         players1[p].server_last_sdat_sent_frame = passcount;





// how am i going to log bandwidth?

client...
just log itself
hooks in client send and client rx
keep track
per frame, too often
per second, not often enough

- needs tally counters in player struct
- needs hooks to add to them every frame
- needs a way to dump and store results as log entry
- needs running max's
- for tx and rx, bytes and packets


this is what I already have:
server uses it:

   int tx_current_bytes_for_this_frame;
   int tx_current_packets_for_this_frame;

   int tx_total_bytes;
   int tx_total_packets;
   int tx_max_bytes_per_frame;
   int tx_max_packets_per_frame;

   int tx_packets_this_sec;
   int tx_bytes_this_sec;
   int tx_packets_per_sec;
   int tx_bytes_per_sec;

   int rx_current_bytes_for_this_frame;
   int rx_current_packets_for_this_frame;

   int rx_total_bytes;
   int rx_total_packets;
   int rx_max_bytes_per_frame;
   int rx_max_packets_per_frame;

   int rx_packets_this_sec;
   int rx_bytes_this_sec;
   int rx_packets_per_sec;
   int rx_bytes_per_sec;


I could easily use it on a client

then also make server keep track of per client bandwidth

the per_sec ones can be logged





 ---------------


in log viewer:

show legend on side

with key/mouse to enable disable

ex:

C chdat color num_line ins this log

C cdat 13 (200) [on/off]
S sdat 15 (400)

if none are in this log file, don't show


players:
for client, no effect
for server(all, or only one)

----------------------
24/02/18 06:15

viewer is just about done...
- no mouse
add player died to log file...done
server add player filter...done



--------------------------------------------

24/02/18 07:41

moving on...

the next big thing i want to do today is bandwidth logging

- I will have a tally on bytes and packets sent and received per frame, per client

this should do it:
   int tx_current_bytes_for_this_frame;
   int tx_current_packets_for_this_frame;
   int rx_current_bytes_for_this_frame;
   int rx_current_packets_for_this_frame;

-clients only needs to do themselves:
-server needs to do total P0 and all active clients

at a specified interval (num frames)
the tallies will be logged and reset..

also want to keep max per frame and grand total

int tx_total_bytes;
int tx_total_packets;
int tx_max_bytes_per_frame;
int tx_max_packets_per_frame;

int rx_total_bytes;
int rx_total_packets;
int rx_max_bytes_per_frame;
int rx_max_packets_per_frame;


lets do a client first....
use existing vars...

at start of client_control

do stuff then clear tallys


make a new type of log entry..bandwidth

do i want to go one step further and capture
max bytes/sec and max packets/sec
like I do for frames?

sure why not?

at the same time, max sure all tallies are 0'd

done...

its logged, with max's also, one per s


now to do server, per client...


start with server itself


I'm going to need to fix server tx and rx to know what client


modify  void ServerSendTo(void *data, int len, int who)
to take int player also...
did same for receive...

next...made process bandwidth counters a function common to clinet and server!!!

next find out why players drop...


can i draw a graph on banwdith..come on you know you want to...

24/02/18 17:08
graph is done and it looks fine!

more testing...



add to end summary
bandwidth maxs and avg's..done
done 24/02/18 17:51



log frame skip...
E6400 and E6410 had bad frame skip
how to log it, must be done on client...
when to send to server...
no new packets...
client sends cerr to server when chdf is late
no big rush, could sent total late chdt with sdak
also send total frames skippped with sdak...
ok do it....done 24/02/18 18:30


--------------------
i have been having problems with frame skip on clients

i turned off all logging and ran a game for 4000 seconds that did not die
although lots of the clients had a lot of missed frames...

why should it be harder to run?


in the logs when server rx sdak, show the frame skip..done

players colors are all fucked up...
i did it when i moved color and bitmap index to players1
with the new sycn mode, i cant rely on searching game moves to set
proper color, i rely on chdf to do it
switch it back...done




ran a game overnight, 23,000 sec 6.3 hours
6 of 7 clients were still doing good sdat replys, but the game_moves had all maxed out at 1,000,000

40 moves/sec x 7 players = 280moves/sec

1,000,000 / 280 = 3571s / 60 = 59 minutes


------------------

ran another game and overflowed the space for my log files

the server froze and I have no log files
clients log file is 6.5M with 145,000 lines to passcount 114256 (47 min)

started at 04:06:59 ran to 4:23 (must be sped up when client had comm issues



char log_msg[10000000]; // for logging
char log_lines[100000][100]; // for log file viewer
int log_lines_int[100000][3]; // for log file viewer

do i really want to increase this??
try * 10....




i just tried a 2 player game with e6400 and got frame skips there too.

e6400 has frame skips even in single player...

disabled all logging and still skips

disabled netplay and still skips

i need to fix this first, eh?

what dll am i linking with?


tried simple level, same
tried basic theme, same

there is a funny rect section in ur corner that does not update right

skips around 50 frames...

e6400 4G RAM - 64 bit
driver: NVIDIA NVS 160M 9.18.13.4161 from 2015-04-26
updated to 21.21.13.4200 from 2016-10-18
now says NVIDIA QUADRO NVS 160M



i pretty sure its the computer...had troubles with sonar also...

moving on and skipping that computer...



---------------------
ran 4 player game and all clients quit


10][0][5659]+--------------------------------------------------------------------------+
[10][0][5659]|                                                                          |
[10][0][5659]|                    Local Server(i990) quit the game.                     |
[10][0][5659]|                                                                          |
[10][0][5659]+--------------------------------------------------------------------------+
[22][0][5659]+--------------------------------------------------------------------------+
[22][0][5659]|        level.....................[12]                                    |
[22][0][5659]|        total frames..............[5659]                                  |
[22][0][5659]|        total moves...............[20407]                                 |
[22][0][5659]|        total time (seconds)......[141]                                   |
[22][0][5659]|        total time (minutes)......[2]                                     |
[22][0][5659]|        server frames skipped.. ..[148]                                   |
[22][0][5659]|        total tx bytes............[1408208]                               |
[22][0][5659]|        max tx bytes per frame....[3052]                                  |
[22][0][5659]|        avg tx bytes per frame....[248]                                   |
[22][0][5659]|        max rx bytes per second...[27270]                                 |
[22][0][5659]|        avg tx bytes per sec......[9953]                                  |
[22][0][5659]|        total tx packets..........[15224]                                 |
[22][0][5659]|        max tx packets per frame..[24]                                    |
[22][0][5659]|        max tx packets per second.[257]                                   |
[22][0][5659]|        total rx bytes............[506892]                                |
[22][0][5659]|        max rx bytes per frame....[630]                                   |
[22][0][5659]|        avg rx bytes per frame....[89]                                    |
[22][0][5659]|        max rx bytes per second...[6270]                                  |
[22][0][5659]|        avg rx bytes per sec......[3582]                                  |
[22][0][5659]|        total rx packets..........[35111]                                 |
[22][0][5659]|        max rx packets per frame..[63]                                    |
[22][0][5659]|        max rx packets per second.[627]                                   |
[22][0][5659]+--------------------------------------------------------------------------+
[22][1][5659]|        Player:1 (4230-3)                                                 |
[22][1][5659]|        frame when client joined..[250]                                   |
[22][1][5659]|        frame when client quit....[5232]                                  |
[22][0][5659]|        reason for quit...........[unknown]                               |
[22][1][5659]|        frames client was active..[4982]                                  |
[22][1][5659]|        cdat late to server.......[164]                                   |
[22][1][5659]|        chdf late.................[0]                                     |
[22][1][5659]|        chdf corrections..........[6]                                     |
[22][0][5659]|        frames skipped.. ..[100]                                          |
[22][0][5659]|        total tx bytes............[362108]                                |
[22][0][5659]|        max tx bytes per frame....[2811]                                  |
[22][0][5659]|        avg tx bytes per frame....[63]                                    |
[22][0][5659]|        max rx bytes per second...[19074]                                 |
[22][0][5659]|        avg tx bytes per sec......[2559]                                  |
[22][0][5659]|        total tx packets..........[3767]                                  |
[22][0][5659]|        max tx packets per frame..[4]                                     |
[22][0][5659]|        max tx packets per second.[43]                                    |
[22][0][5659]|        total rx bytes............[112345]                                |
[22][0][5659]|        max rx bytes per frame....[112]                                   |
[22][0][5659]|        avg rx bytes per frame....[19]                                    |
[22][0][5659]|        max rx bytes per second...[1261]                                  |
[22][0][5659]|        avg rx bytes per sec......[794]                                   |
[22][0][5659]|        total rx packets..........[7225]                                  |
[22][0][5659]|        max rx packets per frame..[9]                                     |
[22][0][5659]|        max rx packets per second.[81]                                    |
[22][1][5659]+--------------------------------------------------------------------------+
[22][2][5659]|        Player:2 (e4230f)                                                 |
[22][2][5659]|        frame when client joined..[765]                                   |
[22][2][5659]|        frame when client quit....[5031]                                  |
[22][0][5659]|        reason for quit...........[unknown]                               |
[22][2][5659]|        frames client was active..[4266]                                  |
[22][2][5659]|        cdat late to server.......[195]                                   |
[22][2][5659]|        chdf late.................[0]                                     |
[22][2][5659]|        chdf corrections..........[12]                                    |
[22][0][5659]|        frames skipped.. ..[532]                                          |
[22][0][5659]|        total tx bytes............[322207]                                |
[22][0][5659]|        max tx bytes per frame....[2796]                                  |
[22][0][5659]|        avg tx bytes per frame....[56]                                    |
[22][0][5659]|        max rx bytes per second...[7395]                                  |
[22][0][5659]|        avg tx bytes per sec......[2277]                                  |
[22][0][5659]|        total tx packets..........[3540]                                  |
[22][0][5659]|        max tx packets per frame..[5]                                     |
[22][0][5659]|        max tx packets per second.[43]                                    |
[22][0][5659]|        total rx bytes............[103741]                                |
[22][0][5659]|        max rx bytes per frame....[72]                                    |
[22][0][5659]|        avg rx bytes per frame....[18]                                    |
[22][0][5659]|        max rx bytes per second...[1271]                                  |
[22][0][5659]|        avg rx bytes per sec......[733]                                   |
[22][0][5659]|        total rx packets..........[6589]                                  |
[22][0][5659]|        max rx packets per frame..[5]                                     |
[22][0][5659]|        max rx packets per second.[82]                                    |
[22][2][5659]+--------------------------------------------------------------------------+
[22][3][5659]|        Player:3 (4230a)                                                  |
[22][3][5659]|        frame when client joined..[966]                                   |
[22][3][5659]|        frame when client quit....[4828]                                  |
[22][0][5659]|        reason for quit...........[unknown]                               |
[22][3][5659]|        frames client was active..[3862]                                  |
[22][3][5659]|        cdat late to server.......[187]                                   |
[22][3][5659]|        chdf late.................[0]                                     |
[22][3][5659]|        chdf corrections..........[7]                                     |
[22][0][5659]|        frames skipped.. ..[911]                                          |
[22][0][5659]|        total tx bytes............[326899]                                |
[22][0][5659]|        max tx bytes per frame....[2755]                                  |
[22][0][5659]|        avg tx bytes per frame....[57]                                    |
[22][0][5659]|        max rx bytes per second...[9110]                                  |
[22][0][5659]|        avg tx bytes per sec......[2310]                                  |
[22][0][5659]|        total tx packets..........[3363]                                  |
[22][0][5659]|        max tx packets per frame..[4]                                     |
[22][0][5659]|        max tx packets per second.[44]                                    |
[22][0][5659]|        total rx bytes............[98480]                                 |
[22][0][5659]|        max rx bytes per frame....[93]                                    |
[22][0][5659]|        avg rx bytes per frame....[17]                                    |
[22][0][5659]|        max rx bytes per second...[1271]                                  |
[22][0][5659]|        avg rx bytes per sec......[696]                                   |
[22][0][5659]|        total rx packets..........[6262]                                  |
[22][0][5659]|        max rx packets per frame..[7]                                     |
[22][0][5659]|        max rx packets per second.[82]                                    |
[22][3][5659]+--------------------------------------------------------------------------+
[22][4][5659]|        Player:4 (e6430)                                                  |
[22][4][5659]|        frame when client joined..[1245]                                  |
[22][4][5659]|        frame when client quit....[5403]                                  |
[22][0][5659]|        reason for quit...........[unknown]                               |
[22][4][5659]|        frames client was active..[4158]                                  |
[22][4][5659]|        cdat late to server.......[152]                                   |
[22][4][5659]|        chdf late.................[0]                                     |
[22][4][5659]|        chdf corrections..........[7]                                     |
[22][0][5659]|        frames skipped.. ..[536]                                          |
[22][0][5659]|        total tx bytes............[374442]                                |
[22][0][5659]|        max tx bytes per frame....[2803]                                  |
[22][0][5659]|        avg tx bytes per frame....[66]                                    |
[22][0][5659]|        max rx bytes per second...[14449]                                 |
[22][0][5659]|        avg tx bytes per sec......[2646]                                  |
[22][0][5659]|        total tx packets..........[3851]                                  |
[22][0][5659]|        max tx packets per frame..[7]                                     |
[22][0][5659]|        max tx packets per second.[51]                                    |
[22][0][5659]|        total rx bytes............[114919]                                |
[22][0][5659]|        max rx bytes per frame....[131]                                   |
[22][0][5659]|        avg rx bytes per frame....[20]                                    |
[22][0][5659]|        max rx bytes per second...[1271]                                  |
[22][0][5659]|        avg rx bytes per sec......[812]                                   |
[22][0][5659]|        total rx packets..........[7368]                                  |
[22][0][5659]|        max rx packets per frame..[12]                                    |
[22][0][5659]|        max rx packets per second.[82]                                    |
[22][4][5659]+--------------------------------------------------------------------------+


none of them quit on their own I had to kill them with F12




4719 fps = 40

4721 rx'd 81 sdat packets in a single frame from server frame 4722 to 4826

then server sync was 105 and fps got set to 144

4721 fps = 144

at that point server dropped any more cdats





4721 last sdat rx'd from server with 100 game moves

4230a

9064 ends still sending cdats...
around 4800 getting error about server dropping cdat cause they were late



on server:

4720 chdf sent
4731 chak came back

11 frames? kind long

sdak shows 2 frames skipped in that time

server sent 9 sdat's in that time size from 5 to 30

then sdat's sent and sdak's rx'd from 4731 to 4826
when sync > 100 and client dropped


client never got drop...

on server when client is dropped...
- add drop game move

- when drop game move is read


- set keep alive timer for 100 frame to make sure packet is received
- stop rx of cdat for that client


- when drop game move is read:
- on local client, quit immed
- on non-local clinet drop immed
- on server, keep alive for 100 frames to keep sending sdats in hope client will get them...



// drop players
         if (players1[p].last_sdak_rx + 100 < passcount)
         {
            add_game_move(passcount + 2, 8, p, 2); // log server dropped (reason no sdak for 100 frames)
            add_game_move(passcount + 4, 1, p, 0); // make client inactive
            players1[p].drop_in_progress = 100;



// send sdat
      if ((players1[p].control_method == 2) || (players1[p].drop_in_progress))
      {
         if (players1[p].drop_in_progress) players1[p].drop_in_progress--;

// rx cdat
            if (cm == 127) // client quit
            {
               add_game_move(pc+2, 5, p, cm);  // put in future
               sprintf(tmsg2,"<-- player:%d quit\n", p);
            }
            else if (players1[p].drop_in_progress)
            {
                sprintf(tmsg2,"<-- dropped (player drop in progress)";
            }
            else
            {
               // add to game_move array, unless late, then drop and inc error
               if (c_sync >= 0) add_game_move(pc, 5, p, cm);
               else


i should change rx cdat to only accept when control_method == 2


            if (players1[p].control_method != 2) sprintf(tmsg2,"<--player control method != 2");
            else
            {
               // this special case here is to fix bug that occurs when server_lead_frames > 0, and quit move doesn't get synced back to the client
               if (cm == 127) // client quit
               {
                  add_game_move(pc+2, 5, p, cm);  // put in future
                  sprintf(tmsg2,"<-- player:%d quit\n", p);
               }
               else
               {
                  // add to game_move array, unless late, then drop and inc error
                  if (c_sync >= 0) add_game_move(pc, 5, p, cm);
                  else
                  {
                     players1[p].c_sync_err++;
                     sprintf(tmsg2, "<--ERROR! (total errors:%d)\n", players1[p].c_sync_err);

                     Packet("serr"); // server error
                     PacketAdd4Bytes(passcount);
                     PacketAdd4Bytes(c_sync);
                     PacketAdd4Bytes(players1[p].c_sync_err);
                     ServerSendTo(packetbuffer, packetsize, who, p);
                  }
               }
            }

-----------------
this should work...test it....
never got to the point where a client was dropped yet...
server also has frame skip
seems to work a lot better with logging off
lets try TCP...still seems to work...





server can drop client if behaving badly,
client should also detect when netgame has gone bad...
like when.....
   // check to see if game has gone bad and we need to quit
   if ((passcount > 0) && (last_sdat_lpc > 0))
   {
       int ss = passcount - last_sdat_lpc;
       // printf("pc:%d lspc:%d  ss:%d\n", passcount, last_sdat_lpc, ss);
       if (ss > 120)
       {
          sprintf(msg, "Player %d LOST SERVER CONNECTION", active_local_player);
          float stretch = ( (float)SCREEN_W / (strlen(msg)*8)) - 1; // (SCREEN_W / text length*8) -1
          int color = players[active_local_player].color;
          int y_pos = SCREEN_H/2;
          rtextout_centre(screen, msg, SCREEN_W/2, y_pos, color, stretch, 0);
          rest(1000);
          tsw();
          fast_exit();
       }
   }
25/02/18 08:40



ran with 6 clinets for 400s
only 2 frame skips, logging off

try it with bandwidth and netplay only

#define LOGGING
#define LOGGING_NETPLAY
#define LOGGING_NETPLAY_JOIN
#define LOGGING_NETPLAY_bandwidth

ran for 200s only one skip

[10][0][8191]+--------------------------------------------------------------------------+
[10][0][8191]|                                                                          |
[10][0][8191]|                    Local Server(i990) quit the game.                     |
[10][0][8191]|                                                                          |
[10][0][8191]+--------------------------------------------------------------------------+
[22][0][8191]+--------------------------------------------------------------------------+
[22][0][8191]|        level.....................[12]                                    |
[22][0][8191]|        total frames..............[8191]                                  |
[22][0][8191]|        total moves...............[42250]                                 |
[22][0][8191]|        total time (seconds)......[204]                                   |
[22][0][8191]|        total time (minutes)......[3]                                     |
[22][0][8191]|        server frames skipped.. ..[0]                                     |
[22][0][8191]|        total tx bytes............[4739370]                               |
[22][0][8191]|        max tx bytes per frame....[3893]                                  |
[22][0][8191]|        avg tx bytes per frame....[578]                                   |
[22][0][8191]|        max rx bytes per second...[28709]                                 |
[22][0][8191]|        avg tx bytes per sec......[23144]                                 |
[22][0][8191]|        total tx packets..........[44002]                                 |
[22][0][8191]|        max tx packets per frame..[10]                                    |
[22][0][8191]|        max tx packets per second.[244]                                   |
[22][0][8191]|        total rx bytes............[1325617]                               |
[22][0][8191]|        max rx bytes per frame....[341]                                   |
[22][0][8191]|        avg rx bytes per frame....[161]                                   |
[22][0][8191]|        max rx bytes per second...[7523]                                  |
[22][0][8191]|        avg rx bytes per sec......[6473]                                  |
[22][0][8191]|        total rx packets..........[84715]                                 |
[22][0][8191]|        max rx packets per frame..[22]                                    |
[22][0][8191]|        max rx packets per second.[485]                                   |
[22][0][8191]+--------------------------------------------------------------------------+
[22][1][8191]|        Player:1 (m7667)                                                  |
[22][1][8191]|        frame when client joined..[125]                                   |
[22][1][8191]|        frame when client quit....[8191]                                  |
[22][0][8191]|        reason for quit...........[unknown]                               |
[22][1][8191]|        frames client was active..[8066]                                  |
[22][1][8191]|        cdat late to server.......[0]                                     |
[22][1][8191]|        chdf late.................[0]                                     |
[22][1][8191]|        chdf corrections..........[4]                                     |
[22][0][8191]|        frames skipped.. ..[0]                                            |
[22][0][8191]|        total tx bytes............[780945]                                |
[22][0][8191]|        max tx bytes per frame....[3358]                                  |
[22][0][8191]|        avg tx bytes per frame....[95]                                    |
[22][0][8191]|        max rx bytes per second...[7465]                                  |
[22][0][8191]|        avg tx bytes per sec......[3813]                                  |
[22][0][8191]|        total tx packets..........[7452]                                  |
[22][0][8191]|        max tx packets per frame..[5]                                     |
[22][0][8191]|        max tx packets per second.[44]                                    |
[22][0][8191]|        total rx bytes............[219837]                                |
[22][0][8191]|        max rx bytes per frame....[72]                                    |
[22][0][8191]|        avg rx bytes per frame....[26]                                    |
[22][0][8191]|        max rx bytes per second...[1281]                                  |
[22][0][8191]|        avg rx bytes per sec......[1073]                                  |
[22][0][8191]|        total rx packets..........[13880]                                 |
[22][0][8191]|        max rx packets per frame..[5]                                     |
[22][0][8191]|        max rx packets per second.[83]                                    |
[22][1][8191]+--------------------------------------------------------------------------+
[22][2][8191]|        Player:2 (nv59)                                                   |
[22][2][8191]|        frame when client joined..[166]                                   |
[22][2][8191]|        frame when client quit....[8191]                                  |
[22][0][8191]|        reason for quit...........[unknown]                               |
[22][2][8191]|        frames client was active..[8025]                                  |
[22][2][8191]|        cdat late to server.......[0]                                     |
[22][2][8191]|        chdf late.................[0]                                     |
[22][2][8191]|        chdf corrections..........[3]                                     |
[22][0][8191]|        frames skipped.. ..[0]                                            |
[22][0][8191]|        total tx bytes............[816552]                                |
[22][0][8191]|        max tx bytes per frame....[3318]                                  |
[22][0][8191]|        avg tx bytes per frame....[99]                                    |
[22][0][8191]|        max rx bytes per second...[7514]                                  |
[22][0][8191]|        avg tx bytes per sec......[3987]                                  |
[22][0][8191]|        total tx packets..........[7443]                                  |
[22][0][8191]|        max tx packets per frame..[5]                                     |
[22][0][8191]|        max tx packets per second.[44]                                    |
[22][0][8191]|        total rx bytes............[220109]                                |
[22][0][8191]|        max rx bytes per frame....[72]                                    |
[22][0][8191]|        avg rx bytes per frame....[26]                                    |
[22][0][8191]|        max rx bytes per second...[1281]                                  |
[22][0][8191]|        avg rx bytes per sec......[1074]                                  |
[22][0][8191]|        total rx packets..........[13916]                                 |
[22][0][8191]|        max rx packets per frame..[5]                                     |
[22][0][8191]|        max rx packets per second.[83]                                    |
[22][2][8191]+--------------------------------------------------------------------------+
[22][3][8191]|        Player:3 (4230a)                                                  |
[22][3][8191]|        frame when client joined..[686]                                   |
[22][3][8191]|        frame when client quit....[8191]                                  |
[22][0][8191]|        reason for quit...........[unknown]                               |
[22][3][8191]|        frames client was active..[7505]                                  |
[22][3][8191]|        cdat late to server.......[0]                                     |
[22][3][8191]|        chdf late.................[0]                                     |
[22][3][8191]|        chdf corrections..........[2]                                     |
[22][0][8191]|        frames skipped.. ..[0]                                            |
[22][0][8191]|        total tx bytes............[779395]                                |
[22][0][8191]|        max tx bytes per frame....[3338]                                  |
[22][0][8191]|        avg tx bytes per frame....[95]                                    |
[22][0][8191]|        max rx bytes per second...[7142]                                  |
[22][0][8191]|        avg tx bytes per sec......[3806]                                  |
[22][0][8191]|        total tx packets..........[7402]                                  |
[22][0][8191]|        max tx packets per frame..[5]                                     |
[22][0][8191]|        max tx packets per second.[44]                                    |
[22][0][8191]|        total rx bytes............[226593]                                |
[22][0][8191]|        max rx bytes per frame....[83]                                    |
[22][0][8191]|        avg rx bytes per frame....[27]                                    |
[22][0][8191]|        max rx bytes per second...[1271]                                  |
[22][0][8191]|        avg rx bytes per sec......[1106]                                  |
[22][0][8191]|        total rx packets..........[14593]                                 |
[22][0][8191]|        max rx packets per frame..[5]                                     |
[22][0][8191]|        max rx packets per second.[82]                                    |
[22][3][8191]+--------------------------------------------------------------------------+
[22][4][8191]|        Player:4 (e4230f)                                                 |
[22][4][8191]|        frame when client joined..[726]                                   |
[22][4][8191]|        frame when client quit....[8191]                                  |
[22][0][8191]|        reason for quit...........[unknown]                               |
[22][4][8191]|        frames client was active..[7465]                                  |
[22][4][8191]|        cdat late to server.......[0]                                     |
[22][4][8191]|        chdf late.................[0]                                     |
[22][4][8191]|        chdf corrections..........[2]                                     |
[22][0][8191]|        frames skipped.. ..[0]                                            |
[22][0][8191]|        total tx bytes............[767329]                                |
[22][0][8191]|        max tx bytes per frame....[3311]                                  |
[22][0][8191]|        avg tx bytes per frame....[93]                                    |
[22][0][8191]|        max rx bytes per second...[7087]                                  |
[22][0][8191]|        avg tx bytes per sec......[3747]                                  |
[22][0][8191]|        total tx packets..........[7401]                                  |
[22][0][8191]|        max tx packets per frame..[5]                                     |
[22][0][8191]|        max tx packets per second.[44]                                    |
[22][0][8191]|        total rx bytes............[226204]                                |
[22][0][8191]|        max rx bytes per frame....[62]                                    |
[22][0][8191]|        avg rx bytes per frame....[27]                                    |
[22][0][8191]|        max rx bytes per second...[1251]                                  |
[22][0][8191]|        avg rx bytes per sec......[1104]                                  |
[22][0][8191]|        total rx packets..........[14553]                                 |
[22][0][8191]|        max rx packets per frame..[4]                                     |
[22][0][8191]|        max rx packets per second.[81]                                    |
[22][4][8191]+--------------------------------------------------------------------------+
[22][5][8191]|        Player:5 (e6430)                                                  |
[22][5][8191]|        frame when client joined..[926]                                   |
[22][5][8191]|        frame when client quit....[8191]                                  |
[22][0][8191]|        reason for quit...........[unknown]                               |
[22][5][8191]|        frames client was active..[7265]                                  |
[22][5][8191]|        cdat late to server.......[0]                                     |
[22][5][8191]|        chdf late.................[0]                                     |
[22][5][8191]|        chdf corrections..........[2]                                     |
[22][0][8191]|        frames skipped.. ..[0]                                            |
[22][0][8191]|        total tx bytes............[740133]                                |
[22][0][8191]|        max tx bytes per frame....[3105]                                  |
[22][0][8191]|        avg tx bytes per frame....[90]                                    |
[22][0][8191]|        max rx bytes per second...[6888]                                  |
[22][0][8191]|        avg tx bytes per sec......[3614]                                  |
[22][0][8191]|        total tx packets..........[7327]                                  |
[22][0][8191]|        max tx packets per frame..[4]                                     |
[22][0][8191]|        max tx packets per second.[43]                                    |
[22][0][8191]|        total rx bytes............[223973]                                |
[22][0][8191]|        max rx bytes per frame....[62]                                    |
[22][0][8191]|        avg rx bytes per frame....[27]                                    |
[22][0][8191]|        max rx bytes per second...[1271]                                  |
[22][0][8191]|        avg rx bytes per sec......[1093]                                  |
[22][0][8191]|        total rx packets..........[14408]                                 |
[22][0][8191]|        max rx packets per frame..[4]                                     |
[22][0][8191]|        max rx packets per second.[82]                                    |
[22][5][8191]+--------------------------------------------------------------------------+
[22][6][8191]|        Player:6 (4230-3)                                                 |
[22][6][8191]|        frame when client joined..[1366]                                  |
[22][6][8191]|        frame when client quit....[8191]                                  |
[22][0][8191]|        reason for quit...........[unknown]                               |
[22][6][8191]|        frames client was active..[6825]                                  |
[22][6][8191]|        cdat late to server.......[0]                                     |
[22][6][8191]|        chdf late.................[0]                                     |
[22][6][8191]|        chdf corrections..........[2]                                     |
[22][0][8191]|        frames skipped.. ..[1]                                            |
[22][0][8191]|        total tx bytes............[819876]                                |
[22][0][8191]|        max tx bytes per frame....[3259]                                  |
[22][0][8191]|        avg tx bytes per frame....[100]                                   |
[22][0][8191]|        max rx bytes per second...[7687]                                  |
[22][0][8191]|        avg tx bytes per sec......[4003]                                  |
[22][0][8191]|        total tx packets..........[6878]                                  |
[22][0][8191]|        max tx packets per frame..[5]                                     |
[22][0][8191]|        max tx packets per second.[44]                                    |
[22][0][8191]|        total rx bytes............[208316]                                |
[22][0][8191]|        max rx bytes per frame....[72]                                    |
[22][0][8191]|        avg rx bytes per frame....[25]                                    |
[22][0][8191]|        max rx bytes per second...[1260]                                  |
[22][0][8191]|        avg rx bytes per sec......[1017]                                  |
[22][0][8191]|        total rx packets..........[13334]                                 |
[22][0][8191]|        max rx packets per frame..[5]                                     |
[22][0][8191]|        max rx packets per second.[82]                                    |
[22][6][8191]+--------------------------------------------------------------------------+


lets try a tougher level...

39??

still awesome


[10][0][11543]+--------------------------------------------------------------------------+
[10][0][11543]|                                                                          |
[10][0][11543]|                    Local Server(i990) quit the game.                     |
[10][0][11543]|                                                                          |
[10][0][11543]+--------------------------------------------------------------------------+
[22][0][11543]+--------------------------------------------------------------------------+
[22][0][11543]|        level.....................[39]                                    |
[22][0][11543]|        total frames..............[11543]                                 |
[22][0][11543]|        total moves...............[58366]                                 |
[22][0][11543]|        total time (seconds)......[288]                                   |
[22][0][11543]|        total time (minutes)......[4]                                     |
[22][0][11543]|        server frames skipped.. ..[0]                                     |
[22][0][11543]|        total tx bytes............[6371098]                               |
[22][0][11543]|        max tx bytes per frame....[7327]                                  |
[22][0][11543]|        avg tx bytes per frame....[551]                                   |
[22][0][11543]|        max rx bytes per second...[31594]                                 |
[22][0][11543]|        avg tx bytes per sec......[22077]                                 |
[22][0][11543]|        total tx packets..........[64557]                                 |
[22][0][11543]|        max tx packets per frame..[12]                                    |
[22][0][11543]|        max tx packets per second.[242]                                   |
[22][0][11543]|        total rx bytes............[1920204]                               |
[22][0][11543]|        max rx bytes per frame....[301]                                   |
[22][0][11543]|        avg rx bytes per frame....[166]                                   |
[22][0][11543]|        max rx bytes per second...[7482]                                  |
[22][0][11543]|        avg rx bytes per sec......[6654]                                  |
[22][0][11543]|        total rx packets..........[121660]                                |
[22][0][11543]|        max rx packets per frame..[18]                                    |
[22][0][11543]|        max rx packets per second.[482]                                   |
[22][0][11543]+--------------------------------------------------------------------------+
[22][1][11543]|        Player:1 (nv59)                                                   |
[22][1][11543]|        frame when client joined..[245]                                   |
[22][1][11543]|        frame when client quit....[6264]                                  |
[22][0][11543]|        reason for quit...........[unknown]                               |
[22][1][11543]|        frames client was active..[6019]                                  |
[22][1][11543]|        cdat late to server.......[0]                                     |
[22][1][11543]|        chdf late.................[0]                                     |
[22][1][11543]|        chdf corrections..........[3]                                     |
[22][0][11543]|        frames skipped.. ..[1]                                            |
[22][0][11543]|        total tx bytes............[577744]                                |
[22][0][11543]|        max tx bytes per frame....[2013]                                  |
[22][0][11543]|        avg tx bytes per frame....[50]                                    |
[22][0][11543]|        max rx bytes per second...[6320]                                  |
[22][0][11543]|        avg tx bytes per sec......[2002]                                  |
[22][0][11543]|        total tx packets..........[5535]                                  |
[22][0][11543]|        max tx packets per frame..[3]                                     |
[22][0][11543]|        max tx packets per second.[42]                                    |
[22][0][11543]|        total rx bytes............[166527]                                |
[22][0][11543]|        max rx bytes per frame....[62]                                    |
[22][0][11543]|        avg rx bytes per frame....[14]                                    |
[22][0][11543]|        max rx bytes per second...[1271]                                  |
[22][0][11543]|        avg rx bytes per sec......[577]                                   |
[22][0][11543]|        total rx packets..........[10628]                                 |
[22][0][11543]|        max rx packets per frame..[4]                                     |
[22][0][11543]|        max rx packets per second.[82]                                    |
[22][1][11543]+--------------------------------------------------------------------------+
[22][2][11543]|        Player:2 (m7667)                                                  |
[22][2][11543]|        frame when client joined..[327]                                   |
[22][2][11543]|        frame when client quit....[11543]                                 |
[22][0][11543]|        reason for quit...........[unknown]                               |
[22][2][11543]|        frames client was active..[11216]                                 |
[22][2][11543]|        cdat late to server.......[0]                                     |
[22][2][11543]|        chdf late.................[0]                                     |
[22][2][11543]|        chdf corrections..........[3]                                     |
[22][0][11543]|        frames skipped.. ..[0]                                            |
[22][0][11543]|        total tx bytes............[1023763]                               |
[22][0][11543]|        max tx bytes per frame....[2004]                                  |
[22][0][11543]|        avg tx bytes per frame....[88]                                    |
[22][0][11543]|        max rx bytes per second...[5938]                                  |
[22][0][11543]|        avg tx bytes per sec......[3547]                                  |
[22][0][11543]|        total tx packets..........[10848]                                 |
[22][0][11543]|        max tx packets per frame..[3]                                     |
[22][0][11543]|        max tx packets per second.[42]                                    |
[22][0][11543]|        total rx bytes............[330783]                                |
[22][0][11543]|        max rx bytes per frame....[62]                                    |
[22][0][11543]|        avg rx bytes per frame....[28]                                    |
[22][0][11543]|        max rx bytes per second...[1250]                                  |
[22][0][11543]|        avg rx bytes per sec......[1146]                                  |
[22][0][11543]|        total rx packets..........[21250]                                 |
[22][0][11543]|        max rx packets per frame..[4]                                     |
[22][0][11543]|        max rx packets per second.[81]                                    |
[22][2][11543]+--------------------------------------------------------------------------+
[22][3][11543]|        Player:3 (4230-3)                                                 |
[22][3][11543]|        frame when client joined..[445]                                   |
[22][3][11543]|        frame when client quit....[11543]                                 |
[22][0][11543]|        reason for quit...........[unknown]                               |
[22][3][11543]|        frames client was active..[11098]                                 |
[22][3][11543]|        cdat late to server.......[0]                                     |
[22][3][11543]|        chdf late.................[0]                                     |
[22][3][11543]|        chdf corrections..........[2]                                     |
[22][0][11543]|        frames skipped.. ..[0]                                            |
[22][0][11543]|        total tx bytes............[1057110]                               |
[22][0][11543]|        max tx bytes per frame....[1976]                                  |
[22][0][11543]|        avg tx bytes per frame....[91]                                    |
[22][0][11543]|        max rx bytes per second...[5917]                                  |
[22][0][11543]|        avg tx bytes per sec......[3663]                                  |
[22][0][11543]|        total tx packets..........[10840]                                 |
[22][0][11543]|        max tx packets per frame..[3]                                     |
[22][0][11543]|        max tx packets per second.[42]                                    |
[22][0][11543]|        total rx bytes............[331916]                                |
[22][0][11543]|        max rx bytes per frame....[72]                                    |
[22][0][11543]|        avg rx bytes per frame....[28]                                    |
[22][0][11543]|        max rx bytes per second...[1250]                                  |
[22][0][11543]|        avg rx bytes per sec......[1150]                                  |
[22][0][11543]|        total rx packets..........[21371]                                 |
[22][0][11543]|        max rx packets per frame..[5]                                     |
[22][0][11543]|        max rx packets per second.[81]                                    |
[22][3][11543]+--------------------------------------------------------------------------+
[22][4][11543]|        Player:4 (4230a)                                                  |
[22][4][11543]|        frame when client joined..[725]                                   |
[22][4][11543]|        frame when client quit....[11543]                                 |
[22][0][11543]|        reason for quit...........[unknown]                               |
[22][4][11543]|        frames client was active..[10818]                                 |
[22][4][11543]|        cdat late to server.......[0]                                     |
[22][4][11543]|        chdf late.................[1]                                     |
[22][4][11543]|        chdf corrections..........[1]                                     |
[22][0][11543]|        frames skipped.. ..[0]                                            |
[22][0][11543]|        total tx bytes............[1071183]                               |
[22][0][11543]|        max tx bytes per frame....[2038]                                  |
[22][0][11543]|        avg tx bytes per frame....[92]                                    |
[22][0][11543]|        max rx bytes per second...[6577]                                  |
[22][0][11543]|        avg tx bytes per sec......[3711]                                  |
[22][0][11543]|        total tx packets..........[10820]                                 |
[22][0][11543]|        max tx packets per frame..[3]                                     |
[22][0][11543]|        max tx packets per second.[42]                                    |
[22][0][11543]|        total rx bytes............[327072]                                |
[22][0][11543]|        max rx bytes per frame....[104]                                   |
[22][0][11543]|        avg rx bytes per frame....[28]                                    |
[22][0][11543]|        max rx bytes per second...[1271]                                  |
[22][0][11543]|        avg rx bytes per sec......[1133]                                  |
[22][0][11543]|        total rx packets..........[20902]                                 |
[22][0][11543]|        max rx packets per frame..[6]                                     |
[22][0][11543]|        max rx packets per second.[82]                                    |
[22][4][11543]+--------------------------------------------------------------------------+
[22][5][11543]|        Player:5 (e4230f)                                                 |
[22][5][11543]|        frame when client joined..[765]                                   |
[22][5][11543]|        frame when client quit....[11543]                                 |
[22][0][11543]|        reason for quit...........[unknown]                               |
[22][5][11543]|        frames client was active..[10778]                                 |
[22][5][11543]|        cdat late to server.......[0]                                     |
[22][5][11543]|        chdf late.................[0]                                     |
[22][5][11543]|        chdf corrections..........[1]                                     |
[22][0][11543]|        frames skipped.. ..[0]                                            |
[22][0][11543]|        total tx bytes............[1072744]                               |
[22][0][11543]|        max tx bytes per frame....[2019]                                  |
[22][0][11543]|        avg tx bytes per frame....[92]                                    |
[22][0][11543]|        max rx bytes per second...[6565]                                  |
[22][0][11543]|        avg tx bytes per sec......[3717]                                  |
[22][0][11543]|        total tx packets..........[10816]                                 |
[22][0][11543]|        max tx packets per frame..[3]                                     |
[22][0][11543]|        max tx packets per second.[42]                                    |
[22][0][11543]|        total rx bytes............[326257]                                |
[22][0][11543]|        max rx bytes per frame....[73]                                    |
[22][0][11543]|        avg rx bytes per frame....[28]                                    |
[22][0][11543]|        max rx bytes per second...[1271]                                  |
[22][0][11543]|        avg rx bytes per sec......[1130]                                  |
[22][0][11543]|        total rx packets..........[20826]                                 |
[22][0][11543]|        max rx packets per frame..[5]                                     |
[22][0][11543]|        max rx packets per second.[82]                                    |
[22][5][11543]+--------------------------------------------------------------------------+
[22][6][11543]|        Player:6 (e6430)                                                  |
[22][6][11543]|        frame when client joined..[805]                                   |
[22][6][11543]|        frame when client quit....[11543]                                 |
[22][0][11543]|        reason for quit...........[unknown]                               |
[22][6][11543]|        frames client was active..[10738]                                 |
[22][6][11543]|        cdat late to server.......[0]                                     |
[22][6][11543]|        chdf late.................[0]                                     |
[22][6][11543]|        chdf corrections..........[0]                                     |
[22][0][11543]|        frames skipped.. ..[0]                                            |
[22][0][11543]|        total tx bytes............[1035780]                               |
[22][0][11543]|        max tx bytes per frame....[2092]                                  |
[22][0][11543]|        avg tx bytes per frame....[89]                                    |
[22][0][11543]|        max rx bytes per second...[6764]                                  |
[22][0][11543]|        avg tx bytes per sec......[3589]                                  |
[22][0][11543]|        total tx packets..........[10813]                                 |
[22][0][11543]|        max tx packets per frame..[3]                                     |
[22][0][11543]|        max tx packets per second.[42]                                    |
[22][0][11543]|        total rx bytes............[327756]                                |
[22][0][11543]|        max rx bytes per frame....[62]                                    |
[22][0][11543]|        avg rx bytes per frame....[28]                                    |
[22][0][11543]|        max rx bytes per second...[1261]                                  |
[22][0][11543]|        avg rx bytes per sec......[1135]                                  |
[22][0][11543]|        total rx packets..........[20977]                                 |
[22][0][11543]|        max rx packets per frame..[4]                                     |
[22][0][11543]|        max rx packets per second.[81]                                    |
[22][6][11543]+--------------------------------------------------------------------------+
[22][7][11543]|        Player:7 (nv59)                                                   |
[22][7][11543]|        frame when client joined..[6765]                                  |
[22][7][11543]|        frame when client quit....[11543]                                 |
[22][0][11543]|        reason for quit...........[unknown]                               |
[22][7][11543]|        frames client was active..[4778]                                  |
[22][7][11543]|        cdat late to server.......[0]                                     |
[22][7][11543]|        chdf late.................[0]                                     |
[22][7][11543]|        chdf corrections..........[1]                                     |
[22][0][11543]|        frames skipped.. ..[1]                                            |
[22][0][11543]|        total tx bytes............[485981]                                |
[22][0][11543]|        max tx bytes per frame....[1535]                                  |
[22][0][11543]|        avg tx bytes per frame....[42]                                    |
[22][0][11543]|        max rx bytes per second...[6726]                                  |
[22][0][11543]|        avg tx bytes per sec......[1684]                                  |
[22][0][11543]|        total tx packets..........[4809]                                  |
[22][0][11543]|        max tx packets per frame..[3]                                     |
[22][0][11543]|        max tx packets per second.[42]                                    |
[22][0][11543]|        total rx bytes............[109141]                                |
[22][0][11543]|        max rx bytes per frame....[73]                                    |
[22][0][11543]|        avg rx bytes per frame....[9]                                     |
[22][0][11543]|        max rx bytes per second...[1061]                                  |
[22][0][11543]|        avg rx bytes per sec......[378]                                   |
[22][0][11543]|        total rx packets..........[5666]                                  |
[22][0][11543]|        max rx packets per frame..[4]                                     |
[22][0][11543]|        max rx packets per second.[61]                                    |
[22][7][11543]+--------------------------------------------------------------------------+



how about if I turn on all logging...

getting lots of skips...

what logging is it???

on server looks like
sdat
sdak
cdat
are the worst offenders


on client
move
cdfwhen
cdat
sdat
timer


this is my new list:
-----------------------
#define LOGGING
#define LOGGING_NETPLAY
#define LOGGING_NETPLAY_JOIN
#define LOGGING_NETPLAY_bandwidth
//#define LOGGING_NETPLAY_client_timer_adjust
//#define LOGGING_NETPLAY_cdat
//#define LOGGING_NETPLAY_game_move
//#define LOGGING_NETPLAY_sdat
//#define LOGGING_NETPLAY_sdak
#define LOGGING_NETPLAY_chdf
//#define LOGGING_NETPLAY_chdf_all_packets
//#define LOGGING_NETPLAY_chdf_when_to_apply
#define LOGGING_NETPLAY_show_dif1
#define LOGGING_NETPLAY_show_dif2



[10][0][293599]+--------------------------------------------------------------------------+
[10][0][293599]|                                                                          |
[10][0][293599]|                    Local Server(i990) quit the game.                     |
[10][0][293599]|                                                                          |
[10][0][293599]+--------------------------------------------------------------------------+
[22][0][293599]+--------------------------------------------------------------------------+
[22][0][293599]|        level.....................[39]                                    |
[22][0][293599]|        total frames..............[293599]                                |
[22][0][293599]|        total moves...............[880368]                                |
[22][0][293599]|        total time (seconds)......[7339]                                  |
[22][0][293599]|        total time (minutes)......[122]                                   |
[22][0][293599]|        server frames skipped.. ..[4551]                                  |
[22][0][293599]|        total tx bytes............[107774771]                             |
[22][0][293599]|        max tx bytes per frame....[6731]                                  |
[22][0][293599]|        avg tx bytes per frame....[367]                                   |
[22][0][293599]|        max rx bytes per second...[29231]                                 |
[22][0][293599]|        avg tx bytes per sec......[54]                                    |
[22][0][293599]|        total tx packets..........[1064829]                               |
[22][0][293599]|        max tx packets per frame..[12]                                    |
[22][0][293599]|        max tx packets per second.[242]                                   |
[22][0][293599]|        total rx bytes............[39266932]                              |
[22][0][293599]|        max rx bytes per frame....[394]                                   |
[22][0][293599]|        avg rx bytes per frame....[133]                                   |
[22][0][293599]|        max rx bytes per second...[7533]                                  |
[22][0][293599]|        avg rx bytes per sec......[5349]                                  |
[22][0][293599]|        total rx packets..........[2771691]                               |
[22][0][293599]|        max rx packets per frame..[25]                                    |
[22][0][293599]|        max rx packets per second.[486]                                   |
[22][0][293599]+--------------------------------------------------------------------------+
[22][1][293599]|        Player:1 (m7667)                                                  |
[22][1][293599]|        frame when client joined..[125]                                   |
[22][1][293599]|        frame when client quit....[291765]                                |
[22][0][293599]|        reason for quit...........[server drop (no sdak for 100 frames)]  |
[22][1][293599]|        frames client was active..[291640]                                |
[22][1][293599]|        cdat late to server.......[936]                                   |
[22][1][293599]|        chdf late.................[4]                                     |
[22][1][293599]|        chdf corrections..........[509]                                   |
[22][0][293599]|        frames skipped.. ..[2128]                                         |
[22][0][293599]|        total tx bytes............[17827828]                              |
[22][0][293599]|        max tx bytes per frame....[1982]                                  |
[22][0][293599]|        avg tx bytes per frame....[60]                                    |
[22][0][293599]|        max rx bytes per second...[6059]                                  |
[22][0][293599]|        avg tx bytes per sec......[2428]                                  |
[22][0][293599]|        total tx packets..........[177596]                                |
[22][0][293599]|        max tx packets per frame..[4]                                     |
[22][0][293599]|        max tx packets per second.[42]                                    |
[22][0][293599]|        total rx bytes............[6547593]                               |
[22][0][293599]|        max rx bytes per frame....[94]                                    |
[22][0][293599]|        avg rx bytes per frame....[22]                                    |
[22][0][293599]|        max rx bytes per second...[1282]                                  |
[22][0][293599]|        avg rx bytes per sec......[892]                                   |
[22][0][293599]|        total rx packets..........[462113]                                |
[22][0][293599]|        max rx packets per frame..[7]                                     |
[22][0][293599]|        max rx packets per second.[82]                                    |
[22][1][293599]+--------------------------------------------------------------------------+
[22][2][293599]|        Player:2 (nv59)                                                   |
[22][2][293599]|        frame when client joined..[205]                                   |
[22][2][293599]|        frame when client quit....[291705]                                |
[22][0][293599]|        reason for quit...........[server drop (no sdak for 100 frames)]  |
[22][2][293599]|        frames client was active..[291500]                                |
[22][2][293599]|        cdat late to server.......[1224]                                  |
[22][2][293599]|        chdf late.................[34]                                    |
[22][2][293599]|        chdf corrections..........[542]                                   |
[22][0][293599]|        frames skipped.. ..[82903]                                        |
[22][0][293599]|        total tx bytes............[18136170]                              |
[22][0][293599]|        max tx bytes per frame....[2017]                                  |
[22][0][293599]|        avg tx bytes per frame....[61]                                    |
[22][0][293599]|        max rx bytes per second...[5898]                                  |
[22][0][293599]|        avg tx bytes per sec......[2470]                                  |
[22][0][293599]|        total tx packets..........[177908]                                |
[22][0][293599]|        max tx packets per frame..[5]                                     |
[22][0][293599]|        max tx packets per second.[42]                                    |
[22][0][293599]|        total rx bytes............[6548163]                               |
[22][0][293599]|        max rx bytes per frame....[93]                                    |
[22][0][293599]|        avg rx bytes per frame....[22]                                    |
[22][0][293599]|        max rx bytes per second...[1272]                                  |
[22][0][293599]|        avg rx bytes per sec......[892]                                   |
[22][0][293599]|        total rx packets..........[462126]                                |
[22][0][293599]|        max rx packets per frame..[8]                                     |
[22][0][293599]|        max rx packets per second.[82]                                    |
[22][2][293599]+--------------------------------------------------------------------------+
[22][3][293599]|        Player:3 (4230a)                                                  |
[22][3][293599]|        frame when client joined..[565]                                   |
[22][3][293599]|        frame when client quit....[291545]                                |
[22][0][293599]|        reason for quit...........[server drop (no sdak for 100 frames)]  |
[22][3][293599]|        frames client was active..[290980]                                |
[22][3][293599]|        cdat late to server.......[1664]                                  |
[22][3][293599]|        chdf late.................[26]                                    |
[22][3][293599]|        chdf corrections..........[486]                                   |
[22][0][293599]|        frames skipped.. ..[5280]                                         |
[22][0][293599]|        total tx bytes............[17732348]                              |
[22][0][293599]|        max tx bytes per frame....[2015]                                  |
[22][0][293599]|        avg tx bytes per frame....[60]                                    |
[22][0][293599]|        max rx bytes per second...[6385]                                  |
[22][0][293599]|        avg tx bytes per sec......[2415]                                  |
[22][0][293599]|        total tx packets..........[178256]                                |
[22][0][293599]|        max tx packets per frame..[5]                                     |
[22][0][293599]|        max tx packets per second.[42]                                    |
[22][0][293599]|        total rx bytes............[6549680]                               |
[22][0][293599]|        max rx bytes per frame....[94]                                    |
[22][0][293599]|        avg rx bytes per frame....[22]                                    |
[22][0][293599]|        max rx bytes per second...[1271]                                  |
[22][0][293599]|        avg rx bytes per sec......[892]                                   |
[22][0][293599]|        total rx packets..........[462358]                                |
[22][0][293599]|        max rx packets per frame..[6]                                     |
[22][0][293599]|        max rx packets per second.[82]                                    |
[22][3][293599]+--------------------------------------------------------------------------+
[22][4][293599]|        Player:4 (e4230f)                                                 |
[22][4][293599]|        frame when client joined..[605]                                   |
[22][4][293599]|        frame when client quit....[291605]                                |
[22][0][293599]|        reason for quit...........[server drop (no sdak for 100 frames)]  |
[22][4][293599]|        frames client was active..[291000]                                |
[22][4][293599]|        cdat late to server.......[1612]                                  |
[22][4][293599]|        chdf late.................[16]                                    |
[22][4][293599]|        chdf corrections..........[494]                                   |
[22][0][293599]|        frames skipped.. ..[5382]                                         |
[22][0][293599]|        total tx bytes............[17647387]                              |
[22][0][293599]|        max tx bytes per frame....[1933]                                  |
[22][0][293599]|        avg tx bytes per frame....[60]                                    |
[22][0][293599]|        max rx bytes per second...[5967]                                  |
[22][0][293599]|        avg tx bytes per sec......[2404]                                  |
[22][0][293599]|        total tx packets..........[178210]                                |
[22][0][293599]|        max tx packets per frame..[5]                                     |
[22][0][293599]|        max tx packets per second.[42]                                    |
[22][0][293599]|        total rx bytes............[6551181]                               |
[22][0][293599]|        max rx bytes per frame....[93]                                    |
[22][0][293599]|        avg rx bytes per frame....[22]                                    |
[22][0][293599]|        max rx bytes per second...[1271]                                  |
[22][0][293599]|        avg rx bytes per sec......[892]                                   |
[22][0][293599]|        total rx packets..........[462496]                                |
[22][0][293599]|        max rx packets per frame..[7]                                     |
[22][0][293599]|        max rx packets per second.[82]                                    |
[22][4][293599]+--------------------------------------------------------------------------+
[22][5][293599]|        Player:5 (e6430)                                                  |
[22][5][293599]|        frame when client joined..[805]                                   |
[22][5][293599]|        frame when client quit....[291465]                                |
[22][0][293599]|        reason for quit...........[server drop (no sdak for 100 frames)]  |
[22][5][293599]|        frames client was active..[290660]                                |
[22][5][293599]|        cdat late to server.......[342]                                   |
[22][5][293599]|        chdf late.................[19]                                    |
[22][5][293599]|        chdf corrections..........[487]                                   |
[22][0][293599]|        frames skipped.. ..[1598]                                         |
[22][0][293599]|        total tx bytes............[17552755]                              |
[22][0][293599]|        max tx bytes per frame....[1911]                                  |
[22][0][293599]|        avg tx bytes per frame....[59]                                    |
[22][0][293599]|        max rx bytes per second...[5941]                                  |
[22][0][293599]|        avg tx bytes per sec......[2391]                                  |
[22][0][293599]|        total tx packets..........[177034]                                |
[22][0][293599]|        max tx packets per frame..[3]                                     |
[22][0][293599]|        max tx packets per second.[42]                                    |
[22][0][293599]|        total rx bytes............[6550450]                               |
[22][0][293599]|        max rx bytes per frame....[72]                                    |
[22][0][293599]|        avg rx bytes per frame....[22]                                    |
[22][0][293599]|        max rx bytes per second...[1281]                                  |
[22][0][293599]|        avg rx bytes per sec......[892]                                   |
[22][0][293599]|        total rx packets..........[462325]                                |
[22][0][293599]|        max rx packets per frame..[7]                                     |
[22][0][293599]|        max rx packets per second.[83]                                    |
[22][5][293599]+--------------------------------------------------------------------------+
[22][6][293599]|        Player:6 (4230-3)                                                 |
[22][6][293599]|        frame when client joined..[1645]                                  |
[22][6][293599]|        frame when client quit....[291965]                                |
[22][0][293599]|        reason for quit...........[server drop (no sdak for 100 frames)]  |
[22][6][293599]|        frames client was active..[290320]                                |
[22][6][293599]|        cdat late to server.......[2]                                     |
[22][6][293599]|        chdf late.................[28]                                    |
[22][6][293599]|        chdf corrections..........[484]                                   |
[22][0][293599]|        frames skipped.. ..[184]                                          |
[22][0][293599]|        total tx bytes............[18838463]                              |
[22][0][293599]|        max tx bytes per frame....[1978]                                  |
[22][0][293599]|        avg tx bytes per frame....[64]                                    |
[22][0][293599]|        max rx bytes per second...[6470]                                  |
[22][0][293599]|        avg tx bytes per sec......[2566]                                  |
[22][0][293599]|        total tx packets..........[175757]                                |
[22][0][293599]|        max tx packets per frame..[3]                                     |
[22][0][293599]|        max tx packets per second.[42]                                    |
[22][0][293599]|        total rx bytes............[6519280]                               |
[22][0][293599]|        max rx bytes per frame....[83]                                    |
[22][0][293599]|        avg rx bytes per frame....[22]                                    |
[22][0][293599]|        max rx bytes per second...[1281]                                  |
[22][0][293599]|        avg rx bytes per sec......[888]                                   |
[22][0][293599]|        total rx packets..........[460242]                                |
[22][0][293599]|        max rx packets per frame..[5]                                     |
[22][0][293599]|        max rx packets per second.[83]                                    |
[22][6][293599]+--------------------------------------------------------------------------+



---------------------




what happens at level done?

- when any player touches unlocked exit...
- extern int level_done = 1;
in proc_controllers (which is called every frame in loop)
game move level done is inserted at passcount

see right there is a problem...
client should not be doing this
client should never add anything into game_moves, only server

-------------
moved it to:

if (players1[p].control_method == 0) // local single player control
{
   if (level_done) add_game_move(passcount, 6, 0, 0); // insert level done into game move


and

if (players1[p].control_method == 3) server_local_control(p);

void server_local_control(int p)
{
   set_comp_move_from_player_key_check(p);                  // but don't set controls !!!
   int fpc = passcount + control_lead_frames;               // add CLF to passcount
   if (players1[p].comp_move != players1[p].old_comp_move)  // players keys have changed
   {
      players1[p].old_comp_move = players1[p].comp_move;
      int cm = players1[p].comp_move;
      add_game_move(fpc, 5, p, cm);
   }
   if (level_done) add_game_move(fpc, 6, 0, 0);             // insert level done into game move
}


then what happens...

when game move is read...

            case 6:  // 'level done'
               #ifdef LOGGING_NETPLAY
               if ((ima_client) || (ima_server))
               {
                  extern int play_level;
                  sprintf(msg,"LEVEL %d DONE", play_level);
                  add_log_entry_header(10, 0, msg, 3);

                  for (int p=0; p<NUM_PLAYERS; p++)
                     if (players[p].active) players1[p].quit_reason = 9;

                  if (ima_client) log_ending_stats();
                  if (ima_server) log_ending_stats_server();

               }
               #endif
               proc_level_done();


void proc_level_done(void)
{
   stretch_text("Level", "Done!", 9);
//   if ((!ima_server) && (!ima_client)) rest(1000);
   rest(1000);

   #ifdef NETPLAY
   if (ima_server)
   {
      void server_flush(void);
      server_flush();
   }
   if (ima_client)
   {
      void client_flush(void);
      client_flush();
      for (int x=0; x<10; x++) client_statistic[x] = 0;
   }

   // free all the used clients, so they can be re-assigned on the next level
   for (int p=0; p<NUM_PLAYERS; p++)
      if (players1[p].control_method == 9) players1[p].control_method = 0;

   // set all clients inactive on server and client, to force them to re-chase and lock on the new level
   for (int p=0; p<NUM_PLAYERS; p++)
      if ((players1[p].control_method == 2) || (players1[p].control_method == 4)) players[p].active = 0;
   #endif

   stop_sound();
   blind_save_game_moves(1);
   play_level++;
   start_mode = 3; // level_done
}


26/02/18 04:16

cleaned the client init code
logging and errors fixed
26/02/18 04:17


i think the level done thing has to do with states

make sure states on sever are good..
everything gets reset on level done..


when client does join...
waits at passcount 0 till server sends chdf

when client does level done
waits at passcount 0 till server sends chdf

server is sending a chdf with 0-0
and client is blindly applying it

---------
modified server to not send chdf on passcount 0;


modified client to check before applying dif
the check was always there, but it was called everry frame to see
if it was time to run apply_dif

moved the check into apply_dif, so that even when called to blindly apply_dif at join
the check is still done

now in the loop apply_dif is called every frame, it it checks internally to see if its time

   #ifdef LOGGING_NETPLAY_chdf_when_to_apply
   sprintf(msg, "base:[%d] - last dif:[%d to %d]\n", clientl_chdf_id,  dif_id[0], dif_id[1] );
   add_log_entry2(29, active_local_player, msg);
   #endif

   // check to see if passcounts match and its time to apply dif
   if (passcount == dif_id[1])           // current passcount is dif target
      if (clientl_chdf_id == dif_id[0])  // stored state is dif source
      {



this seems to work good, but wrong number of clients and colors are in new level...

after level done, server looks good, but no server player shows on client

server shows as active 0 on client..isnt that one of those things that chdf does??

chdf is never being applied beacuse base is -2..make reset set it to 0;

that seeems to fix it...


----------------------------------------

now I would like server to send cdhf faster at join
or when level done

how about in send chdf, when deciding who to send to,
made that all better....

now send_chdf is a stand alone funtion that only send to one specific client
and I have another that chooses when and who to send to
i added to player1 struct join_chdf_sent
and immediatley send to all player when that is set to 0;
----------------------------------------
done 26/02/18 05:46


----------------------------------------
add connection or channel info to logs..done
----------------------------------------
done 26/02/18 05:46


---------------------------------------------------------------
log file does not work good when level done...
scrolling is done based on passcounts...

i should dump log to disk whenever level done...
should be easy to do and easy to put back if i need to trouble shoot level done

added log_msg[0] = 0; to save_log..

now I also want to add level x started to logs..done

no header past first level...but i'll live
---------------------------------------------------------------
done 26/02/18 06:14

---------------------------------------------------------------
I don't log frame_skip, do I?, yes i do
its passed from client to server with sdak, and is captured there
server's frame skip is only display at end of level..
---------------------------------------------------------------
26/02/18 06:23


what dx version of windows?all the ones i've checked have 11
except for win 10 which has 12


works just as good with win10 on woprk laptop..
show compressed dif sizes and then mess with zlib  compression levels...
not much diff...
actually much of the bandwidth comes from sdat's



---------------------------------------------------------------
why do some clients never get off dif start0
server sends chdf on join...s0 d154
before chak rx'd
server sends ANOTHER chdf on timer..s0 d160
server gets ack for 154, but no longer has 154 to set as new base

after that all chdf's sent are from s0
and no chaks are rx'd

client get chdf 0-154 and applies
new client base is 154
when server keeps sending fron 0-100, 0-200 etc
client cant do anything, because clinet base is 154

how can I fix this...

- make a hold off to not send another chdf if enough time has not passed

- make a way to recover
on server:
if can't set new base, make base 0 again
done

on client if you get a dif from 0 just do it
- set to zero and dif

now
don't apply dif from block until r'xd, let regular apply dif catch it

don;t need to pass chekc_diff to apply dif, only skip  if passcount == 0
only one call to apply_dif now...

if bases don't match, and server sent dif from 0, set clinet base to 0
if bases don't match, and server sent dif from NOT 0, RAISE ERROR and don;t apply
---------------------------------------------------------------
done and tested27/02/18 06:29


show packets/s per client on server..done

i want to know how much bandwidth sdat uses compared to chdf

------------------------------------------------------
this is what sdat does with chdf completely disabled:
------------------------------------------------------

---idle-------------------------------------------------
Bytes
tx  p0[   182] p1-7[ 26]
rx  p0[   294] p1-7[ 42] maxed client[1240]
Packets
tx  p0[14] p1-7[2]
rx  p0[14] p1-7[2]

---one client max keypress
Bytes
tx  p0[ 7,000] p1-7[1000]
rx  p0[ 6,000] p1-7[840] maxed client[1240]
Packets
tx  p0[280] p1-7[40]
rx  p0[320] p1-7[40]  maxed client[80]

---all clients max keypress
Bytes
tx  p0[30,000] p1-7[4000]
rx  p0[ 8,000] p1-7[1240]
Packets
tx  p0[280] p1-7[40]
rx  p0[560] p1-7[80]

------------------------------------------------------
this is how much chdf uses when set chdf_freq = 40
------------------------------------------------------
Bytes
tx  p0[~1,700] same as client getting chdf
rx  p0[    10] same as client getting chdf
Packets
tx  p0[2] same as client getting chdf
rx  p0[1] same as client getting chdf
-------------------------------------------------------------------------
done 27/02/18 17:58



now I want to adjust clf on client as see what happens
2 has pretty frequent errors
3 is good most of the time
4 is safest
5 is starting to get noticeably laggy

and server lead frames...
0 works as good as 1

default just change from
s=1 c=4 to
s=0 c=3

get some minor errors

i want to see on client how many rx'd game moves are wasted
both at the reject packet level and reject entry double
done

test 0-3 for a bit...

get some late moves from server and some late chdf
try slf = 1

i like that better, lets go with
clf=3 and slf=1

--------------------------------

make that the default if cfg erased

add zlib comp to cfg

i can make some variables change while the game is running

client has complete control over its own clf
it could set it based on server_sync

client also has complete control over its own server_lead frames
if receiving things too late it could increase the delay


server has complete control over chdf_freq and could dynamically adjust it
tried that..its good at 40

server could also experiment with different zlib compression ratios..done
not much diff
-------------------------------------------------------
done messing with var's
final default values:
chdf_freq 40
zlib_cmp = 7
server_lead_frames = 1
contol_lead_frames = 3


-------------------------------------------------------
make 40 fps default, reset on every start and dont bother saving...done
add zlib cmp to cfg..done
add deathmatch bullet damage to cfg and gui ..done
pass dpd to client at join
-------------------------------------------------------
done 28/02/18 05:52


---------------------------------------------------------------
lower the time or make more unobtrusive...player died!!

draw on lower layer?? // not gonna happens
if I want to draw below players and stuff, i'll have to draw on level_buffer

lower from 80 to 60
reduced total time from 80 frames to 60 frames
reduced the percentage move / center freeze
old:
0.0 to 0.3 grow
0.3 to 0.7 stay
0.7 to 1.0 shrink
new:
0.0 to 0.4 grow
0.4 to 0.6 stay
0.6 to 1.0 shrink

---------------------------------------------------------------
done 28/02/18 06:12


---------------------------------------------------------------
add better death scene animation for player
at least make it so he can't still move (change shape)
should be easy to do in get player shape...
---------------------------------------------------------------
28/02/18 06:20


backup time

28/02/18 07:44



---------------------------------------------------------------
make logging enabled by variables not #ifdef's, both

#define LOGGING
#define LOGGING_NETPLAY
#define LOGGING_NETPLAY_JOIN
#define LOGGING_NETPLAY_bandwidth
#define LOGGING_NETPLAY_client_timer_adjust
#define LOGGING_NETPLAY_cdat
#define LOGGING_NETPLAY_game_move
#define LOGGING_NETPLAY_sdat
#define LOGGING_NETPLAY_sdak
#define LOGGING_NETPLAY_chdf
#define LOGGING_NETPLAY_chdf_all_packets
#define LOGGING_NETPLAY_chdf_when_to_apply
#define LOGGING_NETPLAY_show_dif1
#define LOGGING_NETPLAY_show_dif2

int L_LOGGING = 0; done 15
int L_LOGGING_NETPLAY = 0; 41 (control-8-done) (loop-1-done) (main-5 changed to logging) (client-13-done) (server-14-done)
int L_LOGGING_NETPLAY_JOIN = 0; done 10
int L_LOGGING_NETPLAY_bandwidth = 0; done 6
int L_LOGGING_NETPLAY_client_timer_adjust = 0; done 1
int L_LOGGING_NETPLAY_cdat = 0; done 3
int L_LOGGING_NETPLAY_game_move = 0; done 1
int L_LOGGING_NETPLAY_sdat = 0; done 3
int L_LOGGING_NETPLAY_sdak = 0; done 2
int L_LOGGING_NETPLAY_chdf = 0; done 6
int L_LOGGING_NETPLAY_chdf_all_packets = 0; done 2
int L_LOGGING_NETPLAY_chdf_when_to_apply = 0; done 1
int L_LOGGING_NETPLAY_show_dif1 = 0; done 7
int L_LOGGING_NETPLAY_show_dif2 = 0; done 7


make UDP vs TCP not need recompile
done...
now both CHANNEL and CONNECTION are defined
I use the global int TCP to choose which
make it a config int, same as logging ones...
---------------------------------------------------------------
this is all done..test  01/03/18 06:04
tests good....

now CONNECTION and CHANNEL mode are always both compiled
also all logging is always compiled

they are controlled with variable, not defines...

there should be no need for any user to recompile...




make netplay shut down nicely so client can rejoin without quitting
where is client quit code??
ClientExit is never called...
same with  ServerExit...
where is the best place to do that?
the game exits with ESC
in control when game exit move is received
done 01/03/18 13:57..need to test


in options menu - start up splash screen on/off
done 01/03/18 14:25


when leaving join netgame from menu, put us back in same menu choice
done at end of loop when going back to menu...
02/03/18 02:48

log_file_viewer does not handle log files that have non linear passcounts
like more than one level played, or re-joins
also wont go to the end if lots of entries have same passcount
added line_mode
scroll by lines or passcount (toggle with L)
done 02/03/18 03:08


---------------------------------------------------------------
there are only 2 places that active_local_player is set:
- when declared in main, its set to 0
- after client join, its set to what the server says
do i need to reset it to zero when client quits?...probably not
how about when client becomes inactive; reset all players data?..no

it looks like client quit immediately after join beacause it thinks it lost server connection..
why is this not logged?
server never knows that client has gone and keeps sending sdat sync and chdf packets
for at least 500 frames...why does sever not drop??
server does not drop because player has not become active yet
server only looks to drop active players with control method 2
lets remove the active check...
might break some stuff, but then we'll fix it...

now I can't make anything fail

now server stops sending sdats after 100 frames
but chdf still keep getting sent and no logs
when player become inactive in control, only happens if player was already active
al_fixed by making a special case...

on client it looks like last sdat_rx is kept from previous game..
set in chdf block after setting pascounts...done

set players1[p].last_sdak_rx on server when client is sent join invitation..done
wrong...i should set 'last_sdat_lpc' not in player struct...done

on client when quits, no quit message is shown, but when game is re-joined it shows
i should clear game moves in client init...
isn't it done with start_mode?..yes
moves are getting sync'd...

on server when join is sent or when chdf??
set game_move entry pos for that client to prevent for moves being sync'd
just do join

set it on client at join also:
players1[cp].game_move_entry_pos = server_game_move_entry_pos;

still not al_fixed... could it be that you just need to reset join_quit timers??
yes...that al_fixed it....
---------------------------------------------------------------
02/03/18 04:31



---------------------------------------------------------------
clean up the client and server exit stuff
make just one function to call:done

i waste a lot of time trying to figure out why player quit or go inactive

if i made it part of the game move it could simplify things

right now i use:
0 - passcount
1 - type
2 - player
3 - 1-15 = color

if its not zero it means go active and color = value
change to mean if > 63 then quit reason

   if (r == 64) sprintf(tmsg,"player quit game with ESC");
   if (r == 65) sprintf(tmsg,"player quit with F12");
   if (r == 70) sprintf(tmsg,"server drop (server sync > 100)");
   if (r == 71) sprintf(tmsg,"server drop (no sdak for 100 frames)");
   if (r == 74) sprintf(tmsg,"client never became active");
   if (r == 75) sprintf(tmsg,"client lost server connection");
   if (r == 80) sprintf(tmsg,"level done");
   if (r == 90) sprintf(tmsg,"local client quit");
   if (r == 91) sprintf(tmsg,"local server quit");
   if (r == 92) sprintf(tmsg,"remote server quit");

do it....
join stuff can stay the same

fixed a bunch of stuff in game move....
now to find and fix all the places that a quit game move gets entered..

the code in control where players become inactive has been
re-factored and is much clearer now...
this took many hours...
---------------------------------------------------------------
02/03/18 07:00



---------------------------------------------------------------
make bandwidth work without logging enabled
make a seperate conditional for that??
make it a define for now, but will probbaly always leave it on
i don't think it will slow anything down
#define NETPLAY_bandwidth_tracking
---------------------------------------------------------------
..done 03/03/18 04:57


---------------------------------------------------------------
first time splash screen on/off is pressed nothing happens if on already...
its because I also use that variable to tell if i hav alreadt done
the splash screen since staring the game...
---------------------------------------------------------------
done 03/03/18 05:33


---------------------------------------------------------------
re-do fps display:
- if not netgame:
only show if fps != 40
or frame skipped

- if netgame
- only show if skipped

---------------------------------------------------------------
done 03/03/18 05:34


---------------------------------------------------------------
make simple netgame displays
that can be used in release version

switch between modes with F10

server
-------------------
simplest (bottom line display)
---------------------
- Netgame Server (hostname)
- Clients:   (show number of active clients)
- bandwidth (TX + RX) bytes/sec


clients
-------------------
simplest (bottom line display)
---------------------
- Netgame Client (hostname)
- Sync

more complex...keep like it is

maybe make the key combination harder to get like CTRL ALT F10
---------------------------------------------------------------
done...
03/03/18 07:22


---------------------------------------------------------------
I just made a huge change to the game
since they very begining I have been saving sptit001.pm the same way:
read and write each pixel with get_pixel and put_pixel then save to file
and the pallete the same way
now I use load_bitmap and save_bitmap
the file_size is the same...
it loads so much faster, even on win 10...
---------------------------------------------------------------
03/03/18 09:01







---------------------------------------------------------------
how hard would it be to try other color depths..why?
just to fix win7 and win 10 fullscreen bugs??yes
added    set_color_depth(32);
just before init screen
shapes all look good, but colors are bad...
what about fullscreen mode...

disable so i can try it..
shape colors all look good...of course text and primitives are bad...

try 16 same
15 and 24 wont even run.. bad crash
8 has same frame skipping as 16 or 32
win 10 with 8 bit, now has no full screen problem???
win 7 still does

changing a bunch of color things:

old: color
new: palette_color[color]

in 8 bit mode, this will have no effect...

a big problem i will have is that in my 8 bit mode
color 0 is transparent
while in truecolor modes it is max red, green, min blue

what if I set that on load??? done

done:
------
frame and title
title...
frame
menu (1 line!!)
draw_percent_bar

different approach....
found and changed all textout...done

next line (with it came hline, vline and spline)...done
next rect and rectfill...done
the only ones i have not changed are in bled where the draw is a direct copy from getpixel
partway through bled i gave up on bled...

circle..done

now to fix players..
base shape 400

y = 3
x = 6 color 8
x = 7 color 56
x = 8 color 136

colors
8   32 0 63 (8519935)
56  24 0 50 (6357195)
136 14 0 29 (3670133)

the problem with my color 5 is that its max red and blue!!!
which is transparent in true color modes...

how to fix...

go back the old

lets see if I can save it the new way...yes i can...

now I should set all the shapes alpha at load...done

now fix fill l2000..done

now try in full screen mode...looking good, no skip even at full 32 bit

next items draw..done
enemy draw...done

when blocks are removed with keys or destroyed with bombs..fix that

switch blocks....done...

breakable blocks...done...

door shapes...done...
----------------------------------------
majority of 32 bit color done...
03/03/18 20:54


backup time....



---------------------------------------------------------------
fix netgame configuration to look nice...
can't pass any dynamic colors to GUI, so I made three versions
for 8, 16, and 32 bit, with hard coded colors...
---------------------------------------------------------------
done 04/03/18 04:58


---------------------------------------------------------------
reset splash screen when running from menu
---------------------------------------------------------------
done 04/03/18 05:02


---------------------------------------------------------------
fix screen messages to not have black background
---------------------------------------------------------------
join_quit...
actually rtextout_centre
al_fixed:
void rtextout_centre(ALLEGRO_BITMAP *dbmp, char *txt1, int x, int y, int col, float scale, int rot)
void mtextout(ALLEGRO_BITMAP *dbmp, char *txt1, int x, int y, float x_scale, float y_scale, int col)
void mtextout_centre(ALLEGRO_BITMAP *dbmp, char *txt1, int x, int y, float x_scale, float y_scale, int col)
removed stretch text and replaced with show_level_done
---------------------------------------------------------------
done 04/03/18 06:25




---------------------------------------------------------------

force level editor to use 8 bit??
or just bled???

even in 8 bit mode:
block editor is crazy slow.. but is just used to set shape attributes
bitmap editor is kinda slow too...even in 8 bit mode

lets try adding screen buffers:
first to select bitmap proc..done
then copy bitmap...done
animation_proc()..done
int draw_current_bitmap(int msg, DIALOG *d, int c) ..done
int new_draw_csp(int msg, DIALOG *d, int c) ..done

now i get weird crash when putting pixels on bitmap...
it freezes and I have no idea where....

bascially dont do anything with show hide mouse in DRAW part of GUI
al_fixed...

make sure save sprit is not messed up with 32 bit stuff
fix bled so i can edit shapes still..force 8 bit mode??

make it so bitmap editor will not run in anything but 8 bit
done...

block editor??? what is it good for??
choosing what goes in selection window??
actually i don't even think it does that....
i can set all shape attributes with bitmap editor...
ok then its done...
comment it out...
totally killed all trace of it, even killed its source file bled.cpp

now make the rest of level editor work with 32 bit...


main cursor...done

draw item and view item...done...

quit dialog...actually all the dialogs
wherever i set gui_fg_color..al_fixed


zomm full screen good, no changes needed

viewers..all good

creators..all good

lift text edit...done

i dont like the cursor blink with empty shape

try a real blank...255 is totally blank
no just rectfill it...done...
test level editor in 32 bit
level editor is all done unless i find more bugs
block editor is completely gone
bitmap editor wont run unless in 8 bit mode
---------------------------------------------------------------
04/03/18 10:42



---------------------------------------------------------------
fix full screen mode disable
---------------------------------------------------------------
by default use 32 bit
save in config file
added new globals
int color_depth = 32;
int auto_full_screen = 1;
save and load to cfg...
just about done...
04/03/18 13:16
---------------------------------------------------------------



dis-allow trying to set mode larger than desktop
already done, but bring back equal if windoewed mode
al_fixed


why does the word sync show in ur corner
al_fixed







lets make color depth 16 a thing too...
make global int dsx = 0, dsy = 0;
can i get color depth too?? yes...

make a test for my game...
like load a saved game and run it at the current graphics mode
as fast as i can, drawing every frame and see how fast it is

---------------------------------
- Speed test for i990
Desktop resolution: [2048 x 1152] 32 bit
OS detected:        [Windows 7] [ver:6.1]
Allegro version:    [Allegro 4.4.2, MinGW32]

[2048 x 1152] 32 bit fullscreen..[ 68] Frames per second -- [14ms] per frame
[2048 x 1152] 16 bit fullscreen..[119] Frames per second -- [8ms] per frame
[2048 x 1152]  8 bit fullscreen..[124] Frames per second -- [8ms] per frame
[1024 x  768] 32 bit windowed....[138] Frames per second -- [7ms] per frame
[1024 x  768] 16 bit windowed....[169] Frames per second -- [5ms] per frame
[1024 x  768]  8 bit windowed....[182] Frames per second -- [5ms] per frame
[1024 x  768] 32 bit fullscreen..[130] Frames per second -- [7ms] per frame
[1024 x  768] 16 bit fullscreen..[212] Frames per second -- [4ms] per frame
[1024 x  768]  8 bit fullscreen..[246] Frames per second -- [4ms] per frame
[ 800 x  600] 32 bit windowed....[165] Frames per second -- [6ms] per frame
[ 800 x  600] 16 bit windowed....[214] Frames per second -- [4ms] per frame
[ 800 x  600]  8 bit windowed....[247] Frames per second -- [4ms] per frame
[ 800 x  600] 32 bit fullscreen..[160] Frames per second -- [6ms] per frame
[ 800 x  600] 16 bit fullscreen..[255] Frames per second -- [3ms] per frame
[ 800 x  600]  8 bit fullscreen..[314] Frames per second -- [3ms] per frame

---------------------------------
- Speed test for m7667
Desktop resolution: [1280 x 1024] 32 bit
OS detected:        [Windows 7] [ver:6.1]
Allegro version:    [Allegro 4.4.2, MinGW32]

[1280 x 1024] 32 bit fullscreen..[ 38] Frames per second -- [25ms] per frame
[1280 x 1024] 16 bit fullscreen..[ 72] Frames per second -- [13ms] per frame
[1280 x 1024]  8 bit fullscreen..[ 91] Frames per second -- [10ms] per frame
[1024 x  768] 32 bit windowed....[ 45] Frames per second -- [22ms] per frame
[1024 x  768] 16 bit windowed....[ 74] Frames per second -- [13ms] per frame
[1024 x  768]  8 bit windowed....[ 97] Frames per second -- [10ms] per frame
[1024 x  768] 32 bit fullscreen..[ 45] Frames per second -- [21ms] per frame
[1024 x  768] 16 bit fullscreen..[ 89] Frames per second -- [11ms] per frame
[1024 x  768]  8 bit fullscreen..[116] Frames per second -- [8ms] per frame
[ 800 x  600] 32 bit windowed....[ 55] Frames per second -- [18ms] per frame
[ 800 x  600] 16 bit windowed....[ 89] Frames per second -- [11ms] per frame
[ 800 x  600]  8 bit windowed....[126] Frames per second -- [7ms] per frame
[ 800 x  600] 32 bit fullscreen..[ 55] Frames per second -- [17ms] per frame
[ 800 x  600] 16 bit fullscreen..[100] Frames per second -- [9ms] per frame
[ 800 x  600]  8 bit fullscreen..[139] Frames per second -- [7ms] per frame


---------------------------------
- Speed test for nv59
Desktop resolution: [1600 x 1200] 32 bit
OS detected:        [Windows 7] [ver:6.1]
Allegro version:    [Allegro 4.4.2, MinGW32]

[1600 x 1200] 32 bit fullscreen..[ 54] Frames per second -- [18ms] per frame
[1600 x 1200] 16 bit fullscreen..[ 85] Frames per second -- [11ms] per frame
[1600 x 1200]  8 bit fullscreen..[ 96] Frames per second -- [10ms] per frame
[1024 x  768] 32 bit windowed....[ 82] Frames per second -- [12ms] per frame
[1024 x  768] 16 bit windowed....[ 80] Frames per second -- [12ms] per frame
[1024 x  768]  8 bit windowed....[ 82] Frames per second -- [12ms] per frame
[1024 x  768] 32 bit fullscreen..[ 56] Frames per second -- [17ms] per frame
[1024 x  768] 16 bit fullscreen..[ 84] Frames per second -- [11ms] per frame
[1024 x  768]  8 bit fullscreen..[ 93] Frames per second -- [10ms] per frame
[ 800 x  600] 32 bit windowed....[ 70] Frames per second -- [14ms] per frame
[ 800 x  600] 16 bit windowed....[ 85] Frames per second -- [11ms] per frame
[ 800 x  600]  8 bit windowed....[110] Frames per second -- [9ms] per frame
[ 800 x  600] 32 bit fullscreen..[ 50] Frames per second -- [19ms] per frame
[ 800 x  600] 16 bit fullscreen..[ 67] Frames per second -- [14ms] per frame
[ 800 x  600]  8 bit fullscreen..[ 90] Frames per second -- [11ms] per frame


---------------------------------
- Speed test for DESKTOP-DBNSJH8
Desktop resolution: [1366 x 768] 32 bit
OS detected:        [Windows 7] [ver:6.2]
Allegro version:    [Allegro 4.4.2, MinGW32]

[1366 x  768] 32 bit fullscreen..[ 78] Frames per second -- [12ms] per frame
[1366 x  768] 16 bit fullscreen..[ 75] Frames per second -- [13ms] per frame
[1366 x  768]  8 bit fullscreen..[ 91] Frames per second -- [10ms] per frame
Error setting: [1024 x 768] gfx_card:2 color_depth:32
Error setting: [1024 x 768] gfx_card:2 color_depth:16
Error setting: [1024 x 768] gfx_card:2 color_depth:8
[1024 x  768] 32 bit fullscreen..[ 88] Frames per second -- [11ms] per frame
[1024 x  768] 16 bit fullscreen..[ 88] Frames per second -- [11ms] per frame
[1024 x  768]  8 bit fullscreen..[113] Frames per second -- [8ms] per frame
[ 800 x  600] 32 bit windowed....[131] Frames per second -- [7ms] per frame
[ 800 x  600] 16 bit windowed....[169] Frames per second -- [5ms] per frame
[ 800 x  600]  8 bit windowed....[202] Frames per second -- [4ms] per frame
[ 800 x  600] 32 bit fullscreen..[113] Frames per second -- [8ms] per frame
[ 800 x  600] 16 bit fullscreen..[120] Frames per second -- [8ms] per frame
[ 800 x  600]  8 bit fullscreen..[147] Frames per second -- [6ms] per frame


---------------------------------
- Speed test for pfv
Desktop resolution: [1600 x 1200] 32 bit
OS detected:        [Windows XP] [ver:5.1]
Allegro version:    [Allegro 4.4.2, MinGW32]

[1600 x 1200] 32 bit fullscreen..[ 26] Frames per second -- [38ms] per frame
[1600 x 1200] 16 bit fullscreen..[ 48] Frames per second -- [20ms] per frame
[1600 x 1200]  8 bit fullscreen..[ 61] Frames per second -- [16ms] per frame
[1024 x  768] 32 bit windowed....[ 39] Frames per second -- [25ms] per frame
[1024 x  768] 16 bit windowed....[ 60] Frames per second -- [16ms] per frame
[1024 x  768]  8 bit windowed....[ 75] Frames per second -- [13ms] per frame
[1024 x  768] 32 bit fullscreen..[ 41] Frames per second -- [24ms] per frame
[1024 x  768] 16 bit fullscreen..[ 70] Frames per second -- [14ms] per frame
[1024 x  768]  8 bit fullscreen..[ 87] Frames per second -- [11ms] per frame
[ 800 x  600] 32 bit windowed....[ 46] Frames per second -- [21ms] per frame
[ 800 x  600] 16 bit windowed....[ 75] Frames per second -- [13ms] per frame
[ 800 x  600]  8 bit windowed....[102] Frames per second -- [9ms] per frame
[ 800 x  600] 32 bit fullscreen..[ 49] Frames per second -- [20ms] per frame
[ 800 x  600] 16 bit fullscreen..[ 89] Frames per second -- [11ms] per frame
[ 800 x  600]  8 bit fullscreen..[106] Frames per second -- [9ms] per frame

---------------------------------
- Speed test for e6410
Desktop resolution: [1280 x 800] 32 bit
OS detected:        [Windows 7] [ver:6.1]
Allegro version:    [Allegro 4.4.2, MinGW32]

[1280 x  800] 32 bit fullscreen..[ 66] Frames per second -- [15ms] per frame
[1280 x  800] 16 bit fullscreen..[130] Frames per second -- [7ms] per frame
[1280 x  800]  8 bit fullscreen..[174] Frames per second -- [5ms] per frame
[1024 x  768] 32 bit windowed....[ 90] Frames per second -- [11ms] per frame
[1024 x  768] 16 bit windowed....[ 56] Frames per second -- [17ms] per frame
[1024 x  768]  8 bit windowed....[149] Frames per second -- [6ms] per frame
[1024 x  768] 32 bit fullscreen..[ 80] Frames per second -- [12ms] per frame
[1024 x  768] 16 bit fullscreen..[143] Frames per second -- [6ms] per frame
[1024 x  768]  8 bit fullscreen..[186] Frames per second -- [5ms] per frame
[ 800 x  600] 32 bit windowed....[104] Frames per second -- [9ms] per frame
[ 800 x  600] 16 bit windowed....[ 64] Frames per second -- [15ms] per frame
[ 800 x  600]  8 bit windowed....[196] Frames per second -- [5ms] per frame
[ 800 x  600] 32 bit fullscreen..[106] Frames per second -- [9ms] per frame
[ 800 x  600] 16 bit fullscreen..[173] Frames per second -- [5ms] per frame
[ 800 x  600]  8 bit fullscreen..[229] Frames per second -- [4ms] per frame

---------------------------------
- Speed test for e4230f
Desktop resolution: [1280 x 800] 32 bit
OS detected:        [Windows 7] [ver:6.1]
Allegro version:    [Allegro 4.4.2, MinGW32]

[1280 x  800] 32 bit fullscreen..[ 38] Frames per second -- [25ms] per frame
[1280 x  800] 16 bit fullscreen..[ 71] Frames per second -- [14ms] per frame
[1280 x  800]  8 bit fullscreen..[ 86] Frames per second -- [11ms] per frame
[1024 x  768] 32 bit windowed....[ 40] Frames per second -- [24ms] per frame
[1024 x  768] 16 bit windowed....[ 63] Frames per second -- [15ms] per frame
[1024 x  768]  8 bit windowed....[ 82] Frames per second -- [12ms] per frame
[1024 x  768] 32 bit fullscreen..[ 41] Frames per second -- [24ms] per frame
[1024 x  768] 16 bit fullscreen..[ 78] Frames per second -- [12ms] per frame
[1024 x  768]  8 bit fullscreen..[ 98] Frames per second -- [10ms] per frame
[ 800 x  600] 32 bit windowed....[ 41] Frames per second -- [24ms] per frame
[ 800 x  600] 16 bit windowed....[ 73] Frames per second -- [13ms] per frame
[ 800 x  600]  8 bit windowed....[101] Frames per second -- [9ms] per frame
[ 800 x  600] 32 bit fullscreen..[ 49] Frames per second -- [20ms] per frame
[ 800 x  600] 16 bit fullscreen..[ 89] Frames per second -- [11ms] per frame
[ 800 x  600]  8 bit fullscreen..[118] Frames per second -- [8ms] per frame


---------------------------------
- Speed test for 4230a
Desktop resolution: [1280 x 800] 32 bit
OS detected:        [Windows 7] [ver:6.1]
Allegro version:    [Allegro 4.4.2, MinGW32]

[1280 x  800] 32 bit fullscreen..[ 38] Frames per second -- [26ms] per frame
[1280 x  800] 16 bit fullscreen..[ 70] Frames per second -- [14ms] per frame
[1280 x  800]  8 bit fullscreen..[ 86] Frames per second -- [11ms] per frame
[1024 x  768] 32 bit windowed....[ 39] Frames per second -- [25ms] per frame
[1024 x  768] 16 bit windowed....[ 63] Frames per second -- [15ms] per frame
[1024 x  768]  8 bit windowed....[ 82] Frames per second -- [12ms] per frame
[1024 x  768] 32 bit fullscreen..[ 40] Frames per second -- [24ms] per frame
[1024 x  768] 16 bit fullscreen..[ 77] Frames per second -- [12ms] per frame
[1024 x  768]  8 bit fullscreen..[ 97] Frames per second -- [10ms] per frame
[ 800 x  600] 32 bit windowed....[ 47] Frames per second -- [20ms] per frame
[ 800 x  600] 16 bit windowed....[ 74] Frames per second -- [13ms] per frame
[ 800 x  600]  8 bit windowed....[106] Frames per second -- [9ms] per frame
[ 800 x  600] 32 bit fullscreen..[ 49] Frames per second -- [20ms] per frame
[ 800 x  600] 16 bit fullscreen..[ 87] Frames per second -- [11ms] per frame
[ 800 x  600]  8 bit fullscreen..[117] Frames per second -- [8ms] per frame


linux dies, but probably due to a different number for
CLOCKS_PER_SEC.  al_fixed that but still dies...
it was failing to open file for writing...

---------------------------------
- Speed test for 4230-3
Desktop resolution: [1280 x 1024] 32 bit
OS detected:        [Linux] [ver:4.13]
CLOCKS_PER_SEC [1000000]
Allegro version:    [Allegro 4.4.2, Unix]

[1280 x 1024] 32 bit fullscreen..[ 28] Frames per second -- [35657ms] per frame
[1280 x 1024] 16 bit fullscreen..[ 36] Frames per second -- [27177ms] per frame
[1280 x 1024]  8 bit fullscreen..[ 51] Frames per second -- [19540ms] per frame
[1024 x  768] 32 bit windowed....[ 32] Frames per second -- [30313ms] per frame
[1024 x  768] 16 bit windowed....[ 47] Frames per second -- [21185ms] per frame
[1024 x  768]  8 bit windowed....[ 71] Frames per second -- [13898ms] per frame
[1024 x  768] 32 bit fullscreen..[ 32] Frames per second -- [30536ms] per frame
[1024 x  768] 16 bit fullscreen..[ 46] Frames per second -- [21629ms] per frame
[1024 x  768]  8 bit fullscreen..[ 62] Frames per second -- [15888ms] per frame
[ 800 x  600] 32 bit windowed....[ 40] Frames per second -- [24733ms] per frame
[ 800 x  600] 16 bit windowed....[ 58] Frames per second -- [17017ms] per frame
[ 800 x  600]  8 bit windowed....[ 90] Frames per second -- [11047ms] per frame
[ 800 x  600] 32 bit fullscreen..[ 40] Frames per second -- [24595ms] per frame
[ 800 x  600] 16 bit fullscreen..[ 57] Frames per second -- [17423ms] per frame
[ 800 x  600]  8 bit fullscreen..[ 88] Frames per second -- [11314ms] per frame


what do i make of these results?


16 bit fullscreen is usually twice as fast as 32
except on win 10 where they were close to the same...
except on ubuntu where it was a little slower

in windowed mode 16 is usually better too...
i should try to make 16 my default for  full screen

and 8 for windowed


I wonder if 6410 looks good cause the test is not long enough...



what does graphics mode select look like in linux with no filters...

 i get:
X11 fullscreen
X11 window
DGA 2.0 soft
DGA 2.0

DGA only has 32 bit mode
others have 8,15,16,24,32


----------------------------------------
05/03/18 12:30



---------------------------------------------------------------

make 16 the default for full screen and 8 for windowed

changed safe mode to 8
changed get from config default to 8

auto now uses desktop color depth
i can either force 16 or leave it

i think what i will do is leave it, but
dont let it be 8 unless OS...
in that case set to 16

no..

   // force 16 for full screen, unless xp or linux, then force 8
   color_depth = 16;
   if ((os_type == OSTYPE_LINUX) || (os_type == OSTYPE_WINXP)) color_depth = 8;

force 8 for windowed??
added one line in int screen to do this...

filter...done

---------------------------------------------------------------
done...06/03/18 06:28





time for backup...


06/03/18 07:00





got some weirdness..
zaiden playng on 6430
quite far into game, kept getting corrections and player's pos would jump around
also kept getting moving on his own like another player was moving him

to prevent this from happening:

on server check that the cdat's received are really from who they are supposed to be

can't check on client, sdats aren't specific to player
but they are sent to a specific player num...???
even if they are sent to the wrong player, the data shouldd be valid
it could be used as a sanity check to see if the server knows who its sending to...

players1[p].who = who; // set who in player array; may be redundant; done at join?
when server sends SJON reply to client, it sets who then

only server keeps track of who
server could check to make sure multiple who's do not exist
and that not more than one player has same who...same thing??

enum players twice and make sure no doubles exists
every frame or on join??

for (int p1=1; p1<NUM_PLAYERS; p1++)
   for (int p2=1; p2<NUM_PLAYERS; p2++)
      if (p1 != p2)
      {
         int p1w = players1[p1].who;
         int p2w = players1[p2].who;
         if ((p1w != 99) && (p2w != 99))
            if (p1w == p2w) // we have a duplicate
            {
               // do something here



            }
      }


server rx cdat, sdak, chak player who mismatch

server duplicate who

add client checks...

chdf
sdat
serr

modify all these on sever end to also send player num
done
now rx on client...

also made serr pass type as well


something broke, now client does not come active...
client logs coming active...?


make sure all packet rx and tx is good and has p first

client tx
chak
sdak x 2
cdat

client rx
chdf
sdat
serr

server tx
chdf
sdat x 2
serr

server rx
cdat
chak
sdak


for testing add tp chdf when...logging


player goes active, then when next chdf rx'd goes inactive...

server show client as active and chdfs are happening...
when reading from packet on client, change chunk offset to 23 from 22
beacuse I added one more btye...why does decompress not error??

right now i'm logging these errors, but should I do something about them?


on client I could quit
or just ignore bad data like now

on server I could drop client
leave it like this for now...
07/03/18 06:44


run game does not exit well
seems good now...

from command line added fast exit after done
from menu reset active local player to 0 when done

in control when player goes inactive
check if file play and only make player inactive
then check to make sure alp is not inactive...
done 08/03/18 10:08




when a client joins sometimes other clients show as method 0 instead of 2

control method is not synced...because its different...

what if i sync it, then locally modify it on clients
client will get servers copy

0 will be 3
so set it to 2

set local active player to 4


moved from player1 struct to player...done



just before sync compare
set 0 to 3
set local = 2

just after sync
set 0 to 2
set local to 4

            // fix control methods to match server
            players[0].control_method = 3;
            players[p].control_method = 2;



            // make copy of current state
            char tmp[CHUNK_SIZE];
            state_to_chunk(tmp);

            // compare copy to modified base state
            if (memcmp(tmp, clientl_chdf, CHUNK_SIZE))
            {
               dif_corr = 1;
               players1[p].dif_corr++;

               sprintf(tmsg, "corrections applied - total corrections:%d", players1[p].dif_corr);

               // show dif
               show_chunk_dif(tmp, clientl_chdf);

               // copy modified base state to current game state
               chnk_to_state(clientl_chdf);

            }
            else
            {
              sprintf(tmsg, "no differences");
              dif_corr = 0;
            }
         }
         else // no dif checking,  just blindly copy (used for join)
         {
            sprintf(tmsg, "applied (no check)");

            // copy modified base state to current game state
            chnk_to_state(clientl_chdf);
         }
         clientl_chdf_id = passcount; // update client base passcount


         // restore control methods
         players[0].control_method = 2;
         players[p].control_method = 4;


08/03/18 07:26






fix the overlay stuff
server and client are good
rungame...
and single player

always show fps
if not 40 show set act
if skip last sec show fps act skip

on overlay show all
finally happy with this...
08/03/18 10:42





player is still alive but shows 0 health

old  if (players[p].LIFE <= al_itofix(0)) // is LIFE <= 0
mew  if (players[p].LIFE < al_itofix(1)) // is LIFE < 1
08/03/18 15:04




after a long game server player was doing weird things, moving on its own
i didn't have logging on
the only error i had was on server console:
ERROR rx sdak player[99].who does not match packet who[1]
added some more check for this
09/03/18 04:06

client end of game stats are mostly blank like they've been reset..al_fixed






what can i do to not make logging slow down game??
it is beacuse log become so big that adding to the end of it is slow??
turn all logging on...
disable the part where it adds to log text
not a single skip

change from strcat to sprintf
still good

back to strcat
bad again

looks like this works:

void add_log_entry2(int type, int player, char *txt)
{
   char tmsg[200];
   sprintf(tmsg, "[%2d][%d][%d]%s", type, player, passcount, txt);

   // strcat(log_msg, tmsg);

   memcpy(log_msg + log_msg_pos, tmsg, strlen(tmsg));
   log_msg_pos += strlen(tmsg);
   log_msg[log_msg_pos+1] = 0; // NULL terminate

al_fixed!!!! 09/03/18 04:43



if server quits and restarts from menu bad things happen...
only if client joined
in server exit
- reset player data
- reset clientchann and clientconn arrays

al_fixed 09/03/18 05:30




how hard would it be to re-implement demo mode?

make demo dir

iterate filenames and store in array

hook into menu like splash screen, with a timer

make a menu entry also

could even have it play on the menu screen map!

could make it only work if the level was not paused

could make it play the current play level first

it should not take to long to do, but making the hooks
look nice could eat a lot of time


it pretty much needs to be on the main menu
if i make a new entry all my spacing will be off

if that's all i have to worry about, temporarily use controller
later I wil re-arrange the menu's....

how to exit from demo mode??

global int demo_mode = 1;

proc_controls can set it to 0;


working on menu stuff....

after demo it comes back on resume..al_fixed


I think I will move color to options menu

list them here:

   strcpy (global_string[7][0], ""); // main menu
   strcpy (global_string[7][1], "");
   strcpy (global_string[7][2], "Start Level  (1)");
   strcpy (global_string[7][3], "Start New Game");
   strcpy (global_string[7][4], "Resume Current Game");
   strcpy (global_string[7][5], "Host Network Game");
   strcpy (global_string[7][6], "Join Network Game");
   strcpy (global_string[7][7], "Controller Setup");
   strcpy (global_string[7][8], "<-Change Color->");
   strcpy (global_string[7][9], "Level Editor");
   strcpy (global_string[7][10], "Options Menu");
   strcpy (global_string[7][11], "Run Game");
   strcpy (global_string[7][12], "Save Game");
   strcpy (global_string[7][13], "Help Screens");
   strcpy (global_string[7][14], "end");

   strcpy (global_string[8][0], "Options Menu");
   strcpy (global_string[8][1], "----------");
   strcpy (global_string[8][2], "Back to Game Menu");
   strcpy (global_string[8][3], "Speed:Fast");
   strcpy (global_string[8][4], "Sound:Off");
   strcpy (global_string[8][5], "Sound Effects Volume:9");
   strcpy (global_string[8][6], "Sound Track Volume:9");
   strcpy (global_string[8][7], "Screen Mode: 640 x 480");
   strcpy (global_string[8][8], "Netgame Configuration");
   strcpy (global_string[8][9], "Splash Screen:ON");
   strcpy (global_string[8][10], "end");


new arrangement

Game Type:[Single Player]
Game Type:[Run Saved Game From File]
Game Type:[Netgame Server]
Game Type:[Netgame Client]

next line under that:
sp Starting Level
sg File name to play
ns Starting Level
nc server name


   strcpy (global_string[7][0], ""); // main menu
   strcpy (global_string[7][1], "");
   strcpy (global_string[7][2], "Start Level  (1)");
   strcpy (global_string[7][3], "Start New Game");
   strcpy (global_string[7][4], "Resume Current Game");
   strcpy (global_string[7][5], "Host Network Game");
   strcpy (global_string[7][6], "Join Network Game");
   strcpy (global_string[7][11], "Replay Saved Game");
   strcpy (global_string[7][12], "Save Game to Disk");
   strcpy (global_string[7][10], "Options Menu");
   strcpy (global_string[7][9], "Level Editor");
   strcpy (global_string[7][13], "Help Screens");
   strcpy (global_string[7][14], "end");


   strcpy (global_string[8][0], "Options Menu");
   strcpy (global_string[8][1], "----------");
   strcpy (global_string[8][2], "Back to Game Menu");
   strcpy (global_string[8][3], "Screen Mode: 640 x 480");
   strcpy (global_string[8][4], "<-Change Color->");
   strcpy (global_string[8][5], "Controller Setup");
   strcpy (global_string[8][6], "Speed:Fast");
   strcpy (global_string[8][7], "Sound:Off");
   strcpy (global_string[8][8], "Sound Effects Volume:9");
   strcpy (global_string[8][9], "Sound Track Volume:9");
   strcpy (global_string[8][10], "Netgame Configuration");
   strcpy (global_string[8][11], "Splash Screen:ON");
   strcpy (global_string[8][12], "end");


----------------
step 1 - move color and controller to options

screen mode to 3 old 7

speed       to 6 old 3

st vol      to 9 old 6
se vol      to 8

splash     to 11 old 9

netconf from x to 10

sound  from to 7

color

done............

now main menu has 2 empty slots
one is used for demo
09/03/18 08:58





running saved game can still crash when it ends
fix what happen at the end of rungame...
when level done..al_fixed now dood
when player dies..seems good
when player quits..not good..al_fixed

show demo mode overlay

make demo mode countdown
global int demo_mode_countdown
done


another meun re-arrange...

move save and load to options

main menu current:

   strcpy (global_string[7][0], ""); // main menu
   strcpy (global_string[7][1], "");
   strcpy (global_string[7][2], "Start Level (1)");
   strcpy (global_string[7][3], "Start New Game");
   strcpy (global_string[7][4], "Resume Current Game");
   strcpy (global_string[7][5], "   ---   ");
   strcpy (global_string[7][6], "   ---   ");

#ifdef NETPLAY
   strcpy (global_string[7][5], "Host Network Game");
   strcpy (global_string[7][6], "Join Network Game");
#endif



   strcpy (global_string[7][7], "Demo Mode");
   strcpy (global_string[7][8], "------------");
   strcpy (global_string[7][9], "Level Editor");
   strcpy (global_string[7][10], "Options Menu");
   strcpy (global_string[7][11], "Run Game");
   strcpy (global_string[7][12], "Save Game");
   strcpy (global_string[7][13], "Help Screens");
   strcpy (global_string[7][14], "end");


new:
   strcpy (global_string[7][2], "Start Level (1)");
   strcpy (global_string[7][3], "Start New Game");
   strcpy (global_string[7][4], "Resume Current Game");
   strcpy (global_string[7][5], "Host Network Game");
   strcpy (global_string[7][6], "Join Network Game");
   strcpy (global_string[7][7], "Options Menu");
   strcpy (global_string[7][8], "Level Editor");
   strcpy (global_string[7][9], "Demo Mode");
   strcpy (global_string[7][10], "Help Screens");
   strcpy (global_string[7][11], "end");


moved save and run to options

options from 10 to 7

done 11/03/18 09:23



make a way to make demo not do repeats
add some check in demo to handle:
0 gm
1 gm
more than 100 gm
done 11/03/18 10:24


add function to test controls
to see if simultanoeous is good
done 11/03/18 14:15


20180311 - Released Version 6.0

This file is getting so long....almost 900K, I'm moving to a new one...

