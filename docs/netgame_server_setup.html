<!doctype html>
<title>Netgame - Server Setup</title>

<html>

    <script src="prism.js"></script>
    <link href = "themes/prism.css" rel="stylesheet" />
    <link href = "css/mdw.css"      rel="stylesheet" type = "text/css" />

    
    <body>

        <nav class="col-1">

<mdw_lhs_nav><div style="text-align: center;">Navigation</div><hr>    
<div style="text-align: center;"><a href="index.html" target="_top">Home</a></div>    
<div style="text-align: center;"><a href="index.html#Description" target="_top">Description</a></div>    
<div style="text-align: center;"><a href="index.html#Demo Video" target="_top">Demo Video</a></div>    
<div style="text-align: center;"><a href="index.html#Features" target="_top">Features</a></div>    
<div style="text-align: center;"><a href="index.html#Created by" target="_top">Created by</a></div>    
<div style="text-align: center;"><a href="index.html#Created with" target="_top">Created with</a></div>    
<div style="text-align: center;"><a href="index.html#License" target="_top">License</a></div>    
<div style="text-align: center;"><a href="index.html#Supported Systems" target="_top">Supported Systems</a></div>    
<div style="text-align: center;"><a href="index.html#External Links" target="_top">External Links</a></div>    
<div style="text-align: center;"><a href="index.html#Older Versions" target="_top">Older Versions</a></div>    
<div style="text-align: center;"><a href="index.html#History" target="_top">History</a></div>    

<br><div style="text-align: center;">Technical Descriptions</div><hr>    
<div style="text-align: center;"><a href="project_organization.html" target="_top">Project Organization</a></div>    
<div style="text-align: center;"><a href="logo.html" target="_top">Logo</a></div>    
<div style="text-align: center;"><a href="timers.html" target="_top">Timers</a></div>    
<div style="text-align: center;"><a href="events.html" target="_top">Events</a></div>    
<div style="text-align: center;"><a href="input.html" target="_top">Input</a></div>    
<div style="text-align: center;"><a href="level_done.html" target="_top">Level Done</a></div>    
<div style="text-align: center;"><a href="game_moves_array.html" target="_top">Game Moves Array</a></div>    
<div style="text-align: center;"><a href="sound.html" target="_top">Sound</a></div>    
<div style="text-align: center;"><a href="display.html" target="_top">Display</a></div>    
<div style="text-align: center;"><a href="tiles.html" target="_top">Tiles</a></div>    
<div style="text-align: center;"><a href="block_flags.html" target="_top">Block Flags</a></div>    
<div style="text-align: center;"><a href="bullets.html" target="_top">Bullets</a></div>    
<div style="text-align: center;"><a href="level_array.html" target="_top">Level Array</a></div>    

<div style="text-align: center;"><a href="netgame_main.html"                  target="_top">Netgame - Main</a></div>    
<div style="text-align: center;"><a href="netgame_state_and_dif.html"         target="_top">Netgame - State and Dif</a></div>    
<div style="text-align: center;"><a href="netgame_server_state.html"          target="_top">Netgame - Server State</a></div>    
<div style="text-align: center;"><a href="netgame_client_state.html"          target="_top">Netgame - Client State</a></div>    
<div style="text-align: center;"><a href="netgame_client_control_change.html" target="_top">Netgame - Client Control Change</a></div>    
<div style="text-align: center;"><a href="netgame_client_timing_sync.html"    target="_top">Netgame - Client Timing Sync</a></div>    
<div style="text-align: center;"><a href="netgame_fast_packet_loop.html"      target="_top">Netgame - Fast Packet Loop</a></div>    
<div style="text-align: center;"><a href="netgame_ping.html"                  target="_top">Netgame - Ping</a></div>    
<div style="text-align: center;"><a href="netgame_packets.html"               target="_top">Netgame - Packets</a></div>    
<div style="text-align: center;"><a href="netgame_config.html"                target="_top">Netgame - Config</a></div>    
<div style="text-align: center;"><a href="netgame_join.html"                  target="_top">Netgame - Join</a></div>    
<div style="text-align: center;"><a href="netgame_status.html"                target="_top">Netgame - Status</a></div>    

</mdw_lhs_nav>
            
        </nav>
      
        <div class="col-2">
            <header>
                <mh11>Purple Martians</mh11><hr>
                <mh12>Technical Code Descriptions</mh12><hr>
            </header>

<mh3><hr></mh3>
<mh8>Netgame - Server Setup</mh8>
<mh3><hr><mdw_file_toc> <a href="netgame_server_setup.html#Overview" target="_top">Overview</a>
 <a href="netgame_server_setup.html#Program states for server" target="_top">Program states for server</a>
 <a href="netgame_server_setup.html#Server initializes network" target="_top">Server initializes network</a>
 <a href="netgame_server_setup.html#Server listens" target="_top">Server listens</a>
</mdw_file_toc><hr></mh3>

<a name="Overview"></a>
<mh7>Overview</mh7>
<mh3>
The server initializes the network.
The server listens for connections from clients.

</mh3>


<a name="Program states for server"></a>
<mh7>Program states for server</mh7>

<mh3>
The program states used by a server are:

20 - server start new game
11 - main game loop
19 - server exit

</mh3>


<a name="Server initializes network"></a>
<mh7>Server initializes network</mh7>

<mh3>
When a server game is started, the first thing that happens is the network initialization.
</mh3>

<pre><code class="language-cpp">int server_init(void)
{
   if (ServerInitNetwork())
   {
      sprintf(msg, "Could not find internet driver!");
      return 0;
   }

   sprintf(msg, "Server successfully initialized");

   // still needed or client dies at joining
   Packet("JUNK");
   ServerBroadcast(packetbuffer, packetsize);

   players[0].control_method = 3; // server_local_control
   ima_server = 1;
   strncpy(players1[0].hostname, local_hostname, 16);

   return 1;
}


int ServerInitNetwork() // Initialize the server
{
   init_packet_buffer();
   if(NetworkInit())
   {
      sprintf(msg, "Error: failed to initialize network\n");
      return -1;
   }
   if (TCP)
   {
      ListenConn = net_openconn(NetworkDriver, "");
      if(!ListenConn)
      {
         sprintf(msg, "Error: failed to open listening connection\n");
         return -1;
      }
      if(net_listen(ListenConn))
      {
         return -1;
      }
      sprintf(msg, "Network initialized - connection mode (TCP)");
   }
   else // UDP
   {
      // open the listening channel;
      if (!(ListenChannel = net_openchannel(NetworkDriver, "")))
      {
         sprintf(msg, "Error: failed to open listening channel\n");
         return -1;
      }
      if (net_assigntarget(ListenChannel, ""))
      {
         sprintf(msg, "Error: failed to assign target to listening channel\n");
         net_closechannel(ListenChannel);
         return -1;
      }
      sprintf(msg, "Network initialized - channel mode (UDP)");
   }
   return 0;
}
</code></pre>


<a name="Server listens"></a>
<mh7>Server listens</mh7>

<mh3>
Then the server listens for new connections (TCP) or new channels (UDP)
</mh3>
<pre><code class="language-cpp">void ServerListen()
{
   if (TCP) // listen for connections
   {
      NET_CONN *newconn;
      newconn = net_poll_listen(ListenConn);
      if(newconn == NULL) return;
      else
      {
         ClientConn[ClientNum] = newconn;
         ClientNum++;
         sprintf(msg, "Connection received from %s", net_getpeer (newconn));
      }
   }
   else // UDP - listen for channels
   {
      char address[32];
      packetsize = net_receive(ListenChannel, packetbuffer, 1024, address);
      if (packetsize)
      {
         set_packetpos(0);
         if (PacketRead("1234"))
         {
            sprintf(msg, "Server received initial 1234 packet from '%s'",address);
            if (!(ClientChannel[ClientNum] = net_openchannel(NetworkDriver, NULL)))
            {
               sprintf(msg, "Error: failed to open channel for %s\n", address);
               return;
            }
            if (net_assigntarget (ClientChannel[ClientNum], address))
            {
               sprintf(msg, "Error: couldn't assign target `%s' to channel\n", address);
               net_closechannel (ClientChannel[ClientNum]);
               return;
            }
            sprintf(msg, "Server opened channel for `%s' and sent reply", address);
            Packet("5678");
            ServerSendTo(packetbuffer, packetsize, ClientNum, 0);
            ClientNum++;
         }
      }
   }
}
</code></pre>


               <footer>                <mh11>Purple Martians</mh11><hr>
                <div id="copyright">
                Copyright &copy; 2023, by <a href="mailto:mweiss001@gmail.com"> Michael David Weiss</a>
                </div>
</footer>

        </div>
    </body>

</html>
