<!doctype html>
<title>Game Moves Array</title>

<html>

    <script src="prism.js"></script>
    <link href = "themes/prism.css" rel="stylesheet" />
    <link href = "css/mdw.css"      rel="stylesheet" type = "text/css" />

    
    <body>

        <nav class="col-1">
        
<mdw_lhs_nav><div style="text-align: center;">Navigation</div><hr>    
<div style="text-align: center;"><a href="index.html" target="_top">Home</a></div>    
<div style="text-align: center;"><a href="index.html#Description" target="_top">Description</a></div>    
<div style="text-align: center;"><a href="index.html#Demo Video" target="_top">Demo Video</a></div>    
<div style="text-align: center;"><a href="index.html#Features" target="_top">Features</a></div>    
<div style="text-align: center;"><a href="index.html#Created by" target="_top">Created by</a></div>    
<div style="text-align: center;"><a href="index.html#Created with" target="_top">Created with</a></div>    
<div style="text-align: center;"><a href="index.html#License" target="_top">License</a></div>    
<div style="text-align: center;"><a href="index.html#Supported Systems" target="_top">Supported Systems</a></div>    
<div style="text-align: center;"><a href="index.html#External Links" target="_top">External Links</a></div>    
<div style="text-align: center;"><a href="index.html#Older Versions" target="_top">Older Versions</a></div>    
<div style="text-align: center;"><a href="index.html#History" target="_top">History</a></div>    

<br><div style="text-align: center;">Technical Descriptions</div><hr>    
<div style="text-align: center;"><a href="project_organization.html" target="_top">Project Organization</a></div>    
<div style="text-align: center;"><a href="logo.html" target="_top">Logo</a></div>    
<div style="text-align: center;"><a href="timers.html" target="_top">Timers</a></div>    
<div style="text-align: center;"><a href="events.html" target="_top">Events</a></div>    
<div style="text-align: center;"><a href="input.html" target="_top">Input</a></div>    
<div style="text-align: center;"><a href="level_done.html" target="_top">Level Done</a></div>    
<div style="text-align: center;"><a href="game_moves_array.html" target="_top">Game Moves Array</a></div>    
<div style="text-align: center;"><a href="sound.html" target="_top">Sound</a></div>    
<div style="text-align: center;"><a href="display.html" target="_top">Display</a></div>    
<div style="text-align: center;"><a href="tiles.html" target="_top">Tiles</a></div>    
<div style="text-align: center;"><a href="block_flags.html" target="_top">Block Flags</a></div>    
<div style="text-align: center;"><a href="shots.html" target="_top">Shots</a></div>    
<div style="text-align: center;"><a href="level_array.html" target="_top">Level Array</a></div>    

<div style="text-align: center;"><a href="netgame_main.html"                     target="_top">Netgame - Main</a></div>    
<div style="text-align: center;"><a href="netgame_state_and_dif.html"            target="_top">Netgame - State and Dif</a></div>    
<div style="text-align: center;"><a href="netgame_server_state.html"             target="_top">Netgame - Server State</a></div>    
<div style="text-align: center;"><a href="netgame_client_state.html"             target="_top">Netgame - Client State</a></div>    
<div style="text-align: center;"><a href="netgame_client_control_change.html"    target="_top">Netgame - Client Control Change</a></div>    
<div style="text-align: center;"><a href="netgame_client_timing_sync.html"       target="_top">Netgame - Client Timing Sync</a></div>    
<div style="text-align: center;"><a href="netgame_fast_packet_loop.html"         target="_top">Netgame - Fast Packet Loop</a></div>    
<div style="text-align: center;"><a href="netgame_ping.html"                     target="_top">Netgame - Ping</a></div>    
<div style="text-align: center;"><a href="netgame_packets.html"                  target="_top">Netgame - Packets</a></div>    
<div style="text-align: center;"><a href="netgame_config.html"                   target="_top">Netgame - Config</a></div>    
<div style="text-align: center;"><a href="netgame_server_setup.html"             target="_top">Netgame - Server Setup</a></div>    
<div style="text-align: center;"><a href="netgame_join.html"                     target="_top">Netgame - Join</a></div>    
<div style="text-align: center;"><a href="netgame_control_and_monitoring.html"   target="_top">Netgame - Control and Monitoring</a></div>    

</mdw_lhs_nav>
            
        </nav>

        
        <div class="col-2">

            <header>
                <mh11>Purple Martians</mh11><hr>
                <mh12>Technical Code Descriptions</mh12><hr>
            </header>

<mh3><hr></mh3>
<mh8>Game Moves Array</mh8>
<mh3><hr><mdw_file_toc> <a href="game_moves_array.html#Overview" target="_top">Overview</a>
 <a href="game_moves_array.html#Variables" target="_top">Variables</a>
 <a href="game_moves_array.html#Array elements" target="_top">Array elements</a>
 <a href="game_moves_array.html#Types of game moves" target="_top">Types of game moves</a>
 <a href="game_moves_array.html#How game_move entries are added in single player mode" target="_top">How game_move entries are added in single player mode</a>
 <a href="game_moves_array.html#How game move entries are added in netgame" target="_top">How game move entries are added in netgame</a>
 <a href="game_moves_array.html#How controls are set from game move array" target="_top">How controls are set from game move array</a>
 <a href="game_moves_array.html#Run demo game mode" target="_top">Run demo game mode</a>
</mdw_file_toc><hr></mh3>

<a name="Overview"></a>
<mh7>Overview</mh7>

<mh3>
The game moves array is the heart of the entire game control system.
It contains every input from every player, indexed by the frame number.

The array does not store an entry for every frame, only when a player's controls have changed.

Players controls are never set directly, even in single player mode.
When a player's control inputs change, a new entry is made into the array at that frame number.

In another function, the game move array is used to set players controls when the frame numbers match. 

This method is not needed for single player mode, but it is essential for netgame and demo game replaying.
So, in the interests of keeping things consistant, it is also the method used for single player.

</mh3>


<br><a name="Variables"></a>
<mh7>Variables</mh7>
<pre><code class="language-cpp">#define GAME_MOVES_SIZE 1000000
class mwGameMoves
{
   ...
   int arr[GAME_MOVES_SIZE][4];
   int entry_pos = 0;
   int current_pos = 0; // for savegame running only
</code></pre>
<mh3>The game moves array can hold 1 million game moves.

1 million might seem excessive but with 8 players at 40fps, you could theoretically get 320 game moves per second.
(In reality a human player can't press the controls fast enough to make 40 moves per second!)
But at the worst case, that's 19200 game_moves per minute or 1,152,000 game_moves per hour.

</mh3>

<pre><code class="language-cpp">entry_pos;</code></pre>
<mh3>The current entry position of the array.
When a new move is added, it is added at this position, and then this position is incremented.

</mh3>

<pre><code class="language-cpp">current_pos;</code></pre>
<mh3>The current read position of the array.
Used only for demo game playing to keep track of the current read position of the array.
</mh3>

<br><a name="Array elements"></a>
<mh7>Array elements</mh7>
<mh3>
Each game move entry has 4 elements:
</mh3>

<pre><code class="language-cpp">mGameMoves.arr[x][0]; // frame_num
mGameMoves.arr[x][1]; // game move type
mGameMoves.arr[x][2]; // player number
mGameMoves.arr[x][3]; // comp_move
</code></pre>
<mh3>
A player's controls are encoded into a bitfield called 'comp_move' with these values:
</mh3>
<pre><code class="language-cpp">1  [LEFT]
2  [RIGHT]
4  [UP]
8  [DOWN]
16 [JUMP]
32 [FIRE]</code></pre>




<br><a name="Types of game moves"></a>
<mh7>Types of game moves</mh7>
<mh3>   
Type 5 - Regular game move 
</mh3>
<pre><code class="language-cpp">mGameMoves.arr[x][0]; // frame_num
mGameMoves.arr[x][1]; // game_move type = 5 (regular game move)
mGameMoves.arr[x][2]; // player number
mGameMoves.arr[x][3]; // comp_move
</code></pre>

<mh3>   
Type 6 - Level done
</mh3>
<pre><code class="language-cpp">mGameMoves.arr[x][0]; // frame_num
mGameMoves.arr[x][1]; // game_move type = 6 (level done)
mGameMoves.arr[x][2]; // not used
mGameMoves.arr[x][3]; // not used
</code></pre>


<mh3>   
Type 1 - Player state change
</mh3>
<pre><code class="language-cpp">mGameMoves.arr[x][0]; // frame_num
mGameMoves.arr[x][1]; // game_move type = 1 (player state)
mGameMoves.arr[x][2]; // player number
mGameMoves.arr[x][3]; // val

if ((val > 0) && (val < 16)) // make player active and set color
{
   mPlayer.syn[p].active = 1;
   mPlayer.syn[p].color = val;
}

if (val > 63) // make player inactive and log reason
{
   mPlayer.syn[p].active = 0;
   mPlayer.syn[p].quit_reason = val;
}</code></pre>




<br><a name="How game_move entries are added in single player mode"></a>
<mh7>How game_move entries are added in single player mode</mh7>

<pre><code class="language-cpp">void mwPlayer::set_comp_move_from_player_key_check(int p) // doesn't set controls
{
   int cm = 0;
   if (mInput.key[loc[p].left_key][0])       cm |= PM_COMPMOVE_LEFT;
   if (mInput.key[loc[p].right_key][0])      cm |= PM_COMPMOVE_RIGHT;
   if (mInput.key[loc[p].up_key][0])         cm |= PM_COMPMOVE_UP;
   if (mInput.key[loc[p].down_key][0])       cm |= PM_COMPMOVE_DOWN;
   if (mInput.key[loc[p].jump_key][0])       cm |= PM_COMPMOVE_JUMP;
   if (mInput.key[loc[p].fire_key][0])       cm |= PM_COMPMOVE_FIRE;
   if (mInput.key[loc[p].menu_key][0])       cm |= PM_COMPMOVE_MENU;
   if (mInput.key[ALLEGRO_KEY_ESCAPE][0])    cm |= PM_COMPMOVE_MENU;
   loc[p].comp_move = cm;
}

if (loc[p].old_comp_move != loc[p].comp_move)  // player's controls have changed
{
   loc[p].old_comp_move = loc[p].comp_move;
   mGameMoves.add_game_move(mLoop.frame_num, 5, p, loc[p].comp_move);
   ...

void mwGameMoves::add_game_move(int frame, int type, int data1, int data2)
{
   arr[entry_pos][0] = frame;
   arr[entry_pos][1] = type;
   arr[entry_pos][2] = data1;
   arr[entry_pos][3] = data2;
   entry_pos++;
}
</code></pre>







<br><a name="How game move entries are added in netgame"></a>
<mh7>How game move entries are added in netgame</mh7>
<mh3>
In netgame, things are done differently.

In client mode, when a control change happens, it is also sent to the server:
</mh3>

<pre><code class="language-cpp">
mNetgame.Packet("cdat");
mNetgame.PacketPut1ByteInt(p);
mNetgame.PacketPut4ByteInt(mLoop.frame_num);
mNetgame.PacketPut1ByteInt(loc[p].comp_move);
mNetgame.ClientSend(mNetgame.packetbuffer, mNetgame.packetsize);</code></pre>

<mh3>
When the server receives the packet, the client's game move is puts in the server's master game moves array.
</mh3>

<pre><code class="language-cpp">if(PacketRead("cdat"))
{
   int p = PacketGet1ByteInt();
   int fn = PacketGet4ByteInt();
   int cm = PacketGet1ByteInt();
   add_game_move(fn, 5, p, cm); // add to game_move array
}</code></pre>


<br><a name="How controls are set from game move array"></a>
<mh7>How controls are set from game move array</mh7>
<mh3>
This is common to all modes (single player, run demo game, netgame).

Player's controls are set by reading game moves from the array.
</mh3>
<pre><code class="language-cpp">// this function processes all entries in the game_moves array that match current frame_num
void mwGameMoves::proc(void)
{
   // search entire range
   int start_index = entry_pos-1;
   int end_index = 0;

   // reduce search range
   start_index = current_pos + 100;
   if (start_index > entry_pos-1) start_index = entry_pos-1;

   end_index = current_pos - 100;
   if (end_index < 0) end_index = 0;

   for (int x=start_index; x>=end_index; x--)  // search backwards from start_index to end_index
   {
      if (arr[x][0] == mLoop.frame_num) // found frame number that matches current frame
      {
         if (x > current_pos) current_pos = x; // index of last used gm - keep this at the most recent one, never go back
         switch (arr[x][1])
         {
            case 1: proc_player_active_game_move(x); break;
            case 2: proc_player_inactive_game_move(x); break;
            case 3: proc_player_client_join_game_move(x); break;
            case 4: proc_player_client_quit_game_move(x); break;
            case 5: mPlayer.set_controls_from_comp_move(arr[x][2], arr[x][3]); break;
         }
      }
   }
}

void mwPlayer::set_controls_from_comp_move(int p, int comp_move)
{
   clear_controls(p);
   if (comp_move & PM_COMPMOVE_LEFT)  syn[p].left  = 1;
   if (comp_move & PM_COMPMOVE_RIGHT) syn[p].right = 1;
   if (comp_move & PM_COMPMOVE_UP)    syn[p].up    = 1;
   if (comp_move & PM_COMPMOVE_DOWN)  syn[p].down  = 1;
   if (comp_move & PM_COMPMOVE_JUMP)  syn[p].jump  = 1;
   if (comp_move & PM_COMPMOVE_FIRE)  syn[p].fire  = 1;
   if (comp_move & PM_COMPMOVE_MENU)  syn[p].menu  = 1;
}</code></pre>

<br><a name="Run demo game mode"></a>
<mh7>Run demo game mode</mh7>
<mh3>
In this mode, the game moves array is loaded from a file.  After that, it's played back from the array in the exact same way as every other mode.


When a game is saved to file, the game moves array is simply dumped with a small header of 4 integers:

1 - num of game move entries
2 - deathmatch_pbullets
3 - deathmatch_pbullets_damage
4 - suicide_pbullets

The save game file extension is .gm.  If you look at it with a text editor, all you will see a list of numbers like this:
</mh3>
<pre><code class="language-cpp">'savegame.gm'
30
0
5
0
0
0
4
0
0
1
0
8
0
5
0
3</code></pre>

<mh3>
It is also saved as human readable text file like this:
</mh3>
<pre><code class="language-cpp">'savegame.txt'
number of entries 30
deathmatch_pbullets 0
deathmatch_pbullets_damage 5
suicide_pbullets 0
[ gm][  pc][p][cm]
[  0][   0]-------------START (level:4)------------- 
[  1][   0]-------------PLAYER 0 ACTIVE (color:8)-- 
[  2][   0][0][ 3]  [    ][    ][    ][  ][RIGHT][LEFT]
[  3][   3][0][ 7]  [    ][    ][    ][UP][RIGHT][LEFT]
[  4][   4][0][ 6]  [    ][    ][    ][UP][RIGHT][    ]
[  5][   5][0][38]  [FIRE][    ][    ][UP][RIGHT][    ]
[  6][   8][0][33]  [FIRE][    ][    ][  ][     ][LEFT]
[  7][   9][0][ 1]  [    ][    ][    ][  ][     ][LEFT]
[  8][  12][0][19]  [    ][JUMP][    ][  ][RIGHT][LEFT]
[  9][  14][0][22]  [    ][JUMP][    ][UP][RIGHT][    ]
[ 10][  15][0][38]  [FIRE][    ][    ][UP][RIGHT][    ]
[ 11][  17][0][33]  [FIRE][    ][    ][  ][     ][LEFT]
[ 12][  18][0][ 1]  [    ][    ][    ][  ][     ][LEFT]
[ 13][  19][0][17]  [    ][JUMP][    ][  ][     ][LEFT]
[ 14][  21][0][19]  [    ][JUMP][    ][  ][RIGHT][LEFT]
[ 15][  23][0][ 6]  [    ][    ][    ][UP][RIGHT][    ]
[ 16][  24][0][34]  [FIRE][    ][    ][  ][RIGHT][    ]
[ 17][  25][0][33]  [FIRE][    ][    ][  ][     ][LEFT]
[ 18][  26][0][ 1]  [    ][    ][    ][  ][     ][LEFT]
[ 19][  27][0][17]  [    ][JUMP][    ][  ][     ][LEFT]
[ 20][  29][0][18]  [    ][JUMP][    ][  ][RIGHT][    ]
[ 21][  31][0][38]  [FIRE][    ][    ][UP][RIGHT][    ]
[ 22][  33][0][32]  [FIRE][    ][    ][  ][     ][    ]
[ 23][  34][0][49]  [FIRE][JUMP][    ][  ][     ][LEFT]
[ 24][  36][0][17]  [    ][JUMP][    ][  ][     ][LEFT]
[ 25][  37][0][19]  [    ][JUMP][    ][  ][RIGHT][LEFT]
[ 26][  38][0][ 6]  [    ][    ][    ][UP][RIGHT][    ]
[ 27][  42][0][ 1]  [    ][    ][    ][  ][     ][LEFT]
[ 28][  43][0][ 0]  [    ][    ][    ][  ][     ][    ]
[ 29][  45]-------------PLAYER 0 INACTIVE----------- 
</code></pre>














            
               <footer>                <mh11>Purple Martians</mh11><hr>
                <div id="copyright">
                Copyright &copy; 2023, by <a href="mailto:mweiss001@gmail.com"> Michael David Weiss</a>
                </div>
</footer>

        </div>
    </body>

</html>
