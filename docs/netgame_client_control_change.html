<!doctype html>
<title>Netgame - Client Control Change</title>

<html>

    <script src="prism.js"></script>
    <link href = "themes/prism.css" rel="stylesheet" />
    <link href = "css/mdw.css"      rel="stylesheet" type = "text/css" />

    
    <body>

        <nav class="col-1">

<mdw_lhs_nav><div style="text-align: center;">Navigation</div><hr>    
<div style="text-align: center;"><a href="index.html" target="_top">Home</a></div>    
<div style="text-align: center;"><a href="index.html#Description" target="_top">Description</a></div>    
<div style="text-align: center;"><a href="index.html#Demo Video" target="_top">Demo Video</a></div>    
<div style="text-align: center;"><a href="index.html#Features" target="_top">Features</a></div>    
<div style="text-align: center;"><a href="index.html#Created by" target="_top">Created by</a></div>    
<div style="text-align: center;"><a href="index.html#Created with" target="_top">Created with</a></div>    
<div style="text-align: center;"><a href="index.html#License" target="_top">License</a></div>    
<div style="text-align: center;"><a href="index.html#Supported Systems" target="_top">Supported Systems</a></div>    
<div style="text-align: center;"><a href="index.html#External Links" target="_top">External Links</a></div>    
<div style="text-align: center;"><a href="index.html#Older Versions" target="_top">Older Versions</a></div>    
<div style="text-align: center;"><a href="index.html#History" target="_top">History</a></div>    

<br><div style="text-align: center;">Technical Descriptions</div><hr>    
<div style="text-align: center;"><a href="project_organization.html" target="_top">Project Organization</a></div>    
<div style="text-align: center;"><a href="logo.html" target="_top">Logo</a></div>    
<div style="text-align: center;"><a href="timers.html" target="_top">Timers</a></div>    
<div style="text-align: center;"><a href="events.html" target="_top">Events</a></div>    
<div style="text-align: center;"><a href="input.html" target="_top">Input</a></div>    
<div style="text-align: center;"><a href="level_done.html" target="_top">Level Done</a></div>    
<div style="text-align: center;"><a href="game_moves_array.html" target="_top">Game Moves Array</a></div>    
<div style="text-align: center;"><a href="sound.html" target="_top">Sound</a></div>    
<div style="text-align: center;"><a href="display.html" target="_top">Display</a></div>    
<div style="text-align: center;"><a href="tiles.html" target="_top">Tiles</a></div>    
<div style="text-align: center;"><a href="block_flags.html" target="_top">Block Flags</a></div>    
<div style="text-align: center;"><a href="shots.html" target="_top">Shots</a></div>    
<div style="text-align: center;"><a href="level_array.html" target="_top">Level Array</a></div>    

<div style="text-align: center;"><a href="netgame_main.html"                     target="_top">Netgame - Main</a></div>    
<div style="text-align: center;"><a href="netgame_state_and_dif.html"            target="_top">Netgame - State and Dif</a></div>    
<div style="text-align: center;"><a href="netgame_server_state.html"             target="_top">Netgame - Server State</a></div>    
<div style="text-align: center;"><a href="netgame_client_state.html"             target="_top">Netgame - Client State</a></div>    
<div style="text-align: center;"><a href="netgame_client_control_change.html"    target="_top">Netgame - Client Control Change</a></div>    
<div style="text-align: center;"><a href="netgame_client_timing_sync.html"       target="_top">Netgame - Client Timing Sync</a></div>    
<div style="text-align: center;"><a href="netgame_fast_packet_loop.html"         target="_top">Netgame - Fast Packet Loop</a></div>    
<div style="text-align: center;"><a href="netgame_ping.html"                     target="_top">Netgame - Ping</a></div>    
<div style="text-align: center;"><a href="netgame_packets.html"                  target="_top">Netgame - Packets</a></div>    
<div style="text-align: center;"><a href="netgame_config.html"                   target="_top">Netgame - Config</a></div>    
<div style="text-align: center;"><a href="netgame_server_setup.html"             target="_top">Netgame - Server Setup</a></div>    
<div style="text-align: center;"><a href="netgame_join.html"                     target="_top">Netgame - Join</a></div>    
<div style="text-align: center;"><a href="netgame_control_and_monitoring.html"   target="_top">Netgame - Control and Monitoring</a></div>    

</mdw_lhs_nav>

        </nav>

        
        <div class="col-2">

            <header>
                <mh11>Purple Martians</mh11><hr>
                <mh12>Technical Code Descriptions</mh12><hr>
            </header>

<mh3><hr></mh3>
<mh8>Netgame - Client Control Change</mh8>
<mh3><hr><mdw_file_toc> <a href="netgame_client_control_change.html#Client's controls have changed" target="_top">Client's controls have changed</a>
 <a href="netgame_client_control_change.html#Server receives control change" target="_top">Server receives control change</a>
</mdw_file_toc><hr></mh3>

<a name="Client's controls have changed"></a>
<mh7>Client's controls have changed</mh7>

<mh3>
Every frame, the client's controls are compared with their previous state.

If they have changed:

- an entry is put in the client's local game moves array (in case the change needs to be played back later)

- a 'cdat' packet with the control change and frame number is sent to the server

- the change is applied to the client's local game state
</mh3>    
<pre><code class="language-cpp">void mwPlayer::proc_player_input(void)
{
...
   if (loc[p].old_comp_move != loc[p].comp_move)  // player's controls have changed
   {
	  loc[p].old_comp_move = loc[p].comp_move;
      mGameMoves.add_game_move(mLoop.frame_num, 5, p, loc[p].comp_move);	
	  if (cm == 4)   // in client mode, send cdat packet, and apply move directly to controls
	  {
		 mNetgame.Packet("cdat");
		 mNetgame.PacketPut1ByteInt(p);
		 mNetgame.PacketPut4ByteInt(mLoop.frame_num);
		 mNetgame.PacketPut1ByteInt(loc[p].comp_move);
		 mNetgame.ClientSend(mNetgame.packetbuffer, mNetgame.packetsize);
		 set_controls_from_comp_move(p, loc[p].comp_move);

</code></pre>

<br><a name="Server receives control change"></a>
<mh7>Server receives control change</mh7>

<mh3>    
When the server receives a 'cdat' packet from a client, the server compares the frame number of the client's control change to the frame number of the last saved state on the server.

If it is earlier, the cdat arrived too late to be applied and is discarded.

Otherwise the client's control change is added to the server's game moves array.
</mh3>    
            
<pre><code class="language-cpp">void mwNetgame::server_proc_cdat_packet(double timestamp)
{
   char msg[1024];
   int p = PacketGet1ByteInt();
   int cdat_frame_num = PacketGet4ByteInt();
   int cm = PacketGet1ByteInt();

   mPlayer.loc[p].client_cdat_packets_tx++;

   // calculate game_move_sync
   mPlayer.loc[p].server_game_move_sync = cdat_frame_num - mLoop.frame_num;

   // calculate game_move_dsync
   mPlayer.loc[p].game_move_dsync = ( (double) mPlayer.loc[p].server_game_move_sync * 0.025) + mTimeStamp.timestamp_frame_start - timestamp;

   mTally_game_move_dsync_avg_last_sec[p].add_data(mPlayer.loc[p].game_move_dsync); // add to average tally


   // check to see if earlier than the last stdf state
   if (cdat_frame_num < srv_client_state_frame_num[0][1])
   {
      mPlayer.loc[p].late_cdats++;
      mTally_late_cdats_last_sec[p].add_data(1); // add to tally
      sprintf(msg, "rx cdat p:%d fn:[%d] sync:[%d] late - droppped\n", p, cdat_frame_num, mPlayer.loc[p].server_game_move_sync);
   }
   else
   {
      mGameMoves.add_game_move(cdat_frame_num, 5, p, cm); // add to game_move array
      sprintf(msg, "rx cdat p:%d fn:[%d] sync:[%d] gmep:[%d] - entered\n", p, cdat_frame_num, mPlayer.loc[p].server_game_move_sync, mGameMoves.entry_pos);
   }
   if (mLog.LOG_NET_cdat) mLog.add_log_entry2(35, p, msg);
}</code></pre>

               <footer>                <mh11>Purple Martians</mh11><hr>
                <div id="copyright">
                Copyright &copy; 2023, by <a href="mailto:mweiss001@gmail.com"> Michael David Weiss</a>
                </div>
</footer>

        </div>
    </body>

</html>
