<!doctype html>
<title>Netgame - Client Timing Sync</title>

<html>

    <script src="prism.js"></script>
    <link href = "themes/prism.css" rel="stylesheet" />
    <link href = "css/mdw.css"      rel="stylesheet" type = "text/css" />

    
    <body>

        <nav class="col-1">

<mdw_lhs_nav><div style="text-align: center;">Navigation</div><hr>    
<div style="text-align: center;"><a href="index.html" target="_top">Home</a></div>    
<div style="text-align: center;"><a href="index.html#Description" target="_top">Description</a></div>    
<div style="text-align: center;"><a href="index.html#Demo Video" target="_top">Demo Video</a></div>    
<div style="text-align: center;"><a href="index.html#Features" target="_top">Features</a></div>    
<div style="text-align: center;"><a href="index.html#Created by" target="_top">Created by</a></div>    
<div style="text-align: center;"><a href="index.html#Created with" target="_top">Created with</a></div>    
<div style="text-align: center;"><a href="index.html#License" target="_top">License</a></div>    
<div style="text-align: center;"><a href="index.html#Supported Systems" target="_top">Supported Systems</a></div>    
<div style="text-align: center;"><a href="index.html#External Links" target="_top">External Links</a></div>    
<div style="text-align: center;"><a href="index.html#Older Versions" target="_top">Older Versions</a></div>    
<div style="text-align: center;"><a href="index.html#History" target="_top">History</a></div>    

<br><div style="text-align: center;">Technical Descriptions</div><hr>    
<div style="text-align: center;"><a href="project_organization.html" target="_top">Project Organization</a></div>    
<div style="text-align: center;"><a href="logo.html" target="_top">Logo</a></div>    
<div style="text-align: center;"><a href="timers.html" target="_top">Timers</a></div>    
<div style="text-align: center;"><a href="events.html" target="_top">Events</a></div>    
<div style="text-align: center;"><a href="input.html" target="_top">Input</a></div>    
<div style="text-align: center;"><a href="level_done.html" target="_top">Level Done</a></div>    
<div style="text-align: center;"><a href="game_moves_array.html" target="_top">Game Moves Array</a></div>    
<div style="text-align: center;"><a href="sound.html" target="_top">Sound</a></div>    
<div style="text-align: center;"><a href="display.html" target="_top">Display</a></div>    
<div style="text-align: center;"><a href="tiles.html" target="_top">Tiles</a></div>    
<div style="text-align: center;"><a href="block_flags.html" target="_top">Block Flags</a></div>    
<div style="text-align: center;"><a href="shots.html" target="_top">Shots</a></div>    
<div style="text-align: center;"><a href="level_array.html" target="_top">Level Array</a></div>    

<div style="text-align: center;"><a href="netgame_main.html"                     target="_top">Netgame - Main</a></div>    
<div style="text-align: center;"><a href="netgame_state_and_dif.html"            target="_top">Netgame - State and Dif</a></div>    
<div style="text-align: center;"><a href="netgame_server_state.html"             target="_top">Netgame - Server State</a></div>    
<div style="text-align: center;"><a href="netgame_client_state.html"             target="_top">Netgame - Client State</a></div>    
<div style="text-align: center;"><a href="netgame_client_control_change.html"    target="_top">Netgame - Client Control Change</a></div>    
<div style="text-align: center;"><a href="netgame_client_timing_sync.html"       target="_top">Netgame - Client Timing Sync</a></div>    
<div style="text-align: center;"><a href="netgame_fast_packet_loop.html"         target="_top">Netgame - Fast Packet Loop</a></div>    
<div style="text-align: center;"><a href="netgame_ping.html"                     target="_top">Netgame - Ping</a></div>    
<div style="text-align: center;"><a href="netgame_packets.html"                  target="_top">Netgame - Packets</a></div>    
<div style="text-align: center;"><a href="netgame_config.html"                   target="_top">Netgame - Config</a></div>    
<div style="text-align: center;"><a href="netgame_server_setup.html"             target="_top">Netgame - Server Setup</a></div>    
<div style="text-align: center;"><a href="netgame_join.html"                     target="_top">Netgame - Join</a></div>    
<div style="text-align: center;"><a href="netgame_control_and_monitoring.html"   target="_top">Netgame - Control and Monitoring</a></div>    

</mdw_lhs_nav>

        </nav>

        
        <div class="col-2">

            <header>
                <mh11>Purple Martians</mh11><hr>
                <mh12>Technical Code Descriptions</mh12><hr>
            </header>

<mh3><hr></mh3>
<mh8>Netgame - Client Timing Sync</mh8>
<mh3><hr><mdw_file_toc> <a href="netgame_client_timing_sync.html#Client Timing Sync" target="_top">Client Timing Sync</a>
 <a href="netgame_client_timing_sync.html#Server sends 'stdf' packet" target="_top">Server sends 'stdf' packet</a>
 <a href="netgame_client_timing_sync.html#Client receives 'stdf' packet and calculates dsync" target="_top">Client receives 'stdf' packet and calculates dsync</a>
 <a href="netgame_client_timing_sync.html#Determine the setpoint" target="_top">Determine the setpoint</a>
 <a href="netgame_client_timing_sync.html#Adjust client timer" target="_top">Adjust client timer</a>
</mdw_file_toc><hr></mh3>


<br><a name="Client Timing Sync"></a>
<mh7>Client Timing Sync</mh7>

<mh3>    
Timing is critical in netgame. The server and client must have a tightly controlled timing relationship.

The server is the master timing source, and runs at 40 frames per second.

Clients are responsible for measuring and maintaining their timing offset with the server.

The time difference between the client and server is called dsync.

Clients use the 'stdf' packet sent from the server as the timing reference.
</mh3>


<br><a name="Server sends 'stdf' packet"></a>
<mh7>Server sends 'stdf' packet</mh7>



<mh3>    
The server sends 'stdf' packets to clients on a regular basis. Usually only a few frames apart.

These stdf packets contain pieces of a compressed dif state, and a header that describes the contents.

From that header, the destination frame number is the current frame number on the server when the dif was created and sent.

That is what the client uses to measure its timing relation to the server.
</mh3>

<pre><code class="language-cpp">void mwNetgame::server_send_dif(int p)
{
   ...
   Packet("stdf");
   PacketPut4ByteInt(srv_client_state_frame_num[p][1]); // dst frame_num
   ServerSendTo(packetbuffer, packetsize, players1[p].who, p);
</code></pre>





<br><a name="Client receives 'stdf' packet and calculates dsync"></a>
<mh7>Client receives 'stdf' packet and calculates dsync</mh7>



<mh3>    
When the client receives an 'stdf' packet, it uses the server's frame_num and its own local frame_num to make a simple frame based integer sync.
</mh3>
<pre><code class="language-cpp">void mwNetgame::client_process_stdf_packet(double timestamp)
{
   ...
   int dst = PacketGet4ByteInt();
   int client_sync = dst - mLoop.frame_num;                             // crude integer sync based on frame numbers
</code></pre>

<mh3>This is called 'client_sync' and only has a resolution of 1 frame (25ms).

    
The passed variable 'timestamp' was recorded by the <a href="netgame_fast_packet_loop.html#Client fast packet loop" target="_top">fast packet loop</a> when the packet was actually received.

This is used to give timing information less than one frame.

The two are combined and the result is 'dsync'.
</mh3>
<pre><code class="language-cpp">   if (mPlayer.loc[p].client_last_stdf_rx_frame_num != mLoop.frame_num)    // this is the first stdf received for this frame
   {
      mPlayer.loc[p].client_last_stdf_rx_frame_num = mLoop.frame_num;   // client keeps track of last stdf rx'd and quits if too long
      mPlayer.loc[p].dsync = al_get_time() - timestamp;                 // time between when the packet was received into the packet buffer and now
      mPlayer.loc[p].dsync += (double) client_sync * 0.025;             // combine with client_sync
</code></pre>
<mh3> Then dsync is <a href="rolling_average.html" target="_top">averaged</a> and 'client_timer_adjust()' is called.</mh3>
<pre><code class="language-cpp">      mRollingAverage[2].add_data(mPlayer.loc[p].dsync);    // send to rolling average
      mPlayer.loc[p].dsync_avg = mRollingAverage[2].avg;
      client_timer_adjust();
   }</code></pre>

<br><a name="Determine the setpoint"></a>
<mh7>Determine the setpoint</mh7>

<mh3>    
Before we adjust the timer, we need two things:

- a measured value, 'dsync_avg', which we just calculated

- a setpoint (what we want the value to be)

The setpoint is called 'client_chase_offset', and it is set from the average ping time as described here:

<a href="netgame_ping.html" target="_top">How ping is calculated.</a>

<a href="netgame_ping.html#Client uses 'ping_avg' time to set 'client_chase_offset'" target="_top">How ping is used to set client_chase_offset.</a>.
</mh3>


<br><a name="Adjust client timer"></a>
<mh7>Adjust client timer</mh7>


<mh3>    
At this point we have a measured value and a setpoint.

Next the client timer is adjusted to make the measured value approach the setpoint.

I was experimenting with implementing a <a href="https://www.google.com/search?q=pid+control+loop" target="_top">PID control loop</a>  here, but found it was not needed, so I just use the proportional term.
</mh3>


<pre><code class="language-cpp">void mwNetgame::client_timer_adjust(void)
{
   int p = mPlayer.active_local_player;
   float mva = mPlayer.loc[p].dsync_avg;            // measured value
   float mv = mPlayer.loc[p].dsync;                 // measured value
   float sp = mPlayer.loc[p].client_chase_offset;   // set point
   float err = sp - mva;                            // error = set point - measured value

   float p_adj = err * 80; // instantaneous error adjustment (proportional)

   tmaj_i += err; // cumulative error adjust (integral)
   float i_clamp = 5;
   if (tmaj_i >  i_clamp) tmaj_i =  i_clamp;
   if (tmaj_i < -i_clamp) tmaj_i = -i_clamp;
   tmaj_i *= 0.95; // decay
   float i_adj = tmaj_i * 0;

   float t_adj = p_adj + i_adj; // total adj

   float fps_chase = mLoop.frame_speed - t_adj;

   if (fps_chase < 10) fps_chase = 10; // never let this go negative
   if (fps_chase > 70) fps_chase = 70;
   al_set_timer_speed(mEventQueue.fps_timer, ( 1 / fps_chase));
   mPlayer.loc[p].client_chase_fps = fps_chase;
}</code></pre>


<mh3>

</mh3>


               <footer>                <mh11>Purple Martians</mh11><hr>
                <div id="copyright">
                Copyright &copy; 2023, by <a href="mailto:mweiss001@gmail.com"> Michael David Weiss</a>
                </div>
</footer>

        </div>
    </body>

</html>
