<!doctype html>
<title>Netgame - Control and Monitoring</title>

<html>

    <script src="prism.js"></script>
    <link href = "themes/prism.css" rel="stylesheet" />
    <link href = "css/mdw.css"      rel="stylesheet" type = "text/css" />

    
    <body>

        <nav class="col-1">

<mdw_lhs_nav><div style="text-align: center;">Navigation</div><hr>    
<div style="text-align: center;"><a href="index.html" target="_top">Home</a></div>    
<div style="text-align: center;"><a href="index.html#Description" target="_top">Description</a></div>    
<div style="text-align: center;"><a href="index.html#Demo Video" target="_top">Demo Video</a></div>    
<div style="text-align: center;"><a href="index.html#Features" target="_top">Features</a></div>    
<div style="text-align: center;"><a href="index.html#Created by" target="_top">Created by</a></div>    
<div style="text-align: center;"><a href="index.html#Created with" target="_top">Created with</a></div>    
<div style="text-align: center;"><a href="index.html#License" target="_top">License</a></div>    
<div style="text-align: center;"><a href="index.html#Supported Systems" target="_top">Supported Systems</a></div>    
<div style="text-align: center;"><a href="index.html#External Links" target="_top">External Links</a></div>    
<div style="text-align: center;"><a href="index.html#Older Versions" target="_top">Older Versions</a></div>    
<div style="text-align: center;"><a href="index.html#History" target="_top">History</a></div>    

<br><div style="text-align: center;">Technical Descriptions</div><hr>    
<div style="text-align: center;"><a href="project_organization.html" target="_top">Project Organization</a></div>    
<div style="text-align: center;"><a href="logo.html" target="_top">Logo</a></div>    
<div style="text-align: center;"><a href="timers.html" target="_top">Timers</a></div>    
<div style="text-align: center;"><a href="events.html" target="_top">Events</a></div>    
<div style="text-align: center;"><a href="input.html" target="_top">Input</a></div>    
<div style="text-align: center;"><a href="level_done.html" target="_top">Level Done</a></div>    
<div style="text-align: center;"><a href="game_moves_array.html" target="_top">Game Moves Array</a></div>    
<div style="text-align: center;"><a href="sound.html" target="_top">Sound</a></div>    
<div style="text-align: center;"><a href="display.html" target="_top">Display</a></div>    
<div style="text-align: center;"><a href="tiles.html" target="_top">Tiles</a></div>    
<div style="text-align: center;"><a href="block_flags.html" target="_top">Block Flags</a></div>    
<div style="text-align: center;"><a href="bullets.html" target="_top">Bullets</a></div>    
<div style="text-align: center;"><a href="level_array.html" target="_top">Level Array</a></div>    

<div style="text-align: center;"><a href="netgame_main.html"                  target="_top">Netgame - Main</a></div>    
<div style="text-align: center;"><a href="netgame_state_and_dif.html"         target="_top">Netgame - State and Dif</a></div>    
<div style="text-align: center;"><a href="netgame_server_state.html"          target="_top">Netgame - Server State</a></div>    
<div style="text-align: center;"><a href="netgame_client_state.html"          target="_top">Netgame - Client State</a></div>    
<div style="text-align: center;"><a href="netgame_client_control_change.html" target="_top">Netgame - Client Control Change</a></div>    
<div style="text-align: center;"><a href="netgame_client_timing_sync.html"    target="_top">Netgame - Client Timing Sync</a></div>    
<div style="text-align: center;"><a href="netgame_fast_packet_loop.html"      target="_top">Netgame - Fast Packet Loop</a></div>    
<div style="text-align: center;"><a href="netgame_ping.html"                  target="_top">Netgame - Ping</a></div>    
<div style="text-align: center;"><a href="netgame_packets.html"               target="_top">Netgame - Packets</a></div>    
<div style="text-align: center;"><a href="netgame_config.html"                target="_top">Netgame - Config</a></div>    
<div style="text-align: center;"><a href="netgame_join.html"                  target="_top">Netgame - Join</a></div>    
<div style="text-align: center;"><a href="netgame_status.html"                target="_top">Netgame - Status</a></div>    

</mdw_lhs_nav>
			
        </nav>

        
        <div class="col-2">

            <header>
                <mh11>Purple Martians</mh11><hr>
                <mh12>Technical Code Descriptions</mh12><hr>
            </header>

<mh3><hr></mh3>
<mh8>Netgame - Control and Monitoring</mh8>
<mh3><hr><mdw_file_toc>

</mdw_file_toc><hr></mh3>

<a name="Overview"></a>
<mh7>Overview</mh7>
<mh3>
These variables are used to control and monitor the status of netgame.
</mh3>    


<br><a name="dsync and dsync_avg"></a>
<mh7>dsync and dsync_avg</mh7>



<br><me1>Description</me1>
<mh3>
The timing offset between the client and the server.

Negative values are when the client is ahead of the server.

Positive values are when the client is behind the server.

Calculated by clients when receiving 'stdf' packet.

Clients also calculate a rolling average of dsync called dsync_avg.

Clients also send dsync to the server with 'stak' packets, so the server also has a dsync value for each client.
</mh3>

<br><me1>Variables</me1>
<mh3>
Client:
players1[p].dsync  
players1[p].dsync_avg 

Server:
players1[p].dsync
</mh3>

<br><me1>Code</me1>
<mh3>
When the client receives an 'stdf' packet from the server, it calculates dsync and dsync_avg like this: <a href="netgame_client_timing_sync.html#Client receives 'stdf' packet" target="_top">Client receives 'stdf' packet</a>

The client uses dsync_avg to adjust it's timing offset with reference to the server like this:  <a href="netgame_client_timing_sync.html#Adjust client timer" target="_top">Adjust client timer</a>

The server uses dsync to control when joining clients become active like this: <a href="netgame_join.html#Client chase and lock" target="_top">Client chase and lock</a>
</mh3>





<br><a name="ping and ping_avg"></a>
<mh7>ping and ping_avg</mh7>

<br><me1>Description</me1>
<mh3>
The round trip ping response times between the client and the server.

Clients calculate and store their own ping time, as well a a rolling average 'ping_avg'.

The server calculates and stores ping times for each client.
</mh3>


<br><me1>Variables</me1>
<mh3>
Client:
players1[p].ping  
players1[p].ping_avg 

Server:
players1[p].ping
</mh3>

<br><me1>Code</me1>
<mh3>
The method of calculating ping is described here: <a href="netgame_ping.html" target="_top">ping</a>

The method of the client calculating the rolling average is described here: <a href="netgame_ping.html#Client calculates the rolling average of its ping time" target="_top">ping rolling average</a>

The client uses the ping average to set client_chase_offset here:<a href="netgame_ping.html#Client uses 'ping_avg' time to set 'client_chase_offset'" target="_top">client_chase_offset</a>

The server finds the maximum client ping and uses it to set 'server_state_freq' as described here:  <a href="netgame_ping.html#Server uses 'server_max_client_ping' to set 'server_state_freq'" target="_top">server_state_freq</a>
</mh3>





<br><a name="Server Game Move Sync"></a>
<mh7>Server Game Move Sync</mh7>

<br><me1>Description</me1>
<mh3>
Measure the time between when a cdat is recieved on the server and the frame when it needs to be applied.

When a cdat is received, the frame number is compared to the current server frame number.

The server calculates and stores this for each client.
</mh3>


<br><me1>Variables</me1>
<mh3>
On the server, per client:
players1[p].server_game_move_sync
players1[p].game_move_dsync
players1[p].game_move_dsync_avg_last_sec
</mh3>

<br><me1>Code</me1>
<mh3>

</mh3>

<pre><code class="language-cpp">void server_proc_cdat_packet(double timestamp)
{
   int p = PacketGet1ByteInt();
   int cdat_frame_num = PacketGet4ByteInt();
   int cm = PacketGet1ByteInt();

   players1[p].client_cdat_packets_tx++;

   // calculate game_move_sync
   players1[p].server_game_move_sync = cdat_frame_num - frame_num;

   // calculate game_move_dsync
   players1[p].game_move_dsync = ( (double) players1[p].server_game_move_sync * 0.025) + timestamp_frame_start - timestamp;
   players1[p].game_move_dsync_avg_last_sec_tally += players1[p].game_move_dsync;
   players1[p].game_move_dsync_avg_last_sec_count +=1;

   // check to see if earlier than the last stdf state
   if (cdat_frame_num < srv_client_state_frame_num[0][1])
   {
      players1[p].late_cdats_last_sec_tally++;
      players1[p].late_cdats++;
      sprintf(msg, "rx cdat p:%d fn:[%d] sync:[%d] late - droppped\n", p, cdat_frame_num, players1[p].server_game_move_sync);
   }
   else
   {
      add_game_move(cdat_frame_num, 5, p, cm); // add to game_move array
      sprintf(msg, "rx cdat p:%d fn:[%d] sync:[%d] gmep:[%d] - entered\n", p, cdat_frame_num, players1[p].server_game_move_sync, game_move_entry_pos);
   }
   if (LOG_NET_cdat) add_log_entry2(35, p, msg);
}
</code></pre>

               <footer>                <mh11>Purple Martians</mh11><hr>
                <div id="copyright">
                Copyright &copy; 2023, by <a href="mailto:mweiss001@gmail.com"> Michael David Weiss</a>
                </div>
</footer>

        </div>
    </body>

</html>
