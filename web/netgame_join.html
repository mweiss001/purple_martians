<!doctype html>
<title>Netgame - Join</title>

<html>

    <script src="prism.js"></script>
    <link href = "themes/prism.css" rel="stylesheet" />
    <link href = "css/mdw.css"      rel="stylesheet" type = "text/css" />

    
    <body>

        <nav class="col-1">
            
            <div style="text-align: center;">Navigation</div><hr>    

            <div style="text-align: center;"><a href="index.html" target="_top">Home</a></div>    
            <div style="text-align: center;"><a href="index.html#description" target="_top">Description</a></div>    
            <div style="text-align: center;"><a href="index.html#video" target="_top">Demo Video</a></div>    
            <div style="text-align: center;"><a href="index.html#features" target="_top">Features</a></div>    

            <div style="text-align: center;"><a href="index.html#created_by" target="_top">Created by</a></div>    
            <div style="text-align: center;"><a href="index.html#created_with" target="_top">Created with</a></div>    
            <div style="text-align: center;"><a href="index.html#license" target="_top">License</a></div>    
            <div style="text-align: center;"><a href="index.html#systems" target="_top">Supported Systems</a></div>    

            <div style="text-align: center;"><a href="index.html#external links" target="_top">External Links</a></div>    

            <div style="text-align: center;"><a href="index.html#old_versions" target="_top">Older Versions</a></div>    
            <div style="text-align: center;"><a href="index.html#history" target="_top">History</a></div>    

            <br><div style="text-align: center;">Technical Descriptions</div><hr>    
            
            <div style="text-align: center;"><a href="logo.html" target="_top">Logo</a></div>    
            <div style="text-align: center;"><a href="timers.html" target="_top">Timers</a></div>    
            <div style="text-align: center;"><a href="events.html" target="_top">Events</a></div>    
            <div style="text-align: center;"><a href="input.html" target="_top">Input</a></div>    
            <div style="text-align: center;"><a href="sound.html" target="_top">Sound</a></div>    
            <div style="text-align: center;"><a href="display.html" target="_top">Display</a></div>    
            <div style="text-align: center;"><a href="tiles.html" target="_top">Tiles</a></div>    
            <div style="text-align: center;"><a href="level_array.html" target="_top">Level Array</a></div>    
            <div style="text-align: center;"><a href="netgame_main.html" target="_top">Netgame - Main</a></div>    
            <div style="text-align: center;"><a href="netgame_state.html" target="_top">Netgame - State</a></div>    
            <div style="text-align: center;"><a href="netgame_join.html" target="_top">Netgame - Join</a></div>    
            
        </nav>

        
        <div class="col-2">

            <header>
                <mh11>Purple Martians</mh11><hr>
                <mh1>Technical Code Descriptions</mh1><hr>
            </header>


<mh8>Netgame - Join</mh8>
<mh7>Overview</mh7>
<mh3>

The netgame is only designed to work in a LAN, not the internet.    
    
To join a netgame the client needs to know the IP or hostname of the server.
    
The server does not need to know anything about the client.
    
If both the server and the client can ping each other, netgame should work.
In some cases a firewall exception may need to be created. (especially for the server)
    
In windows, open up a command prompt and type:
- 'ipconfig' to see your local IP address
- 'hostname' to see your hostname
    
Do this for both the client and the server.
    
Then try to ping each other by typing:
- 'ping [IP]' or
- 'ping [hostname]'     
    
If that works then all you need to do is make sure the client(s) have the server's IP or hostname set.
    
You can do this three different ways:
- in the game from 'options menu' -> 'netgame options'
- open the config file 'pm.cfg' and edit the entry 'server_IP='    
- from a command prompt start the game in client mode with 'pm -c [hostname or IP]'    

Start the server game running with 'Host Network Game', then start the client(s) with 'Join Network Game'
    
In a few seconds the client will join.


</mh3>
<mh7>How joining works</mh7>
<mh3>
When a client wants to join, it sends a 'CJON' packet to the server, requesting to join.</mh3>
<pre><code class="language-cpp">Packet("CJON");
PacketPut1ByteInt(players[0].color); // request the color of current player 0
PacketAddString(local_hostname);
ClientSend(packetbuffer, packetsize);
</code></pre>

   
<mh3>    
The server sets up a client player structure and replies with an 'SJON' packet.</mh3>
<pre><code class="language-cpp">players[cn].color = color;
players[cn].bitmap_index = color - 1;
players[cn].active = 0;
players[cn].control_method = 2; // server client remote view only
players1[cn].who = who;
players1[cn].server_last_sdak_rx_frame_num = frame_num + 200;
players1[cn].game_move_entry_pos = game_move_entry_pos;

Packet("SJON"); // reply with SJON
PacketPut2ByteInt(play_level);
PacketPut4ByteInt(frame_num);
PacketPut4ByteInt(game_move_entry_pos);
PacketPut1ByteInt(frame_speed);
PacketPut1ByteInt(cn);
PacketPut1ByteInt(color);
PacketPut1ByteInt(deathmatch_pbullets);
PacketPut1ByteInt(deathmatch_pbullets_damage);
PacketPut1ByteInt(suicide_pbullets);
</code></pre>

<mh7>Client gets 'SJON' and set up local client player:</mh7>
<br>
<pre><code class="language-cpp">play_level = PacketGet2ByteInt(); 
int server_SJON_frame_num      =  PacketGet4ByteInt(); 
int server_game_move_entry_pos =  PacketGet4ByteInt(); 
frame_speed = PacketGet1ByteInt();    
int cp = PacketGet1ByteInt();     // client player number
int color = PacketGet1ByteInt();  // client player color
deathmatch_pbullets = PacketGet1ByteInt();
deathmatch_pbullets_damage = PacketGet1ByteInt();
suicide_pbullets = PacketGet1ByteInt();

al_set_timer_speed(fps_timer, 1/(float)frame_speed);

players[0].active = 1;          // server is alway player 0 and active when on a client
players[0].control_method = 2;  // server is remote view when on a client

active_local_player = cp;
init_player(cp, 1);
players[cp].active = 0;          // active is not set here on purpose
players[cp].control_method = 4;  // client local player
players[cp].color = color;
players[cp].bitmap_index = color -1;
players1[cp].game_move_entry_pos = server_game_move_entry_pos;
</code></pre>



<mh7>Client blocks until it gets stdf from server:</mh7>
<br>
<mh3>On both client and server, proc_controllers() does nothing because the player is not active yet.
  
On the client in the function 'client_control()': </mh3>
<pre><code class="language-cpp">if (frame_num == 0) client_block_until_good_stdf_received();

void client_block_until_good_stdf_received(void)
{
   int p = active_local_player;
   sprintf(msg, "Waiting for game state from server");
   rtextout_centre(NULL, msg, SCREEN_W/2, SCREEN_H/2, 10, 2, 0, 1);

   reset_states();

   int done = 0;
   while (!done)
   {
      if ((packetsize = ClientReceive(packetbuffer)))
      {
         if(PacketRead("stdf"))
         {
             done = process_stdf_packet();
         }
      }
   }
   
   // set frame_nums
   frame_num = client_state_dif_dst;
   al_set_timer_count(fps_timer, frame_num);

   players1[p].client_last_sdat_rx_frame_num = frame_num + 200;
   
   client_apply_diff();

   // redraw blocks just in case
   init_level_background();

   // check for other active clients and set their control methods to 2
   for (int pp=1; pp < NUM_PLAYERS; pp++)
      if (players[pp].active) players[pp].control_method = 2;

   players[p].control_method = 4; // set my own control method to 4


   // send ack up to this point (we don't care about previous game moves anymore)
   Packet("sdak");
   PacketPut1ByteInt(p);
   PacketPut4ByteInt(frame_num);
   PacketPut4ByteInt(players1[p].game_move_entry_pos); // new entry pos
   PacketPut4ByteInt(players1[p].stdf_late);
   PacketPut4ByteInt(players1[p].frames_skipped);
   ClientSend(packetbuffer, packetsize);
}


</code></pre>
<mh3>

After this the client's frame_num is set and the game runs from this point. 

The client is still not active, but it processes all the packets the server sends.

In particular sdat packets that it uses to adjust its timer and catch up with the server.



The server is monitoring the clients cync, when it replies to sdats with sdaks
</mh3>
<pre><code class="language-cpp">if(PacketRead("sdak"))
{
   int client_fn = PacketGet4ByteInt();

   // set server_sync in player struct
   players1[p].server_sync = frame_num - client_fn;

   if ((players[p].active == 0) && (players[p].control_method == 2) && (players1[p].server_sync < 4) && (players1[p].server_sync > -2))
   {
      add_game_move(frame_num + 4, 1, p, players[p].color);
   }
}

</code></pre>
   




   
   
    
            
<pre><code class="language-cpp">




</code></pre>
       
            
            
            
<br><mh7>Packets used for join</mh7>
<br>            

<pk0>Packet: 'CJON'</pk0>
<pk1>description: 'client join'
direction: client to server
- 1 byte (requested color)
- 16 bytes (client hostname)
</pk1><br>
        
<pk0>Packet: 'SJON'</pk0>
<pk1>description: 'server join'
direction: server to client
- 2 bytes (play level)
- 4 bytes (server frame_num)
- 4 bytes (server game_move entry position)
- 1 byte (frame speed)
- 1 byte (player number)
- 1 byte (player color)
- 1 byte (deathmatch_pbullets)
- 1 byte (deathmatch_pbullets_damage)
- 1 byte (suicide_pbullets)
</pk1>        






               <footer>
                <mh11>Purple Martians</mh11><hr>
                <div id="copyright">
                Copyright &copy; 2018, by <a href="mailto:mweiss001@gmail.com"> Michael David Weiss</a>
                </div>
            </footer>

        </div>
    </body>

</html>
